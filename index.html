<!DOCTYPE html>
<html lang="bn">
<head>
<script type='text/javascript'>
//<![CDATA[
var uri = window.location.toString();
if (uri.indexOf("?m=1") > 0) {
    var clean_uri = uri.substring(0, uri.indexOf("?m=1"));
    window.history.replaceState({}, document.title, clean_uri);
}
//]]>
</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>কেনাকাটার তালিকা ও হিসাব খাতা</title>
    <!-- START: SEO Meta Tag Added -->
    <meta name="description" content="Talika.xyz - একটি সহজ এবং শক্তিশালী অনলাইন কেনাকাটার তালিকা এবং ব্যক্তিগত হিসাব খাতা। আপনার দৈনন্দিন কেনাকাটা ও আয়-ব্যয়ের হিসাব সহজ করুন।">
    <!-- END: SEO Meta Tag Added -->

    <link rel="manifest" href="manifest.json">

    <link rel="apple-touch-icon" sizes="180x180" href="icons/icon-192x192.png">

    <!-- jsPDF library for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas library for converting HTML to canvas/image -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        /* আপনার সকল CSS কোড এখানে অপরিবর্তিত থাকবে */
        /* START: Auth Loading Fix - নতুন কোড যোগ করা হলো */
        body.auth-loading {
            visibility: hidden;
            /* এটি ফ্ল্যাশ হওয়া রোধ করে এবং স্ক্রিন জাম্পিং বন্ধ করে */
            position: fixed; 
            width: 100%; 
            height: 100%; 
            overflow: hidden; /* স্ক্রলবার আসা বন্ধ করার জন্য */
        }
        /* END: Auth Loading Fix */
        :root {
            --list-item-border-color: #e0e0e0;
            --default-font-size: 16px; /* Font size reduced as requested */
            --income-color: #28a745;
            --expense-color: #dc3545;
            --income-color-dark: #5cb85c;
            --expense-color-dark: #ff6666;
            --primary-color: #3f51b5; /* USER UPDATED COLOR */
            --primary-dark-color: #5c6bc0; /* USER UPDATED COLOR (Dark Mode) */
            --fab-color: #d9534f;
            --fab-hover-color: #c9302c;
            --disabled-color: #f0f2f5;
            --disabled-text-color: #a0a0a0;
            --light-expense-bg-color: #fff0f0; /* New variable for light red background */
            --main-bg-color: #f0f2f5; /* ADDED for Page backgrounds */

        }
        body.dark-mode {
            --list-item-border-color: #444;
            --disabled-color: #2a2a4a;
            --disabled-text-color: #777;
            --light-expense-bg-color: transparent; /* Dark mode equivalent for light red background */
            --main-bg-color: #1a1a2e; /* Dark body background */
        }
        
        /* --- START: কেনাকাটার রিপোর্ট রঙের কাস্টমাইজেশন (ইউজার রিকোয়েস্ট) --- */

/* সামগ্রিক সারাংশ ব্লক - মোট সংখ্যাগুলির রঙ পরিবর্তন */
/* মোট তালিকার সংখ্যা, মোট পণ্যের সংখ্যা, কেনা/কেনা হয়নি পণ্যের সংখ্যা কালো/ডিফল্ট রঙের জন্য */
#reportPage .report-summary-item strong {
    /* এটি সকল strong-কে ওভাররাইড করে, তাই আমরা নিচে স্পেসিফিক আইডিগুলোর কালার দেব */
    color: var(--primary-color); /* ডিফল্ট কালারটি যেমন আছে, তেমন থাকুক */
}

/* **গুরুত্বপূর্ণ পরিবর্তন:** পরিমাণগুলো কালো/ডিফল্ট রঙের জন্য */
#reportSummaryTotalLists,
#reportSummaryTotalItems,
#reportSummaryBoughtItemsCount,
#reportSummaryUnboughtItemsCount {
    color: inherit !important; /* এটি তার প্যারেন্ট এলিমেন্ট (body বা .container)-এর কালার ব্যবহার করবে, যা কালো বা সাদা হবে */
}

/* মোট কেনা পণ্যের মূল্য: সবুজ */
#reportSummaryBoughtItemsTotal {
    color: var(--income-color) !important;
}
body.dark-mode #reportSummaryBoughtItemsTotal {
    color: var(--income-color-dark) !important;
}

/* মোট কেনা হয়নি পণ্যের মূল্য: লাল */
#reportSummaryUnboughtItemsTotal {
    color: var(--expense-color) !important;
}
body.dark-mode #reportSummaryUnboughtItemsTotal {
    color: var(--expense-color-dark) !important;
}

/* তারিখ পরিসীমা অনুযায়ী রিপোর্ট - মোট পণ্যের মূল্য (বাটন কালার/Primary) */
#dateFilterTotalAmount {
    color: var(--primary-color) !important; /* Primary Color/Button Color */
}
body.dark-mode #dateFilterTotalAmount {
    color: var(--primary-dark-color) !important;
}

/* তারিখ পরিসীমা অনুযায়ী রিপোর্ট - মোট কেনা পণ্যের মূল্য: সবুজ */
#dateFilterBoughtTotal {
    color: var(--income-color) !important;
}
body.dark-mode #dateFilterBoughtTotal {
    color: var(--income-color-dark) !important;
}

/* তারিখ পরিসীমা অনুযায়ী রিপোর্ট - মোট কেনা হয়নি পণ্যের মূল্য: লাল */
#dateFilterUnboughtTotal {
    color: var(--expense-color) !important;
}
body.dark-mode #dateFilterUnboughtTotal {
    color: var(--expense-color-dark) !important;
}

/* কেনা পণ্যের তালিকার মোট মূল্য (Sticky Footer) - সবুজ */
#reportAllBoughtItems .sticky-total-wrapper span:last-child {
    color: var(--income-color) !important; 
}

/* কেনা হয়নি পণ্যের তালিকার মোট মূল্য (Sticky Footer) - লাল */
#reportAllUnboughtItems .sticky-total-wrapper span:last-child {
    color: var(--expense-color) !important;
}


/* --- END: কেনাকাটার রিপোর্ট রঙের কাস্টমাইজেশন (ইউজার রিকোয়েস্ট) --- */
        
        /* CSS পরিবর্তন: গ্রাহকের পাতার ফোন নম্বরের জন্য */
.ledger-customer-view .customer-header-info .phone a { 
    color: var(--income-color); /* নম্বর সবুজ করা হয়েছে (লাইট মোড) */
    text-decoration: none; 
    display: inline-flex;
    align-items: center;
    gap: 5px; /* আইকন এবং নম্বরের মধ্যে সামান্য গ্যাপ */
}

/* নতুন নিয়ম: ফোন আইকনের রঙ পরিবর্তন (আকার ছোট করা হয়েছে) */
.ledger-customer-view .customer-header-info .phone a i {
    color: var(--expense-color); /* আইকন লাল করা হয়েছে */
    font-size: 1em; /* আইকনটি 1em করা হয়েছে */
}

/* ডার্ক মোডের জন্য বিশেষ পরিবর্তন: */

/* **চূড়ান্ত ফিক্স:** ডার্ক মোডেও নম্বর সবুজ করার জন্য !important ব্যবহার */
body.dark-mode .ledger-customer-view .customer-header-info .phone a {
    color: var(--income-color-dark) !important; 
    /* !important ব্যবহার করে যেকোনো প্যারেন্ট ডার্ক মোড টেক্সট কালারকে ওভাররাইড করা হলো */
}

/* ডার্ক মোডের জন্য ফোন আইকনের রঙ পরিবর্তন (লাল) */
body.dark-mode .ledger-customer-view .customer-header-info .phone a i {
    color: var(--expense-color-dark) !important; /* !important ব্যবহার করে নিশ্চিত করা হলো */
}
        
        /* START: Progress Bar Styles Added for Loader */
.progress-container {
    width: 250px; /* স্পিনারের থেকে একটু চওড়া */
    margin-bottom: 25px; /* স্পিনার থেকে দূরত্ব */
    margin: 0 auto 25px auto; /* <-- নতুন/পরিবর্তিত: কন্টেইনারটিকে সেন্টারে আনবে */
    text-align: center; /* <-- নতুন: ভেতরের লেবেলটিকে সেন্টারে আনবে */
}
.progress-label {
    display: block;
    font-size: 0.9em;
    font-weight: 500;
    color: #555;
    margin-bottom: 5px;
}
body.dark-mode .progress-label {
    color: #bbb;
}
#progressBar {
    width: 100%;
    height: 10px;
    appearance: none;
    border: none;
    border-radius: 5px;
    background-color: #e0e0e0;
}
/* Chrome/Safari-এর জন্য প্রোগ্রেস বার স্টাইল */
#progressBar::-webkit-progress-bar {
    background-color: #e0e0e0;
    border-radius: 5px;
}
#progressBar::-webkit-progress-value {
    background-color: var(--primary-color);
    border-radius: 5px;
    transition: width 0.3s ease; /* স্মুথ ট্রানজিশন */
}
/* Firefox-এর জন্য প্রোগ্রেস বার স্টাইল */
#progressBar::-moz-progress-bar {
    background-color: var(--primary-color);
    border-radius: 5px;
}
body.dark-mode #progressBar {
    background-color: #4a4a6a;
}
body.dark-mode #progressBar::-webkit-progress-bar {
    background-color: #4a4a6a;
}
body.dark-mode #progressBar::-webkit-progress-value {
    background-color: var(--primary-dark-color);
}
/* END: Progress Bar Styles Added for Loader */
        
        /* START: Custom Modal Validation Error Styles */
.custom-modal-input-group {
    position: relative;
    /* DANGER: এই লাইনটি সরিয়ে দেওয়া হচ্ছে, যাতে অন্য মডালের স্পেস ঠিক হয় */
    /* padding-bottom: 20px; */ 
}
.custom-modal-input-group.error {
    padding-bottom: 20px; /* শুধুমাত্র ভুল দেখালে অতিরিক্ত জায়গা থাকবে */
}
.custom-modal-error-message {
    position: absolute;
    bottom: 0;
    left: 5px;
    font-size: 0.8em;
    color: var(--expense-color);
    display: none; /* ডিফল্টভাবে লুকানো থাকবে */
}
/* ... বাকি CSS অপরিবর্তিত ... */
.custom-modal-input-group.error input {
    border-color: var(--expense-color) !important; /* !important দিয়ে অগ্রাধিকার দেওয়া হলো */
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2) !important;
}
.custom-modal-input-group.error .custom-modal-error-message {
    display: block; /* যখন error ক্লাস থাকবে, তখন দেখা যাবে */
}
/* END: Custom Modal Validation Error Styles */
        
        /* START: ভ্যালিডেশন ভুলের বার্তার জন্য CSS */
.auth-input-group {
    position: relative;
    padding-bottom: 18px; /* ভুলের বার্তার জন্য জায়গা */
}
.error-message {
    position: absolute;
    bottom: 0;
    left: 5px;
    font-size: 0.8em;
    color: var(--expense-color);
    display: none; /* ডিফল্টভাবে লুকানো থাকবে */
}
.auth-input-group.error input {
    border-color: var(--expense-color);
}
.auth-input-group.error .error-message {
    display: block; /* যখন error ক্লাস থাকবে, তখন দেখা যাবে */
}
/* END: নতুন CSS */
        
        /* START: ইমেইল/পাসওয়ার্ড অথেনটিকেশন ফর্মের জন্য নতুন CSS (Floating Label সহ) */
#emailAuthContainer {
    width: 100%;
    margin-top: 15px; /* মার্জিন কমানো হলো */
    margin-bottom: 10px; /* মার্জিন কমানো হলো */
}

/* ফ্লোটিং লেবেলের জন্য নতুন ক্লাস */
.floating-label-group {
    position: relative;
    padding-top: 15px; /* লেবেল উপরে ওঠার জন্য জায়গা কমানো হলো */
    /* *** দূরত্ব কমানো হয়েছে *** */
    margin-bottom: 5px; /* 8px থেকে কমিয়ে 5px করা হয়েছে */
}
/* যখন error ক্লাস থাকবে, তখন নিচে error মেসেজের জন্য অতিরিক্ত জায়গা যোগ করা হলো */
.auth-input-group.error.floating-label-group {
    padding-bottom: 18px; /* error মেসেজের জন্য জায়গা কমানো হলো */
}


.auth-input-group input {
    width: 100%;
    /* প্যাডিং পরিবর্তন করে ইনপুট ফিল্ড ছোট করা হয়েছে */
    padding: 15px 15px 8px 15px; 
    font-size: 0.95em; /* ফন্ট সাইজ কিছুটা ছোট করা হয়েছে */
    border-radius: 10px; /* আরও ছোট গোল */
    border: 1px solid #ddd;
    background-color: #f8f8f8;
    box-sizing: border-box;
    color: #333;
    transition: all 0.2s ease-out;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}
.auth-input-group input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 1px var(--primary-color), 0 2px 4px rgba(63, 81, 181, 0.2); /* শ্যাডো কমানো হয়েছে */
    background-color: #fff;
}

/* লেবেলের ডিফল্ট স্টাইল (ইনপুটের ভেতরে) */
.floating-label-group label {
    position: absolute;
    /* ইনপুট ফিল্ড ছোট হওয়ায় টপ অ্যাডজাস্ট করা হয়েছে */
    top: 45%; 
    left: 15px;
    transform: translateY(-50%);
    color: #888;
    font-size: 0.95em; /* ফন্ট সাইজ কিছুটা ছোট করা হয়েছে */
    pointer-events: none; /* যাতে লেবেলে ক্লিক হলেও ফোকাস ইনপুটে যায় */
    transition: all 0.2s ease-out;
    background-color: transparent;
}

/* যখন ইনপুট ফোকাসড অথবা যখন টেক্সট টাইপ করা হয়েছে */
.floating-label-group input:focus + label,
.floating-label-group input:not(:placeholder-shown) + label {
    top: 3px; /* উপরে উঠে যাওয়া পজিশন কমানো হলো */
    font-size: 0.7em; /* ফ্লোটিং লেবেলের ফন্ট সাইজ আরও ছোট করা হয়েছে */
    color: var(--primary-color);
    transform: translateY(0);
    /* ব্যাকগ্রাউন্ড কালার যোগ করা হয়েছে যাতে ইনপুটের বর্ডার লাইনটি ঢেকে যায় */
    background-color: var(--main-bg-color); 
    padding: 0 5px;
    left: 10px;
}

/* পাসওয়ার্ড টগল বাটনের পজিশন ঠিক করা হয়েছে */
.password-input-wrapper .password-toggle-btn {
    right: 15px;
    top: 45%; /* ইনপুট ছোট হওয়ায় পজিশন অ্যাডজাস্ট করা হলো */
}
/* পাসওয়ার্ড ইনপুটের প্যাডিং ঠিক করা হয়েছে যাতে আইকনের সাথে জায়গা না থাকে */
.password-input-wrapper input[type="password"],
.password-input-wrapper input[type="text"] {
    padding-right: 45px !important; 
}


.auth-btn {
    width: 100%;
    padding: 11px; /* বাটনের প্যাডিং কমানো হলো */
    font-size: 1em; /* বাটনের ফন্ট সাইজ কমানো হলো */
    background-color: var(--primary-color); /* Primary color for consistency */
    color: white;
    border: none;
    border-radius: 10px; /* গোল করা কমানো হলো */
    cursor: pointer;
    font-weight: 600;
    transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
    box-shadow: 0 3px 8px rgba(63, 81, 181, 0.3); /* শ্যাডো কমানো হলো */
}
.auth-btn:hover {
    background-color: #303f9f;
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(63, 81, 181, 0.4);
}

.auth-switch-text {
    margin-top: 10px; /* মার্জিন কমানো হলো */
    font-size: 0.9em;
    color: #555;
}
.auth-switch-text a {
    color: var(--primary-color);
    font-weight: 600;
    text-decoration: none;
}
.auth-switch-text a:hover {
    text-decoration: underline;
}

.auth-divider {
    display: flex;
    align-items: center;
    text-align: center;
    color: #888;
    margin-bottom: 10px; /* মার্জিন কমানো হলো */
    font-size: 0.9em;
}
.auth-divider::before,
.auth-divider::after {
    content: '';
    flex: 1;
    border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}
.auth-divider:not(:empty)::before {
    margin-right: .5em;
}
.auth-divider:not(:empty)::after {
    margin-left: .5em;
}

/* Dark Mode Styles */
body.dark-mode .auth-input-group input {
    background-color: #3a3a5a;
    border-color: #555;
    color: #e0e0e0;
}
body.dark-mode .auth-input-group input:focus {
    border-color: var(--primary-dark-color);
    box-shadow: 0 0 0 1px var(--primary-dark-color), 0 2px 4px rgba(92, 107, 192, 0.2);
    background-color: #3a3a5a;
}
body.dark-mode .floating-label-group label {
    color: #aaa;
}
body.dark-mode .floating-label-group input:focus + label,
body.dark-mode .floating-label-group input:not(:placeholder-shown) + label {
    color: var(--primary-dark-color);
    background-color: #2a2a4a; /* Dark body background */
}
body.dark-mode .auth-switch-text {
    color: #bbb;
}
body.dark-mode .auth-divider {
    color: #aaa;
}
body.dark-mode .auth-divider::before,
body.dark-mode .auth-divider::after {
    border-bottom-color: rgba(255, 255, 255, 0.15);
}
body.dark-mode .auth-btn {
    background-color: var(--primary-dark-color);
    box-shadow: 0 3px 8px rgba(92, 107, 192, 0.3);
}
body.dark-mode .auth-btn:hover {
    background-color: #4e5d9e;
    box-shadow: 0 4px 10px rgba(92, 107, 192, 0.4);
}
/* END: নতুন CSS (Floating Label সহ) */

/* START: Password Toggle Styles Added */
.password-input-wrapper {
    position: relative;
}
.password-input-wrapper input[type="password"],
.password-input-wrapper input[type="text"] { /* এই ইনপুটগুলো এখন নতুন ক্লাস দ্বারা স্টাইল করা হবে */
    padding-right: 45px !important; /* আইকনের জন্য জায়গা */
}
.password-toggle-btn {
    position: absolute;
    right: 5px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    font-size: 1.1em;
    color: #999;
    cursor: pointer;
    padding: 10px; /* সহজ ক্লিক করার জন্য প্যাডিং */
    z-index: 10;
}
.password-toggle-btn:hover {
    color: var(--primary-color);
}
body.dark-mode .password-toggle-btn {
    color: #bbb;
}
body.dark-mode .password-toggle-btn:hover {
    color: var(--primary-dark-color);
}
/* END: Password Toggle Styles Added */
        
        /* --- START: চূড়ান্ত কাস্টম ক্যালকুলেটর স্টাইল (আগের সুন্দর ডিজাইন এবং উন্নত অ্যানিমেশন) --- */
.calculator-container {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    max-width: 800px;
    left: 50%;
    transform: translateX(-50%) translateY(100%);
    background-color: #f0f2f5;
    box-shadow: 0 -3px 12px rgba(0, 0, 0, 0.1);
    border-top: 1px solid #dcdcdc;
    transition: transform 0.25s ease-out;
    padding-bottom: env(safe-area-inset-bottom, 5px);
    padding-top: 5px;
}
.calculator-container.show {
    transform: translateX(-50%) translateY(0);
}

.calculator-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1px;
    background-color: #dcdcdc;
}

.calc-btn {
    background-color: #ffffff;
    border: none;
    padding: 12px 0;
    font-size: 1.3em;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    transition: background-color 0.2s, transform 0.1s; /* Transform transition যোগ করা হয়েছে */
    -webkit-tap-highlight-color: transparent;
}

.calc-btn.utility {
    color: #555;
    font-size: 1.1em;
}
.calc-btn.operator {
    background-color: #fafafa;
    color: var(--primary-color);
}
.calc-btn.equals {
    background-color: var(--primary-color);
    color: white;
    grid-row: span 2;
}

/* --- START: লাইট মোডের জন্য সকল বাটনের ক্লিকের অ্যানিমেশন --- */
.calc-btn:active,
.calc-btn.utility:active,
.calc-btn.operator:active {
    background-color: #e0e0e0;
    transform: scale(0.95); /* বাটন চাপার ইফেক্ট */
}
.calc-btn.equals:active {
    background-color: #303f9f;
    transform: scale(0.95);
}
/* --- END: লাইট মোডের অ্যানিমেশন কোড --- */


/* --- ডার্ক মোডের জন্য স্টাইল --- */
body.dark-mode .calculator-container {
    background-color: #202030;
    border-top-color: #444;
}
body.dark-mode .calculator-grid {
    background-color: #444;
}
body.dark-mode .calc-btn {
    background-color: #2a2a4a;
    color: #e0e0e0;
}
body.dark-mode .calc-btn.utility {
    color: #bbb;
}
body.dark-mode .calc-btn.operator {
    background-color: #33335a;
    color: var(--primary-dark-color);
}
body.dark-mode .calc-btn.equals {
    background-color: var(--primary-dark-color);
}

/* --- START: ডার্ক মোডের জন্য সকল বাটনের ক্লিকের অ্যানিমেশন --- */
body.dark-mode .calc-btn:active,
body.dark-mode .calc-btn.utility:active,
body.dark-mode .calc-btn.operator:active {
    background-color: #3a3a5a;
    transform: scale(0.95); /* বাটন চাপার ইফেক্ট */
}
body.dark-mode .calc-btn.equals:active {
    background-color: #4e5d9e;
    transform: scale(0.95);
}
/* --- END: ডার্ক মোডের অ্যানিমেশন কোড --- */

/* --- END: চূড়ান্ত কাস্টম ক্যালকুলেটর স্টাইল --- */
        
        /* --- START: নতুন স্ক্রল কন্টেইনারের জন্য স্টাইল --- */
.customer-list-scroll-container {
    flex-grow: 1; /* বাকি সব জায়গা নিয়ে নেবে */
    overflow-y: auto; /* শুধুমাত্র এই অংশটিই এখন স্ক্রল হবে */
}
/* --- END: নতুন স্টাইল --- */
        
        /* --- START: নতুন স্টিকি হেডার র‍্যাপারের স্টাইল --- */
.sticky-ledger-header {
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 6;
    background-color: #fff; /* এটি পেছনের কনটেন্ট ঢেকে রাখার জন্য জরুরি */
}

body.dark-mode .sticky-ledger-header {
    background-color: #2a2a4a;
}
/* --- END: নতুন স্টাইল --- */
        
        /* --- START: উন্নত লোডার স্টাইল --- */
.loader-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(240, 242, 245, 0.85); /* হালকা ব্যাকগ্রাউন্ড */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
    -webkit-backdrop-filter: blur(5px);
    transition: opacity 0.3s ease;
}
body.dark-mode .loader-overlay {
     background-color: rgba(26, 26, 46, 0.85);
}

.loading-content {
    text-align: center;
}

.loading-text {
    margin-top: 20px;
    font-size: 1.1em;
    font-weight: 500;
    color: var(--primary-color);
    letter-spacing: 0.5px;
}
body.dark-mode .loading-text {
    color: var(--primary-dark-color);
}

.dot-pulse {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 15px;
}
.dot-pulse span {
  width: 15px;
  height: 15px;
  border-radius: 50%;
  background-color: var(--primary-color);
  animation: pulse 1.4s infinite ease-in-out both;
}
body.dark-mode .dot-pulse span {
    background-color: var(--primary-dark-color);
}

.dot-pulse span:nth-child(1) {
  animation-delay: -0.32s;
}
.dot-pulse span:nth-child(2) {
  animation-delay: -0.16s;
}

@keyframes pulse {
  0%, 80%, 100% {
    transform: scale(0.5);
    opacity: 0.5;
  }
  40% {
    transform: scale(1);
    opacity: 1;
  }
}
/* --- END: উন্নত লোডার স্টাইল --- */

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif, 'Noto Sans Bengali', sans-serif;
            margin: 0;
            background-color: #f0f2f5;
            color: #333;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
            padding: 20px 10px;
            box-sizing: border-box;
            font-size: var(--default-font-size); /* Use CSS variable for default */
            transition: background-color 0.3s ease, color 0.3s ease, font-size 0.3s ease;
            padding-bottom: 100px; /* Add padding to prevent overlap with new bottom menu */
            overscroll-behavior-y: none; /* পেজ রিফ্রেশ বা বাউন্স ইফেক্ট বন্ধ করবে */
    touch-action: pan-y;         /* হরিজন্টাল সোয়াইপ ব্রাউজারকে আটকাবে */
        }
        .container {
            max-width: 800px;
            width: 100%;
            background: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            margin-top: 10px;
            box-sizing: border-box;
            position: relative;
            display: flex; /* MODIFIED: For layout fix */
            flex-direction: column; /* MODIFIED: For layout fix */
            flex-grow: 1; /* MODIFIED: For layout fix */
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 25px;
            font-size: 2.0em; /* Font size reduced */
            font-weight: 600;
        }

        /* --- START: View Switcher (Tabs) --- */
        .view-switcher {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
        }
        .view-switcher button {
            flex-grow: 1;
            padding: 12px 15px;
            font-size: 1.0em; /* Font size reduced */
            font-weight: 500;
            border: none;
            background-color: transparent;
            color: #555;
            cursor: pointer;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        .view-switcher button.active {
            background-color: var(--primary-color);
            color: white;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .view-switcher button:not(.active):hover {
            background-color: #e0e0e0;
        }
        body.dark-mode .view-switcher {
            border-color: #555;
            background-color: #2a2a4a;
        }
        body.dark-mode .view-switcher button {
            color: #bbb;
        }
        body.dark-mode .view-switcher button.active {
            background-color: var(--primary-dark-color);
            color: #e0e0e0;
        }
        body.dark-mode .view-switcher button:not(.active):hover {
            background-color: #3a3a5a;
        }
        /* --- END: View Switcher (Tabs) --- */

        /* --- Input and Control Group --- */
        .controls-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px; /* Space between elements */
        }
        .list-selector-group {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-grow: 1;
            min-width: 200px; /* Minimum width for selector group */
        }
        .list-selector-group select {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95em; /* Font size reduced */
            background-color: #f9f9f9;
            flex-grow: 1;
            max-width: 250px;
            min-width: 120px;
            transition: border-color 0.3s ease;
        }
        .list-selector-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.25);
        }
        .list-selector-group button {
            padding: 8px 12px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em; /* Font size reduced */
            transition: background-color 0.3s ease, transform 0.2s ease;
            white-space: nowrap; /* Prevent text wrap */
        }
        .list-selector-group button:hover {
            background-color: #303f9f; /* Darker shade of primary */
            transform: translateY(-1px);
        }
        .list-button-group {
            display: flex;
            gap: 8px;
        }

        /* --- START: New Input Group Layout (Removed Quantity) --- */
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto auto auto; 
            gap: 12px;
            margin-bottom: 25px;
        }
        .input-group .input-item-name-group {
            grid-column: 1 / span 2; /* Full width */
            display: flex;
            gap: 8px;
            position: relative; /* For autocomplete */
        }
        
        /* New price/priority row configuration for desktop */
        #shoppingListSection .input-group #itemPrice {
            grid-column: 1 / 2; /* Left half */
            grid-row: 2; 
        }
        #shoppingListSection .input-group #itemPriority {
            grid-column: 2 / 3; /* Right half */
            grid-row: 2; 
        }
        
        .input-group input[type="text"],
        .input-group input[type="number"],
        .input-group input[type="date"],
        .input-group select {
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95em; /* Font size reduced */
            transition: border-color 0.3s ease;
            box-sizing: border-box;
            width: 100%;
            background-color: #fff; /* Default background for inputs */
        }
        .input-group input:focus,
        .input-group select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.25);
        }
        .input-group button.add-item-btn {
            padding: 12px 18px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color 0.3s ease, transform 0.2s ease;
            box-sizing: border-box;
            grid-column: 1 / span 2; /* Full width button */
            grid-row: 3; /* Placed in the third row, full width */
            width: 100%;
            white-space: nowrap;
        }
        .input-group button.add-item-btn:hover {
            background-color: #303f9f; /* Darker shade of primary */
            transform: translateY(-1px);
        }
        .input-group .voice-input-button {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0; /* Prevent shrinking */
        }
        .input-group .voice-input-button:hover {
            background-color: #218838;
        }
        /* --- END: New Input Group Layout --- */
        
        /* --- START: নতুন এবং উন্নত শিরোনামের স্টাইল --- */
.grand-total-title {
    display: none; /* ডিফল্টভাবে লুকানো থাকবে */
    margin: 0 auto 20px auto;
    padding: 12px 15px;
    font-size: 1.05em;
    font-weight: 500;
    color: #3f51b5; /* --primary-color */
    background: linear-gradient(135deg, #f5f7fa 0%, #e8eaf6 100%);
    border: none;
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(63, 81, 181, 0.15);
    letter-spacing: 0.5px;
    
    /* আইকন এবং টেক্সট সেন্টারে আনার জন্য */
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px; /* আইকন এবং লেখার মধ্যে স্পেস */
}

body.dark-mode .grand-total-title {
    color: #c5cae9;
    background: linear-gradient(135deg, #3a3a5a 0%, #2a2a4a 100%);
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}
/* --- END: নতুন শিরোনামের স্টাইল --- */

        /* --- START: Ledger NEW Styles (IMAGE-BASED REDESIGN) --- */
        .ledger-main-view, .ledger-customer-view, #receivableListView, #payableListView { display: none; }
        .ledger-main-view.active, .ledger-customer-view.active, #receivableListView.active, #payableListView.active { display: block; }
        
        .ledger-summary-top {
    display: flex;
    justify-content: space-around;
    text-align: center;
    padding: 15px 0 10px 0;
    padding-bottom: 40px; /* <-- এই লাইনটি যোগ করুন */
    margin-bottom: 0;
    border-radius: 0;
    background-color: transparent;
}
        .ledger-summary-top .summary-box {
            flex: 1;
            position: relative;
        }
        /* Vertical Separator */
        .ledger-summary-top .summary-box:first-child::after {
            content: '';
            position: absolute;
            right: 0;
            top: 10%;
            bottom: 10%;
            width: 1px;
            background-color: #e0e0e0;
        }
        .ledger-summary-top .summary-box .amount {
            font-size: 1.6em; /* MODIFIED: Font size reduced */
            font-weight: bold;
            display: block;
            word-break: break-all;
            white-space: normal;
            line-height: 1.2;
        }
        .ledger-summary-top .summary-box .label {
            font-size: 0.9em;
            color: #333; /* CHANGED: Make label black in light mode */
        }
        /* Colors as per image - USER MODIFIED */
        #ledger-total-receivable { color: var(--expense-color); } /* মোট পাবো - Red */
        #ledger-total-payable { color: var(--income-color); } /* মোট দেবো - Green */
        
        .ledger-controls-main {
            margin-bottom: 20px;
        }
        #ledgerMainView .ledger-controls-main {
    z-index: 5;
    background-color: transparent;
    padding: 10px 0;
    
    /* --- START: পরিবর্তন এখানে করা হয়েছে --- */
    border-bottom: 1px solid rgba(255, 255, 255, 0.05); /* বর্ডারটিকে প্রায় অদৃশ্য করে দেওয়া হয়েছে */
    /* --- END: পরিবর্তন শেষ --- */
}
        body.dark-mode #ledgerMainView .ledger-controls-main {
    background: transparent; /* এটি transparent থাকবে কারণ প্যারেন্ট ডিভের ব্যাকগ্রাউন্ড ব্যবহৃত হচ্ছে */
    border-bottom-color: rgba(255, 255, 255, 0.08); /* নতুন লাইনটি এখানে যোগ করা হয়েছে */
}

        /* Hide extra buttons to match image */
        .ledger-controls-main .icon-button {
            display: none;
        }

        .customer-list-item {
            display: flex;
            align-items: flex-start;
            padding: 10px 5px;
            margin-bottom: 10px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        .customer-list-item:hover { background-color: #f8f9fa; }
        
        .customer-initial-circle {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-right: 15px;
            flex-shrink: 0;
        }
        .customer-info { flex-grow: 1; }
        .customer-info .name {
            font-weight: 500; /* Medium weight */
            font-size: 1.0em; /* MODIFIED: Font size reduced */
            color: #333;
            margin-bottom: 2px;
        }
        .customer-info .last-updated {
            font-size: 0.85em;
            color: #888;
        }
        .customer-balance {
            font-size: 1.0em; /* MODIFIED: Font size reduced */
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: flex-end; /* Added for better right alignment */
            gap: 8px;
            /* flex-shrink: 0; <-- This was causing the overflow. Removing it allows the element to shrink. */
            color: #333;
            text-align: right;
            margin-left: auto;
            word-break: break-all; /* This will now work as intended */
            white-space: normal;
            line-height: 1.2;
        }
        /* Balances to receive are red, to give are green - USER MODIFIED */
        .customer-balance.positive { color: var(--expense-color); }
        .customer-balance.negative { color: var(--income-color); }

        .customer-balance .fa-chevron-right {
            color: #ccc;
            font-size: 0.9em;
            flex-shrink: 0; /* Prevent the icon from shrinking */
        }
        
        /* --- FIXED: Clean & Modern FAB Button (No Ring) --- */
.fab-add-customer {
    position: fixed;
    bottom: 90px; 
    right: 25px; 
    width: 55px; 
    height: 55px; 
    
    background-color: var(--primary-color); 
    color: white;
    border-radius: 50%;
    
    /* ✅ পরিবর্তন: বর্ডার বা রিং সম্পূর্ণ বাদ দেওয়া হলো */
    border: none;
    
    /* ✅ পরিবর্তন: সূক্ষ্ম কিন্তু দৃশ্যমান শ্যাডো */
    box-shadow: 0 4px 10px rgba(63, 81, 181, 0.4); 
    
    font-size: 1.6em; 
    
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.2s ease;
    z-index: 999;
}
.fab-add-customer:hover { 
    background-color: #303f9f; 
    box-shadow: 0 6px 15px rgba(63, 81, 181, 0.5); 
    transform: scale(1.05);
}

/* ডার্ক মোড FAB */
body.dark-mode .fab-add-customer {
    border: none;
    background-color: var(--primary-dark-color);
}
body.dark-mode .fab-add-customer:hover { 
    background-color: #4e5d9e;
}

        /* Customer Detail View (MODIFIED) */
        .ledger-customer-view .customer-view-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            margin-bottom: 0; /* Margin moved to subheader */
        }
        .ledger-customer-view .back-button {
            font-size: 1.4em; cursor: pointer; color: #555; background: none; border: none; padding: 5px 10px;
        }
        .ledger-customer-view .customer-header-info { text-align: left; flex-grow: 1; padding-left: 0; }
        .ledger-customer-view .customer-header-info .name { font-size: 1.3em; font-weight: bold; } /* MODIFIED: Font size reduced */
        .ledger-customer-view .customer-header-info .phone { font-size: 0.9em; margin-top: 2px; }
        .ledger-customer-view .customer-header-info .phone a:hover { color: var(--primary-color); }

        
        .ledger-customer-view .customer-view-subheader {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 0 15px 0;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .ledger-customer-view .customer-view-subheader .balance { 
            font-size: 1.1em; /* MODIFIED: Font size reduced */
            font-weight: 500;
        }
        /* START: USER REQUESTED CHANGE for 'Pabo'/'Debo' color */
        .balance-label {
            color: inherit; /* Inherits black/white from parent */
            font-weight: 500;
        }
        .balance.positive .balance-amount { color: var(--expense-color); }
        .balance.negative .balance-amount { color: var(--income-color); }
        body.dark-mode .balance.positive .balance-amount { color: var(--expense-color-dark); }
        body.dark-mode .balance.negative .balance-amount { color: var(--income-color-dark); }
        /* END: USER REQUESTED CHANGE */

        .ledger-customer-view .customer-view-subheader .last-updated {
            font-size: 0.9em;
            color: #777;
        }
        body.dark-mode .ledger-customer-view .customer-view-subheader { border-bottom-color: #444; }
        body.dark-mode .ledger-customer-view .customer-view-subheader .last-updated { color: #aaa; }


        .ledger-customer-view .header-actions {
            position: relative;
        }
        .ledger-customer-view .header-actions .icon-button {
            font-size: 1.1em; color: #555; background: none; border: none; padding: 5px; margin-left: 10px; cursor: pointer;
        }

        /* --- START: NEW Transaction Form Styles (MODIFIED FOR LAYOUT) --- */
        #ledgerCustomerView {
            display: none; /* Hide by default, shown by JS */
            flex-direction: column;
            flex-grow: 1; /* MODIFIED: For layout fix */
        }
        .customer-transaction-form-wrapper {
            flex-grow: 1; /* This will take up all available space */
            overflow-y: auto; /* Make the form scrollable if content overflows */
        }
        .customer-transaction-form {
            background-color: #fff; padding: 0; border-radius: 8px; margin-bottom: 15px;
        }
        .customer-transaction-form .amount-inputs { display: flex; gap: 15px; margin-bottom: 15px; }
        .customer-transaction-form .amount-inputs .input-wrapper {
            flex: 1;
            position: relative;
        }
        .customer-transaction-form .amount-inputs .input-wrapper::before {
            content: '৳';
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
            font-size: 1.2em;
        }

        .customer-transaction-form .amount-inputs input {
            width: 100%;
            padding: 15px 15px 15px 40px;
            font-size: 1.1em;
            text-align: left;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
        }
        .customer-transaction-form .description-input {
            position: relative;
        }
        .customer-transaction-form .description-input::before {
            font-family: "Font Awesome 5 Free";
            content: '\f044'; /* fa-edit */
            font-weight: 900;
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #888;
        }
        .customer-transaction-form .description-input input {
            width: 100%; padding: 15px 15px 15px 45px; font-size: 1em; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 15px; box-sizing: border-box;
        }
        .customer-transaction-form .utility-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
        }
        .customer-transaction-form .utility-buttons .utility-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #ccc;
            background-color: #f8f9fa;
            cursor: pointer;
            text-align: center;
            font-size: 1em;
        }
        .customer-transaction-form .utility-buttons .utility-btn .fas {
            margin-right: 8px;
        }
        
        /* START: Accessible hiding for date input */
        .customer-transaction-form .utility-buttons input[type="date"] {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }
        /* END: Accessible hiding for date input */

        .confirm-button-wrapper {
            padding-top: 10px;
            margin-top: auto; /* MODIFIED: For layout fix */
            flex-shrink: 0; /* ADDED: Prevent this from shrinking */
        }
        #confirmTransactionBtn {
            width: 100%; 
            padding: 14px 18px; 
            font-size: 1.1em; 
            font-weight: bold; 
            color: white; 
            border: none; 
            border-radius: 12px; 
            cursor: pointer; 
            transition: background-color: 0.3s ease, opacity: 0.3s ease;
        }
        #confirmTransactionBtn.disabled {
            background-color: var(--disabled-color);
            color: var(--disabled-text-color);
            cursor: not-allowed;
            border: 1px solid #e0e0e0;
        }
        body.dark-mode #confirmTransactionBtn.disabled {
             border: 1px solid #444;
        }
        #confirmTransactionBtn:not(.disabled) {
            background-color: var(--primary-color);
        }
        /* --- END: Transaction Form Styles Modification --- */
        
        /* --- START: NEW Transaction History Table Styles --- */
        .customer-transaction-table {
            width: 100%;
        }
        .tx-table-header, .tx-table-row {
            display: flex;
            border-bottom: 1px solid #eee;
            flex-wrap: nowrap;
        }
        .tx-table-footer {
            display: flex;
            flex-wrap: nowrap;
            border-top: 1px solid #333; /* Modified */
        }
        body.dark-mode .tx-table-footer {
            border-top: 1px solid #555; /* Modified */
        }

        .tx-table-header {
            background-color: #f8f9fa;
            font-weight: 500;
            color: #555;
        }
        .tx-table-header .tx-col {
            padding: 12px 10px;
        }
        .tx-table-row {
            cursor: pointer;
            transition: background-color: 0.2s;
        }
        .tx-table-row:hover {
            background-color: #f8f9fa;
        }
        .tx-col {
            box-sizing: border-box;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis; 
            word-break: break-word; 
            flex-grow: 0;
            flex-shrink: 0;
        }
        .tx-table-row .tx-col,
        .tx-table-footer .tx-col {
            padding-top: 15px;
            padding-bottom: 15px;
        }
        .tx-col:not(:last-child)::after {
            content: '';
            position: absolute;
            right: 0;
            top: 10%;
            bottom: 10%;
            width: 1px;
            background-color: #eee;
        }
        
        /* This rule was previously hiding the separators. It is being kept for non-report pages. */
        #ledgerCustomerView .tx-table-row .tx-col-details::after,
        #ledgerCustomerView .tx-table-header .tx-col-details::after,
        #ledgerCustomerView .tx-table-footer .tx-col-details::after {
            display: none;
        }
        #ledgerCustomerView .tx-table-row .tx-col-gave::after,
        #ledgerCustomerView .tx-table-header .tx-col-gave::after,
        #ledgerCustomerView .tx-table-footer .tx-col-gave::after {
            display: none;
        }

        .tx-col-details {
            flex-basis: 40%; 
            padding-left: 10px;
            padding-right: 10px;
            font-size: 0.9em;
            flex-grow: 0;
            flex-shrink: 0;
            min-width: 0;
        }
        .tx-col-gave, .tx-col-received {
            flex-basis: 30%;
            font-size: 1.0em;
            font-weight: 500;
            padding-left: 10px;
            padding-right: 10px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .tx-col-gave { 
            color: var(--expense-color); 
            background-color: var(--light-expense-bg-color);
        }
        .tx-col-received { color: var(--income-color); }
        
        body.dark-mode .tx-col-gave {
            color: var(--expense-color-dark);
            background-color: transparent; /* MODIFIED: User Request */
        }
        body.dark-mode .tx-col-received {
            color: var(--income-color-dark);
        }

        .tx-table-row .tx-col-gave,
        .tx-table-row .tx-col-received,
        .tx-table-footer .tx-col-gave,
        .tx-table-footer .tx-col-received {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }


        .tx-table-header .tx-col-details,
        .tx-table-footer .tx-col-details {
            text-align: left;
        }

        .tx-table-header .tx-col-gave, 
        .tx-table-header .tx-col-received {
            text-align: center;
            color: #555;
        }
        body.dark-mode .tx-table-header .tx-col-gave,
        body.dark-mode .tx-table-header .tx-col-received {
            color: #f0f0f0;
        }
        
        .tx-col-details .tx-date {
            font-size: 1.1em;
            font-weight: 500;
            margin-bottom: 0px; 
            line-height: 1.2;
        }
        .tx-col-details .tx-date-year { 
            font-size: 1.1em;
            font-weight: 500;
            color: #555;
            margin-bottom: 2px;
            display: block;
        }
        body.dark-mode .tx-col-details .tx-date-year {
            color: #aaa;
        }
        .tx-col-details .tx-time {
            color: #777;
            margin-bottom: 5px;
            display: block;
            font-size: 0.8em;
        }
        body.dark-mode .tx-col-details .tx-time {
            color: #999;
        }

        .tx-description-label { 
            font-size: 0.85em;
            font-weight: 500;
            color: #555;
            margin-top: 5px;
            margin-bottom: 2px;
            display: block;
        }
        body.dark-mode .tx-description-label {
            color: #bbb;
        }
        .tx-description-text { 
            font-size: 0.8em;
            color: #666;
            word-break: break-word; 
            white-space: pre-wrap;
            display: block;
            line-height: 1.4;
        }
        body.dark-mode .tx-description-text {
            color: #ccc;
        }

        .running-balance-chip {
            margin-top: 10px;
            display: inline-block;
            padding: 3px 8px;
            font-size: 0.8em;
            border-radius: 12px;
            background-color: #f0f2f5;
            color: #555;
            font-weight: 500;
        }
        body.dark-mode .running-balance-chip {
            background-color: #3a3a5a;
            color: #bbb;
        }
        /* --- END: NEW Transaction History Table Styles --- */
        
        /* USER REQUEST: Sticky Header and Row Borders for Report Page */
        #customerReportPageContent .tx-table-header {
            position: -webkit-sticky; /* For Safari */
            position: sticky;
            top: 0;
            z-index: 5;
        }
        #customerReportPage .tx-table-row {
            border-bottom: 1px solid #e0e0e0;
        }
        /* START: USER REQUESTED CHANGE - Remove last row border */
        #customerReportPageContent .tx-table-row:last-of-type {
            border-bottom: none;
        }
        /* END: USER REQUESTED CHANGE */

        body.dark-mode #customerReportPageContent .tx-table-header {
    background-color: #2a2a4a;
    color: #f0f0f0;
    border-bottom: 1px solid #444; /* নতুন এই লাইনটি যোগ করুন */
}
        body.dark-mode #customerReportPage .tx-table-row {
            border-bottom-color: #444;
        }
        
        body.dark-mode #customerReportPage .tx-table-row:hover {
            background-color: #3a3a5a;
        }
        
        /* Dark Mode for New Ledger Design */
        body.dark-mode .ledger-summary-top { background-color: #2a2a4a; }
        body.dark-mode .ledger-summary-top .summary-box:first-child::after { background-color: #444; }
        body.dark-mode .ledger-summary-top .label { color: #bbb; }
        body.dark-mode .customer-list-item:hover { background-color: #3a3a5a; }
        body.dark-mode .customer-info .name { color: #e0e0e0; }
        body.dark-mode .customer-info .last-updated { color: #999; }
        body.dark-mode .customer-balance { color: #e0e0e0; }

        body.dark-mode .customer-balance.positive { color: var(--expense-color-dark); }
        body.dark-mode .customer-balance.negative { color: var(--income-color-dark); }
        body.dark-mode .customer-balance .fa-chevron-right { color: #555; }
        
        body.dark-mode .ledger-customer-view .back-button,
        body.dark-mode .ledger-customer-view .header-actions .icon-button { color: #bbb; }
        body.dark-mode .ledger-customer-view .customer-header-info .phone a { color: #bbb; }
        
        body.dark-mode .customer-transaction-form { background-color: transparent; }
        body.dark-mode .customer-transaction-form input { background-color: #3a3a5a; border-color: #555; color: #e0e0e0; }
        body.dark-mode .customer-transaction-form .amount-inputs .input-wrapper::before,
        body.dark-mode .customer-transaction-form .description-input::before { color: #aaa; }
        body.dark-mode .customer-transaction-form .utility-buttons .utility-btn { background-color: #3a3a5a; border-color: #555; color: #bbb; }

        body.dark-mode #confirmTransactionBtn:not(.disabled) { background-color: var(--primary-dark-color); }
        /* --- END: Ledger NEW Styles --- */
        
        /* Autocomplete styles */
        .autocomplete-suggestions {
            position: absolute;
            top: 100%; /* Below the input */
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            z-index: 10;
            max-height: 200px;
            overflow-y: auto;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .autocomplete-suggestions div {
            padding: 10px 12px;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 1px solid #eee;
        }
        .autocomplete-suggestions div:last-child {
            border-bottom: none;
        }
        .autocomplete-suggestions div:hover {
            background-color: #f0f0f0;
        }
        .autocomplete-suggestions div.selected {
            background-color: #e0e0e0;
        }
        
        /* START: Shopping List Layout Fix */
        #shoppingListSection, #ledgerSection {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            }
        #shoppingList, #customerList {
            flex-grow: 1;
            overflow-y: auto;
padding-bottom: 80px; /* Make the list itself scrollable */
        }
        /* END: Shopping List Layout Fix */
        
        /* --- START: New Item Display Styles (FINAL & STANDARD VERSION) --- */

.list-item {
    display: flex;
    flex-direction: column;
    /* ✅ এটাই স্ট্যান্ডার্ড সাইজ (৮ পিক্সেল) */
    padding: 8px 12px; 
    margin-bottom: 7px;
    border: 1px solid #f0f0f0;
    border-radius: 8px;
    background-color: #ffffff;
    transition: all 0.2s ease;
    position: relative; 
    overflow: hidden; 
    cursor: pointer; 
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    padding-left: 12px; 
    min-height: auto;
    justify-content: center;
}

.list-item:active {
    cursor: grabbing;
}

.list-item.dragging {
    opacity: 0.5;
    border: 2px dashed var(--primary-color);
    background-color: #e6f2ff;
}

/* কেনা (Bought) হলে স্টাইল */
.list-item.bought {
    background-color: #f9f9fa;
    border-color: #e8e8e8;
    box-shadow: none;
}

.list-item.bought .item-name-compact {
    text-decoration: line-through;
    color: #999; 
    font-weight: 500 !important; 
}
.list-item.bought .item-total-price-compact {
    color: #999 !important;
}

.list-item:last-child {
    margin-bottom: 0;
}

/* Priority indicator */
.item-priority-indicator {
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    width: 4px; 
    border-radius: 8px 0 0 8px; 
}
.priority-high { background-color: var(--expense-color); } 
.priority-medium { background-color: #ffc107; } 
.priority-low { background-color: var(--primary-color); } 

/* The main row */
.item-compact-row { 
    display: flex;
    align-items: center;
    width: 100%;
}

/* Checkbox */
.item-compact-row .toggle-bought-btn {
    flex-shrink: 0;
    font-size: 1.15em;
    margin-right: 10px; 
    color: #b0b0b0; 
    background: none;
    border: none;
    padding: 0; 
    cursor: pointer;
    display: flex;
    align-items: center;
}

.list-item.bought .item-compact-row .toggle-bought-btn {
    color: var(--income-color); 
}

/* Item Name */
.item-name-compact {
    font-size: 0.95em; 
    color: #333;
    font-weight: 600; 
    flex-grow: 1;
    margin-right: 10px;
    word-break: break-word;
    line-height: 1.35; 
}

/* Item Total Price */
.item-total-price-compact {
    font-weight: 700; 
    color: var(--primary-color); 
    font-size: 0.95em; 
    white-space: nowrap;
    flex-shrink: 0;
}

/* --- Expanded Details Row --- */
.item-expanded-details { 
    display: none;
    width: 100%;
    padding-top: 6px;
    margin-top: 6px; 
    border-top: 1px dashed #f0f0f0; 
    justify-content: space-between;
    align-items: center;
}

.list-item.expanded {
    padding-bottom: 8px; 
}

.list-item.expanded .item-expanded-details {
    display: flex; 
}

/* Time and Date */
.item-time-date {
    font-size: 0.8em; 
    color: #777;
    flex-grow: 1;
    display: flex;
    align-items: center;
}
.item-time-date i {
    margin-right: 5px;
    color: #999;
    font-size: 0.9em;
}

/* Actions Buttons */
.item-actions-expanded {
    display: flex;
    gap: 8px; 
    flex-shrink: 0;
}
.item-actions-expanded button {
    background: #f2f4f8; 
    border: none;
    cursor: pointer;
    font-size: 0.85em; 
    padding: 4px 10px;
    border-radius: 5px; 
    transition: background 0.2s;
}

/* --- Dark Mode Overrides --- */
body.dark-mode .list-item {
    background-color: #2a2a4a;
    border-color: #444;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
}
body.dark-mode .list-item.bought {
    background-color: #33335a;
    border-color: #555;
    box-shadow: none;
}
body.dark-mode .item-name-compact {
    color: #e0e0e0;
}
body.dark-mode .item-total-price-compact {
    color: var(--primary-dark-color) !important;
}
body.dark-mode .list-item.bought .item-name-compact,
body.dark-mode .list-item.bought .item-total-price-compact {
    color: #888 !important;
}
body.dark-mode .item-expanded-details {
    border-top-color: #444;
}
body.dark-mode .item-actions-expanded button {
    background: #3a3a5a;
    color: #bbb;
}
body.dark-mode .item-actions-expanded button:hover {
    background: #4a4a6a;
    color: #fff;
}

/* Hide old elements just in case */
.list-item .item-main-details,
.list-item .item-sub-details-and-actions,
.list-item .item-price-details,
.list-item .item-quantity,
.list-item .item-actions {
    display: none; 
}

/* --- END: New Item Display Styles --- */

        /* --- START: User Requested Change for Action Buttons --- */
        .action-buttons {
            display: none; /* Replaced by bottom navigation menu */
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
            flex-wrap: wrap;
        }
        /* --- END: User Requested Change for Action Buttons --- */
        
        /* START: Tooltip for Backup Button */
        .tooltip-container {
            position: relative;
            display: inline-flex;
            align-items: center;
            gap: 2px; /* Small gap between button and icon */
        }
        .info-icon {
            font-size: 0.7em;
            color: #6c757d;
            cursor: help;
            border: 1px solid #ccc;
            border-radius: 50%;
            width: 15px;
            height: 15px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-left: -5px; /* Slightly overlap the button */
            background-color: #fff;
            transform: translateY(-12px);
        }
        .tooltip-text {
            visibility: hidden;
            width: 220px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 8px;
            position: absolute;
            z-index: 1;
            bottom: 125%; /* Position above the icon */
            left: 50%;
            margin-left: -110px; /* Use half of the width to center */
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85em;
            font-weight: normal;
        }
        .tooltip-text::after { /* Tooltip arrow */
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #333 transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        /* END: Tooltip for Backup Button */


        /* --- New Header Controls --- */
        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
            height: 30px; /* Give it a fixed height to contain the elements */
        }
        .header-controls .info-button,
        .header-controls .dark-mode-toggle,
        .header-controls .profile-button {
            font-size: 22px;
            cursor: pointer;
            color: #555;
            transition: color 0.3s ease;
            background: none;
            border: none;
            padding: 0;
        }
        .header-controls .info-button:hover,
        .header-controls .dark-mode-toggle:hover,
        .header-controls .profile-button:hover {
            color: var(--primary-color);
        }
        
        /* NEW: Profile Menu */
        #profileMenu {
    display: none;
    position: absolute;
    top: 100%;
    right: 0;
    background-color: #fff;
    border-radius: 12px; /* একটু সুন্দর করার জন্য রাউন্ড বাড়াতে পারেন */
    box-shadow: 0 5px 25px rgba(0, 0, 0, 0.2);
    z-index: 1010;
    overflow: hidden;
    
    /* ✅ পরিবর্তন: প্রস্থ বাড়ানো হয়েছে এবং সর্বোচ্চ প্রস্থ সেট করা হয়েছে */
    width: 260px; 
    max-width: 90vw; /* মোবাইলের স্ক্রিনের বাইরে যেন না যায় */
    
    border: 1px solid #eee;
}
        /* NEW: Profile Menu User Name */
        .profile-user-name {
    padding: 15px;
    font-weight: bold;
    color: #333;
    border-bottom: 1px solid #eee;
    text-align: center;
    font-size: 0.95em;
    
    /* ✅ পরিবর্তন: ইমেইল বড় হলে তা অটোমেটিক নিচে লাইনে চলে আসবে */
    word-wrap: break-word; 
    overflow-wrap: break-word;
    white-space: normal; 
    line-height: 1.4; /* লাইনের মাঝখানের ফাঁকা ঠিক রাখা */
}
        body.dark-mode .profile-user-name {
            color: #e0e0e0;
            border-bottom-color: #555;
        }
        #profileMenu button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            color: #333;
            transition: background-color: 0.2s;
        }
        #profileMenu button:hover {
            background-color: #f5f5f5;
        }
        #profileMenu button i {
            margin-right: 12px;
            width: 20px;
            text-align: center;
            color: #555;
        }
        body.dark-mode #profileMenu {
            background-color: #3a3a5a;
            border-color: #555;
        }
        body.dark-mode #profileMenu button {
            color: #e0e0e0;
        }
        body.dark-mode #profileMenu button:hover {
            background-color: #4a4a6a;
        }
        body.dark-mode #profileMenu button i {
            color: #bbb;
        }
        /* END: Profile Menu */

        /* Font Size Controls */
        .font-size-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }
        .font-size-controls button {
            background: none;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 4px 8px;
            font-size: 1em;
            cursor: pointer;
            color: #555;
            transition: all 0.2s ease;
        }
        .font-size-controls button:hover {
            background-color: #f0f0f0;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }
        .font-size-controls button:active {
            transform: translateY(1px);
        }
        .font-size-controls button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        .font-size-controls button.active:hover {
             background-color: #303f9f;
             border-color: #303f9f;
             color: white;
        }

        /* Modal Styles (General for Info, Share, Report) */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            /* z-index: 100; <-- Removed for JS control */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            overflow-y: auto;
            padding: 15px;
            box-sizing: border-box;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
            font-family: 'Noto Sans Bengali', sans-serif;
            color: #333;
            max-height: 90vh;
            overflow-y: auto;
            box-sizing: border-box;
        }
        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }
        .modal-content h2 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.8em; /* Font size reduced */
            text-align: center;
            margin-bottom: 20px;
        }
        .modal-content p {
            margin-bottom: 15px;
            line-height: 1.6;
            font-size: 1.0em; /* Font size reduced */
        }
        .modal-content ul {
            list-style: none;
            margin-bottom: 15px;
            padding-left: 3px;
        }
        .modal-content ul li {
            margin-bottom: 15px;
            line-height: 1.5;
        }
        .modal-close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }
        .modal-close-button:hover {
            color: #333;
        }
        /* START: Info Modal Enhancements */
        #infoModalOverlay .fab-highlight {
            display: inline-flex;
            justify-content: center;
            align-items: center;
            background-color: var(--fab-color);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            font-size: 0.8em;
            vertical-align: middle;
        }
        #infoModalOverlay .confirm-btn-highlight {
            background-color: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        #infoModalOverlay .modal-content ul ul {
            margin-top: 10px;
            padding-left: 20px;
            list-style-type: circle;
        }
        #infoModalOverlay .modal-content ul ul li {
            margin-bottom: 8px;
        }
        /* END: Info Modal Enhancements */

        /* Specific styles for Share Modal */
        #shareModalContent pre {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap; /* Allow wrapping */
            word-wrap: break-word; /* Ensure long words break */
            font-family: 'Noto Sans Bengali', monospace;
            font-size: 0.9em; /* Font size reduced */
            max-height: 300px; /* Limit height */
            overflow-y: auto;
            margin-bottom: 15px;
            text-align: left; /* Ensure text aligns left inside pre */
            font-weight: normal; /* USER CHANGE: Ensure text is not bold */
        }
        #shareModalContent .share-buttons-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        #shareModalContent .share-buttons-group button {
            flex-grow: 1; /* Make buttons take equal space */
            padding: 10px 15px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color: 0.3s ease;
            border: none;
            color: white;
        }
        #shareModalContent .copy-button {
            background-color: var(--primary-color);
        }
        #shareModalContent .copy-button:hover {
            background-color: #303f9f;
        }
        #shareModalContent .share-platform-button { /* For the new 'Share' button */
            background-color: #17a2b8; /* A different color for distinct action */
        }
        #shareModalContent .share-platform-button:hover {
            background-color: #138496;
        }

        /* --- START: Report Page & Customer Report Page Styles --- */
        #reportPage {
            display: none;
            flex-direction: column;
            max-width: 800px;
            width: 100%;
            background: #fff;
            padding: 0;
            border-radius: 0;
            box-shadow: none;
            margin-top: 10px;
            box-sizing: border-box;
            position: relative;
        }

        #customerReportPage {
            display: none;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 998;
        }
        
        body.dark-mode #reportPage,
        body.dark-mode #customerReportPage {
            background: #1a1a2e;
        }
        .report-page-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0;
            position: sticky;
            top: 0;
            background-color: #fff;
            padding: 15px 25px;
            z-index: 20;
            border-bottom: 1px solid #eee;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            flex-shrink: 0;
        }
        body.dark-mode .report-page-header {
            background-color: #2a2a4a;
            border-bottom-color: #444;
        }
        .report-page-header h2 {
            margin: 0;
            flex-grow: 1;
            text-align: center;
            font-size: 1.6em;
            color: #2c3e50;
        }
        body.dark-mode .report-page-header h2 {
            color: #e0e0e0;
        }
        .report-page-header .back-button {
            font-size: 1.4em;
            cursor: pointer;
            color: #555;
            background: none;
            border: none;
            padding: 5px 10px;
            flex-shrink: 0;
            margin-right: 10px;
        }
        .report-page-header .report-page-actions {
            display: flex;
            gap: 15px;
        }
        .report-page-header .report-page-actions button {
            background: none;
            border: none;
            font-size: 1.2em;
            color: #555;
            cursor: pointer;
            padding: 5px 8px;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: inline-flex;
            justify-content: center;
            align-items: center;
        }
        .report-page-header .report-page-actions button#customerReportShareBtn {
            color: white; background-color: #17a2b8;
        }
        .report-page-header .report-page-actions button#customerReportCopyBtn {
            color: white; background-color: var(--primary-color);
        }
        .report-page-header .report-page-actions button#customerReportPdfBtn {
            color: white; background-color: var(--expense-color);
        }
        body.dark-mode .report-page-header .back-button {
            color: #bbb;
        }
        body.dark-mode .report-page-header .report-page-actions button {
            color: #bbb;
        }
        body.dark-mode .report-page-header .report-page-actions button#customerReportShareBtn {
            background-color: #4a90a0;
        }
        body.dark-mode .report-page-header .report-page-actions button#customerReportCopyBtn {
            background-color: var(--primary-dark-color);
        }
        body.dark-mode .report-page-header .report-page-actions button#customerReportPdfBtn {
            background-color: var(--expense-color-dark);
        }

        .report-page-content {
            padding: 25px;
            overflow-y: auto;
        }

        #customerReportPageContent {
            flex: 1 1 auto;
            overflow-y: auto;
            padding: 0;
            scrollbar-gutter: stable; /* CHANGED: Fix for footer alignment */
        }
        
        #customerReportPageFooterContainer {
             flex-shrink: 0;
             background-color: #fff; /* CHANGED: To match content area */
             padding: 0;
        }
        body.dark-mode #customerReportPageFooterContainer {
             background-color: transparent; /* CHANGED: To match content area */
        }
        #customerReportPageFooterContainer .tx-table-footer {
            border-top: 1px solid #ccc;
            border-bottom: 1px solid #ccc; /* ADDED BORDER */
        }
        body.dark-mode #customerReportPageFooterContainer .tx-table-footer {
    border-top: 1px solid #444; /* এটি ফুটারের উপরের সাদা বর্ডার ঠিক করবে */
    border-bottom: 1px solid #444;
    color: #e0e0e0;
}

        #customerReportPage .tx-table-header,
        #customerReportPage .tx-table-row,
        #customerReportPage .tx-table-footer {
            padding-left: 25px;
            padding-right: 25px;
            box-sizing: border-box;
        }


        #reportPage h3 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 10px;
            font-size: 1.4em;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            text-align: left;
        }
        .report-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .report-summary-block {
            /* নতুন: Report-summary-item-কে ঠিকমতো ফ্লো করার জন্য */
            display: flex;
            flex-direction: column;
        }
        #reportPage .report-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 1.0em;
        }
        #reportPage .report-summary-item strong {
            color: var(--primary-color);
        }
        #reportPage .report-list ul {
            list-style: none;
            padding-left: 0;
        }
        #reportPage .report-list ul li {
            background-color: #fcfcfc;
            border: 1px solid #eee;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 5px;
            font-size: 0.9em;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            overflow: hidden;
        }
        #reportPage .report-list ul li span {
            flex-basis: 70%;
            flex-grow: 0;
            flex-shrink: 1;
            word-break: break-word;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: normal;
            text-align: left;
            padding-right: 5px;
        }
        #reportPage .report-list ul li .report-amount {
            font-weight: bold;
            color: var(--income-color);
            flex-basis: 25%;
            flex-grow: 0;
            flex-shrink: 0;
            text-align: right;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #reportPage .report-no-data {
            text-align: center;
            color: #777;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
            margin-top: 10px;
        }

        #reportListFilterGroup, #reportPriorityFilterGroup {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            margin-bottom: 15px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
            justify-content: center;
        }
        #reportListFilter, #reportPriorityFilter {
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.9em;
            background-color: #f9f9f9;
            flex-grow: 1;
            min-width: 120px;
        }
        
        .date-filter-results-container {
            display: none;
            margin-top: 15px;
            text-align: center;
        }
        .date-filter-display {
            font-weight: 500;
        }
        .date-filter-total {
            width: 100%;
            margin-bottom: 10px;
        }
        #dateFilterTotalAmount {
            font-weight: bold !important;
        }
        .date-filter-range {
            font-weight: normal;
            color: #555;
            line-height: 1.5;
            width: 100%;
            margin-bottom: 15px;
        }
        .date-filter-sub-totals {
            margin-top: 10px;
            width: 100%;
            font-size: 1.0em;
            line-height: 1.4;
        }
        .date-filter-sub-totals div {
            margin-bottom: 5px;
        }
        .date-filter-sub-totals strong {
            color: var(--primary-color);
            font-weight: bold;
            display: block;
            margin-top: 2px;
        }
        /* --- END: Report Page Styles --- */

        /* START: Scrollable Report List Styles */
        .report-list.scrollable {
            max-height: 450px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 15px;
            background-color: #fdfdfd;
            position: relative; /* ভেতরের sticky পজিশনের জন্য প্রয়োজন */
            /* নিচের প্যাডিং সরানো হয়েছে, কারণ ফুটারেই সব থাকবে */
            padding-bottom: 0; 
        }

        .report-list.scrollable-large {
            max-height: 460px;
        }
        /* END: Scrollable Report List Styles */
        
        /* START: Report sticky footer for scrollable list (USER REQUESTED ADDITION) */
        .sticky-total-wrapper {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #fdfdfd; /* List background color */
            border-top: 1px solid #e0e0e0;
            padding: 10px;
            box-sizing: border-box;
            z-index: 10;
            border-radius: 0 0 8px 8px; /* নিচের দিকে রাউন্ডেড কর্নার ঠিক করা */
            font-weight: bold;
            font-size: 1.1em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* Dark Mode Fix */
        body.dark-mode .sticky-total-wrapper {
            background-color: #2a2a4a;
            border-top-color: #555;
        }
        /* END: Report sticky footer for scrollable list */
        
        /* --- START: তারিখ ফিল্টার স্টাইল (স্ক্রিনশট অনুযায়ী) --- */
        #reportDateFilterGroup {
            display: flex;
            flex-wrap: wrap;
            align-items: flex-end;
            gap: 10px;
        }

        #reportDateFilterGroup .date-filter-input-container {
            flex: 1;
            min-width: 150px;
        }

        #reportDateFilterGroup label {
            display: block;
            text-align: left;
            font-weight: 500;
            margin-bottom: 5px;
            font-size: 0.9em;
            color: #333;
        }

        #reportDateFilterGroup input[type="date"] {
            width: 100%;
            box-sizing: border-box; 
            padding: 8px 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 0.95em;
        }

        #reportDateFilterGroup button {
            padding: 9px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.95em;
            flex-shrink: 0;
            transition: background-color: 0.3s ease;
        }
        #reportDateFilterGroup button:hover {
            background-color: #303f9f;
        }

        /* ডার্ক মোডের জন্য স্টাইল */
        body.dark-mode #reportDateFilterGroup label {
            color: #bbb;
        }
        body.dark-mode #reportDateFilterGroup input[type="date"] {
            background-color: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        body.dark-mode #reportDateFilterGroup button {
            background-color: var(--primary-dark-color);
        }
        body.dark-mode #reportDateFilterGroup button:hover {
            background-color: #4e5d9e;
        }

        @media (max-width: 550px) {
            #reportDateFilterGroup {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            
            #reportDateFilterGroup input[type="date"] {
                width: auto;
            }
        }
        /* --- END: তারিখ ফিল্টার স্টাইল --- */


        /* সকল স্ক্রিনের জন্য ডিফল্ট */
        .modal-content ul li i {
            margin-right: 0px;
        }

        /* বড় স্ক্রিনের (যেমন পিসি) জন্য */
        @media (min-width: 601px) {
            .modal-content ul li i {
                margin-right: 8px;
            }
        }
        /* Styles for PDF content rendering (hidden div) */
        #pdfContent {
            position: absolute;
            left: -9999px;
            width: 700px;
            padding: 20px;
            background-color: #fff;
            color: #000;
            font-family: 'Noto Sans Bengali', sans-serif;
            font-size: 20px;
        }
        #pdfContent .pdf-header-label {
            font-size: 24px;
        }
        #pdfContent h2 {
            text-align: center;
            font-size: 40px;
            margin-bottom: 20px;
            color: #000;
        }
        .pdf-item {
            display: flex;
            justify-content: space-between;
            padding: 7px 0;
            border-bottom: 1px dashed #ccc;
            position: relative; /* For priority indicator */
            padding-left: 10px; /* Space for priority indicator */
        }
        #pdfContent .pdf-item .pdf-priority-indicator {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            width: 5px;
        }
        #pdfContent .pdf-item.bought-pdf {
            text-decoration: line-through;
            color: #777;
        }
        #pdfContent .pdf-item span {
            flex-basis: 30%;
        }
        #pdfContent .pdf-item .pdf-name {
            flex-basis: 50%;
            font-size: 1.1em;
        }
        #pdfContent .pdf-item .pdf-total {
            text-align: right;
            flex-basis: 20%;
            font-size: 1.1em;
        }
        #pdfContent .pdf-total-amount {
            text-align: right;
            margin-top: 18px;
            padding-top: 12px;
            font-size: 1.1em;
            line-height: 1.6;
        }

        #pdfContent .pdf-total-amount .pdf-overall-total {
            border-top: 2px solid #333;
            margin-top: 8px;
            padding-top: 8px;
            font-weight: bold;
            font-size: 1.2em;
        }

        /* --- Dark Mode Styles --- */
        body.dark-mode {
            background-color: #1a1a2e;
            color: #e0e0e0;
        }
        .dark-mode .container {
            background: #2a2a4a;
            box-shadow: 0 4px 25px rgba(0, 0, 0, 0.3);
        }
        .dark-mode h1,
        .dark-mode .total-section {
            color: #e0e0e0;
        }
        .dark-mode .controls-group button {
            background-color: var(--primary-dark-color);
            color: #e0e0e0;
        }
        .dark-mode .controls-group button:hover {
            background-color: #4e5d9e;
        }
        .dark-mode .list-selector-group select {
            background-color: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .list-selector-group select:focus {
            border-color: #8c9eff;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.25);
        }

        .dark-mode .input-group input[type="text"],
        .dark-mode .input-group input[type="number"],
        .dark-mode .input-group input[type="date"],
        .dark-mode .input-group select {
            background-color: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .input-group input::placeholder {
            color: #aaa;
        }
        .dark-mode .input-group input:focus,
        .dark-mode .input-group select:focus {
            border-color: #8c9eff;
            box-shadow: 0 0 0 3px rgba(92, 107, 192, 0.25);
        }
        .dark-mode .input-group button.add-item-btn {
            background-color: var(--primary-dark-color);
        }
        .dark-mode .input-group button.add-item-btn:hover {
            background-color: #4e5d9e;
        }
        .dark-mode .input-group .voice-input-button {
            background-color: #4cae4c;
        }
        .dark-mode .input-group .voice-input-button:hover {
            background-color: #3c9c3c;
        }
        .dark-mode .autocomplete-suggestions {
            background: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        .dark-mode .autocomplete-suggestions div {
            border-bottom-color: #4a4a6a;
        }
        .dark-mode .autocomplete-suggestions div:hover {
            background-color: #4a4a6a;
        }
        .dark-mode .autocomplete-suggestions div.selected {
            background-color: #5a5a7a;
        }

        .dark-mode .list-item {
            background-color: #3a3a5a;
            border-color: #444;
        }
        .dark-mode .list-item.dragging {
            border: 2px dashed #8c9eff;
            background-color: #4a4a6a;
        }
        .dark-mode .list-item.bought {
            background-color: #333;
            color: #999;
            border-color: #555;
        }
        .dark-mode .list-item.bought .item-name-compact,
        body.dark-mode .list-item.bought .item-compact-row .toggle-bought-btn,
        .dark-mode .list-item.bought .item-total-price-compact {
            color: #888;
        }
        .dark-mode .item-name-compact {
            color: #e0e0e0;
        }
        .dark-mode .item-total-price-compact {
            color: var(--income-color-dark);
        }
        .dark-mode .item-time-date {
            color: #bbb;
        }
        body.dark-mode .item-time-date i {
            color: #bbb; /* Keep time icon slightly muted in dark mode */
        }
        body.dark-mode .item-actions-expanded .edit-btn-expanded {
            color: var(--primary-dark-color);
        }
        body.dark-mode .item-actions-expanded .delete-btn-expanded {
            color: var(--expense-color-dark);
        }
        body.dark-mode .item-actions-expanded button:hover {
             background-color: #4a4a6a;
        }
        body.dark-mode .item-actions-expanded .delete-btn-expanded:hover {
            background-color: #5a3a3a;
        }
        .dark-mode .total-section {
            border-top-color: #444;
        }

        .dark-mode .header-controls .dark-mode-toggle,
        .dark-mode .header-controls .info-button,
        .dark-mode .header-controls .profile-button {
            color: #9fa8da; /* Lighter shade of primary for dark mode */
        }
        .dark-mode .header-controls .dark-mode-toggle:hover,
        .dark-mode .header-controls .info-button:hover,
        .dark-mode .header-controls .profile-button:hover {
            color: #c5cae9;
        }
        .dark-mode .font-size-controls button {
            color: #9fa8da;
            border-color: #555;
            background-color: #3a3a5a;
        }
        .dark-mode .font-size-controls button:hover {
            background-color: #4a4a6a;
            border-color: #8c9eff;
            color: #8c9eff;
        }
        .dark-mode .font-size-controls button.active {
            background-color: #8c9eff;
            color: white;
            border-color: #8c9eff;
        }
        .dark-mode .font-size-controls button.active:hover {
            background-color: #7986cb;
            border-color: #7986cb;
            color: white;
        }

        .dark-mode .modal-content {
            background-color: #3a3a5a;
            color: #e0e0e0;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }
        .dark-mode .modal-content h2 {
            color: #8c9eff;
        }
        .dark-mode .modal-close-button {
            color: #aaa;
        }
        .dark-mode .modal-close-button:hover {
            color: #e0e0e0;
        }
        .dark-mode #shareModalContent pre {
            background-color: #2a2a4a;
            border-color: #444;
            color: #e0e0e0;
        }
        .dark-mode #shareModalContent .copy-button {
            background-color: var(--primary-dark-color);
        }
        .dark-mode #shareModalContent .copy-button:hover {
            background-color: #4e5d9e;
        }
        .dark-mode #shareModalContent .share-platform-button {
            background-color: #4a90a0;
        }
        .dark-mode #shareModalContent .share-platform-button:hover {
            background-color: #3a7d8d;
        }
        
        /* --- START: Dark Mode for Report Modifications --- */
        .dark-mode .report-section {
            border-color: #555;
            background-color: #33335a; /* Slightly different shade */
        }
        .dark-mode #reportPage h3 {
            color: #e0e0e0;
            border-bottom-color: #444;
        }
        .dark-mode #reportPage .report-summary-item strong {
            color: #8c9eff;
        }
        .dark-mode #reportPage .report-list ul li {
            background-color: #3a3a5a;
            border-color: #444;
        }
        .dark-mode #reportPage .report-list ul li .report-amount {
            color: var(--income-color-dark);
        }
        .dark-mode #reportPage .report-no-data {
            background-color: #2a2a4a;
            color: #aaa;
        }
        
        /* Dark mode for date filter (MODIFIED) */
        .dark-mode .date-filter-results-container {
            background-color: transparent; /* Changed to transparent as parent has color now */
            border-color: #444;
        }
        /* START: USER REQUESTED CHANGE */
        .dark-mode .date-filter-total,
        .dark-mode #dateFilterTotalAmount {
            color: #f0f0f0 !important; /* Make text visible in dark mode */
        }
        /* END: USER REQUESTED CHANGE */
        .dark-mode .date-filter-range {
            color: #bbb;
        }
        .dark-mode .date-filter-sub-totals strong {
            color: #8c9eff;
        }

        .dark-mode #reportListFilterGroup select, .dark-mode #reportListFilterGroup input,
        .dark-mode #reportPriorityFilterGroup select, .dark-mode #reportPriorityFilterGroup input {
            background-color: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        /* START: Dark Mode for Scrollable Report List */
        .dark-mode .report-list.scrollable {
            border-color: #555;
            background-color: #2a2a4a;
        }
        /* END: Dark Mode for Scrollable Report List */
        /* --- END: Dark Mode for Report Modifications --- */

        /* START: USER REQUEST - Show report page separators in light mode & FIX BORDER THICKNESS */
        #customerReportPage .tx-col-details::after,
        #customerReportPage .tx-col-gave::after {
            display: block;
            top: 0;
            bottom: 0;
            background-color: #e0e0e0;
        }
        /* END: USER REQUEST */

        /* START: User Request for Dark Mode Report Table Styling & FIX BORDER THICKNESS */
        body.dark-mode #customerReportPage .tx-col-gave {
            background-color: transparent; /* Remove red background */
        }
        
        body.dark-mode #customerReportPage .tx-col-details::after,
        body.dark-mode #customerReportPage .tx-col-gave::after {
            display: block;
            top: 0;
            bottom: 0;
            background-color: #444; /* উল্লম্ব বিভাজক */
        }
        /* END: User Request for Dark Mode Report Table Styling */
        
        /* --- START: USER REQUESTED CHANGE for Total Amount Color --- */

/* মোট পরিমাণের সংখ্যাটিকে বাটন কালার (Primary Color)-এ পরিবর্তন করা হচ্ছে */
.total-section #totalAmount {
    color: var(--primary-color);
}

/* ডার্ক মোডের জন্য মোট পরিমাণের সংখ্যাটিকে ডার্ক বাটন কালার-এ পরিবর্তন করা হচ্ছে */
body.dark-mode .total-section #totalAmount {
    color: var(--primary-dark-color);
}

/* --- END: USER REQUESTED CHANGE --- */

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .controls-group {
                flex-direction: column;
                align-items: stretch;
                gap: 15px;
            }
            /* --- START: User Requested Change --- */
            .list-selector-group {
                flex-direction: column;
                align-items: stretch;
                width: 100%;
                gap: 8px;
            }
            .list-button-group {
                width: 100%;
            }
            .list-button-group button:first-child { /* Targets the "নতুন তালিকা" button */
                flex-grow: 1;
            }
            .list-selector-group {
                 flex-direction: row; /* Keep elements in a row */
                 flex-wrap: wrap; /* Allow wrapping if needed */
            }
            /* --- END: User Requested Change --- */

            .list-selector-group select {
                max-width: 100%;
                flex-grow: 1; /* Allow selector to take more space on mobile */
            }
            
            /* Old list item styles are removed/hidden, so no need for item-sub-details-and-actions media query here */
            

            #reportListFilterGroup, #reportPriorityFilterGroup {
                flex-direction: column;
                align-items: stretch;
                max-width: 100%;
            }
            #reportListFilter, #reportPriorityFilter {
                min-width: unset;
                width: 100%;
            }
            #reportListFilterGroup label, #reportPriorityFilterGroup label {
                display: block;
                width: 100%;
                margin-bottom: 5px;
                text-align: left;
            }
            /* Adjust report page header on small screens */
            .report-page-header {
                justify-content: flex-start; /* Keep back button left */
            }
            .report-page-header h2 {
                text-align: left; /* Align title left to avoid collision */
                font-size: 1.8em;
            }
        }

        @media (max-width: 600px) {
            body { padding: 0; padding-bottom: 80px; } /* Remove body padding on mobile, adjust for nav */
            .container {
                padding: 15px;
                margin-top: 0;
                border-radius: 0;
            }
            /* Adjust padding for fixed report pages on mobile */
            #reportPage {
                padding: 0;
            }
            .report-page-header {
                padding: 10px 15px;
            }
            .report-page-content {
                padding: 15px;
            }
            #customerReportPageContent {
                padding: 0; /* MODIFIED: Padding removed */
            }
            #customerReportPageFooterContainer {
                padding-left: 0;  /* MODIFIED: Padding removed */
                padding-right: 0; /* MODIFIED: Padding removed */
            }
            /* MODIFIED: Added rules to control padding inside the report page */
            #customerReportPage .tx-table-header,
            #customerReportPage .tx-table-row,
            #customerReportPage .tx-table-footer {
                padding-left: 15px;
                padding-right: 15px;
            }

            h1 {
                font-size: 1.8em; /* Font size reduced */
                margin-bottom: 20px;
            }
            
            /* --- START: New Input Group Layout for Mobile (UPDATED) --- */
            #shoppingListSection .input-group {
                /* মোবাইলেও দুটি কলাম করা হলো যাতে পাশাপাশি রাখা যায় */
                grid-template-columns: 1fr 1fr; 
                grid-template-rows: auto auto auto; /* ৩টি সারি: নাম, দাম+গুরুত্ব, বাটন */
                gap: 10px;
                margin-bottom: 20px;
            }

            /* ১. পণ্যের নাম: পুরো লাইন জুড়ে থাকবে (উপরে) */
            #shoppingListSection .input-group .input-item-name-group {
                grid-column: 1 / span 2;
                grid-row: 1;
            }

            /* ২. মোট মূল্য: বাম দিকে থাকবে */
            #shoppingListSection .input-group #itemPrice {
                grid-column: 1 / 2;
                grid-row: 2;
            }

            /* ৩. গুরুত্ব: ডান দিকে থাকবে */
            #shoppingListSection .input-group #itemPriority {
                grid-column: 2 / 3;
                grid-row: 2;
            }

            /* ৪. বাটন: পুরো লাইন জুড়ে থাকবে (সবার নিচে) */
            #shoppingListSection .input-group button.add-item-btn {
                grid-column: 1 / span 2;
                grid-row: 3;
                padding: 10px 15px;
            }
            /* --- END: New Input Group Layout for Mobile (UPDATED) --- */

            /* List Item Compact Adjustments */
            .item-name-compact { font-size: 1em; }
            .item-total-price-compact { font-size: 1em; }
            .item-time-date { font-size: 0.8em; }
            .item-actions-expanded button { font-size: 0.95em; }

            .header-controls .dark-mode-toggle,
            .header-controls .info-button,
            .header-controls .profile-button { font-size: 20px; }
            .modal-content { padding: 20px; }
            .modal-content h2 { font-size: 1.6em; } /* Font size reduced */
            .font-size-controls { gap: 5px; }
            .font-size-controls button {
                font-size: 0.9em;
                padding: 2px 6px;
            }
            .fab-add-customer {
                bottom: 100px; /* Adjusted */
                right: 20px;
                width: 55px;
                height: 55px;
            }
            .report-page-header h2 {
                font-size: 1.6em;
            }
        }
         @media (max-width: 400px) {
            /* Handled in 600px breakpoint now:
            #shoppingListSection .input-group {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto auto auto; 
            }
             #shoppingListSection .input-group .input-item-name-group,
             #shoppingListSection .input-group #itemQuantity,
             #shoppingListSection .input-group #itemPrice,
             #shoppingListSection .input-group #itemPriority,
             #shoppingListSection .input-group button.add-item-btn {
                grid-column: 1;
                grid-row: auto;
            }
            */
             .item-name-compact { font-size: 0.9em; }
            .item-total-price-compact { font-size: 0.9em; }
            .item-time-date { font-size: 0.75em; }
            .item-actions-expanded button {
                padding: 5px 7px;
                font-size: 0.9em;
            }
            .total-section { font-size: 1.1em; }
            .modal-content h2 { font-size: 1.5em; }
            .modal-content p, .modal-content ul li { font-size: 0.95em; }
            .controls-group { gap: 10px; }
            .font-size-controls { gap: 3px; }
            .font-size-controls button {
                font-size: 0.85em;
                padding: 1px 5px;
            }
            .report-page-header h2 {
                font-size: 1.5em;
            }
        }

        /* --- Footer Styles --- */
        /* START: New styles for footer inside modal */
        .modal-footer-content {
            border-top: 1px solid #eee; /* Separator line */
            margin-top: 25px;         /* Space above the line */
            padding-top: 20px;        /* Space below the line */
            text-align: center;       /* Center the content */
            font-size: 0.9em;         /* Slightly smaller font */
            color: #555;             /* Muted text color */
        }
        .modal-footer-content p {
            margin: 0 0 10px 0;
            font-weight: normal;
        }
        .footer-contact a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: color 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-size: 0.95em;
        }
        .footer-contact a:hover {
            color: #303f9f;
            text-decoration: underline;
        }
        .footer-contact i {
            font-size: 1.1em;
        }
        body.dark-mode .modal-footer-content {
            border-top-color: #444; /* Darker border for dark mode */
            color: #aaa;             /* Lighter muted color for dark mode */
        }
        body.dark-mode .footer-contact a {
            color: #8c9eff;
        }
        body.dark-mode .footer-contact a:hover {
            color: #c5cae9;
        }
        /* END: New styles for footer inside modal */

        /* New Custom Modal Styles */
        .custom-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            /* z-index: 1000; <-- Removed for JS control */
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
            padding: 15px;
            box-sizing: border-box;
            overflow-y: auto;
        }
        .custom-modal.active {
            opacity: 1;
            visibility: visible;
        }
        .custom-modal-content {
            background-color: #fff;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.4);
            max-width: 450px;
            width: 100%;
            position: relative;
            transform: scale(0.95);
            transition: transform 0.3s ease;
            font-family: 'Noto Sans Bengali', sans-serif;
            color: #333;
            box-sizing: border-box;
            text-align: center;
            max-height: 90vh;
            overflow-y: auto;
        }
        .custom-modal.active .custom-modal-content {
            transform: scale(1);
        }
        .custom-modal-content h3 {
            margin-top: 0;
            color: var(--primary-color);
            font-size: 1.6em;
            margin-bottom: 15px;
        }
        .custom-modal-content p {
            font-size: 1em;
            margin-bottom: 25px;
            line-height: 1.5;
        }
        .custom-modal-input-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .custom-modal-input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 1em;
        }
        /* ... (৯২৫ নং লাইন এর আশেপাশে) ... */
.custom-modal-input-group input[type="text"],
.custom-modal-input-group input[type="number"],
.custom-modal-input-group input[type="tel"],
/* START: নতুন করে password ইনপুট যোগ করা হলো */
.custom-modal-input-group input[type="password"],
/* END: নতুন কোড */
.custom-modal-input-group select,
.custom-modal-input-group input[type="date"],
.custom-modal-input-group input[type="file"] {
    width: 100%;
    padding: 11px 15px; /* <-- প্যাডিং বাড়িয়ে ইনপুট চওড়া করা হলো */
    border: 1px solid #ccc;
    border-radius: 6px;
    font-size: 1em;
    box-sizing: border-box;
    transition: border-color 0.3s ease, box-shadow 0.3s ease;
    background-color: #f9f9f9;
}
/* ... (৯৪১ নং লাইন এর আশেপাশে) ... */
        .custom-modal-input-group input:focus,
        .custom-modal-input-group select:focus,
        .custom-modal-input-group input[type="date"]:focus,
        .custom-modal-input-group input[type="file"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
            background-color: #fff;
        }
        /* START: Phone validation styles */
        .phone-input-wrapper.input-invalid input {
            border-color: var(--expense-color);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.2);
        }
        .phone-error-message {
            display: none;
            color: var(--expense-color);
            font-size: 0.85em;
            margin-top: 5px;
        }
        /* END: Phone validation styles */

        .custom-modal-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 25px;
        }
        .custom-modal-buttons button {
            padding: 10px 20px;
            border-radius: 6px;
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color: 0.3s ease, transform 0.2s ease;
            min-width: 100px;
        }
        .custom-modal-buttons button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .custom-modal-buttons .confirm-btn,
        .custom-modal-buttons .submit-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
        }
        .custom-modal-buttons .confirm-btn:hover,
        .custom-modal-buttons .submit-btn:hover {
            background-color: #303f9f;
            transform: translateY(-1px);
        }
        .custom-modal-buttons .cancel-btn {
            background-color: #6c757d;
            color: white;
            border: none;
        }
        .custom-modal-buttons .cancel-btn:hover {
            background-color: #5a6268;
            transform: translateY(-1px);
        }
        .custom-modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.3s ease;
        }
        .custom-modal-close:hover {
            color: #333;
        }

        /* Dark Mode for Custom Modals */
        body.dark-mode .custom-modal-content {
            background-color: #2a2a4a;
            color: #e0e0e0;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.6);
        }
        body.dark-mode .custom-modal-content h3 { color: #8c9eff; }
        body.dark-mode .custom-modal-input-group label { color: #bbb; }
        body.dark-mode .custom-modal-input-group input[type="text"],
        body.dark-mode .custom-modal-input-group input[type="number"],
        body.dark-mode .custom-modal-input-group input[type="tel"],
        body.dark-mode .custom-modal-input-group input[type="password"],
        body.dark-mode .custom-modal-input-group select,
        body.dark-mode .custom-modal-input-group input[type="date"],
        body.dark-mode .custom-modal-input-group input[type="file"] {
            background-color: #3a3a5a;
            border-color: #555;
            color: #e0e0e0;
        }
        body.dark-mode .custom-modal-input-group input:focus,
        body.dark-mode .custom-modal-input-group select:focus,
        body.dark-mode .custom-modal-input-group input[type="date"]:focus,
        body.dark-mode .custom-modal-input-group input[type="file"]:focus {
            border-color: #8c9eff;
            box-shadow: 0 0 0 3px rgba(140, 158, 255, 0.2);
            background-color: #3a3a5a;
        }
        body.dark-mode .custom-modal-buttons .confirm-btn,
        body.dark-mode .custom-modal-buttons .submit-btn {
            background-color: var(--primary-dark-color);
        }
        body.dark-mode .custom-modal-buttons .confirm-btn:hover,
        body.dark-mode .custom-modal-buttons .submit-btn:hover {
            background-color: #4e5d9e;
        }
        body.dark-mode .custom-modal-buttons .cancel-btn {
            background-color: #8899aa;
        }
        body.dark-mode .custom-modal-buttons .cancel-btn:hover {
            background-color: #778899;
        }
        body.dark-mode .custom-modal-buttons button:disabled {
            background-color: #555;
            color: #888;
        }
        body.dark-mode .custom-modal-close { color: #aaa; }
        body.dark-mode .custom-modal-close:hover { color: #e0e0e0; }
        
        /* START: PRO-LEVEL GLASSMORPHISM Login Screen Styles (COMPACT) */
        #login-view {
            display: flex;
            justify-content: center;
            align-items: center;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 20px; /* Reduced padding */
            box-sizing: border-box;
            background-color: #f0f2f5; /* Light background for glass effect */
            z-index: 10000;
        }
        .login-card-d12 {
            max-width: 340px; /* Reduced max-width */
            width: 100%;
            padding: 25px; /* Reduced padding */
            border-radius: 16px; /* Slightly less rounded */
            text-align: center;
            
            /* Glassmorphism Effect for Light Mode */
            background: rgba(255, 255, 255, 0.7); 
            backdrop-filter: blur(10px); 
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37); 
            
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .login-card-d12::before { display: none; }

        .app-icon {
            font-size: 2.2em; /* Reduced icon size */
            color: var(--primary-color);
            margin-bottom: 10px;
        }
        .login-card-d12 h1 {
            font-family: 'Noto Sans Bengali', sans-serif;
            font-size: 1.6em; /* Reduced title size */
            line-height: 1.2;
            margin-top: 0;
            margin-bottom: 15px; /* Reduced margin */
            color: var(--primary-color);
            font-weight: 700;
        }
        
        /* গুগল সাইন ইন বাটনের নতুন স্টাইল (স্ক্রিনশট অনুযায়ী) */
        .google-sign-in-btn {
            width: 100%;
            padding: 11px 15px; /* ইনপুট ফিল্ডের মতো একই প্যাডিং */
            font-size: 1em; 
            background-color: #fff; /* White background */
            color: #333;
            border: 1px solid #ccc; /* Black/Gray border */
            border-radius: 12px; /* ইনপুট ফিল্ডের মতো একই কর্নার */
            cursor: pointer;
            display: flex; /* Flexbox ব্যবহার করে লোগো বামে রাখা হয়েছে */
            align-items: center;
            justify-content: center; /* সেন্টারে আনার জন্য */
            gap: 8px; 
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600; /* স্ক্রিনশটের মতো বোল্ড করা হয়েছে */
            margin-top: 10px; /* স্পেস যোগ করা হয়েছে */
        }
        .google-sign-in-btn:hover {
             background-color: #f5f5f5;
             transform: translateY(-1px);
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        /* রেফার কোড ইনপুটের জন্য বিশেষ স্টাইলগুলো মুছে ফেলা হলো */
        
        /* Dark Mode for Login Screen (Glassmorphism) */
        body.dark-mode #login-view { background-color: #1a1a2e; }
        body.dark-mode .login-card-d12 {
            background: rgba(42, 42, 74, 0.7);
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
        }
        body.dark-mode .login-card-d12 h1 { color: var(--primary-dark-color); }
        
        body.dark-mode .google-sign-in-btn {
            background-color: #3a3a5a;
            color: #e0e0e0;
            border-color: #555;
        }
        body.dark-mode .google-sign-in-btn:hover {
            background-color: #4a4a6a;
        }
        /* END: PRO-LEVEL GLASSMORPHISM Login Screen Styles (COMPACT) */


        /* START: Toast Notification Styles */
        #toastContainer {
            position: fixed;
            bottom: 100px; /* Adjusted for bottom nav */
            right: 20px;
            z-index: 25000;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }
        .toast {
            background-color: #333;
            color: #fff;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            font-size: 0.95em;
            display: flex;
            align-items: center;
            gap: 15px;
            opacity: 0;
            transform: translateX(100%);
            transition: transform 0.4s ease, opacity 0.4s ease;
        }
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        .toast-undo-button {
            background-color: var(--primary-dark-color);
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color: 0.2s;
        }
        .toast-undo-button:hover {
            background-color: #4e5d9e;
        }
        /* END: Toast Notification Styles */
        
        /* START: New Transaction Confirmation Modal Style (Screenshot Redesign) */
        #txConfirmModal .custom-modal-content {
            background-color: #f0f2f5;
            padding: 0;
            max-width: 400px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }
        body.dark-mode #txConfirmModal .custom-modal-content {
            background-color: #2a2a4a;
        }
        #txConfirmModal .tx-header {
            text-align: center;
            padding: 25px 20px 15px 20px;
        }
        #txConfirmModal .tx-header .success-icon {
            font-size: 1.8em;
            color: white;
            background-color: var(--income-color);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: inline-flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 12px;
        }
        #txConfirmModal h3 {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin: 0;
        }
        body.dark-mode #txConfirmModal h3 {
             color: #e0e0e0;
        }

        #txConfirmModal .tx-details-card {
            background-color: #fff;
            margin: 0 15px;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        body.dark-mode #txConfirmModal .tx-details-card {
            background-color: #3a3a5a;
        }
        
        #txConfirmModal .tx-customer-info {
            display: flex;
            align-items: center;
            gap: 12px;
            padding-bottom: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        body.dark-mode #txConfirmModal .tx-customer-info {
             border-bottom-color: #4a4a6a;
        }
        #txConfirmModal .tx-customer-info .initial-circle {
             width: 40px; height: 40px; border-radius: 50%; color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2em; font-weight: bold; flex-shrink: 0;
        }
        #txConfirmModal .tx-customer-info .name {
            font-size: 1.2em;
            font-weight: 500;
        }

        #txConfirmModal .tx-detail-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 1em;
        }
        #txConfirmModal .tx-detail-item span:first-child {
            color: #555;
        }
        body.dark-mode #txConfirmModal .tx-detail-item span:first-child { color: #bbb; }
        #txConfirmModal .tx-detail-item span:last-child {
            font-weight: 500;
        }
        /* USER MODIFIED */
        #txConfirmModal .tx-detail-item .gave { color: var(--expense-color); }
        #txConfirmModal .tx-detail-item .received { color: var(--income-color); }
        
        #txConfirmModal .tx-detail-item.final-balance {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-weight: bold;
        }
        #txConfirmModal .tx-detail-item.description {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
            font-size: 0.9em;
            color: #666;
        }
        body.dark-mode #txConfirmModal .tx-detail-item.final-balance,
        body.dark-mode #txConfirmModal .tx-detail-item.description { 
            border-top-color: #4a4a6a; 
        }
        body.dark-mode #txConfirmModal .tx-detail-item.description {
            color: #ccc;
        }


        #txConfirmModal .tx-share-section {
            padding: 20px;
            text-align: center;
        }
        #txConfirmModal .tx-share-section .share-title {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 15px;
        }
        body.dark-mode #txConfirmModal .tx-share-section .share-title { color: #aaa; }

        #txConfirmModal .tx-share-buttons {
            display: flex;
            justify-content: center;
            gap: 40px;
        }
        #txConfirmModal .tx-share-buttons button {
            background: none; border: none; cursor: pointer;
            display: flex; flex-direction: column; align-items: center; gap: 8px;
            color: #555; font-size: 0.9em;
        }
        body.dark-mode #txConfirmModal .tx-share-buttons button { color: #bbb; }
        #txConfirmModal .tx-share-buttons i {
            font-size: 1.6em;
            width: 45px; height: 45px;
            background-color: #e9ecef;
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            transition: background-color: 0.3s;
        }
        body.dark-mode #txConfirmModal .tx-share-buttons i { background-color: #3a3a5a; }
        #txConfirmModal .tx-share-buttons button:hover i {
            background-color: #d6dbe1;
        }
        body.dark-mode .tx-share-buttons button:hover i {
            background-color: #4a4a6a;
        }

        /* END: New Transaction Confirmation Modal Style */

        /* START: Customer Options Menu Style */
        #customerOptionsMenu {
            display: none;
            position: absolute;
            top: 40px;
            right: 0;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            z-index: 10;
            overflow: hidden;
            width: 150px;
        }
        #customerOptionsMenu button {
            display: block;
            width: 100%;
            padding: 12px 15px;
            background: none;
            border: none;
            text-align: left;
            cursor: pointer;
            font-size: 1em;
            color: #333;
            transition: background-color: 0.2s;
        }
        #customerOptionsMenu button:hover {
            background-color: #f5f5f5;
        }
        #customerOptionsMenu button i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
            color: #555;
        }
        #customerOptionsMenu .delete-option {
            color: var(--expense-color);
        }
        #customerOptionsMenu .delete-option i {
            color: var(--expense-color);
        }
        body.dark-mode #customerOptionsMenu {
            background-color: #3a3a5a;
        }
        body.dark-mode #customerOptionsMenu button {
            color: #e0e0e0;
        }
        body.dark-mode #customerOptionsMenu button:hover {
            background-color: #4a4a6a;
        }
        body.dark-mode #customerOptionsMenu button i {
            color: #bbb;
        }
        body.dark-mode #customerOptionsMenu .delete-option {
            color: var(--expense-color-dark);
        }
        body.dark-mode #customerOptionsMenu .delete-option i {
            color: var(--expense-color-dark);
        }
        /* END: Customer Options Menu Style */

        /* START: New Transaction Detail Modal Styles */
        #transactionDetailModal .tx-detail-view {
            padding: 10px;
        }
        #transactionDetailModal .tx-detail-view .tx-table-header,
        #transactionDetailModal .tx-detail-view .tx-table-row {
            padding-left: 0;
            padding-right: 0;
        }
        
        body.dark-mode #transactionDetailModal .tx-table-header {
            background-color: #33335a;
            color: #f0f0f0;
        }
        body.dark-mode #transactionDetailModal .tx-table-row {
            background-color: transparent;
            border-bottom-color: #444;
        }
        
        #transactionDetailModal .tx-detail-actions {
            display: flex;
            gap: 15px;
            margin-top: 25px;
            justify-content: center;
        }
        #transactionDetailModal .tx-detail-actions button {
            flex-grow: 1;
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 500;
            border: 1px solid;
            cursor: pointer;
        }
        #transactionDetailModal .tx-detail-actions .delete-btn {
            background-color: transparent;
            color: var(--expense-color);
            border-color: var(--expense-color);
        }
        #transactionDetailModal .tx-detail-actions .edit-btn {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        body.dark-mode #transactionDetailModal .tx-detail-actions .delete-btn {
            color: var(--expense-color-dark);
            border-color: var(--expense-color-dark);
        }
        body.dark-mode #transactionDetailModal .tx-detail-actions .edit-btn {
            background-color: var(--primary-dark-color);
            border-color: var(--primary-dark-color);
        }
        /* END: New Transaction Detail Modal Styles */
        
        /* START: PDF Report Styles (REVISED AND CORRECTED WITH LARGER FONT) */
        #pdfLedgerContent {
            position: absolute;
            left: -9999px;
            width: 800px;
            background-color: #fff;
            color: #333;
            font-family: 'Noto Sans Bengali', sans-serif;
            padding: 25px;
            box-sizing: border-box;
            font-size: 22px; /* Increased Base Font Size */
        }
        .pdf-report-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 15px;
            border-bottom: 2px solid #333;
        }
        .pdf-report-header-left .name {
            font-size: 38px; /* Increased */
            font-weight: bold;
            color: var(--expense-color);
            margin: 0;
        }
        .pdf-report-header-left .phone {
            font-size: 22px; /* Increased */
            margin: 5px 0 0 0;
            color: #555;
        }
        .pdf-report-header-right .logo {
            font-size: 26px; /* Increased */
            font-weight: bold;
            color: #333;
        }
        .pdf-report-subheader {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 15px 0;
        }
        .pdf-report-subheader-left .title {
            font-size: 28px; /* Increased */
            font-weight: bold;
            margin: 0;
        }
        .pdf-report-subheader-left .date {
            margin: 5px 0 0 0;
            font-size: 22px; /* Increased */
            color: #555;
        }
        .pdf-report-subheader-right {
            text-align: right;
            font-size: 22px; /* Increased */
            color: #555;
        }
        .pdf-report-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 10px; 
            font-size: 22px; /* Increased */
        }
        .pdf-report-table th, .pdf-report-table td {
            padding: 12px 10px; /* Increased padding slightly */
            text-align: left;
            vertical-align: top;
        }
        .pdf-report-table thead {
            background-color: #f0f2f5;
            font-size: 24px; /* Increased */
            font-weight: bold;
            color: #333;
        }
        /* Column widths */
        .pdf-report-table .col-details { width: 50%; } 
        .pdf-report-table .col-gave { width: 25%; }
        .pdf-report-table .col-received { width: 25%; }

        /* Align amount columns to the right */
        .pdf-report-table th.col-gave,
        .pdf-report-table td.col-gave,
        .pdf-report-table th.col-received,
        .pdf-report-table td.col-received {
            text-align: right;
        }
        
        .pdf-report-table tbody tr {
            border-bottom: 1px dashed #ccc;
        }
        .pdf-report-table tbody td .tx-time-pdf {
            font-size: 19px; /* Increased */
            color: #666;
        }
        .pdf-report-table tbody td .tx-description-pdf {
            font-size: 19px; /* Increased */
            color: #777;
            white-space: pre-wrap;
            display: block;
            margin-top: 4px;
        }
        
        .pdf-report-table .gave-amount { color: var(--expense-color); font-weight: 500; }
        .pdf-report-table .received-amount { color: var(--income-color); font-weight: 500; }
        
        .pdf-report-table tfoot td {
            font-weight: bold;
            padding-top: 15px; /* Increased padding */
        }
        .pdf-report-table tfoot .total-row td {
            border-top: 2px solid #333;
        }
        .pdf-report-table tfoot .net-balance-row td {
            border-top: 1px solid #ccc;
            background-color: #f0f2f5;
        }
        /* END: PDF Report Styles */

        /* --- START: New Bottom Navigation Menu Styles (Modern App Bar) --- */
.bottom-nav-menu {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    width: 100%;
    max-width: 800px;
    margin: 0 auto;
    height: 65px;
    background-color: #ffffff;
    display: flex;
    justify-content: space-around;
    align-items: center;
    
    /* ✅ পরিবর্তন: Floating Bar Look */
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.08); 
    border-top: none; /* ডিফল্ট বর্ডার সরিয়ে দেওয়া হলো */
    
    z-index: 100;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    flex-grow: 1;
    color: #555;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.3s ease, transform 0.1s ease;
    padding: 3px 0;
    height: 100%;
    -webkit-tap-highlight-color: transparent; /* মোবাইলের নীল শেড বন্ধ */
}

.nav-item:active {
    transform: scale(0.95); /* চাপ দিলে সামান্য ছোট হবে */
}

.nav-item i {
    font-size: 1.3em; /* আইকন সামান্য ছোট করা হয়েছে */
    margin-bottom: 3px; /* গ্যাপ কমানো */
    transition: color 0.3s ease;
}
.nav-item span {
    font-size: 0.75em; /* ফন্ট আরও ছোট এবং ক্লিন */
    font-weight: 600; /* বোল্ড টেক্সট */
    transition: color 0.3s ease;
}

/* ✅ পরিবর্তন: Default Icon Colors (স্ক্রিনশটের মতো) */
/* Shopping List Menu - Default Icon Colors */
#navHomeBtn i { color: #795548; } 
#navShareBtn i { color: #03A9F4; }
#navReportBtn i { color: #009688; } 
#navPdfBtn i { color: #E91E63; } 

/* Ledger Menu - Default Icon Colors */
#navLedgerHomeBtn i { color: #795548; } 
#navLedgerShareBtn i { color: #03A9F4; } 
#navLedgerReceivableBtn i { color: var(--expense-color); } /* Red */
#navLedgerPayableBtn i { color: var(--income-color); } /* Green */


/* Active State - Overrides all default colors */
.nav-item.active i,
.nav-item.active span {
    color: var(--primary-color) !important;
}

/* Dark Mode Styles */
body.dark-mode .bottom-nav-menu {
    background-color: #2a2a4a;
    box-shadow: 0 -5px 15px rgba(0, 0, 0, 0.2);
}
body.dark-mode .nav-item {
    color: #bbb;
}
body.dark-mode .nav-item span {
    color: #bbb;
}
body.dark-mode .nav-item.active i,
body.dark-mode .nav-item.active span {
    color: var(--primary-dark-color) !important;
}
/* --- END: New Bottom Navigation Menu Styles --- */

        /* START: USER REQUEST - Colored Navigation Icons & Active State */
        .nav-item span {
            color: #333;
        }

        /* Shopping List Menu - Default Icon Colors */
        #navHomeBtn i { color: #795548; } /* পরিবর্তন: পার্পেল থেকে বাদামী */
        #navShareBtn i { color: #03A9F4; } /* Light Blue */
        #navReportBtn i { color: #009688; } /* পরিবর্তন: কমলা থেকে টিল */
        #navPdfBtn i { color: #E91E63; } /* Pink */

        /* Ledger Menu - Default Icon Colors */
        #navLedgerHomeBtn i { color: #795548; } /* পরিবর্তন: পার্পেল থেকে বাদামী */
        #navLedgerShareBtn i { color: #03A9F4; } /* Light Blue */
        #navLedgerReceivableBtn i { color: var(--expense-color); } /* Red */
        #navLedgerPayableBtn i { color: var(--income-color); } /* Green */

        /* Active State - Overrides all default colors */
        .nav-item.active i,
        .nav-item.active span {
            color: var(--primary-color) !important;
        }
        /* END: USER REQUEST */


        /* Styles for Receivable/Payable Views */
        .filtered-ledger-view {
    /* overflow-y: auto সরানো হয়েছে */
    flex-grow: 1;
    display: flex; /* নতুন যোগ করা হয়েছে */
    flex-direction: column; /* নতুন যোগ করা হয়েছে */
}
        /* --- FIXED & STYLED: Filtered Ledger Header (Modern Look) --- */
.filtered-ledger-header {
    text-align: center;
    padding: 18px 15px; 
    margin-bottom: 15px;
    
    background-color: #f8f9fa; 
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05); 

    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 5;
    flex-shrink: 0;
}

.filtered-ledger-header h2 {
    margin: 0 0 12px 0;
    font-size: 1.45em;
    font-weight: 700;
    color: #333;
}

/* নরমাল মোডের লেবেল */
.filtered-ledger-summary {
    font-size: 1.05em;
    color: #555; /* লেবেল কালার (মোট গ্রাহক, মোট পাবো, মোট দেবো লেবেল) */
    font-weight: 500;
    line-height: 1.5;
}

/* ✅ নরমাল মোড: 'জন' ইউনিট */
.filtered-ledger-summary .summary-unit {
    color: #333; /* কালো হবে */
    font-weight: 500;
    margin-left: -5px;
}

/* মোট গ্রাহক সংখ্যা প্রাইমারি কালার (নীল) */
.filtered-ledger-summary strong {
    color: var(--primary-color);
    font-weight: 700;
}

/* মোট পাবো/দেবো টাকার পরিমাণকে স্পেসিফিক কালার */
.filtered-ledger-header .total-receivable {
    color: var(--expense-color); /* লাল */
    font-weight: 700;
}
.filtered-ledger-header .total-payable {
    color: var(--income-color); /* সবুজ */
    font-weight: 700;
}


/* --- ডার্ক মোড ফিক্স --- */
body.dark-mode .filtered-ledger-header {
    background-color: #33335a;
    border-color: #444;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    /* এইখানে রং পরিবর্তন হবে না, কারণ আমরা ভেতরের এলিমেন্টে আলাদাভাবে রং দিচ্ছি */
}

/* ✅ ডার্ক মোড ফিক্স: 'মোট গ্রাহক:' এবং 'মোট পাবো/দেবো:' লেবেলগুলো সাদা হবে */
body.dark-mode .filtered-ledger-summary {
    color: #e0e0e0; 
}

body.dark-mode .filtered-ledger-header h2 {
    color: #e0e0e0; 
}

/* ✅ ডার্ক মোড ফিক্স: 'জন' ইউনিট সাদা হবে */
body.dark-mode .filtered-ledger-summary .summary-unit {
    color: #e0e0e0; 
}

/* মোট গ্রাহক সংখ্যা প্রাইমারি ডার্ক কালার */
body.dark-mode .filtered-ledger-summary strong {
    color: var(--primary-dark-color);
}

/* টাকার পরিমাণগুলো ডার্ক কালার ভ্যারিয়েন্ট */
body.dark-mode .filtered-ledger-header .total-receivable {
    color: var(--expense-color-dark);
}
body.dark-mode .filtered-ledger-header .total-payable {
    color: var(--income-color-dark);
}
        /* MODIFIED: Layout fix for sections */
        #shoppingListSection, #ledgerSection {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        /* START: reCAPTCHA Badge Hide Style */
        .grecaptcha-badge {
            visibility: hidden;
        }
        /* END: reCAPTCHA Badge Hide Style */

        /* PERFORMANCE UPDATE: Style for pagination loader */
        .pagination-loader {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #777;
        }
        body.dark-mode .pagination-loader {
            color: #aaa;
        }
        
        /* NEW Page Styles for Change/Reset Password (Ensuring Background is correct) */
        #changePasswordPage, #resetPasswordPage, #changeNamePage, #changeEmailPage {
            background-color: var(--main-bg-color) !important;
        }
        /* Dark Mode Fix for the New Page Container */
body.dark-mode #changeEmailPage .container {
    background: #2a2a4a; /* Match other dark mode containers */
}
        body.dark-mode #resetPasswordPage .login-card-d12 h2 {
            color: var(--primary-dark-color) !important;
        }
        body.dark-mode #resetPasswordPage .login-card-d12 p {
            color: #c5cae9 !important;
        }
        
/* ====================================================== */
/* === পাসওয়ার্ড রিসেট পেজ (মোবাইল লেআউট ফিক্স) - FINAL === */
/* ====================================================== */
#resetPasswordPage .login-card-d12 {
    /* padding-left/right: 25px; ইনলাইন স্টাইলে ছিল, কিন্তু নিচে max-width/width ব্যবহার হওয়ায় 
       এই padding-টি ইনপুট ফিল্ডের জন্য যথেষ্ট। মার্জিনের কাজ নিচে করা হয়েছে। */
    padding-left: 25px !important; 
    padding-right: 25px !important; 
    
    /* সব স্ক্রিনের জন্য মার্জিন সেট করা, যা ছোট স্ক্রিনেও ফাঁকা রাখবে */
    margin: 20px auto; 
    
    /* ছোট স্ক্রিনে ডানে-বামে 20px মার্জিন নিশ্চিত করতে প্রস্থ ঠিক করা */
    width: calc(100% - 40px);
    
    /* max-width: 340px; ইনলাইন স্টাইল হিসেবে আছে, তাই এখানে দরকার নেই। */
    box-sizing: border-box; /* নিশ্চিত করছি প্যাডিং এবং মার্জিন গণনা ঠিক আছে */
}

/* বাটনগুলো যাতে সমান প্রস্থের হয় তার জন্য পরিবর্তন */
#resetPasswordPage .custom-modal-buttons {
    display: flex; 
    gap: 15px;      
    margin-top: 25px; 
    justify-content: center;
}

#resetPasswordPage .custom-modal-buttons .auth-btn {
    flex-grow: 1; 
    width: auto !important; 
    margin-bottom: 0 !important; 
}

/* ইমেইল ইনপুট ফিল্ডের ফিক্স */
#resetPasswordPage .auth-input-group {
    margin-left: 0; 
    margin-right: 0;
}
/* ====================================================== */
        
        /* START: FAB Fix for Wide Screens (PC Mode) - গ্রাহক যোগ করার বাটনটিকে কন্টেইনারের মধ্যে রাখার জন্য */
@media (min-width: 801px) {
    .fab-add-customer {
        /* ডান দিকে অ্যাঙ্কর (right: 40px) বাতিল করা হচ্ছে */
        right: auto !important; 
        
        /* বাটনটিকে কন্টেইনারের ডান প্রান্তে 20px দূরত্বে সেট করা হচ্ছে */
        /* Calculation: 50% (স্ক্রিন সেন্টার) + 
           (800px / 2 - 60px (FAB-এর প্রস্থ) - 20px (প্রত্যাশিত মার্জিন)) = 50% + 320px */
        left: calc(50% + 320px) !important; 
    }
}
/* END: FAB Fix for Wide Screens (PC Mode) */
        
        /* --- START: উন্নত গাইডলাইন মডাল ডিজাইন (আপডেটেড ও ফিক্সড) --- */
.guide-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 5px 0;
}

.guide-card {
    display: flex;
    align-items: flex-start; /* আইকন ও টেক্সট টপ থেকে শুরু হবে */
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 12px;
    padding: 15px;
    transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.guide-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    background: #fff;
    border-color: var(--primary-color);
}

/* বাম পাশের বড় আইকন বক্স */
.guide-icon-wrapper {
    flex-shrink: 0; /* আইকন যেন চ্যাপ্টা না হয় */
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    margin-right: 12px; /* টেক্সট থেকে দূরত্ব কমানো হয়েছে */
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}

.guide-content {
    flex-grow: 1;
    min-width: 0; /* টেক্সট র‍্যাপিং ফিক্স */
}

.guide-content h4 {
    margin: 0 0 8px 0;
    font-size: 1.1em;
    color: #2c3e50;
    font-weight: 700;
    border-bottom: 1px dashed #ddd;
    padding-bottom: 6px;
}

.guide-content p {
    font-size: 0.95em;
    color: #555;
    line-height: 1.5;
    margin-bottom: 8px;
    text-align: left;
}

/* তালিকার ডিজাইন ফিক্স */
.guide-content ul {
    margin: 0;
    padding-left: 18px; /* বাম দিকের গ্যাপ কমানো হয়েছে */
    color: #555;
    font-size: 0.95em;
    line-height: 1.6;
    text-align: left;
}

.guide-content ul li {
    margin-bottom: 8px;
    padding-left: 5px; /* বুলেটের পর টেক্সটের দূরত্ব */
}

/* লেখার মাঝখানের আইকনগুলোকে গোল করার ক্লাস */
.inline-icon-circle {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;       /* ফিক্সড চওড়া */
    height: 24px;      /* ফিক্সড উচ্চতা */
    border-radius: 50%; /* একদম গোল */
    font-size: 0.85em;
    vertical-align: middle; /* লাইনের মাঝ বরাবর থাকবে */
    margin: 0 2px;
    flex-shrink: 0;    /* চ্যাপ্টা হওয়া রোধ করবে */
}

/* বিশেষ হাইলাইট বাটন (যেমন: নিশ্চিত করুন) */
.inline-btn-badge {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 600;
    background-color: var(--primary-color);
    color: white;
    white-space: nowrap; /* লেখা ভাঙবে না */
}

/* Swipe Box Style */
.swipe-box {
    background: #fff;
    border: 1px dashed #ccc;
    border-radius: 8px;
    padding: 10px;
    margin-top: 8px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.swipe-row {
    display: flex;
    align-items: center;
    font-size: 0.9em;
    color: #555;
}

.swipe-row i { 
    margin-right: 10px; 
    color: var(--primary-color);
    flex-shrink: 0;
}

/* Footer Style */
.modal-footer-styled {
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #eee;
    text-align: center;
    font-size: 0.9em;
    color: #555;
}

/* ফুটারের টেক্সট সাইজ ছোট করার কোড */
.modal-footer-styled p {
    font-size: 0.85em !important; /* ফন্ট ছোট করা হয়েছে */
    line-height: 1.4;
    margin-bottom: 8px;
}

.contact-btn-styled {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 15px;
    padding: 10px 25px;
    background-color: var(--primary-color);
    color: white !important;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 500;
    transition: background 0.3s, transform 0.2s;
    box-shadow: 0 3px 8px rgba(63, 81, 181, 0.3);
}
.contact-btn-styled:hover {
    background-color: #303f9f;
    transform: translateY(-1px);
}

/* --- ডার্ক মোড (Dark Mode) --- */
body.dark-mode .guide-card {
    background: #2a2a4a;
    border-color: #444;
}
body.dark-mode .guide-card:hover {
    background: #323259;
    border-color: #666;
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}
body.dark-mode .guide-content h4 { color: #e0e0e0; border-bottom-color: #444; }
body.dark-mode .guide-content ul, 
body.dark-mode .guide-content p { color: #bbb; }
body.dark-mode .swipe-box { background: #33335a; border-color: #555; }
body.dark-mode .swipe-row { color: #ccc; }
body.dark-mode .modal-footer-styled { border-top-color: #444; color: #aaa; }

/* ডার্ক মোড টেক্সট ফিক্স (নতুন যুক্ত করা হয়েছে) */
body.dark-mode #infoModalOverlay .modal-content > p {
    color: #e0e0e0 !important; /* উপরের ইন্ট্রো টেক্সট সাদা */
}
body.dark-mode .modal-footer-styled p,
body.dark-mode .modal-footer-styled a {
    color: #ccc !important; /* ফুটারের টেক্সট এবং লিংক উজ্জ্বল */
}
body.dark-mode .modal-footer-styled a:hover {
    color: #fff !important;
}
/* --- END: CSS --- */

/* ============================================================ */
/*      ADMIN PANEL STYLES (VERSION 10.0 - STICKY FIX)          */
/* ============================================================ */

/* --- FIXED: Admin Button Design and Positioning --- */

/* ১. Admin Button (Pill Shape & Compact) */
#openAdminBtn {
    position: fixed; 
    bottom: 70px !important; 
    z-index: 20000 !important;
    
    background-color: #333; 
    color: white; 
    border: none; 
    
    padding: 8px 15px; 
    border-radius: 30px; 
    
    font-weight: 600; 
    font-size: 0.95em; 
    
    box-shadow: 0 3px 8px rgba(0,0,0,0.3);
    cursor: pointer; 
    transition: background 0.2s, transform 0.1s; 
    
    display: none;
    
    /* মোবাইল ডিফল্ট */
    left: 15px !important; 
}
#openAdminBtn:hover { 
    background-color: #555; 
    transform: translateY(-1px);
}

/* --- START: Total Section (Modern Floating Bar - PILL SHAPE & HIGH ELEVATION - MORE COMPACT) --- */
.total-section {
    position: fixed;
    bottom: 70px; 
    z-index: 90;
    
    background-color: #ffffff; 
    /* ✅ পরিবর্তন: উল্লম্ব প্যাডিং আরও কমানো হলো (আরও স্লিম) */
    padding: 8px 16px; 
    box-sizing: border-box; 
    
    border-radius: 30px; 
    
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2); /* শ্যাডো সামান্য কমানো হয়েছে */
    
    display: flex; 
    justify-content: flex-end;
    align-items: center;
    white-space: nowrap; 
    
    font-size: 1.0em; /* ✅ পরিবর্তন: ফন্ট সাইজ আরও কমানো */
    font-weight: 700; 
    color: #333;
    
    /* মোবাইল ডিফল্ট পজিশন */
    left: auto !important;
    right: 15px !important; 
    max-width: fit-content !important; 
    margin: 0 !important;
    transform: none !important;
}

/* মোট পরিমাণের সংখ্যাকে ফোকাস করা */
.total-section #totalAmount {
    color: var(--primary-color);
    margin-left: 5px; 
}

/* ডার্ক মোডের জন্য */
body.dark-mode .total-section {
    background-color: #3a3a5a; 
    color: #e0e0e0;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.4);
}
body.dark-mode .total-section #totalAmount {
    color: var(--primary-dark-color);
}
body.dark-mode #openAdminBtn {
    background-color: #555;
    color: #e0e0e0;
}


/* ✅ FINAL FIX: Wide Screen Posiioning (চূড়ান্ত সমাধান: কন্টেইনারের ভেতরে থাকবে) */
@media (min-width: 801px) {
    
    /* কন্টেইনারের ভেতরের ফ্লোটিং এলিমেন্টগুলোর জন্য একটি ফিক্সড রেফারেন্স তৈরি করা */
    .container {
        position: relative; /* ফিক্সড বা অ্যাবসোলিউট চাইল্ডদের জন্য পজিশন রেফারেন্স */
    }
    
    /* ১. Admin বাটনকে বাম দিকে কন্টেইনারের ভেতরে রাখা */
    #openAdminBtn {
        /* কন্টেইনারের বাম পাশ থেকে 15px দূরত্বে */
        left: 50% !important; 
        margin-left: -385px !important; /* (800px/2) + 15px বামে */
    }
    
    /* ২. Total Section কে ডান দিকে কন্টেইনারের ভেতরে রাখা */
    .total-section {
        /* কন্টেইনারের ডান পাশ থেকে 15px দূরত্বে */
        right: 50% !important;
        margin-right: -385px !important; /* (800px/2) + 15px ডানে */
        
        /* এখন আর জটিল ট্রান্সফর্মের দরকার নেই, শুধু ডান দিক থেকে সরালেই হবে */
        left: auto !important; 
        transform: none !important;
    }
}
/* --- END: Total Section --- */

/* ২. মেইন কন্টেইনার */
.admin-panel-container {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: #f4f6f9; z-index: 20000; flex-direction: column;
    overflow-y: auto; font-family: 'Segoe UI', sans-serif;
}

/* ৩. হেডার */
.admin-header {
    background: #1e272e; color: white; padding: 10px 20px;
    display: flex; align-items: center; justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 30;
}
.admin-header h2 { margin: 0; font-size: 1.1em; font-weight: 600; }
.icon-btn {
    background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px;
    border-radius: 50%; cursor: pointer; font-size: 0.9em; transition: background 0.3s;
}

/* ৪. কন্টেন্ট এরিয়া */
.admin-content {
    padding: 10px; max-width: 800px; margin: 0 auto; width: 100%; box-sizing: border-box;
    padding-bottom: 80px;
}

/* ৫. কার্ড ও এডিটর */
.admin-card {
    background: white; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05);
    margin-bottom: 15px; overflow: hidden; border: 1px solid #e0e0e0;
}
.card-header { 
    padding: 12px 15px; border-bottom: 1px solid #eee; background: #fff; 
    display: flex; justify-content: space-between; align-items: center;
}
.card-header h3 { margin: 0; font-size: 1.1em; color: #333; display: flex; align-items: center; gap: 8px; }
.user-count-badge { 
    background: #e0e0e0; padding: 2px 10px; border-radius: 12px; 
    font-size: 0.85em; color: #333; font-weight: bold; 
}

/* ৬. এডিটর হেডার */
.editor-card { border-top: 4px solid var(--primary-color); }
.editor-header-content { width: 100%; }
.editor-title-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; }
.editor-title-row h3 { margin: 0; font-size: 1.1em; color: #333; }

.uid-display-box {
    background: #f1f2f6; border: 1px solid #ddd; border-radius: 6px;
    padding: 8px 10px; font-family: monospace; font-size: 0.8em; color: #555;
    margin-bottom: 8px;
}
.uid-actions-row {
    display: flex; justify-content: flex-end; gap: 12px; padding-right: 5px; margin-bottom: 10px;
}
.uid-action-btn { 
    background: none; border: none; cursor: pointer; font-size: 1.1em; transition: transform 0.2s; 
}
.uid-copy-btn { color: var(--primary-color); }
.uid-del-btn { color: #c0392b; }
.uid-action-btn:hover { transform: scale(1.2); }

.uid-manual-search { display: flex; gap: 5px; }
.uid-manual-input { flex: 1; padding: 6px 10px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.9em; }
.uid-manual-btn { padding: 6px 12px; background: #333; color: white; border: none; border-radius: 4px; cursor: pointer; }

.editor-body { padding: 10px; }

/* ৭. ইউজার টেবিল ও অ্যাকশন বাটন */
.user-table-wrapper {
    max-height: 300px; overflow-y: auto; border: 1px solid #eee; border-radius: 8px;
}
.user-table-wrapper thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }

/* টেবিল ফিক্সড লেআউট করা হয়েছে */
.styled-table { 
    width: 100%; 
    border-collapse: collapse; 
    table-layout: fixed; /* এটি বাটনগুলোকে চেপে যাওয়া থেকে রক্ষা করবে */
}

/* ইমেইল এবং নাম ভেঙে নিচে নামানোর লজিক */
.styled-table th, .styled-table td { 
    padding: 10px; 
    border-bottom: 1px solid #eee; 
    text-align: left; 
    font-size: 0.9em; 
    
    /* এই লাইনগুলো ইমেইল ব্রেক করে নিচে নামাবে */
    word-wrap: break-word;
    word-break: break-all; 
    white-space: normal;
}

/* অ্যাকশন কলামের সাইজ এবং বাটন ফিক্স */
.styled-table th:last-child, 
.styled-table td:last-child {
    width: 110px; /* বাটনের জন্য ফিক্সড জায়গা */
    text-align: center;
    white-space: nowrap; /* বাটনগুলো যেন নিচে নিচে না নামে */
}

.user-actions { display: flex; gap: 6px; justify-content: center; }

/* ছোট বাটন */
.manage-btn {
    border: none; width: 26px; height: 26px; border-radius: 50%; 
    cursor: pointer; font-size: 0.8em; color: white;
    display: inline-flex; justify-content: center; align-items: center;
    flex-shrink: 0; /* বাটন চ্যাপ্টা হওয়া রোধ করবে */
}
.btn-user-edit { background: var(--primary-color); }
.btn-user-disable { background: #f39c12; }
.btn-user-enable { background: #27ae60; }
.btn-user-delete { background: #c0392b; }

/* ৮. ভিজ্যুয়াল কন্টেইনার (গুরুত্বপূর্ণ: স্টিকি কাজ করার জন্য) */
.visual-editor-container {
    background: #f9f9f9; border: 1px solid #e0e0e0; border-radius: 8px;
    padding: 0; 
    height: 650px; /* ফিক্সড হাইট */
    display: flex; flex-direction: column;
    overflow: hidden; /* পুরোটা স্ক্রল হবে না */
    margin-bottom: 15px; position: relative;
}

/* ৯. স্টিকি টপ এরিয়া (এটিই আপনার চাহিদামতো স্টিকি হবে) */
.admin-sticky-top {
    flex-shrink: 0; /* এটি সংকুচিত হবে না */
    background-color: #fff; 
    padding: 10px 10px 5px 10px;
    border-bottom: 1px solid #ddd; 
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    z-index: 15; 
    /* স্টিকি পজিশন */
    position: sticky;
    top: 0;
}

/* ১০. স্ক্রলেবল লিস্ট এরিয়া (শুধু এই অংশটি স্ক্রল হবে) */
.admin-scrollable-list {
    flex-grow: 1; /* বাকি সব জায়গা নিয়ে নেবে */
    overflow-y: auto; /* শুধুমাত্র এই অংশটি স্ক্রল হবে */
    padding: 10px; 
    background: #f4f6f9;
    -webkit-overflow-scrolling: touch;
}

/* ১১. সার্চ ইনপুট */
.search-row { position: relative; margin-bottom: 8px; margin-top: 5px; }
.admin-search-input {
    width: 100%; padding: 10px 35px 10px 15px; border: 1px solid #ccc;
    border-radius: 20px; font-size: 1em; box-sizing: border-box; background: #fff;
}
.search-row i { position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: #999; }

/* ১৩. টুলবার (রেসপনসিভ লেআউট: পিসিতে ১ লাইন, মোবাইলে ২ লাইন) */
.admin-toolbar-group {
    background: #fff; 
    padding: 10px; 
    border-radius: 8px; 
    border: 1px solid #ddd; 
    margin-bottom: 10px;
    
    /* মোবাইলে ডিফল্ট আচরণ (ব্লক লেভেল - উপাদানগুলো নিচে নিচে আসবে) */
    display: block;
}

.admin-dropdown-row {
    display: flex;
    width: 100%;
    margin-bottom: 10px; /* মোবাইলে বাটন থেকে দূরত্ব */
}

.admin-list-select {
    width: 100%; /* মোবাইলে ড্রপডাউন পুরো জায়গা নিবে */
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.95em;
}

.admin-btn-group {
    display: flex;
    gap: 8px;
    width: 100%; /* মোবাইলে বাটন গ্রুপ পুরো জায়গা নিবে */
    justify-content: space-between;
}

.btn-tool {
    padding: 8px 12px;
    border: none;
    border-radius: 6px;
    color: white;
    cursor: pointer;
    font-size: 0.9em;
    display: flex;
    align-items: center;
    gap: 5px;
    white-space: nowrap;
}

/* মোবাইলে 'নতুন' বাটনটি বড় হবে এবং লেখা মাঝখানে থাকবে */
.btn-new { 
    background: #27ae60; 
    flex-grow: 1; 
    justify-content: center; 
}
.btn-rename { background: #f39c12; flex-grow: 0; }
.btn-remove { background: #c0392b; flex-grow: 0; }

.btn-center { justify-content: center; }


/* --- পিসি বা ল্যাপটপ ভিউ (Wide Screen Fix) --- */
@media (min-width: 801px) {
    /* পুরো টুলবারটি ফ্লেক্সবক্স হবে, যাতে সব এক লাইনে আসে */
    .admin-toolbar-group {
        display: flex;
        align-items: center;
        gap: 10px; /* ড্রপডাউন এবং বাটনের মাঝখানের গ্যাপ */
    }

    /* ড্রপডাউন রো আর মার্জিন নিবে না এবং অটোমেটিক উইডথ হবে */
    .admin-dropdown-row {
        margin-bottom: 0;
        width: auto;
        flex-grow: 0;
        min-width: 250px; /* ড্রপডাউনটি খুব ছোট হতে দিবে না */
    }
    
    .admin-list-select {
        width: 100%;
    }

    /* বাটন গ্রুপ অটোমেটিক উইডথ হবে */
    .admin-btn-group {
        width: auto;
        justify-content: flex-start;
    }

    /* পিসিতে 'নতুন' বাটনটি আর বড় হবে না */
    .btn-new {
        flex-grow: 0;
        padding-left: 15px;
        padding-right: 15px;
    }
}

/* ১৪. ট্যাব বাটন */
.action-buttons-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
.action-buttons-grid .action-btn {
    border: none; border-radius: 6px; color: white; font-weight: 500; cursor: pointer;
    padding-top: 8px !important; padding-bottom: 8px !important; font-size: 1em;
}
.action-btn.blue { background: #3498db; } .action-btn.purple { background: #9b59b6; }
.action-btn.active-tab { border: 2px solid #333; transform: scale(0.98); opacity: 1 !important; font-weight: bold; }

/* ১৫. শপিং আইটেম */
/* --- START: ADMIN ITEM LIST REPLICATION (USER REQUEST) --- */
/* অ্যাডমিন প্যানেলের জন্য আইটেম কার্ডকে মূল অ্যাপের মতো করা */
.admin-items-wrapper .admin-item-card {
    display: flex;
    flex-direction: column; 
    padding: 8px 12px;
    margin-bottom: 8px;
    border: 1px solid var(--list-item-border-color);
    border-radius: 8px;
    background-color: #fefefe;
    transition: all 0.3s ease;
    position: relative; 
    overflow: hidden; 
    cursor: pointer; 
    
    /* Remove padding-left to put checkbox on the edge */
    padding-left: 12px; 
    border-left: 5px solid var(--primary-color); /* Priority color will override this */
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); /* হালকা শ্যাডো */
}

/* প্রায়োরিটি কালার অ্যাডমিন প্যানেলে */
.admin-item-card.priority-high { border-left-color: var(--expense-color) !important; }
.admin-item-card.priority-medium { border-left-color: #ffc107 !important; }
.admin-item-card.priority-low { border-left-color: var(--primary-color) !important; }

/* কেনা হলে স্টাইল */
.admin-item-card.bought {
    background-color: #f9f9f9;
    color: #777;
    border-color: #ddd;
}
.admin-item-card.bought .admin-item-name-compact,
.admin-item-card.bought .admin-item-total-price-compact {
    text-decoration: line-through;
    color: #999;
}
.admin-item-card.bought .admin-toggle-bought-btn {
    color: var(--income-color);
}


/* কম্প্যাক্ট রো (মূল অ্যাপের .item-compact-row এর রেপ্লিকা) */
.admin-item-compact-row {
    display: flex;
    align-items: center;
    width: 100%;
}

.admin-toggle-bought-btn {
    flex-shrink: 0;
    font-size: 1.4em; 
    margin-right: 12px; 
    color: #999;
    background: none;
    border: none;
    padding: 0;
    cursor: pointer;
    transition: color 0.3s ease;
}

.admin-item-name-compact {
    font-size: 1.05em;
    color: #333;
    font-weight: 500;
    flex-grow: 1;
    margin-right: 12px;
    word-break: break-word;
}

.admin-item-total-price-compact {
    font-weight: bold;
    color: var(--income-color);
    font-size: 1.05em;
    white-space: nowrap;
    flex-shrink: 0;
}

/* এক্সপান্ডেড ডিটেইলস রো (মূল অ্যাপের .item-expanded-details এর রেপ্লিকা) */
.admin-item-expanded-details { 
    display: none; /* JS will change this to flex */
    width: 100%;
    padding-top: 5px;
    border-top: 1px dashed #eee;
    margin-top: 8px;
    justify-content: space-between;
    align-items: center;
}
.admin-item-card.expanded .admin-item-expanded-details {
    display: flex;
}

.admin-item-time-date {
    font-size: 0.85em;
    color: #555;
    flex-grow: 1;
    display: flex;
    align-items: center;
}
.admin-item-time-date i {
    margin-right: 5px;
    color: #555;
}

.admin-item-actions-expanded {
    display: flex;
    gap: 10px;
    flex-shrink: 0;
}
.admin-item-actions-expanded button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1em;
    padding: 5px 8px;
    border-radius: 4px;
}
.admin-item-actions-expanded .btn-edit {
    color: var(--primary-color);
}
.admin-item-actions-expanded .btn-delete {
    color: var(--expense-color);
}
.admin-item-actions-expanded button:hover {
     background-color: #f0f0f0;
}
.admin-item-actions-expanded .btn-delete:hover {
    background-color: #ffe6e6;
}

/* ডার্ক মোড ফিক্স */
body.dark-mode .admin-item-card {
    background-color: #3a3a5a;
    border-color: #444;
}
body.dark-mode .admin-item-name-compact {
    color: #e0e0e0;
}
body.dark-mode .admin-item-total-price-compact {
    color: var(--income-color-dark);
}
body.dark-mode .admin-item-card.bought .admin-item-name-compact,
body.dark-mode .admin-item-card.bought .admin-item-total-price-compact {
    color: #888;
}
body.dark-mode .admin-item-card.bought .admin-toggle-bought-btn {
    color: var(--income-color-dark);
}
body.dark-mode .admin-item-expanded-details {
    border-top-color: #444;
}
body.dark-mode .admin-item-time-date {
    color: #bbb;
}
body.dark-mode .admin-item-time-date i {
    color: #bbb;
}
body.dark-mode .admin-item-actions-expanded button:hover {
     background-color: #4a4a6a;
}
body.dark-mode .admin-item-actions-expanded .btn-delete:hover {
    background-color: #5a3a3a;
}
/* --- END: ADMIN ITEM LIST REPLICATION (USER REQUEST) --- */


/* ১৬. হিসাব খাতা */
.admin-replica-customer {
    background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 10px;
    padding: 12px; display: flex; flex-direction: column; cursor: pointer;
    box-shadow: 0 1px 3px rgba(0,0,0,0.05); -webkit-tap-highlight-color: transparent; user-select: none;
}
.customer-top-section { display: flex; justify-content: space-between; align-items: flex-start; width: 100%; margin-bottom: 8px; }
.cust-info-wrapper { display: flex; gap: 10px; align-items: flex-start; flex-grow: 1; }
.cust-avatar {
    width: 40px; height: 40px; border-radius: 50%; color: white;
    display: flex; justify-content: center; align-items: center; font-weight: bold; flex-shrink: 0; font-size: 1.1em;
}
.cust-name-block { display: flex; flex-direction: column; }
.cust-name { font-size: 1.05em; font-weight: 600; color: #333; line-height: 1.3; }
.ledger-tag { font-size: 0.75em; color: #888; margin-top: 2px; }
.cust-balance-right { text-align: right; font-weight: bold; font-size: 1.1em; white-space: nowrap; margin-left: 10px; }
.balance-red { color: #dc3545; } .balance-green { color: #28a745; } .balance-neutral { color: #777; }
.customer-bottom-section {
    display: flex; justify-content: space-between; align-items: center;
    width: 100%; padding-top: 5px; border-top: 1px dashed #f0f0f0; margin-top: 5px;
}
.cust-phone { font-size: 0.9em; color: #555; font-weight: 500; }
.cust-action-buttons { display: flex; gap: 10px; }
.action-icon-btn {
    background: none; border: none; cursor: pointer; padding: 2px; font-size: 1em; transition: transform 0.2s;
}
.icon-edit { color: #2980b9; } .icon-del { color: #c0392b; } .action-icon-btn:hover { transform: scale(1.2); }

/* ১৭. লেনদেন ও সারাংশ */
.admin-ledger-summary {
    display: flex; justify-content: space-between; background: #fff;
    padding: 12px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 10px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
}
.summary-item { text-align: center; flex: 1; display: flex; flex-direction: column; justify-content: center; }
.summary-item strong { font-size: 1.4em; order: 1; margin-bottom: 3px; }
.summary-item span { font-size: 0.9em; color: #666; order: 2; }
.text-red { color: #dc3545; } .text-green { color: #28a745; }
.all-ledger-header {
    text-align: center; margin-bottom: 8px; background: #e8eaf6; padding: 8px;
    border-radius: 4px; color: var(--primary-color); font-weight: 600; font-size: 0.95em;
}
.ledger-notice-box {
    background: #e8eaf6; color: var(--primary-color); padding: 10px; 
    text-align: center; border-radius: 6px; font-size: 0.9em; margin-bottom: 10px;
    border: 1px solid #d0d4e4;
}
.admin-tx-container { background: #f1f2f6; padding: 10px; border-top: 1px solid #e0e0e0; display: none; }
.tx-table-admin { width: 100%; table-layout: fixed; border-collapse: collapse; background: white; }
.tx-table-admin th, .tx-table-admin td {
    padding: 8px 5px; border: 1px solid #eee; text-align: center; word-wrap: break-word; font-size: 0.85em;
}
.tx-row-admin { cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent; }
.tx-row-admin:hover { background-color: #e8eaf6; }
.tx-row-admin:active { background-color: #dce0e6; }

/* ১৮. পপআপ (আপডেট করা হয়েছে - সব পেজের জন্য নিরাপদ) */

/* ১. সাধারণ মডালের বেস লেভেল */
/* অ্যাডমিন প্যানেল ২০০০০ এ থাকে, তাই মডালকে তার উপরে (২১০০০) রাখা হলো */
.custom-modal { 
    z-index: 21000 !important; 
    background-color: rgba(0, 0, 0, 0.65); /* ব্যাকগ্রাউন্ড একটু গাঢ় */
    transition: opacity 0.2s ease; 
}

/* ২. লেনদেনের বিস্তারিত দেখার মডাল (সাধারণের চেয়ে একটু উপরে) */
/* এটি ২১০০০ এর উপরে থাকবে, কিন্তু এডিট বা কনফার্মেশনের নিচে */
#transactionDetailModal {
    z-index: 22000 !important; 
}

/* ৩. এডিট মডাল (বিস্তারিত মডালের উপরে থাকবে) */
#editTransactionModal {
    z-index: 23000 !important;
}

/* ৪. নিশ্চিতকরণ/সতর্কতা/সাকসেস মডাল (সবার ওপরে থাকবে) */
/* এটি সবার উপরে (৩০,০০০) রাখা হলো যাতে ভুল করেও নিচে না পড়ে */
#confirmationModal, #alertModal, #txConfirmModal {
    z-index: 30000 !important; 
}

/* ক্লোজ বাটন স্টাইল (অপরিবর্তিত) */
.custom-modal-close {
    font-size: 1.5em; color: #555; background: none; border: none;
    position: absolute; top: 10px; right: 15px; cursor: pointer; padding: 5px; z-index: 10;
}
.custom-modal-close:hover { color: red; transform: scale(1.1); }

/* --- Admin Shopping List Total Bar --- */
.admin-total-section {
    background-color: #fff;
    padding: 12px 15px;
    border-top: 1px solid #e0e0e0;
    text-align: right;
    font-weight: bold;
    font-size: 1.1em;
    color: #2c3e50;
    flex-shrink: 0; /* সংকুচিত হবে না */
    z-index: 20;
    box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
}

/* --- START: নীল সিলেকশন এবং প্যারেন্ট ক্লিক ফিক্স (FINAL) --- */

/* ১. মোবাইলে টাচ করলে যে নীল বর্ডার/রং আসে তা বন্ধ করা */
.list-item, 
.admin-item-card,
.list-item *,
.admin-item-card * {
    -webkit-tap-highlight-color: transparent !important;
    outline: none !important;
}

/* ২. এডিট/ডিলিট বাটনে চাপ দিলে প্যারেন্ট আইটেম যেন নড়াচড়া বা কালার চেঞ্জ না করে */
/* লাইট মোড ফিক্স */
.list-item:has(button:active),
.list-item:has(.toggle-bought-btn:active),
.admin-item-card:has(button:active),
.admin-item-card:has(.admin-toggle-bought-btn:active) {
    background-color: #fefefe !important; /* ডিফল্ট ব্যাকগ্রাউন্ড কালার */
    border-color: var(--list-item-border-color) !important;
    transform: none !important;
    box-shadow: none !important;
}

/* আইটেম যদি কেনা (bought) অবস্থায় থাকে */
.list-item.bought:has(button:active),
.admin-item-card.bought:has(button:active) {
    background-color: #f9f9f9 !important; /* কেনা আইটেমের ব্যাকগ্রাউন্ড */
}

/* ৩. ডার্ক মোড ফিক্স */
body.dark-mode .list-item:has(button:active),
body.dark-mode .admin-item-card:has(button:active),
body.dark-mode .list-item:has(.toggle-bought-btn:active),
body.dark-mode .admin-item-card:has(.admin-toggle-bought-btn:active) {
    background-color: #3a3a5a !important; /* ডার্ক মোড ডিফল্ট */
    border-color: #444 !important;
}

body.dark-mode .list-item.bought:has(button:active),
body.dark-mode .admin-item-card.bought:has(button:active) {
    background-color: #333 !important; /* ডার্ক মোডে কেনা আইটেম */
}

/* ৪. শুধুমাত্র বাটনের ক্লিক এনিমেশন চালু রাখা */
.item-actions-expanded button:active,
.admin-item-actions-expanded button:active,
.toggle-bought-btn:active,
.admin-toggle-bought-btn:active {
    transform: scale(0.85); /* বাটন চাপলে ছোট হবে */
    background-color: rgba(0,0,0,0.05); /* বাটনে হালকা শ্যাডো আসবে */
    border-radius: 4px;
    transition: transform 0.1s;
}
/* --- END: CSS FIX --- */

/* --- Admin Drag & Drop Styles --- */
.admin-item-card[draggable="true"] {
    cursor: grab; /* মাউস কার্সার পরিবর্তন */
}
.admin-item-card.dragging {
    opacity: 0.5;
    border: 2px dashed var(--primary-color);
    background-color: #e6f2ff;
}
body.dark-mode .admin-item-card.dragging {
    border-color: #8c9eff;
    background-color: #4a4a6a;
}

/* --- SCREENSHOT REPLICA STYLES (FIXED & RESPONSIVE) --- */

/* Global Box Sizing Fix */
* {
    box-sizing: border-box;
}

/* 1. Header Layout (Dropdown | Plus | Menu) */
.replica-header {
    display: flex;
    align-items: center;
    gap: 8px; /* গ্যাপ কমানো হয়েছে */
    margin-bottom: 15px;
    width: 100%;
}

.replica-dropdown-box {
    flex-grow: 1;
    position: relative;
    background-color: #f2f4f8;
    border-radius: 10px;
    border: 1px solid transparent;
    /* ফ্লেক্সবক্সের ভেতরে টেক্সট ওভারফ্লো আটকানোর জন্য জরুরি */
    min-width: 0; 
}

.replica-select {
    width: 100%;
    padding: 12px 30px 12px 15px; /* অ্যারো আইকনের জন্য ডানে জায়গা */
    font-size: 1em; /* ফন্ট সাইজ সামান্য কমানো */
    font-weight: 600;
    color: #333;
    background: transparent;
    border: none;
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis; /* বড় নাম হলে ... দেখাবে */
}

.replica-dropdown-box::after {
    content: '\f078'; 
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #777;
    pointer-events: none;
    font-size: 0.8em;
}

/* Header Square Buttons */
.header-sq-btn {
    width: 42px; /* বাটন একটু ছোট করা হয়েছে মোবাইলের জন্য */
    height: 42px;
    background-color: #f2f4f8;
    border: none;
    border-radius: 10px;
    color: #444;
    font-size: 1.1em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0; /* বাটন চ্যাপ্টা হবে না */
    transition: background 0.2s;
}
.header-sq-btn:hover { background-color: #e2e6ea; }

/* 2. Shopping Input Area (Card Look) */
.replica-input-container {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    padding: 15px;
    margin-bottom: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.02);
    width: 100%;
}

/* Name Row */
.replica-name-row {
    position: relative;
    margin-bottom: 12px;
    width: 100%;
}
.replica-name-input {
    width: 100%;
    padding: 10px 40px 10px 10px; /* প্যাডিং সামঞ্জস্য */
    font-size: 1.05em;
    border: none;
    border-bottom: 1px dashed #ddd;
    background: transparent;
    outline: none;
    color: #333;
}
.replica-mic-btn {
    position: absolute;
    right: 0;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    color: #666;
    font-size: 1.2em;
    padding: 5px;
    cursor: pointer;
}

/* Bottom Row (Price | Priority | Send) */
.replica-bottom-row {
    display: flex;
    gap: 8px; /* গ্যাপ কমানো */
    align-items: center;
    width: 100%;
}

.replica-pill-input {
    flex: 1; /* সমান জায়গা নিবে */
    background-color: #f2f4f8;
    border: none;
    border-radius: 25px;
    padding: 10px;
    font-size: 0.9em;
    color: #333;
    outline: none;
    text-align: center;
    min-width: 0; /* ওভারফ্লো ফিক্স */
}

.replica-pill-select {
    flex: 1.2; /* একটু বেশি জায়গা নিবে */
    background-color: #f2f4f8;
    border: none;
    border-radius: 25px;
    padding: 10px 5px; /* প্যাডিং কমানো */
    font-size: 0.9em;
    color: #333;
    outline: none;
    cursor: pointer;
    text-align-last: center;
    -webkit-appearance: none;
    appearance: none;
    min-width: 0; /* ওভারফ্লো ফিক্স */
}

/* Send Button */
.replica-send-btn {
    width: 42px; /* সাইজ ফিক্স */
    height: 42px;
    background-color: #3f51b5;
    color: white;
    border: none;
    border-radius: 50%;
    font-size: 1.1em;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 10px rgba(63, 81, 181, 0.3);
    flex-shrink: 0; /* বাটন চ্যাপ্টা হবে না */
    transition: transform 0.2s;
}
.replica-send-btn i { margin-left: -2px; margin-top: 2px; }

/* 3. Ledger Summary Card */
.replica-summary-card {
    background: #fff;
    border: 1px solid #eee;
    border-radius: 15px;
    padding: 15px 10px;
    display: flex;
    justify-content: space-around; /* সমান দূরত্ব */
    align-items: center;
    margin-bottom: 20px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.03);
    width: 100%;
}
.summary-part {
    text-align: center;
    flex: 1;
}
.summary-label {
    font-size: 0.85em;
    color: #777;
    margin-bottom: 5px;
    display: block;
}
.summary-val {
    font-size: 1.3em;
    font-weight: bold;
    display: block;
    word-break: break-all; /* বড় সংখ্যা ভেঙে নিচে আসবে */
}
.summary-divider {
    width: 1px;
    height: 30px;
    background-color: #e0e0e0;
    margin: 0 10px;
}
.val-red { color: var(--expense-color); }
.val-green { color: var(--income-color); }

/* --- UNIFIED FINAL FIXES (Dropdown, Input, Dark Mode Overrides) --- */

/* ১. ড্রপডাউন মেনু পজিশনিং (Replica Header Logic) */
.replica-header {
    position: relative; 
    z-index: 50; /* অন্য কন্টেন্টের উপরে রাখার জন্য */
}

.action-dropdown-menu {
    display: none;
    position: absolute;
    top: 50px; /* বাটনের ঠিক নিচে */
    right: 0;
    
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 25px rgba(0,0,0,0.15);
    width: 200px;
    
    /* ✅ পরিবর্তন ১: Z-Index উঁচু মান দেওয়া হলো (সবার উপরে থাকার জন্য) */
    z-index: 10000 !important; 
    
    border: 1px solid #eee;
    padding: 8px 0;
    margin-top: 5px;
    transform-origin: top right;
    animation: menuPop 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.action-dropdown-menu.show {
    display: block;
}

.action-dropdown-menu button {
    width: 100%;
    text-align: left;
    padding: 12px 20px;
    background: transparent;
    border: none;
    font-size: 0.95em;
    color: #444;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 12px;
    transition: background 0.2s;
}

.action-dropdown-menu button:hover {
    background-color: #f5f7fa;
    color: var(--primary-color);
}

.action-dropdown-menu button i {
    width: 20px;
    text-align: center;
    color: #777;
}

.action-dropdown-menu button.text-danger {
    color: #e74c3c;
}
.action-dropdown-menu button.text-danger:hover {
    background-color: #fff5f5;
}

@keyframes menuPop {
    from { opacity: 0; transform: scale(0.9) translateY(-10px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
}

/* ২. ডার্ক মোড ওভাররাইড ফিক্স (Unified) */

/* ✅ ফিক্স ১: ড্রপডাউন মেনুর ডার্ক মোড */
body.dark-mode .action-dropdown-menu {
    background-color: #3a3a5a;
    border-color: #555;
    box-shadow: 0 5px 25px rgba(0,0,0,0.4);
}
body.dark-mode .action-dropdown-menu button {
    color: #e0e0e0;
}
body.dark-mode .action-dropdown-menu button:hover {
    background-color: #4a4a6a;
}

/* ✅ ফিক্স ২: ইনপুট এরিয়া এবং সামারি কার্ডের ডার্ক মোড ফিক্স */
body.dark-mode .replica-dropdown-box,
body.dark-mode .header-sq-btn,
body.dark-mode .replica-pill-input,
body.dark-mode .replica-pill-select {
    background-color: #3a3a5a !important; /* ইনপুটগুলো */
    color: #e0e0e0 !important;
}
body.dark-mode .replica-input-container,
body.dark-mode .replica-summary-card {
    background-color: #2a2a4a !important; /* ✅ পাবো/দেবো কার্ডের সাদা ব্যাকগ্রাউন্ড ফিক্স */
    border-color: #444 !important;
}
body.dark-mode .replica-name-input {
    color: #e0e0e0 !important;
    border-bottom-color: #555 !important;
}

/* --- SCREENSHOT EXACT MATCH STYLES --- */

/* ১. মেইন ট্যাব ডিজাইন (Segmented Control) */
.view-switcher {
    background-color: #f2f4f8; /* কন্টেইনারের হালকা ধূসর রঙ */
    padding: 6px; /* বাটন এবং কন্টেইনারের মাঝের ফাঁকা জায়গা */
    border-radius: 12px;
    border: none; /* আগের বর্ডার মুছে ফেলা হলো */
    display: flex;
    gap: 0;
    margin-bottom: 25px;
    box-shadow: inset 0 1px 3px rgba(0,0,0,0.02); /* ভেতরের দিকে হালকা শ্যাডো */
}

.view-switcher button {
    flex: 1;
    padding: 10px 15px;
    font-size: 1.05em;
    font-weight: 600;
    border: none;
    border-radius: 8px; /* বাটনের গোল কোণা */
    background-color: transparent; /* ডিফল্ট ব্যাকগ্রাউন্ড স্বচ্ছ */
    color: #666; /* ডিফল্ট টেক্সট কালার */
    transition: all 0.2s ease;
    box-shadow: none;
}

.view-switcher button:hover {
    background-color: rgba(255,255,255,0.5);
}

/* অ্যাক্টিভ বাটন (সাদা কার্ডের মতো দেখাবে) */
.view-switcher button.active {
    background-color: #ffffff;
    color: #3f51b5; /* নীল টেক্সট */
    box-shadow: 0 2px 6px rgba(0,0,0,0.08); /* সুন্দর শ্যাডো */
    transform: none; /* ক্লিক ইফেক্ট রিসেট */
}

/* ২. ড্রপডাউন ডিজাইন (সাদা বক্স + বর্ডার) */
.replica-dropdown-box {
    background-color: #ffffff !important; /* সাদা ব্যাকগ্রাউন্ড */
    border: 1px solid #e0e0e0 !important; /* হালকা বর্ডার */
    border-radius: 12px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.02);
}

.replica-select {
    font-weight: 500;
    color: #333;
}

/* ৩. পাশের বাটন ডিজাইন (+ এবং :) */
.header-sq-btn {
    background-color: #f2f4f8 !important; /* হালকা ধূসর ব্যাকগ্রাউন্ড */
    border: none !important;
    border-radius: 12px;
    color: #444;
}
.header-sq-btn:hover {
    background-color: #e2e6ea !important;
}

/* --- Dark Mode Adjustments (যাতে ডার্ক মোডেও সুন্দর লাগে) --- */
body.dark-mode .view-switcher {
    background-color: #2a2a4a; /* ডার্ক কন্টেইনার */
}
body.dark-mode .view-switcher button {
    color: #bbb;
}
body.dark-mode .view-switcher button.active {
    background-color: #3a3a5a; /* ডার্ক অ্যাক্টিভ বাটন */
    color: #8c9eff;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2);
}

body.dark-mode .replica-dropdown-box {
    background-color: #2a2a4a !important;
    border-color: #444 !important;
}
body.dark-mode .header-sq-btn {
    background-color: #2a2a4a !important;
    color: #e0e0e0;
}

/* --- FIXED: Dropdown Border & Focus Style --- */

/* ১. ড্রপডাউনের বক্স স্টাইল */
.replica-dropdown-box {
    position: relative;
    background-color: #f2f4f8; /* হালকা ব্যাকগ্রাউন্ড */
    border-radius: 10px;
    border: 1px solid transparent; /* ডিফল্ট ট্রান্সপারেন্ট বর্ডার */
    min-width: 0;
    transition: all 0.2s ease; /* স্মুথ ট্রানজিশন */
}

/* ফোকাস বা সিলেক্ট করলে বর্ডার মোটা না হয়ে হালকা নীল হবে */
.replica-dropdown-box:focus-within {
    background-color: #fff;
    border-color: #3f51b5; /* প্রাইমারি কালার */
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1); /* হালকা গ্লো */
}

/* ২. ড্রপডাউন সিলেক্ট এলিমেন্ট */
.replica-select {
    width: 100%;
    padding: 12px 30px 12px 15px;
    font-size: 1em;
    font-weight: 600;
    color: #333;
    background: transparent;
    border: none;
    outline: none !important; /* ব্রাউজারের ডিফল্ট বর্ডার বন্ধ */
    appearance: none;
    -webkit-appearance: none;
    cursor: pointer;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* ফোকাস অবস্থায় ডিফল্ট আউটলাইন বন্ধ করা */
.replica-select:focus {
    outline: none;
    border: none;
}

/* অ্যারো আইকন ফিক্স */
.replica-dropdown-box::after {
    content: '\f078'; 
    font-family: "Font Awesome 5 Free";
    font-weight: 900;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    color: #777;
    pointer-events: none;
    font-size: 0.8em;
    transition: transform 0.2s; /* ঘোরার এনিমেশন */
}

/* সিলেক্ট করলে অ্যারো আইকন একটু ঘুরবে (অপশনাল সুন্দর ইফেক্ট) */
.replica-dropdown-box:focus-within::after {
    color: #3f51b5;
    transform: translateY(-50%) rotate(180deg);
}

/* ডার্ক মোড সাপোর্ট */
body.dark-mode .replica-dropdown-box {
    background-color: #3a3a5a;
    border-color: transparent;
}
body.dark-mode .replica-dropdown-box:focus-within {
    background-color: #3a3a5a;
    border-color: #8c9eff;
    box-shadow: 0 0 0 3px rgba(140, 158, 255, 0.2);
}
body.dark-mode .replica-select {
    color: #e0e0e0;
}

/* --- FIXED: Header Buttons Style (Profile & Dark Mode) - FINAL LAYOUT --- */

/* ১. প্রধান Header Controls কন্টেইনার */
.header-controls {
    display: flex;
    justify-content: flex-start; /* বাম দিকে শুরু হবে */
    align-items: center;
    margin-bottom: 15px;
    position: relative;
    height: 42px; /* বাটনগুলোর উচ্চতা অনুযায়ী ফিক্সড হাইট */
}


/* ২. গোল বাটন ডিজাইন (Info, Dark Mode, Profile) */
.header-controls .dark-mode-toggle,
.header-controls .profile-button,
.header-controls .info-button {
    width: 42px;          
    height: 42px;         
    background-color: #f2f4f8; 
    border-radius: 50%;   
    border: none;
    color: #444;          
    font-size: 1.2em; /* আইকন সাইজ */
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    padding: 0;
    flex-shrink: 0; /* জায়গা কমলে ছোট হবে না */
}

/* ৩. ফন্ট সাইজ কন্ট্রোলস (বাটনগুলো গোল হবে) */
.font-size-controls {
    display: flex;
    gap: 5px; /* গোল বাটনের মাঝে গ্যাপ */
    align-items: center;
    
    /* ✅ পরিবর্তন: Info বাটনের পর এটি বামে চেপে থাকবে এবং মাঝখানে ফাঁকা জায়গা তৈরি হবে */
    margin-right: auto; 
    margin-left: 10px;
}
.font-size-controls button {
    /* ✅ পরিবর্তন: ছোট গোল বাটন */
    width: 32px; 
    height: 32px;
    background: #f2f4f8;
    border: none; /* বর্ডার সরালাম */
    border-radius: 50%; /* গোল শেপ */
    padding: 0;
    font-size: 0.9em; /* ফন্ট কমানো */
    cursor: pointer;
    color: #777;
    transition: all 0.2s ease;
    flex-shrink: 0;
}


/* ৪. হোভার ইফেক্ট */
.header-controls .dark-mode-toggle:hover,
.header-controls .profile-button:hover,
.header-controls .info-button:hover,
.font-size-controls button:hover:not(.active) {
    background-color: #e2e6ea; 
    color: var(--primary-color);
}
.font-size-controls button:active {
    transform: none; /* ডিফল্ট ট্রান্সফর্ম বন্ধ */
}

/* অ্যাক্টিভ ফন্ট বাটন */
.font-size-controls button.active {
    background-color: var(--primary-color);
    color: white;
}
.font-size-controls button.active:hover {
     background-color: #303f9f;
     color: white;
}

/* ৫. ডান দিকে বাটনগুলোর মাঝখানে গ্যাপ */
/* প্রোফাইল বাটনের বামে গ্যাপ */
.header-controls .profile-button {
    margin-left: 10px; 
}
/* ডার্ক মোড বাটনের বামে গ্যাপ (ইনফো এর পর ফন্ট সাইজ কন্ট্রোল শেষ হওয়ার পর) */
.header-controls .dark-mode-toggle {
     margin-left: auto; /* এই লাইনটি মুছে ফেলার পর বামে স্পেস যোগ করা হলো */
}
/* Info বাটনের ঠিক পরে ফন্ট সাইজ কন্ট্রোল চলে আসবে */
.header-controls .info-button {
    margin-left: 0; /* একদম বামে চেপে থাকবে */
}


/* ৬. ডার্ক মোড ফিক্স */
body.dark-mode .header-controls .dark-mode-toggle,
body.dark-mode .header-controls .profile-button,
body.dark-mode .header-controls .info-button,
body.dark-mode .font-size-controls button {
    background-color: #3a3a5a; 
    color: #e0e0e0;
}
body.dark-mode .header-controls .dark-mode-toggle:hover,
body.dark-mode .header-controls .profile-button:hover,
body.dark-mode .header-controls .info-button:hover,
body.dark-mode .font-size-controls button:hover:not(.active) {
    background-color: #4a4a6a;
}
body.dark-mode .font-size-controls button.active {
    background-color: var(--primary-dark-color);
    color: white;
}

/* --- FIXED: Shopping List Search Bar (Like Ledger Style) --- */

.shopping-list-search-bar {
    position: -webkit-sticky;
    position: sticky;
    top: 0;
    z-index: 5;
    background-color: #fff; /* স্টিকি হওয়ার সময় পেছনের কন্টেন্ট ঢাকবে */
    padding: 10px 0;
    margin-bottom: 15px;
}

.shopping-list-search-bar input {
    width: 100%;
    padding: 12px 20px 12px 45px; /* আইকনের জন্য বামে জায়গা */
    border-radius: 12px; /* হিসাব খাতার মতো স্টাইল */
    border: 1px solid #e0e0e0;
    font-size: 1em;
    box-sizing: border-box;
    background-color: #fff;
    color: #333;
    outline: none;
    transition: border-color 0.2s ease;
}

.shopping-list-search-bar input:focus {
    border-color: var(--primary-color);
}

.shopping-list-search-bar input::placeholder {
    color: #999;
}

/* সার্চ আইকন পজিশনিং */
.shopping-list-search-bar .fa-search {
    position: absolute;
    top: 50%;
    left: 15px;
    transform: translateY(-50%);
    color: #888;
    font-size: 1.1em;
    pointer-events: none;
}

/* ডার্ক মোড ফিক্স */
body.dark-mode .shopping-list-search-bar {
    background-color: #2a2a4a; /* কন্টেইনারের সাথে মিল রেখে */
}
body.dark-mode .shopping-list-search-bar input {
    background-color: #3a3a5a;
    border-color: #555;
    color: #e0e0e0;
}
body.dark-mode .shopping-list-search-bar .fa-search {
    color: #bbb;
}

/* --- Ultra Minimal Full-Width Status Bar (FINAL FIXED) --- */
.ledger-status-msg {
    width: 100%;
    
    /* ✅ পরিবর্তন: টেক্সট-অ্যালাইনমেন্টের বদলে Flexbox ব্যবহার */
    display: flex; 
    align-items: center; /* উল্লম্বভাবে মাঝখানে (Vertical Center) */
    justify-content: center; /* অনুভূমিকভাবে মাঝখানে (Horizontal Center) */
    
    gap: 8px;
    
    background-color: #eef6fc; 
    color: #1976d2; 
    
    padding: 10px; 
    border-radius: 12px; 
    
    font-size: 0.95em;
    font-weight: 600;
    margin-bottom: 15px;
    
    box-sizing: border-box;
    border: none;
    box-shadow: none;
}

.ledger-status-msg i {
    font-size: 1em;
    opacity: 0.8; 
}

/* ডার্ক মোড */
body.dark-mode .ledger-status-msg {
    background-color: rgba(63, 81, 181, 0.15); 
    color: #8c9eff;
    border: none;
}

/* --- SWIPE SHADOW FIX --- */

/* ১. ট্যাপ হাইলাইট কালার সম্পূর্ণ বন্ধ করা (মোবাইলের জন্য) */
* {
    -webkit-tap-highlight-color: transparent !important;
}

/* ২. ফোকাস বা এক্টিভ অবস্থায় আউটলাইন বন্ধ করা */
*:focus, *:active {
    outline: none !important;
    box-shadow: none !important;
}

/* ৩. ট্যাবের বাটনগুলোর জন্য স্পেশাল ফিক্স */
.view-switcher button:active,
.view-switcher button:focus {
    background-color: transparent !important; /* ব্যাকগ্রাউন্ড কালার চেঞ্জ হবে না */
    box-shadow: none !important; /* কোনো শ্যাডো আসবে না */
}

/* ৪. অ্যাক্টিভ ট্যাবের জন্য শ্যাডো ঠিক রাখা (যাতে সুন্দর ডিজাইনটা থাকে) */
.view-switcher button.active:active,
.view-switcher button.active:focus {
    background-color: #ffffff !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.08) !important;
}

/* ডার্ক মোডের জন্য */
body.dark-mode .view-switcher button.active:active,
body.dark-mode .view-switcher button.active:focus {
    background-color: #3a3a5a !important;
    box-shadow: 0 2px 6px rgba(0,0,0,0.2) !important;
}

/* --- MODERN APP DESIGN (Facebook/Google Style) --- */

/* ১. সার্চ বার ডিজাইন (উভয় সেকশনের জন্য - ইউনিফাইড) */
.ledger-search-bar input,
.shopping-list-search-bar input {
    width: 100%;
    padding: 14px 20px 14px 45px; /* টেক্সট এবং আইকনের প্যাডিং */
    border-radius: 12px; /* ১২ পিক্সেল রাউন্ড */
    
    /* ✅ নরমাল মোড: তালিকার বর্ডারের মতো কালার */
    border: 1px solid #e0e0e0; 
    
    font-size: 1em;
    background-color: #ffffff; /* সাদা ব্যাকগ্রাউন্ড */
    color: #333;
    outline: none;
    transition: all 0.2s ease;
    box-shadow: none; /* কোনো ডিফল্ট শ্যাডো থাকবে না */
}

/* ✅ ক্লিক বা ফোকাস করলে নীল বর্ডার */
.ledger-search-bar input:focus,
.shopping-list-search-bar input:focus {
    background-color: #fff;
    border-color: var(--primary-color); /* নীল বর্ডার */
    box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.1); /* হালকা নীল গ্লো */
}

/* সার্চ আইকন পজিশন */
.ledger-search-bar .fa-search,
.shopping-list-search-bar .fa-search {
    position: absolute;
    top: 50%;
    left: 18px;
    transform: translateY(-50%);
    color: #999;
    font-size: 1.1em;
    pointer-events: none;
    z-index: 2;
}

/* সার্চ বারের আইকন ঠিক রাখার জন্য কন্টেইনার */
.ledger-search-bar {
    position: relative;
    margin-bottom: 15px; /* চাইলে একটু গ্যাপ রাখতে পারেন */
}

/* --- ডার্ক মোড (Dark Mode) - অ্যাডজাস্টমেন্ট --- */
body.dark-mode .ledger-search-bar input,
body.dark-mode .shopping-list-search-bar input {
    background-color: #3a3a5a;
    
    /* ✅ ডার্ক মোড: হালকা কালো বর্ডার */
    border-color: #444; 
    
    color: #e0e0e0;
}

body.dark-mode .ledger-search-bar input:focus,
body.dark-mode .shopping-list-search-bar input:focus {
    background-color: #2a2a4a;
    
    /* ✅ ডার্ক মোড ফোকাস: নীল বর্ডার */
    border-color: #8c9eff; 
    box-shadow: 0 0 0 3px rgba(140, 158, 255, 0.1);
}

body.dark-mode .ledger-search-bar .fa-search,
body.dark-mode .shopping-list-search-bar .fa-search {
    color: #bbb;
}

/* ২. হিসাব খাতার সারাংশ কার্ড (পাবো/দেবো - Floating Card) */
.replica-summary-card {
    background: #fff;
    border: 1px solid #f0f0f0; /* বর্ডার প্রায় অদৃশ্য */
    border-radius: 16px; /* রাউন্ডেড কর্নার */
    
    /* উচ্চতা বাড়ানো এবং ভেসে থাকার ইফেক্ট */
    padding: 25px 10px; /* উপরে-নিচে জায়গা বাড়ানো হয়েছে */
    margin-bottom: 25px;
    
    /* ভাসমান শ্যাডো (Google Style) */
    box-shadow: 0 8px 24px rgba(149, 157, 165, 0.15); 
    
    display: flex;
    justify-content: space-around;
    align-items: center;
    position: relative;
    overflow: hidden;
}

/* কার্ডের ভেতরের টেক্সট */
.summary-label {
    font-size: 0.9em;
    color: #666;
    margin-top: 5px;    /* ✅ পরিবর্তন: এখন উপরে ফাঁকা থাকবে */
    margin-bottom: 0;   /* ✅ পরিবর্তন: নিচে ফাঁকা দরকার নেই */
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.summary-val {
    font-size: 1.6em; /* টাকার ফন্ট বড় করা হয়েছে */
    font-weight: 700;
    font-family: 'Segoe UI', sans-serif; /* ক্লিন ফন্ট */
}

/* মাঝখানের দাগ */
.summary-divider {
    width: 1px;
    height: 50px; /* দাগ বড় করা হয়েছে */
    background-color: #eee;
}

/* ৩. সাধারণ বর্ডার এবং বাটন ফিক্স */
.replica-dropdown-box,
.header-sq-btn {
    border-radius: 12px;
    background-color: #f2f4f8; /* সফট ব্যাকগ্রাউন্ড */
    border: 1px solid transparent; /* বর্ডার বাদ */
}

.replica-dropdown-box {
    box-shadow: none; /* ড্রপডাউন ফ্ল্যাট */
}

/* ৪. ডার্ক মোড (Dark Mode) - অ্যাডজাস্টমেন্ট */
body.dark-mode .ledger-search-bar input,
body.dark-mode .shopping-list-search-bar input {
    background-color: #3a3a5a;
    border-color: #444;
    color: #e0e0e0;
}
body.dark-mode .ledger-search-bar input:focus,
body.dark-mode .shopping-list-search-bar input:focus {
    background-color: #2a2a4a;
    border-color: #8c9eff;
}
body.dark-mode .replica-summary-card {
    background-color: #2a2a4a;
    border-color: #444;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3); /* ডার্ক শ্যাডো */
}
body.dark-mode .summary-divider {
    background-color: #444;
}

/* --- আধুনিক গাইডলাইন স্টাইল (Modern Minimal User Guide) --- */

.guide-container {
    display: flex;
    flex-direction: column;
    gap: 15px;
    padding: 5px 0;
}

.guide-card {
    display: flex;
    align-items: flex-start;
    background: #ffffff;
    border: 1px solid #f0f0f0;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.02);
    transition: transform 0.2s ease, border-color 0.2s ease;
}

.guide-card:hover {
    transform: translateY(-2px);
    border-color: var(--primary-color);
    box-shadow: 0 5px 15px rgba(0,0,0,0.05);
}

/* আইকন বক্স */
.guide-icon-wrapper {
    flex-shrink: 0;
    width: 42px;
    height: 42px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2em;
    margin-right: 15px;
}

.guide-content {
    flex-grow: 1;
    min-width: 0;
}

.guide-content h4 {
    margin: 0 0 8px 0;
    font-size: 1.1em;
    color: #2c3e50;
    font-weight: 700;
}

.guide-content p {
    font-size: 0.95em;
    color: #555;
    line-height: 1.5;
    margin-bottom: 8px;
    text-align: left;
}

/* লিস্ট স্টাইল */
.guide-content ul {
    margin: 0;
    padding-left: 0;
    list-style: none;
}

.guide-content ul li {
    position: relative;
    padding-left: 18px;
    margin-bottom: 6px;
    font-size: 0.92em;
    color: #444;
    line-height: 1.5;
    text-align: left;
}

/* কাস্টম বুলেট পয়েন্ট */
.guide-content ul li::before {
    content: '';
    position: absolute;
    left: 0;
    top: 8px;
    width: 6px;
    height: 6px;
    background-color: var(--primary-color);
    border-radius: 50%;
}

/* লেখার মাঝখানের ছোট আইকন বাটন (ডিফল্ট) */
.inline-icon-visual {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 0.8em;
    vertical-align: middle;
    margin: 0 4px;
    box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    background-color: #f2f4f8;
    color: #444;
}

/* গ্রাহক যোগ করার বাটন স্টাইল (অ্যাপের FAB বাটনের মতো) */
.guide-content .inline-icon-visual.fab-style {
    background-color: var(--primary-color) !important;
    color: white !important;
    box-shadow: 0 2px 5px rgba(63, 81, 181, 0.3);
}

/* ফুটার বাটন */
.contact-btn-styled {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 10px;
    padding: 10px 25px;
    background: linear-gradient(135deg, var(--primary-color) 0%, #5c6bc0 100%);
    color: white !important;
    border-radius: 25px;
    text-decoration: none;
    font-weight: 600;
    font-size: 0.95em;
    transition: all 0.3s ease;
    box-shadow: 0 4px 10px rgba(63, 81, 181, 0.3);
}
.contact-btn-styled:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 15px rgba(63, 81, 181, 0.4);
}

/* --- ডার্ক মোড সাপোর্ট --- */

body.dark-mode .guide-card {
    background: #2a2a4a;
    border-color: #444;
}
body.dark-mode .guide-content h4 { color: #e0e0e0; }
body.dark-mode .guide-content p, 
body.dark-mode .guide-content ul li { color: #bbb; }
body.dark-mode .guide-icon-wrapper { opacity: 0.9; }

/* ডার্ক মোডে ইনলাইন বাটন */
body.dark-mode .inline-icon-visual { 
    background-color: #333 !important; 
    color: #e0e0e0 !important; 
}

/* ডার্ক মোডে গ্রাহক বাটন */
body.dark-mode .guide-content .inline-icon-visual.fab-style {
    background-color: var(--primary-dark-color) !important;
    color: white !important;
}

/* ডার্ক মোডে টাইটেল ও সাবটাইটেল */
body.dark-mode #infoModalOverlay .info-modal-header h2 {
    color: #ffffff !important;
}
body.dark-mode #infoModalOverlay .info-modal-header p {
    color: #e0e0e0 !important;
}

/* ডার্ক মোডে ধন্যবাদ বার্তার বক্স */
body.dark-mode .thank-you-box {
    background-color: #2a2a4a !important;
    border-color: #444 !important;
}
body.dark-mode .thank-you-box p {
    color: #e0e0e0 !important;
}

/* --- Admin New UID Controls Styles --- */
.uid-display-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: #f8f9fa;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 10px;
}

.uid-text-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: monospace;
    font-size: 0.9em;
    color: #555;
    background: #fff;
    padding: 5px 10px;
    border: 1px solid #eee;
    border-radius: 4px;
}

.uid-copy-btn-inline {
    background: none;
    border: none;
    cursor: pointer;
    color: var(--primary-color);
    font-size: 1.1em;
    padding: 2px 8px;
}

.uid-action-buttons-row {
    display: flex;
    gap: 10px;
}

.uid-action-btn-block {
    flex: 1;
    padding: 6px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    color: white;
    font-size: 0.85em;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
}

.btn-reset-data { background-color: #f39c12; } /* Orange for Reset */
.btn-delete-acc { background-color: #c0392b; } /* Red for Delete */

.manual-uid-box {
    display: flex;
    gap: 5px;
    margin-top: 5px;
    border-top: 1px dashed #ccc;
    padding-top: 8px;
}

.manual-uid-input {
    flex: 1;
    padding: 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    font-size: 0.9em;
}

.manual-uid-submit {
    padding: 8px 15px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

/* UID Input Error Styles */
.manual-uid-input.input-error {
    border-color: #dc3545 !important; /* লাল বর্ডার */
    background-color: #fff8f8 !important; /* হালকা লাল ব্যাকগ্রাউন্ড */
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1) !important;
    animation: shake 0.3s; /* একটু নড়ে উঠবে */
}

.uid-inline-error {
    color: #dc3545;
    font-size: 0.85em;
    font-weight: 600;
    margin-bottom: 5px;
    display: none; /* ডিফল্টভাবে লুকানো থাকবে */
    text-align: left;
    padding-left: 2px;
}

/* Shake Animation */
@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    50% { transform: translateX(5px); }
    75% { transform: translateX(-5px); }
    100% { transform: translateX(0); }
}

/* --- ১. বিরক্তিকর নীল বর্ডার এবং হাইলাইট সম্পূর্ণ বন্ধ করা --- */
* {
    -webkit-tap-highlight-color: transparent !important;
    outline: none !important;
}

/* --- ২. লগইন এবং গুগল বাটনের স্মুথ ট্রানজিশন --- */
.auth-btn, 
.google-sign-in-btn {
    transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1), background-color 0.2s ease;
    user-select: none; /* টেক্সট সিলেক্ট হবে না */
    -webkit-user-select: none;
    cursor: pointer;
    position: relative;
    overflow: hidden; /* ইফেক্ট ভেতরেই থাকবে */
}

/* --- ৩. বাটনে চাপ দিলে (Active State) - সুন্দর ক্লিক ইফেক্ট --- */
.auth-btn:active, 
.google-sign-in-btn:active {
    transform: scale(0.96) !important; /* বাটনটি সামান্য ছোট হয়ে যাবে (Press Feel) */
    opacity: 0.9;
}

/* গুগল বাটনে চাপ দিলে ব্যাকগ্রাউন্ড একটু গাঢ় হবে */
.google-sign-in-btn:active {
    background-color: #f1f3f4 !important; 
    border-color: #bbb !important;
}

/* ডার্ক মোডে গুগল বাটনের ক্লিক কালার */
body.dark-mode .google-sign-in-btn:active {
    background-color: #4a4a6a !important;
    border-color: #666 !important;
}

/* --- ৪. প্যারেন্ট কন্টেইনার (লগইন কার্ড) এর নড়াচড়া বা বর্ডার লক করা --- */
/* এটিই আপনার মূল সমস্যার সমাধান করবে */
.login-card-d12,
.login-card-d12:active,
.login-card-d12:focus,
.login-card-d12:focus-within {
    /* কার্ডের ডিফল্ট স্টাইল ধরে রাখা, যাতে ক্লিক করলে চেঞ্জ না হয় */
    outline: none !important;
    border: 1px solid rgba(255, 255, 255, 0.3) !important; /* আপনার ডিফল্ট বর্ডার কালার */
    box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37) !important; /* আপনার ডিফল্ট শ্যাডো */
    transform: none !important; /* কার্ড নড়বে না */
    background: rgba(255, 255, 255, 0.7) !important;
}

/* ডার্ক মোডে কার্ড লক রাখা */
body.dark-mode .login-card-d12,
body.dark-mode .login-card-d12:active {
    border: 1px solid rgba(255, 255, 255, 0.1) !important;
    box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5) !important;
    background: rgba(42, 42, 74, 0.7) !important;
}

    </style>
    <!-- Google Fonts for Bengali -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="auth-loading">
    <!-- START: উন্নত লোডার (প্রোগ্রেস বার সহ) -->
<div id="loader" class="loader-overlay" style="display: none;">
    <div class="loading-content">
        <!-- নতুন প্রোগ্রেস বার যুক্ত করা হলো -->
        <div id="progressContainer" class="progress-container">
            <span id="progressLabel" class="progress-label"></span>
            <progress id="progressBar" value="0" max="100"></progress>
        </div>
        
        <div class="dot-pulse">
            <span></span>
            <span></span>
            <span></span>
        </div>
        <p id="loadingMessage" class="loading-text">লোড হচ্ছে...</p>
    </div>
</div>
<!-- END: উন্নত লোডার (প্রোগ্রেস বার সহ) -->

    <!-- লগইন ভিউ (কমপ্যাক্ট ডিজাইন) -->
    <div id="login-view" style="display: none;">
        <div class="login-card-d12">
            <div class="app-icon"><i class="fas fa-shopping-cart"></i> &nbsp; <i class="fas fa-book-open"></i></div>
            <h1>তালিকা ও হিসাব খাতা</h1>
            
<!-- START: নতুন ইমেইল/পাসওয়ার্ড ফর্ম (আপডেট করা হয়েছে) -->
<div id="emailAuthContainer">
    <!-- লগইন ফর্ম (পরিবর্তিত - Floating Label সহ) -->
<form id="loginForm" style="display: block;" novalidate>
    <div class="auth-input-group floating-label-group">
        <input type="email" id="loginEmail" required autocomplete="username" placeholder="">
        <label for="loginEmail">ইমেইল</label>
        <span class="error-message"></span>
    </div>
    <div class="auth-input-group floating-label-group password-input-wrapper">
        <input type="password" id="loginPassword" required autocomplete="current-password" placeholder="">
        <label for="loginPassword">পাসওয়ার্ড</label>
        <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
        <span class="error-message"></span>
    </div>
    <button type="submit" class="auth-btn">লগইন করুন</button>
    <p class="auth-switch-text">
        অ্যাকাউন্ট নেই? <a href="#" id="showRegisterFormLink">এখানে সাইন আপ করুন</a>
    </p>
    <!-- ডুপ্লিকেট 'পাসওয়ার্ড ভুলে গেছেন?' লিঙ্কটি এখান থেকে মুছে ফেলা হলো -->
</form>

<!-- রেজিস্ট্রেশন ফর্ম (পরিবর্তিত - Floating Label সহ) -->
<form id="registerForm" style="display: none;" novalidate>
    <div class="auth-input-group floating-label-group">
        <input type="text" id="registerName" required placeholder="">
        <label for="registerName">আপনার নাম</label>
        <span class="error-message"></span>
    </div>
    <div class="auth-input-group floating-label-group">
        <input type="email" id="registerEmail" required placeholder="">
        <label for="registerEmail">ইমেইল</label>
        <span class="error-message"></span>
    </div>
    <div class="auth-input-group floating-label-group password-input-wrapper">
        <input type="password" id="registerPassword" required minlength="6" autocomplete="new-password" placeholder="">
        <label for="registerPassword">পাসওয়ার্ড</label>
        <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
        <span class="error-message"></span>
    </div>
    <!-- START: নতুন ফিল্ড যোগ করা হলো -->
    <div class="auth-input-group floating-label-group password-input-wrapper">
        <input type="password" id="registerConfirmPassword" required minlength="6" autocomplete="new-password" placeholder="">
        <label for="registerConfirmPassword">পাসওয়ার্ড নিশ্চিত করুন</label>
        <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
        <span class="error-message"></span>
    </div>
    <!-- END: নতুন ফিল্ড যোগ করা হলো -->
    <button type="submit" class="auth-btn">রেজিস্টার করুন</button>
    <p class="auth-switch-text">
        ইতিমধ্যে অ্যাকাউন্ট আছে? <a href="#" id="showLoginFormLink">এখানে লগইন করুন</a>
    </p>
</form>
</div>

<!-- "অথবা" বিভাজক -->
<div class="auth-divider">
  <span>অথবা</span>
</div>
<!-- END: নতুন ইমেইল/পাসওয়ার্ড ফর্ম (আপডেট করা হয়েছে) -->

            <!-- REFERRAL CODE FIELD REMOVED FROM HERE -->

            <button id="signInBtn" class="google-sign-in-btn">
                <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; margin-right: 10px; flex-shrink: 0; display: block;">
                    <path fill="#4285F4" d="M22.56 12.02c0-.79-.07-1.54-.2-2.28H12v4.26h6.29c-.27 1.35-1.09 2.47-2.3 3.32v2.73h3.51c2.05-1.89 3.23-4.66 3.23-7.53z"></path>
                    <path fill="#34A853" d="M12 23c3.2 0 5.86-1.07 7.82-2.92l-3.51-2.73c-.97.65-2.22 1.04-4.3 1.04-3.3 0-6.1-2.2-7.1-5.18H.58v2.81c2.06 4.09 6.27 6.92 11.42 6.92z"></path>
                    <path fill="#FBBC05" d="M4.9 13.91c-.48-1.35-.76-2.82-.76-4.37s.28-3.02.76-4.37V2.37H1.39C-.51 6.23-.51 10.77 1.39 14.63l3.51-2.72v2.83z"></path>
                    <path fill="#EA4335" d="M12 3.84c1.82 0 3.44.75 4.67 1.83l3.11-3.11C17.86.89 15.2 0 12 0 6.77 0 2.56 2.83.5 6.92l3.51 2.81c1.0-2.98 3.8-5.18 7.1-5.18z"></path>
                </svg>
                গুগল দিয়ে সাইন ইন করুন
            </button>
            
            <p class="auth-switch-text" style="margin-top: 10px;">
                <a href="#" id="forgotPasswordLink">পাসওয়ার্ড ভুলে গেছেন?</a>
            </p>
            
        </div>
    </div>

    <!-- মূল অ্যাপ ভিউ (ডিফল্টভাবে লুকানো থাকবে) -->
    <div id="app-view" style="display: none; width: 100%; display: flex; flex-direction: column; align-items: center; min-height: 100vh;">
        <div class="container" id="mainContainer">
            <div class="header-controls">
                <button class="info-button" id="infoButton" aria-label="ব্যবহারের নির্দেশিকা">
                    <i class="fas fa-info-circle"></i>
                </button>
                <div class="font-size-controls">
                    <button id="decreaseFont" title="ফন্টের আকার কমান"><i class="fas fa-minus"></i></button>
                    <button id="resetFont" title="ফন্টের আকার রিসেট করুন"><i class="fas fa-font"></i></button>
                    <button id="increaseFont" title="ফন্টের আকার বাড়ান"><i class="fas fa-plus"></i></button>
                </div>
                <button class="dark-mode-toggle" id="darkModeToggle" aria-label="Dark mode toggle">
                    <i class="fas fa-moon"></i>
                </button>
                <button class="profile-button" id="profileBtn" title="প্রোফাইল মেনু" style="margin-left: 10px;">
                    <i class="fas fa-user-circle"></i>
                </button>
                <div id="profileMenu">
    <!-- বিদ্যমান নাম -->
    <div id="profileUserName" class="profile-user-name" style="padding-bottom: 0px;"></div>
    <!-- নতুন ইমেইল ডিসপ্লে -->
    <div id="profileUserEmail" class="profile-user-name" style="font-size: 0.8em; font-weight: normal; padding-top: 5px; border-top: none; margin-bottom: 5px;"></div> 
    
    <button id="changeNameBtn"><i class="fas fa-user-edit"></i> নাম পরিবর্তন</button>
    <button id="changePasswordBtn"><i class="fas fa-key"></i> পাসওয়ার্ড পরিবর্তন</button>
    
    <!-- নতুন বাটন: ইমেইল পরিবর্তন -->
    <button id="changeEmailBtn"><i class="fas fa-envelope"></i> ইমেইল পরিবর্তন</button>

    <button id="signOutBtn"><i class="fas fa-sign-out-alt"></i> লগ আউট</button>
</div>
            </div>

            <div class="view-switcher">
                <button id="showShoppingListBtn" class="active"><i class="fas fa-shopping-cart"></i> তালিকা</button>
                <button id="showLedgerBtn"><i class="fas fa-book"></i> খাতা</button>
            </div>
            
            <!-- ===================================================================== -->
            <!-- ====================== SHOPPING LIST SECTION ======================== -->
            <!-- ===================================================================== -->
            <div id="shoppingListSection">
                <!-- <h1>কেনাকাটার তালিকা</h1> -->

                <!-- START: Replica Shopping Header -->
            <div class="replica-header">
                <!-- Dropdown -->
                <div class="replica-dropdown-box">
                    <select id="currentListSelector" class="replica-select" aria-label="তালিকা নির্বাচন করুন"></select>
                </div>
                
                <!-- Plus Button (Add New List) -->
                <button class="header-sq-btn" id="addNewListBtn" title="নতুন তালিকা তৈরি করুন">
                    <i class="fas fa-plus"></i>
                </button>

                <!-- Menu Button (More Options) -->
                <button class="header-sq-btn" id="shoppingListMenuBtn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>

                <!-- Hidden Menu (Absolute Positioned) -->
                <div class="action-dropdown-menu" id="shoppingListMenu">
                    <button id="renameListBtn"><i class="fas fa-edit"></i> নাম পরিবর্তন</button>
                    <button id="deleteCurrentListBtn" class="text-danger"><i class="fas fa-trash-alt"></i> তালিকা মুছুন</button>
                </div>
            </div>
            <!-- END: Replica Header -->

            <!-- START: Replica Input Area -->
            <div class="replica-input-container">
                <!-- Row 1: Name & Mic -->
                <div class="replica-name-row">
                    <input type="text" id="itemName" class="replica-name-input" placeholder="পণ্যের নাম লিখুন..." aria-label="পণ্যের নাম">
                    <button id="voiceInputButton" class="replica-mic-btn" title="ভয়েস ইনপুট">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <div id="autocompleteSuggestions" class="autocomplete-suggestions" style="display:none;"></div>
                </div>

                <!-- Row 2: Price | Priority | Send -->
                <div class="replica-bottom-row">
                    <input type="number" id="itemPrice" class="replica-pill-input" placeholder="৳ দাম" min="0">
                    
                    <select id="itemPriority" class="replica-pill-select">
                        <option value="low">কম জরুরি</option>
                        <option value="medium">জরুরি</option>
                        <option value="high">অতি জরুরি</option>
                    </select>

                    <button id="addItemBtn" class="replica-send-btn" title="তালিকাভুক্ত করুন">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
            <!-- END: Replica Input Area -->

                <!-- START: NEW Shopping List Search Bar -->
                <div class="shopping-list-search-bar">
                    <i class="fas fa-search"></i>
                    <input type="text" id="shoppingListSearchInput" placeholder="পণ্য খুঁজুন...">
                </div>
                <!-- END: NEW Shopping List Search Bar -->

                <div id="shoppingList">
                    <!-- কেনাকাটার তালিকা এখানে যোগ করা হবে -->
                </div>

                <div class="total-section">
                    মোট: <span id="totalAmount">0.00</span>
                </div>
            </div>

            <!-- ===================================================================== -->
            <!-- ======================== LEDGER SECTION (REBUILT) =================== -->
            <!-- ===================================================================== -->
            <div id="ledgerSection" style="display: none;">
                <!-- Main view with customer list -->
                <div id="ledgerMainView" class="ledger-main-view active">
                    <!-- START: Replica Ledger Header -->
                    <div class="replica-header">
                        <div class="replica-dropdown-box">
                            <select id="currentLedgerSelector" class="replica-select" aria-label="খাতা নির্বাচন করুন"></select>
                        </div>
                        
                        <!-- New Ledger Button -->
                        <button class="header-sq-btn" id="addNewLedgerBtn" title="নতুন খাতা তৈরি করুন">
                            <i class="fas fa-plus"></i>
                        </button>

                        <!-- Menu Button -->
                        <button class="header-sq-btn" id="ledgerMenuBtn">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>

                        <div class="action-dropdown-menu" id="ledgerMenu">
                            <button id="renameLedgerBtn"><i class="fas fa-edit"></i> নাম পরিবর্তন</button>
                            <button id="deleteCurrentLedgerBtn" class="text-danger"><i class="fas fa-trash-alt"></i> খাতা মুছুন</button>
                        </div>
                    </div>
                    <!-- END: Replica Ledger Header -->

                    <!-- START: Sticky Header Wrapper (Updated) -->
                    <div class="sticky-ledger-header">
                        
                        <!-- ১. নতুন টাইটেল বার (এটি জাভাস্ক্রিপ্ট দিয়ে কন্ট্রোল হবে) -->
                        <div id="ledgerStatusMsg" class="ledger-status-msg" style="display: none;">
                            <i class="fas fa-info-circle"></i> সকল খাতার মোট হিসাব
                        </div>

                        <!-- ২. সারাংশ কার্ড (আগের মতোই) -->
                        <div class="replica-summary-card">
    <div class="summary-part">
        <span class="summary-val val-red" id="ledger-total-receivable">০.০০</span>
        <span class="summary-label">মোট পাবো</span>
    </div>
    <div class="summary-divider"></div>
    <div class="summary-part">
        <span class="summary-val val-green" id="ledger-total-payable">০.০০</span>
        <span class="summary-label">মোট দেবো</span>
    </div>
</div>

                        <!-- ৩. সার্চ বার -->
                        <div class="ledger-controls-main" style="border:none; padding:0;">
                            <div class="ledger-search-bar">
    <i class="fas fa-search"></i>
    <input type="text" id="customerSearchInput" placeholder="গ্রাহক খুঁজুন...">
</div>
                        </div>
                    </div>
                    <!-- END: Sticky Header Wrapper -->
                    
                    <div id="customerList">
                        <!-- Customer list will be rendered here via JS -->
                    </div>

                    <button class="fab-add-customer" id="fabAddCustomerBtn" title="নতুন গ্রাহক যোগ করুন">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>

                <!-- Customer specific view for transactions (MODIFIED STRUCTURE) -->
                <div id="ledgerCustomerView" class="ledger-customer-view">
                    <div class="customer-view-header">
                        <button class="back-button" id="backToLedgerMainBtn"><i class="fas fa-arrow-left"></i></button>
                        <div class="customer-initial-circle" id="customerViewInitialHeader" style="margin-right: 12px; flex-shrink: 0;"></div>
                         <div class="customer-header-info">
                            <div class="name" id="customerViewName"></div>
                            <div class="phone" id="customerViewPhone"></div>
                        </div>
                        <div class="header-actions">
                            <button class="icon-button" id="customerOptionsBtn"><i class="fas fa-ellipsis-v"></i></button>
                            <div id="customerOptionsMenu">
                                <button id="customerReportBtn"><i class="fas fa-chart-bar"></i> রিপোর্ট</button>
                                <button id="customerEditBtn"><i class="fas fa-edit"></i> এডিট</button>
                                <button id="customerDeleteBtn" class="delete-option"><i class="fas fa-trash-alt"></i> ডিলিট</button>
                            </div>
                        </div>
                    </div>
                    <div class="customer-view-subheader">
                        <div class="balance" id="customerViewBalance"></div>
                        <div class="last-updated" id="customerViewLastUpdated"></div>
                    </div>

                    <!-- Wrapper for scrollable form area -->
                    <div class="customer-transaction-form-wrapper">
                        <div class="customer-transaction-form">
                            <div class="amount-inputs">
                                <div class="input-wrapper">
                                   <input type="number" id="gaveAmountInput" placeholder="দিলাম/বেচা">
                                </div>
                                <div class="input-wrapper">
                                   <input type="number" id="receivedAmountInput" placeholder="পেলাম/জমা">
                                </div>
                            </div>
                            <div class="description-input">
                                <input type="text" id="transactionDescriptionInput" placeholder="বিবরণ">
                            </div>
                            <div class="utility-buttons">
                                <label class="utility-btn" id="transactionDateLabelBtn" for="transactionDateInput">
                                   <i class="fas fa-calendar-alt"></i>
                                   <span id="transactionDateLabel"></span>
                                </label>
                                <input type="date" id="transactionDateInput">
                            </div>
                        </div>
                    </div>

                    <!-- Confirm button outside the scrollable wrapper -->
                    <div class="confirm-button-wrapper">
                        <button class="confirm-button disabled" id="confirmTransactionBtn">নিশ্চিত</button>
                    </div>
                    
                </div>
                
                <!-- NEW: Receivable List View -->
                <div id="receivableListView" class="filtered-ledger-view">
                    <!-- Content will be injected by JS -->
                </div>

                <!-- NEW: Payable List View -->
                <div id="payableListView" class="filtered-ledger-view">
                    <!-- Content will be injected by JS -->
                </div>

            </div>


            <!-- ===================================================================== -->
            <!-- ====================== COMMON ACTION BUTTONS ======================== -->
            <!-- ===================================================================== -->
            <div class="action-buttons">
                <!-- This section is now replaced by the bottom navigation menu -->
            </div>

        </div>
        
        <!-- ===================================================================== -->
        <!-- ====================== NEW: BOTTOM NAVIGATION ======================= -->
        <!-- ===================================================================== -->
        <div id="shoppingListBottomMenu" class="bottom-nav-menu" style="display: none;">
            <button class="nav-item active" id="navHomeBtn">
                <i class="fas fa-shopping-cart"></i>
                <span>তালিকা</span>
            </button>
            <button class="nav-item" id="navShareBtn">
                <i class="fas fa-share-alt"></i>
                <span>শেয়ার</span>
            </button>
            <button class="nav-item" id="navReportBtn">
                <i class="fas fa-chart-pie"></i>
                <span>রিপোর্ট</span>
            </button>
            <button class="nav-item" id="navPdfBtn">
                <i class="fas fa-file-pdf"></i>
                <span>পিডিএফ</span>
            </button>
        </div>
        
        <div id="ledgerBottomMenu" class="bottom-nav-menu" style="display: none;">
            <button class="nav-item active" id="navLedgerHomeBtn">
                <i class="fas fa-book"></i>
                <span>খাতা</span>
            </button>
            <button class="nav-item" id="navLedgerShareBtn">
                <i class="fas fa-share-alt"></i>
                <span>শেয়ার</span>
            </button>
            <button class="nav-item" id="navLedgerReceivableBtn">
                <i class="fas fa-arrow-down"></i>
                <span>পাবো</span>
            </button>
            <button class="nav-item" id="navLedgerPayableBtn">
                <i class="fas fa-arrow-up"></i>
                <span>দেবো</span>
            </button>
        </div>


        <!-- ===================================================================== -->
        <!-- ====================== REPORT PAGE (FORMERLY MODAL) ================= -->
        <!-- ===================================================================== -->
        <div id="reportPage" style="display: none;">
            <div class="report-page-header">
                <button id="backFromReportBtn" class="back-button" aria-label="রিপোর্ট থেকে ফিরে যান"><i class="fas fa-arrow-left"></i></button>
                <h2>কেনাকাটার রিপোর্ট</h2>
            </div>
            <div class="report-page-content">
                <div class="report-section">
                    <h3>সামগ্রিক সারাংশ</h3>
                    <div id="reportListFilterGroup">
                        <label for="reportListFilter">তালিকা অনুযায়ী ফিল্টার:</label>
                        <select id="reportListFilter" aria-label="তালিকা নির্বাচন করুন"><option value="all">সমস্ত তালিকার মোট</option></select>
                    </div>
                    <div class="report-summary-block">
                        <div class="report-summary-item"><span>মোট তালিকার সংখ্যা:</span> <strong><span id="reportSummaryTotalLists">0</span></strong></div>
                        <div class="report-summary-item"><span>মোট পণ্যের সংখ্যা:</span> <strong><span id="reportSummaryTotalItems">0</span></strong></div>
                        <div class="report-summary-item"><span>মোট পণ্যের মূল্য:</span> <strong><span id="reportSummaryOverallTotal">0.00 টাকা</span></strong></div>
                        <div class="report-summary-item"><span>মোট কেনা পণ্যের সংখ্যা:</span> <strong><span id="reportSummaryBoughtItemsCount">0</span></strong></div>
                        <div class="report-summary-item"><span>মোট কেনা পণ্যের মূল্য:</span> <strong><span id="reportSummaryBoughtItemsTotal">0.00 টাকা</span></strong></div>
                        <div class="report-summary-item"><span>মোট কেনা হয়নি পণ্যের সংখ্যা:</span> <strong><span id="reportSummaryUnboughtItemsCount">0</span></strong></div>
                        <div class="report-summary-item"><span>মোট কেনা হয়নি পণ্যের মূল্য:</span> <strong><span id="reportSummaryUnboughtItemsTotal">0.00 টাকা</span></strong></div>
                    </div>
                </div>
                
                <div class="report-section">
                    <h3>সকল কেনা পণ্যের তালিকা</h3>
                    <div id="reportAllBoughtItems" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noBoughtItemsData" style="display:none;">কোনো কেনা পণ্য নেই।</p>
                    </div>

                <div class="report-section">
                    <h3>সকল কেনা হয়নি পণ্যের তালিকা</h3>
                    <div id="reportAllUnboughtItems" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noUnboughtItemsData" style="display:none;">কোনো কেনা হয়নি পণ্য নেই।</p>
                    </div>

                <div class="report-section">
                    <h3>গুরুত্ব অনুযায়ী পণ্যের তালিকা</h3>
                    <div id="reportPriorityFilterGroup">
                        <label for="reportPriorityFilter">গুরুত্ব অনুযায়ী ফিল্টার:</label>
                        <select id="reportPriorityFilter" aria-label="গুরুত্ব অনুযায়ী পণ্যের তালিকা">
                            <option value="low">কম জরুরি</option>
                            <option value="medium">জরুরি</option>
                            <option value="high">অতি জরুরি</option>
                        </select>
                    </div>
                    <div id="reportPriorityItems" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noPriorityData" style="display:none;">কোনো পণ্য ডেটা নেই।</p>
                    </div>

                <div class="report-section">
                    <h3>সর্বোচ্চ খরচের ১০টি পণ্য</h3>
                    <div id="reportTopSpendingItems" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noTopSpendingData" style="display:none;">কোনো পণ্য ডেটা নেই।</p>
                </div>
                
                <div class="report-section">
                    <h3>মাসিক খরচের বিবরণ</h3>
                    <div id="reportMonthlySpending" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noMonthlyData" style="display:none;">কোনো মাসিক ডেটা নেই।</p>
                </div>

                <div class="report-section">
                    <h3>বাৎসরিক খরচের বিবরণ</h3>
                    <div id="reportAnnualSpending" class="report-list scrollable"></div>
                    <p class="report-no-data" id="noAnnualData" style="display:none;">কোনো বাৎসরিক ডেটা নেই।</p>
                </div>

                <div class="report-section">
                    <h3 style="margin-top: 0;">তারিখ পরিসীমা অনুযায়ী রিপোর্ট</h3>
                    <div id="reportDateFilterGroup">
                        <div class="date-filter-input-container">
                            <label for="reportStartDate">শুরুর তারিখ:</label>
                            <input type="date" id="reportStartDate" aria-label="শুরুর তারিখ">
                        </div>
                        <div class="date-filter-input-container">
                            <label for="reportEndDate">শেষের তারিখ:</label>
                            <input type="date" id="reportEndDate" aria-label="শেষের তারিখ">
                        </div>
                        <button id="applyDateFilter">ফিল্টার করুন</button>
                    </div>
                    <div class="date-filter-results-container" id="dateFilterResults">
                        <div class="date-filter-display">
                            <div class="date-filter-total" style="font-size: 1.1em; color: #555;">মোট পণ্যের মূল্য (এই পরিসীমায়):<span id="dateFilterTotalAmount" style="display: block; font-size: 1.8em; color: #2c3e50; font-weight: bold;">0.00</span></div>
                            <div class="date-filter-range" id="displayDateRange"></div>
                            <div class="date-filter-sub-totals">
                                <div>মোট কেনা পণ্যের মূল্য: <strong id="dateFilterBoughtTotal">0.00</strong></div>
                                <div>মোট কেনা হয়নি পণ্যের মূল্য: <strong id="dateFilterUnboughtTotal">0.00</strong></div>
                            </div>
                        </div>
                        <div id="dateFilterItemsList" class="report-list scrollable scrollable-large" style="margin-top: 20px;"></div>
                        <p class="report-no-data" id="noDateFilterItemsData" style="display:none;">এই তারিখ পরিসীমায় কোনো পণ্য পাওয়া যায়নি।</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===================================================================== -->
        <!-- ================= NEW: CUSTOMER REPORT PAGE ========================= -->
        <!-- ===================================================================== -->
        <div id="customerReportPage" style="display: none;">
            <div class="report-page-header">
                <button id="backFromCustomerReportBtn" class="back-button" aria-label="ফিরে যান"><i class="fas fa-arrow-left"></i></button>
                <h2 id="customerReportPageName"></h2>
                <div class="report-page-actions">
                    <button id="customerReportShareBtn" title="শেয়ার করুন"><i class="fas fa-share-alt"></i></button>
                    <button id="customerReportCopyBtn" title="কপি করুন"><i class="fas fa-copy"></i></button>
                    <button id="customerReportPdfBtn" title="পিডিএফ ডাউনলোড করুন"><i class="fas fa-file-pdf"></i></button>
                </div>
            </div>
            <div id="customerReportPageContent">
                <!-- Customer transaction table will be injected here -->
            </div>
            <div id="customerReportPageFooterContainer">
                 <!-- Sticky footer will be injected here -->
            </div>
        </div>


        <!-- Hidden div to render content for PDF -->
        <div id="pdfContent">
            <h2 id="pdfHeader">কেনাকাটার তালিকা</h2>
            <div id="pdfHeaderCols" style="display: flex; justify-content: space-between; font-weight: bold; border-bottom: 1px solid #000; padding-bottom: 5px; margin-bottom: 5px;">
                <span class="pdf-name pdf-header-label">পণ্য</span>
                <!-- REMOVED: Quantity/Unit Price column -->
                <span class="pdf-total pdf-header-label" style="text-align: right; flex-basis: 50%;">মোট মূল্য</span>
            </div>
            <div id="pdfItemsContainer"></div>
            <div id="pdfTotalAmount" class="pdf-total-amount">
                <div id="pdfBoughtTotalDiv">কেনা হয়েছে মোট: <span id="pdfBoughtTotal">0.00</span></div>
                <div id="pdfUnboughtTotalDiv">কেনা হয়নি মোট: <span id="pdfUnboughtTotal">0.00</span></div>
                <div id="pdfOverallTotalDiv" class="pdf-overall-total">সামগ্রিক মোট: <span id="pdfOverallTotal">0.00</span></div>
            </div>
        </div>
        
        <!-- Hidden div to render Ledger content for PDF -->
        <div id="pdfLedgerContent"></div>


        <!-- Info Modal Overlay (FINAL FIXED VERSION: NO TEXT REMOVED) -->
<div class="modal-overlay" id="infoModalOverlay">
    <div class="modal-content">
        <button class="modal-close-button" id="closeInfoModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
        
        <!-- হেডার -->
        <div class="info-modal-header" style="text-align: center; margin-bottom: 30px;">
            <h2 style="margin: 0; color: var(--primary-color); font-size: 1.8em; font-weight: 700; letter-spacing: 0.5px;">ব্যবহার নির্দেশিকা</h2>
            <p style="color: #555; font-size: 0.95em; margin-top: 10px; line-height: 1.6;">
                আপনার দৈনন্দিন কেনাকাটা ও হিসাব নিকাশকে আরও <strong>স্মার্ট, নির্ভুল এবং সহজ</strong> করতে আমাদের এই আয়োজন। অ্যাপটির ফিচারগুলো কীভাবে আপনাকে সাহায্য করবে, তা নিচে বিস্তারিত আলোচনা করা হলো:
            </p>
        </div>

        <div class="guide-container">
            
            <!-- ১. অ্যাকাউন্ট ও নিরাপত্তা -->
            <div class="guide-card">
                <div class="guide-icon-wrapper" style="background-color: #e8f5e9; color: #2e7d32;">
                    <i class="fas fa-user-shield"></i>
                </div>
                <div class="guide-content">
                    <h4>১. আপনার ডেটার সুরক্ষা</h4>
                    <p>মোবাইল হারালেও আপনার হিসাব যেন না হারায়:</p>
                    <ul>
                        <li><strong>লগইন ও ব্যাকআপ:</strong> গুগল বা ইমেইল দিয়ে <strong>লগইন</strong> করে রাখলে আপনার সব তালিকা ও হিসাবের তথ্য আজীবনের জন্য ক্লাউডে সংরক্ষিত থাকবে।</li>
                        <li><strong>প্রোফাইল সেটিংস:</strong> উপরের ডানদিকের <i class="fas fa-user-circle" style="color: var(--primary-color);"></i> আইকনে ক্লিক করে সহজেই নিজের নাম, পাসওয়ার্ড বা ইমেইল পরিবর্তন করুন।</li>
                    </ul>
                </div>
            </div>

            <!-- ২. কেনাকাটার তালিকা -->
            <div class="guide-card">
                <div class="guide-icon-wrapper" style="background-color: #fff3e0; color: #ef6c00;">
                    <i class="fas fa-tasks"></i>
                </div>
                <div class="guide-content">
                    <h4>২. স্মার্ট শপিং লিস্ট</h4>
                    <p>বাজার বা কেনাকাটা হোক গোছানো ও ঝামেলাহীন:</p>
                    <ul>
                        <li><strong>নতুন তালিকা তৈরি:</strong> বাসা, অফিস বা মেস—ভিন্ন ভিন্ন প্রয়োজনের জন্য আলাদা তালিকা তৈরি করতে <span class="inline-icon-visual"><i class="fas fa-plus"></i></span> বাটনে ট্যাপ করুন।</li>
                        
                        <!-- নতুন যুক্ত করা লাইন -->
                        <li><strong>পণ্য যুক্ত বা আপডেট:</strong> পণ্যের নাম এবং পাশের ঘরে পণ্যের মূল্য (Price) লিখুন। এরপর <span class="inline-icon-visual" style="background-color: #3f51b5; color: white;"><i class="fas fa-paper-plane"></i></span> বাটনে ক্লিক করলেই পণ্যটি তালিকায় আপডেট বা যুক্ত হয়ে যাবে।</li>

                        <li><strong>দ্রুত পণ্য টাইপ:</strong> টাইপ করার ঝামেলা এড়াতে <i class="fas fa-microphone" style="color: #4caf50;"></i> ভয়েস আইকনে ট্যাপ করে মুখে বললেই পণ্যের নাম <strong>লেখা হয়ে যাবে</strong>।</li>
                        
                        <li><strong>ম্যাজিক ক্যালকুলেটর:</strong> পণ্যের দামের ঘরে ক্লিক করলেই একটি স্মার্ট ক্যালকুলেটর চালু হবে। হিসাবের জন্য অ্যাপ থেকে বের হওয়ার প্রয়োজন নেই!</li>

                        <li><strong>পণ্যের গুরুত্ব (Priority):</strong> সব কেনাকাটা সমান জরুরি নয়। পণ্য যোগ করার সময় সেটির গুরুত্ব অনুযায়ী <strong>'অতি জরুরি' (High)</strong>, <strong>'জরুরি' (Medium)</strong> বা <strong>'কম জরুরি' (Low)</strong> সেট করুন। এতে তালিকার পাশে রঙিন দাগ দেখে সহজেই বুঝতে পারবেন কোনটি আগে কিনতে হবে।</li>
                    </ul>
                </div>
            </div>

            <!-- ৩. হিসাব খাতা -->
            <div class="guide-card">
                <div class="guide-icon-wrapper" style="background-color: #e0f2f1; color: #009688;">
                    <i class="fas fa-calculator"></i>
                </div>
                <div class="guide-content">
                    <h4>৩. নির্ভুল ডিজিটাল খাতা</h4>
                    <p>ব্যবসায়িক বা ব্যক্তিগত লেনদেনের স্বচ্ছ হিসাব রাখুন:</p>
                    <ul>
                        <li><strong>হিসাব খাতা তৈরি:</strong> ব্যক্তিগত বা ব্যবসায়িক প্রয়োজনে ভিন্ন ভিন্ন নামের খাতা খুলতে ড্রপডাউন মেনুর পাশে থাকা <span class="inline-icon-visual"><i class="fas fa-plus"></i></span> বাটনে ক্লিক করুন।</li>

                        <li><strong>নাম যুক্ত করা:</strong> খাতায় নতুন কারো নাম তুলতে নিচে থাকা <span class="inline-icon-visual fab-style"><i class="fas fa-user-plus"></i></span> বাটনটি ব্যবহার করুন।</li>
                        
                        <li><strong>লেনদেন রেকর্ড:</strong> গ্রাহকের নামের উপর ক্লিক করে লেনদেন লিখুন।
                            <br><i class="far fa-hand-point-right" style="color: var(--primary-color);"></i> খরচ বা বকেয়া হলে <strong>'দিলাম/বেচা'</strong> ঘরে লিখুন।
                            <br><i class="far fa-hand-point-right" style="color: var(--primary-color);"></i> জমা বা আদায় হলে <strong>'পেলাম/জমা'</strong> ঘরে লিখুন।
                            <!-- নতুন যুক্ত করা লাইন -->
                            <br>লেখা শেষে অবশ্যই নিচের <strong>'নিশ্চিত'</strong> বাটনে ক্লিক করুন।
                        </li>

                        <!-- নতুন যুক্ত করা সেকশন -->
                        <li><strong>অ্যাডভান্সড অপশন:</strong> গ্রাহকের নামের উপর ক্লিক করার পর উপরে ডান কোণে থ্রি-ডট (<i class="fas fa-ellipsis-v"></i>) আইকনে ক্লিক করে আপনি গ্রাহকের তথ্য এডিট বা ডিলিট, বিস্তারিত রিপোর্ট দেখা, পিডিএফ ডাউনলোড করা, শেয়ার করা এবং নির্দিষ্ট লেনদেন এডিট বা ডিলিট করতে পারবেন।</li>

                        <li><strong>সহজ নেভিগেশন:</strong> নিচে থাকা <strong>'পাবো'</strong> বা <strong>'দেবো'</strong> বাটনে ট্যাপ করে আপনার পাওনা বা দেনার হিসাব আলাদাভাবে দেখুন। যদি উপরে নির্দিষ্ট কোনো খাতা সিলেক্ট করা থাকে, তবে শুধু সেই খাতার হিসাব দেখাবে; আর যদি <strong>'সকল খাতা'</strong> সিলেক্ট থাকে, তবে সব খাতার মোট হিসাব একসাথে দেখাবে।</li>

                        <li><strong>রিপোর্ট ও পিডিএফ:</strong> প্রতিটি লেনদেনের স্বচ্ছতা বজায় রাখতে কার কাছে কত পাওনা বা দেনা রয়েছে, তার বিস্তারিত রিপোর্ট দেখুন এবং প্রয়োজনে পিডিএফ তৈরি করে মুহূর্তেই শেয়ার করুন।</li>
                    </ul>
                </div>
            </div>

            <!-- ৪. অ্যাপ নেভিগেশন -->
            <div class="guide-card">
                <div class="guide-icon-wrapper" style="background-color: #f3e5f5; color: #8e24aa;">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="guide-content">
                    <h4>৪. সেটিংস ও ব্যবহারবিধি</h4>
                    <ul>
                        <li><strong>সুপার ফাস্ট সোয়াইপ:</strong> স্ক্রিনে বামে বা ডানে আঙুল দিয়ে <strong>সোয়াইপ (Swipe)</strong> করে নিমিষেই 'তালিকা' ও 'খাতা'র মধ্যে আসা-যাওয়া করুন।</li>
                        <li><strong>ড্রাগ অ্যান্ড ড্রপ:</strong> আপনার পছন্দমতো তালিকা সাজাতে যেকোনো আইটেম চেপে ধরে (Long Press) উপরে-নিচে সরাতে পারবেন।</li>
                        
                        <li><strong>ফন্ট ছোট-বড় করা:</strong> চোখের সুবিধার জন্য উপরের মেনু থেকে <span class="inline-icon-visual" style="font-size: 0.7em; width: 22px; height: 22px;"><i class="fas fa-plus"></i></span> বাটনে চাপ দিয়ে লেখা বড়, <span class="inline-icon-visual" style="font-size: 0.7em; width: 22px; height: 22px;"><i class="fas fa-minus"></i></span> বাটনে চাপ দিয়ে লেখা ছোট এবং <span class="inline-icon-visual" style="font-size: 0.7em; width: 22px; height: 22px;"><i class="fas fa-font"></i></span> বাটনে ক্লিক করে লেখার আকার ডিফল্ট অবস্থায় ফিরিয়ে আনতে পারেন।</li>
                        
                        <li><strong>ডার্ক মোড:</strong> রাতের বেলা বা চোখের আরামের জন্য <i class="fas fa-moon"></i> আইকনে ক্লিক করে ডার্ক মোড অন করে নিন।</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- ধন্যবাদ বার্তা -->
        <div class="thank-you-box" style="text-align: center; margin-top: 30px; padding: 20px; background-color: #fcfcfc; border-radius: 12px; border: 1px dashed #e0e0e0;">
            <p style="color: #555; font-size: 0.95em; line-height: 1.6; margin: 0;">
                আপনার দৈনন্দিন জীবনের হিসাব সহজ ও নির্ভুল করাই আমাদের মূল লক্ষ্য।<br>
                <strong>Talika.xyz</strong> ব্যবহার করার জন্য এবং আমাদের উপর আস্থা রাখার জন্য আপনাকে অনেক অনেক ধন্যবাদ! 🖤
            </p>
        </div>

        <!-- ফুটার -->
        <div class="modal-footer-styled">
            <p>&copy; <span id="currentYear"></span> Talika.xyz (তালিকা) সর্বস্বত্ব সংরক্ষিত।</p>
            
            <p style="margin-top: 15px; color: #888; line-height: 1.5; font-size: 0.85em;">
                This site is protected by reCAPTCHA and the Google
                <a href="https://policies.google.com/privacy" target="_blank" rel="noopener" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Privacy Policy</a> and
                <a href="https://policies.google.com/terms" target="_blank" rel="noopener" style="color: var(--primary-color); text-decoration: none; font-weight: 500;">Terms of Service</a> apply.
            </p>

            <div style="text-align: center; margin-top: 25px; margin-bottom: 10px;">
                <a href="https://imrulkayes.com" target="_blank" class="contact-btn-styled">
                    <i class="fas fa-globe"></i> ডেভেলপার পোর্টাল
                </a>
            </div>
        </div>
    </div>
</div>

        <!-- Share Modal Overlay -->
        <div class="modal-overlay" id="shareModalOverlay">
            <div class="modal-content" id="shareModalContent">
                <button class="modal-close-button" id="closeShareModalBtn" aria-label="শেয়ার পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
                <h2 id="shareModalTitle">তালিকা শেয়ার করুন</h2>
                <p>নিচের তথ্য কপি করে অন্যদের সাথে শেয়ার করতে পারেন:</p>
                <pre id="shareableText"></pre>
                <div class="share-buttons-group">
                    <button id="copyShareTextBtn" class="copy-button"><i class="fas fa-copy"></i> কপি করুন</button>
                    <button id="shareViaApiBtn" class="share-platform-button"><i class="fas fa-share-alt"></i> শেয়ার করুন</button>
                </div>
            </div>
        </div>


        <!-- Custom Modals -->
        <div class="custom-modal" id="alertModal"><div class="custom-modal-content"><button class="custom-modal-close" id="closeAlertModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3>সতর্কতা</h3><p id="alertMessage"></p><div class="custom-modal-buttons"><button class="confirm-btn" id="alertOkBtn">ঠিক আছে</button></div></div></div>
        <div class="custom-modal" id="confirmationModal"><div class="custom-modal-content"><button class="custom-modal-close" id="closeConfirmationModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3>নিশ্চিতকরণ</h3><p id="confirmationMessage"></p><div class="custom-modal-buttons"><button class="confirm-btn" id="confirmButton">হ্যাঁ</button><button class="cancel-btn" id="cancelButton">না</button></div></div></div>
        <div class="custom-modal" id="promptModal"><div class="custom-modal-content"><button class="custom-modal-close" id="closePromptModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3 id="promptTitle"></h3><div class="custom-modal-input-group"><label for="promptInput" id="promptLabel"></label><input type="text" id="promptInput"></div><div class="custom-modal-buttons"><button class="submit-btn" id="promptSubmitButton">জমা দিন</button><button class="cancel-btn" id="promptCancelButton">বাতিল</button></div></div></div>
        
        <!-- REMOVED: New Change Name Modal (Replaced by page) -->
        
        <!-- UPDATED: Edit Item Modal (Quantity Removed) -->
        <div class="custom-modal" id="editItemModal">
            <div class="custom-modal-content">
                <button class="custom-modal-close" id="closeEditModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
                <h3>পণ্য সম্পাদনা করুন</h3>
                <div class="custom-modal-input-group">
                    <label for="editItemName">পণ্যের নাম:</label>
                    <input type="text" id="editItemName">
                </div>
                <!-- REMOVED: editItemQuantity input -->
                <div class="custom-modal-input-group">
                    <label for="editItemPrice">মোট মূল্য:</label> <!-- UPDATED Label -->
                    <input type="number" id="editItemPrice" min="0">
                </div>
                <div class="custom-modal-input-group">
                    <label for="editItemPriority">গুরুত্ব:</label>
                    <select id="editItemPriority">
                        <option value="low">কম জরুরি</option>
                        <option value="medium">জরুরি</option>
                        <option value="high">অতি জরুরি</option>
                    </select>
                </div>
                <div class="custom-modal-buttons">
                    <button class="submit-btn" id="editItemSaveButton">সংরক্ষণ করুন</button>
                    <button class="cancel-btn" id="editItemCancelButton">বাতিল</button>
                </div>
            </div>
        </div>
        <!-- END: UPDATED Edit Item Modal -->

        <div class="custom-modal" id="addCustomerModal"><div class="custom-modal-content"><button class="custom-modal-close" id="closeAddCustomerModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3>নতুন গ্রাহক/সরবরাহকারী</h3><div class="custom-modal-input-group"><label for="customerNameInput">নাম</label><input type="text" id="customerNameInput" placeholder="নাম লিখুন"></div><div class="custom-modal-input-group phone-input-wrapper"><label for="customerPhoneInput">মোবাইল নম্বর (অপশনাল)</label><input type="tel" id="customerPhoneInput" placeholder="১১ সংখ্যার মোবাইল নম্বর লিখুন"><div class="phone-error-message">নম্বরটি সঠিক নয়</div></div><div class="custom-modal-buttons"><button class="submit-btn" id="addCustomerConfirmBtn">যোগ করুন</button><button class="cancel-btn" id="addCustomerCancelBtn">বাতিল</button></div></div></div>
        <!-- START: New Edit Customer Modal -->
        <div class="custom-modal" id="editCustomerModal"><div class="custom-modal-content"><button class="custom-modal-close" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3>গ্রাহক এডিট</h3><div class="custom-modal-input-group"><label for="editCustomerNameInput">নাম</label><input type="text" id="editCustomerNameInput" placeholder="নাম লিখুন"></div><div class="custom-modal-input-group phone-input-wrapper"><label for="editCustomerPhoneInput">মোবাইল নম্বর (অপশনাল)</label><input type="tel" id="editCustomerPhoneInput" placeholder="১১ সংখ্যার মোবাইল নম্বর লিখুন"><div class="phone-error-message">নম্বরটি সঠিক নয়</div></div><div class="custom-modal-buttons"><button class="submit-btn" id="saveEditedCustomerBtn">সংরক্ষণ</button><button class="cancel-btn">বাতিল</button></div></div></div>
        <!-- END: New Edit Customer Modal -->
        <div class="custom-modal" id="monthlySpendingModal"><div class="custom-modal-content"><button class="custom-modal-close" id="closeMonthlyModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button><h3>এই মাসের খরচের হিসাব</h3><div class="report-summary-block" style="text-align: left; margin-top: 20px;"><div class="report-summary-item"><span>মোট তালিকার সংখ্যা:</span> <strong><span id="monthlyReportTotalLists">0</span></strong></div><div class="report-summary-item"><span>মোট পণ্যের সংখ্যা:</span> <strong><span id="monthlyReportTotalItems">0</span></strong></div><div class="report-summary-item"><span>মোট পণ্যের মূল্য:</span> <strong><span id="monthlyReportOverallTotal">0.00 টাকা</span></strong></div><div class="report-summary-item"><span>মোট কেনা পণ্যের সংখ্যা:</span> <strong><span id="monthlyReportBoughtItemsCount">0</span></strong></div><div class="report-summary-item"><span>মোট কেনা পণ্যের মূল্য:</span> <strong><span id="monthlyReportBoughtItemsTotal">0.00 টাকা</span></strong></div><div class="report-summary-item"><span>মোট কেনা হয়নি পণ্যের সংখ্যা:</span> <strong><span id="monthlyReportUnboughtItemsCount">0</span></strong></div><div class="report-summary-item"><span>মোট কেনা হয়নি পণ্যের মূল্য:</span> <strong><span id="monthlyReportUnboughtItemsTotal">0.00 টাকা</span></strong></div></div><div class="custom-modal-buttons"><button class="confirm-btn" id="monthlyToFullReportBtn">বিস্তারিত রিপোর্ট</button><button class="cancel-btn" id="closeMonthlyModalBtn2">বন্ধ করুন</button></div></div></div>
        
        <!-- START: New Transaction Confirmation Modal (REDESIGNED) -->
        <div class="custom-modal" id="txConfirmModal">
            <div class="custom-modal-content">
                <button class="custom-modal-close" id="closeTxConfirmModalBtn" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
                <div class="tx-header">
                    <div class="success-icon"><i class="fas fa-check"></i></div>
                    <h3 id="txConfirmTitle">লেনদেনটি রেকর্ড করা হয়েছে</h3>
                </div>
                
                <div class="tx-details-card">
                    <div id="txConfirmCustomerInfo" class="tx-customer-info">
                        <!-- Customer info will be injected here -->
                    </div>

                    <div id="txConfirmDetails" class="tx-details">
                        <!-- Details will be injected by JS -->
                    </div>
                </div>

                <div class="tx-share-section">
                    <div class="share-title">লেনদেন রেকর্ড শেয়ার করি</div>
                    <div class="tx-share-buttons">
                        <button id="txConfirmShareBtn"><i class="fas fa-share-alt"></i><span>শেয়ার</span></button>
                        <button id="txConfirmCopyBtn"><i class="fas fa-copy"></i><span>কপি</span></button>
                    </div>
                </div>
            </div>
        </div>
        <!-- END: New Transaction Confirmation Modal -->

        <!-- START: New Modals for Transaction Edit/Delete Flow -->
        <div class="custom-modal" id="transactionDetailModal">
            <div class="custom-modal-content">
                <button class="custom-modal-close" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
                <h3>লেনদেন</h3>
                <div id="transactionDetailContent" class="tx-detail-view">
                    <!-- Transaction details will be injected here by JS -->
                </div>
                <div class="tx-detail-actions">
                    <button class="delete-btn" id="transactionDetailDeleteBtn"><i class="fas fa-trash-alt"></i> ডিলিট</button>
                    <button class="edit-btn" id="transactionDetailEditBtn"><i class="fas fa-edit"></i> এডিট</button>
                </div>
            </div>
        </div>

        <div class="custom-modal" id="editTransactionModal">
            <div class="custom-modal-content">
                <button class="custom-modal-close" aria-label="পপআপ বন্ধ করুন"><i class="fas fa-times"></i></button>
                <h3>লেনদেন এডিট</h3>
                <div id="editTransactionCustomerInfo" style="margin-bottom: 20px; text-align: left;"></div>
                <div class="custom-modal-input-group">
                    <label>দিলাম/বেচা</label>
                    <input type="number" id="editGaveAmountInput" placeholder="টাকার পরিমাণ">
                </div>
                <div class="custom-modal-input-group">
                    <label>পেলাম</label>
                    <input type="number" id="editReceivedAmountInput" placeholder="টাকার পরিমাণ">
                </div>
                <div class="custom-modal-input-group">
                    <label>বিবরণ</label>
                    <input type="text" id="editDescriptionInput" placeholder="বিবরণ যোগ করুন">
                </div>
                <div class="custom-modal-input-group">
                     <label>তারিখ</label>
                     <input type="date" id="editDateInput">
                </div>
                <div class="custom-modal-buttons">
                    <button class="submit-btn" id="saveEditedTransactionBtn">সংরক্ষণ করুন</button>
                    <button class="cancel-btn">বাতিল</button>
                </div>
            </div>
        </div>
        <!-- END: New Modals for Transaction Edit/Delete Flow -->
        
        <!-- START: NEW Change Email PAGE (Modal-কে Page এ রূপান্তর) -->
        <div id="changeEmailPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9996; flex-direction: column; align-items: center; padding: 20px 10px; box-sizing: border-box;">
            <div class="container" style="max-width: 450px; flex-grow: 0; padding: 25px;">
                <div class="report-page-header" style="position: static; margin-bottom: 25px; border-bottom: none; box-shadow: none; padding: 0;">
                    <button id="backFromChangeEmailPage" class="back-button" aria-label="ফিরে যান"><i class="fas fa-arrow-left"></i></button>
                    <h2 style="font-size: 1.6em; text-align: center; flex-grow: 1; margin-right: 45px; color: var(--primary-color);">ইমেইল পরিবর্তন</h2>
                </div>
                <p id="changeEmailMessage" style="margin-bottom: 25px; color: #444;">নিরাপত্তার জন্য, অনুগ্রহ করে আপনার বর্তমান পাসওয়ার্ড দিয়ে নিজেকে যাচাই করুন:</p>
                
                <!-- ইনপুট ফিল্ডগুলো এখন Floating Label Style ব্যবহার করছে -->
                <div class="auth-input-group floating-label-group password-input-wrapper" id="changeEmailCurrentPasswordGroup">
                    <input type="password" id="changeEmailCurrentPasswordInput" required autocomplete="current-password" placeholder="">
                    <label for="changeEmailCurrentPasswordInput">বর্তমান পাসওয়ার্ড</label>
                    <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
                    <span class="error-message"></span> <!-- auth-input-group এর error-message ব্যবহার করা হলো -->
                </div>
                
                <div class="auth-input-group floating-label-group">
                    <input type="email" id="changeEmailNewEmailInput" required placeholder="">
                    <label for="changeEmailNewEmailInput">নতুন ইমেইল</label>
                    <span class="error-message"></span>
                </div>
                
                <div class="custom-modal-buttons" style="margin-top: 30px;">
                    <button class="submit-btn" id="saveNewEmailBtn">সংরক্ষণ করুন</button>
                    <button class="cancel-btn" id="cancelChangeEmailPageBtn">বাতিল</button>
                </div>
            </div>
        </div>
        <!-- END: NEW Change Email PAGE -->

        <!-- ===================================================================== -->
        <!-- ====================== NEW: Change Name PAGE ======================== -->
        <!-- ===================================================================== -->
        <div id="changeNamePage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9998; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; box-sizing: border-box;">
            <div class="container" style="max-width: 450px; flex-grow: 0; padding: 25px;">
                <div class="report-page-header" style="position: static; margin-bottom: 25px; border-bottom: none; box-shadow: none; padding: 0;">
                    <button id="backFromChangeNamePage" class="back-button" aria-label="ফিরে যান"><i class="fas fa-arrow-left"></i></button>
                    <h2 style="font-size: 1.6em; text-align: center; flex-grow: 1; margin-right: 45px; color: var(--primary-color);">নাম পরিবর্তন</h2>
                </div>
                <p id="nameChangeMessage" style="margin-bottom: 25px; color: #444;">আপনার প্রোফাইলে দেখানোর জন্য আপনার নাম পরিবর্তন করুন।</p>
                
                <!-- Using auth-input-group for consistent styling -->
                <div class="auth-input-group floating-label-group">
                    <input type="text" id="changeNameFirstNameInputPage" placeholder="" required>
                    <label for="changeNameFirstNameInputPage">প্রথম নাম</label>
                    <span class="error-message"></span>
                </div>
                <div class="auth-input-group floating-label-group">
                    <input type="text" id="changeNameLastNameInputPage" placeholder="">
                    <label for="changeNameLastNameInputPage">শেষ নাম (অপশনাল)</label>
                    <span class="error-message"></span>
                </div>
                
                <div class="custom-modal-buttons">
                    <button class="submit-btn" id="saveChangedNamePageBtn">সংরক্ষণ করুন</button>
                    <button class="cancel-btn" id="cancelChangeNamePageBtn">বাতিল</button>
                </div>
            </div>
        </div>
        
        <!-- ====================== NEW: Change Password PAGE ==================== -->
<div id="changePasswordPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9997; display: flex; flex-direction: column; align-items: center; padding: 20px 10px; box-sizing: border-box;">
    <div class="container" style="max-width: 450px; flex-grow: 0; padding: 25px;">
        <div class="report-page-header" style="position: static; margin-bottom: 25px; border-bottom: none; box-shadow: none; padding: 0;">
            <button id="backFromChangePasswordPage" class="back-button" aria-label="ফিরে যান"><i class="fas fa-arrow-left"></i></button>
            <h2 style="font-size: 1.6em; text-align: center; flex-grow: 1; margin-right: 45px; color: var(--primary-color);">পাসওয়ার্ড পরিবর্তন</h2>
        </div>
        <p id="passwordChangeMessage" style="margin-bottom: 25px; color: #444;">আপনার বর্তমান পাসওয়ার্ড যাচাই করে নতুন পাসওয়ার্ড সেট করুন।</p>
        
        <!-- বর্তমান পাসওয়ার্ড -->
        <div class="auth-input-group floating-label-group password-input-wrapper" id="currentPasswordGroup">
            <input type="password" id="currentPasswordInput" required autocomplete="current-password" placeholder="">
            <label for="currentPasswordInput">বর্তমান পাসওয়ার্ড লিখুন</label>
            <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
            <span class="error-message"></span>
        </div>
        <!-- নতুন পাসওয়ার্ড -->
        <div class="auth-input-group floating-label-group password-input-wrapper" id="newPasswordGroup">
            <input type="password" id="newPasswordInput" required minlength="6" autocomplete="new-password" placeholder="">
            <label for="newPasswordInput">নতুন পাসওয়ার্ড (কমপক্ষে ৬ অক্ষর)</label>
            <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
            <span class="error-message"></span>
        </div>
        <!-- নতুন পাসওয়ার্ড নিশ্চিত করুন -->
        <div class="auth-input-group floating-label-group password-input-wrapper" id="confirmNewPasswordGroup">
            <input type="password" id="confirmNewPasswordInput" required minlength="6" autocomplete="new-password" placeholder="">
            <label for="confirmNewPasswordInput">নতুন পাসওয়ার্ড নিশ্চিত করুন</label>
            <button type="button" class="password-toggle-btn" tabindex="-1"><i class="fas fa-eye-slash"></i></button>
            <span class="error-message"></span>
        </div>
        
        <div class="custom-modal-buttons">
            <button class="submit-btn" id="saveNewPasswordBtn">সংরক্ষণ করুন</button>
            <button class="cancel-btn" id="cancelChangePasswordBtn">বাতিল</button>
        </div>
    </div>
</div>
    </div> <!-- #app-view এর বন্ধনী ট্যাগ -->
    
    <!-- ====================== NEW: Reset Password PAGE (স্থান পরিবর্তন করা হয়েছে) ===================== -->
<div id="resetPasswordPage" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; display: flex; flex-direction: column; align-items: center; justify-content: center; box-sizing: border-box;">
    <div class="login-card-d12" style="max-width: 340px; padding: 25px;">
        <h2 style="font-size: 1.6em; text-align: center; margin-bottom: 25px; margin-top: 0; color: var(--primary-color);">পাসওয়ার্ড রিসেট</h2>
        <p style="font-size: 1em; margin-bottom: 25px; color: #444;">আপনার অ্যাকাউন্টের ইমেইল ঠিকানা দিন:</p>
        
        <!-- ইমেইল ইনপুট -->
        <div class="auth-input-group floating-label-group">
            <input type="email" id="resetPasswordEmailInput" required placeholder="">
            <label for="resetPasswordEmailInput">ইমেইল</label>
            <span class="error-message"></span>
        </div>
        
        <div class="custom-modal-buttons">
            <button class="submit-btn auth-btn" id="resetPasswordSubmitBtn">জমা দিন</button>
            <button class="cancel-btn auth-btn" id="cancelResetPasswordBtn" style="background-color: #6c757d;">বাতিল</button>
        </div>
    </div>
</div>
    
    <!-- START: কাস্টম ক্যালকুলেটর -->
<div id="customCalculator" class="calculator-container">
    <div class="calculator-grid">
        <button class="calc-btn utility" data-key="AC">AC</button>
        <button class="calc-btn utility" data-key="%">%</button>
        <button class="calc-btn operator" data-key="/"><i class="fas fa-divide"></i></button>
        <button class="calc-btn operator" data-key="*"><i class="fas fa-times"></i></button>
        
        <button class="calc-btn" data-key="7">7</button>
        <button class="calc-btn" data-key="8">8</button>
        <button class="calc-btn" data-key="9">9</button>
        <button class="calc-btn operator" data-key="-"><i class="fas fa-minus"></i></button>

        <button class="calc-btn" data-key="4">4</button>
        <button class="calc-btn" data-key="5">5</button>
        <button class="calc-btn" data-key="6">6</button>
        <!-- '+' বাটনটি এখন দুটি সারি জুড়ে বড় হবে -->
        <button class="calc-btn operator" data-key="+" style="grid-row: span 2;"><i class="fas fa-plus"></i></button>

        <button class="calc-btn" data-key="1">1</button>
        <button class="calc-btn" data-key="2">2</button>
        <button class="calc-btn" data-key="3">3</button>
        
        <button class="calc-btn utility" data-key="backspace"><i class="fas fa-backspace"></i></button>
        <button class="calc-btn" data-key="0">0</button>
        <button class="calc-btn" data-key=".">.</button>
        <!-- '=' বাটনটি এখন একটি সারিতে চলে এসেছে -->
        <button class="calc-btn equals" data-key="="><i class="fas fa-equals"></i></button>
    </div>
</div>
<!-- END: কাস্টম ক্যালকুলেটর -->

    <!-- START: Toast Container Added -->
    <div id="toastContainer"></div>
    <!-- END: Toast Container Added -->
    
    <!-- Admin Panel Page -->
<div id="adminPanelPage" class="admin-panel-container">
    <!-- Header -->
    <div class="admin-header">
        <button id="closeAdminPanelBtn" class="icon-btn"><i class="fas fa-arrow-left"></i></button>
        <h2>অ্যাডমিন ড্যাশবোর্ড</h2>
        <button id="refreshAdminDataBtn" class="icon-btn"><i class="fas fa-sync-alt"></i></button>
    </div>
    
    <div class="admin-content">
    <!-- ১. ইউজার সার্চ বার (নতুন) -->
    <div class="admin-card" style="padding: 15px; display: flex; gap: 10px;">
        <input type="text" id="adminUserSearchInput" placeholder="ব্যবহারকারীর নাম বা ইমেইল দিয়ে খুঁজুন..." style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;">
    </div>
        <!-- User List Section (Updated) -->
<div class="admin-card">
    <div class="card-header">
        <h3><i class="fas fa-users"></i> ব্যবহারকারীর তালিকা</h3>
    </div>
    
    <!-- এখানে ক্লাস পরিবর্তন করা হয়েছে -->
    <div class="user-table-wrapper">
        <table id="adminUserTable" class="styled-table">
            <thead>
                <tr>
                    <th>নাম</th>
                    <th>ইমেইল</th>
                    <th style="text-align: center;">অ্যাকশন</th>
                </tr>
            </thead>
            <tbody id="adminUserTableBody">
                <!-- JS দিয়ে ডেটা আসবে -->
            </tbody>
        </table>
    </div>
</div>

        <!-- User Data Editor Section -->
<div id="adminUserDataEditor" class="admin-card editor-card" style="display:none;">
    <div class="card-header editor-header">
        <h3><i class="fas fa-user-edit"></i> ডেটা এডিট মোড</h3>
        <span class="uid-badge">UID: <span id="adminTargetUid">...</span></span>
    </div>
    
    <div class="editor-body">
        <!-- ট্যাব বাটন -->
        <div class="action-buttons-grid" style="grid-template-columns: 1fr 1fr;">
            <button id="adminViewListsBtn" class="action-btn blue"><i class="fas fa-shopping-cart"></i> তালিকা</button>
            <button id="adminViewLedgersBtn" class="action-btn purple"><i class="fas fa-book"></i> খাতা</button>
        </div>

        <!-- ভিজ্যুয়াল এডিটর কন্টেইনার (এখানেই টেবিল আসবে) -->
        <div id="adminVisualContainer" class="visual-editor-container">
            <p style="text-align:center; color:#777; margin-top:20px;">উপরে যেকোনো একটি অপশন (তালিকা বা খাতা) সিলেক্ট করুন।</p>
        </div>

        <!-- লুকানো JSON বক্স (ব্যাকগ্রাউন্ডে কাজের জন্য, কিন্তু অ্যাডমিন দেখবে না) -->
        <textarea id="adminRawDataJson" style="display:none;"></textarea>
        
    </div>
</div>
<!-- Admin Edit Modals (New Addition) -->

<!-- ১. শপিং আইটেম এডিট মডাল -->
<div id="adminItemEditModal" class="custom-modal" style="z-index: 21000;">
    <div class="custom-modal-content">
        <button class="custom-modal-close" onclick="closeAdminModal('adminItemEditModal')"><i class="fas fa-times"></i></button>
        <h3>পণ্য আপডেট করুন</h3>
        
        <div class="custom-modal-input-group">
            <label>নাম</label>
            <input type="text" id="adminItemName">
        </div>
        <!-- REMOVED: Quantity input -->
        <div class="custom-modal-input-group">
            <label>দাম (মোট)</label> <!-- UPDATED Label -->
            <input type="number" id="adminItemPrice">
        </div>
        <div class="custom-modal-input-group">
            <label>গুরুত্ব</label>
            <select id="adminItemPriority">
                <option value="low">কম জরুরি</option>
                <option value="medium">জরুরি</option>
                <option value="high">অতি জরুরি</option>
            </select>
        </div>
        <div class="custom-modal-input-group">
            <label>অবস্থা</label>
            <select id="adminItemBought">
                <option value="false">কেনা হয়নি (বাকি)</option>
                <option value="true">কেনা হয়েছে</option>
            </select>
        </div>
        
        <div class="custom-modal-buttons">
            <button class="submit-btn" id="adminItemSaveBtn">আপডেট করুন</button>
        </div>
    </div>
</div>

<!-- ২. লেনদেন (Transaction) এডিট মডাল -->
<div id="adminTxEditModal" class="custom-modal" style="z-index: 21000;">
    <div class="custom-modal-content">
        <button class="custom-modal-close" onclick="closeAdminModal('adminTxEditModal')"><i class="fas fa-times"></i></button>
        <h3>লেনদেন আপডেট করুন</h3>
        
        <div class="custom-modal-input-group">
            <label>তারিখ</label>
            <input type="date" id="adminTxDate">
        </div>
        <div class="custom-modal-input-group">
            <label>টাকার পরিমাণ</label>
            <input type="number" id="adminTxAmount">
        </div>
        <div class="custom-modal-input-group">
            <label>ধরন</label>
            <select id="adminTxType">
                <option value="gave">দিলাম (খরচ/বেচা)</option>
                <option value="received">পেলাম (জমা)</option>
            </select>
        </div>
        <div class="custom-modal-input-group">
            <label>বিবরণ (অপশনাল)</label>
            <input type="text" id="adminTxDesc">
        </div>
        
        <div class="custom-modal-buttons">
            <button class="submit-btn" id="adminTxSaveBtn">আপডেট করুন</button>
        </div>
    </div>
</div>
    </div>
</div>

<!-- Admin Access Button (Only visible to you) -->
<button id="openAdminBtn" style="display: none; position: fixed; bottom: 20px; left: 20px; z-index: 10000; background: #3f51b5; color: white; border: none; padding: 10px 15px; border-radius: 50px; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.3);">
    <i class="fas fa-user-shield"></i> Admin
</button>
    
    <script type='module'>
    // --- Firebase SDK v10 (Modular) Imports ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut, updateProfile, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updatePassword, EmailAuthProvider, reauthenticateWithCredential, linkWithCredential, updateEmail, verifyBeforeUpdateEmail } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
import { 
    getFirestore, doc, getDoc, setDoc, updateDoc, deleteDoc, 
    enableIndexedDbPersistence, deleteField, collection, getDocs, 
    onSnapshot, query // <-- onSnapshot এবং query যোগ করা হয়েছে
} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
// START: App Check SDK Import
import { initializeAppCheck, ReCaptchaV3Provider } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js";
import { getMessaging, getToken, onMessage } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-messaging.js";
// END: App Check SDK Import

    // --- IIFE (Immediately Inoked Function Expression) to avoid global scope pollution ---
    (function() {
        // --- Firebase Config and Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyDz94B6gpJPZFMGsgdKirGneJcZs48unAg",
            authDomain: "talika-eaa65.firebaseapp.com",
            projectId: "talika-eaa65",
            storageBucket: "talika-eaa65.firebasestorage.app",
            messagingSenderId: "836287630941",
            appId: "1:836287630941:web:d37b4b3efaf9a02c5d07b4"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // START: Initialize App Check
        const appCheck = initializeAppCheck(app, {
          provider: new ReCaptchaV3Provider('6LccAPErAAAAAH-ZKPRhU5cQgZjmHa7lCl9FvcAs'),
          isTokenAutoRefreshEnabled: true
        });
        // END: App Check SDK Import

        try {
            enableIndexedDbPersistence(db)
              .catch(err => {
                  if (err.code == 'failed-precondition') {
                      console.warn("Firestore persistence could not be enabled: Multiple tabs open.");
                  } else if (err.code == 'unimplemented') {
                      console.warn("Firestore persistence could not be enabled: Browser not supported.");
                  }
              });
        } catch (e) {
            console.error("Error enabling Firestore persistence", e);
        }
        
        // --- ADMIN PANEL LOGIC (FIXED FOR SUB-COLLECTIONS) ---

const ADMIN_UID = "66XoRf3tu4Z8QVXW7iQv09hJJr32"; // আপনার অ্যাডমিন UID

// সময় লজিক (Time Ago)
function timeAgoAdmin(dateString) {
    if (!dateString) return '';
    const date = new Date(dateString);
    if (isNaN(date)) return 'তারিখ নেই';
    
    const seconds = Math.floor((new Date() - date) / 1000);
    let interval = seconds / 31536000;
    if (interval > 1) return `${toBengaliNumberLocal(Math.floor(interval))} বছর আগে`;
    interval = seconds / 2592000;
    if (interval > 1) return `${toBengaliNumberLocal(Math.floor(interval))} মাস আগে`;
    interval = seconds / 86400;
    if (interval > 1) return `${toBengaliNumberLocal(Math.floor(interval))} দিন আগে`;
    interval = seconds / 3600;
    if (interval > 1) return `${toBengaliNumberLocal(Math.floor(interval))} ঘণ্টা আগে`;
    interval = seconds / 60;
    if (interval > 1) return `${toBengaliNumberLocal(Math.floor(interval))} মিনিট আগে`;
    return 'এইমাত্র';
}

function toBengaliNumberLocal(str) {
    if(!str) return str;
    const englishNumerals = { '0':'০', '1':'১', '2':'২', '3':'৩', '4':'৪', '5':'৫', '6':'৬', '7':'৭', '8':'৮', '9':'৯' };
    return String(str).replace(/[0-9]/g, (d) => englishNumerals[d]);
}

let adminCurrentFullData = { shoppingLists: {}, ledgers: {} }; 
let adminCurrentViewContext = 'lists'; 
let adminSelectedListId = null;
let adminSelectedLedgerId = 'all';
let adminAllUsersCache = []; 
let adminExpandedItemIndex = -1;

// Auth Listener for Admin Button (Cleaned Version)
onAuthStateChanged(auth, user => {
    const btn = document.getElementById('openAdminBtn');
    
    // শুধু বাটন দেখানো বা লুকানোর কাজ করবে
    if (user && user.uid === ADMIN_UID) {
        if(btn) btn.style.display = 'block';
    } else {
        if(btn) btn.style.display = 'none';
    }
});

// Admin Panel Toggle
const adminPanelPage = document.getElementById('adminPanelPage');
const openAdminBtn = document.getElementById('openAdminBtn');

if(openAdminBtn) {
    openAdminBtn.addEventListener('click', () => {
        adminPanelPage.style.display = 'flex';
        openAdminBtn.style.display = 'none';
        
        // ✅ নতুন পরিবর্তন: অ্যাডমিন প্যানেল খুললে পেছনের অ্যাপ ভিউ লুকিয়ে ফেলা হবে
        if(appView) appView.style.display = 'none';
        
        loadAllUsersForAdmin();
    });
}

document.getElementById('closeAdminPanelBtn').addEventListener('click', () => {
    adminPanelPage.style.display = 'none';
    
    // অ্যাডমিন প্যানেল বন্ধ করলে লিসেনারগুলো বন্ধ করুন
    if (unsubscribeAdminAllUsers) unsubscribeAdminAllUsers();
    if (unsubscribeAdminTargetLists) unsubscribeAdminTargetLists();
    if (unsubscribeAdminTargetLedgers) unsubscribeAdminTargetLedgers();

    // অ্যাপ ভিউ ফিরিয়ে আনা
    if(appView) appView.style.display = 'flex';
    if(openAdminBtn) openAdminBtn.style.display = 'block';
    
    // ইউজারের নিজের অ্যাপ ডেটা রিফ্রেশ (যদি অ্যাডমিন নিজেও ইউজার হিসেবে লগইন থাকে)
    if (typeof loadDataFromFirestore === 'function') {
        loadDataFromFirestore();
    }
});

document.getElementById('refreshAdminDataBtn').addEventListener('click', async function() {
    const icon = this.querySelector('i');
    if(icon) {
        icon.style.transition = "transform 0.5s";
        icon.style.transform = "rotate(360deg)";
        setTimeout(() => icon.style.transform = "rotate(0deg)", 500);
    }
    await loadAllUsersForAdmin();
    // If a user is selected, refresh their data too
    const uidSpan = document.getElementById('adminTargetUid');
    if(uidSpan && uidSpan.innerText.includes('UID:')) {
        const currentUid = uidSpan.querySelector('.uid-display-box span').innerText.replace('UID:', '').trim();
        if(currentUid) await loadTargetUserData(currentUid);
    }
});

// Search Users
document.getElementById('adminUserSearchInput').addEventListener('input', function(e) {
    const term = e.target.value.toLowerCase();
    const filteredUsers = adminAllUsersCache.filter(u => 
        (u.name && u.name.toLowerCase().includes(term)) || 
        (u.email && u.email.toLowerCase().includes(term))
    );
    renderUserTable(filteredUsers);
});

// Load Users List (Real-time)
function loadAllUsersForAdmin() {
    const tbody = document.getElementById('adminUserTableBody');
    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px;">লোড হচ্ছে...</td></tr>';
    
    // আগের লিসেনার থাকলে বন্ধ করুন
    if (unsubscribeAdminAllUsers) unsubscribeAdminAllUsers();

    const q = query(collection(db, "all_users_list"));
    
    unsubscribeAdminAllUsers = onSnapshot(q, (querySnapshot) => {
        adminAllUsersCache = []; 
        if (querySnapshot.empty) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">কোনো ইউজার নেই।</td></tr>';
            return;
        }
        querySnapshot.forEach((doc) => {
            adminAllUsersCache.push(doc.data());
        });
        renderUserTable(adminAllUsersCache);
        
        // Add Event Listeners for Dynamic Buttons (Re-attach after render)
        tbody.onclick = (e) => {
            const btn = e.target.closest('.manage-btn');
            if (!btn) return;
            const uid = btn.getAttribute('data-uid');
            const action = btn.getAttribute('data-action');
            
            if (btn.classList.contains('btn-user-edit')) {
                loadTargetUserData(uid);
            } else if (action) {
                handleUserAction(uid, action);
            }
        };
    }, (error) => {
        console.error("Admin Users Listener Error:", error);
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">ডেটা লোড ব্যর্থ হয়েছে।</td></tr>';
    });
}

// --- Admin: Render User Table (Updated) ---
function renderUserTable(users) {
    // ১. হেডারে মোট ব্যবহারকারীর সংখ্যা আপডেট (বাংলায়)
    const headerTitle = document.querySelector('.admin-card .card-header h3');
    if (headerTitle) {
        // সংখ্যা বাংলায় কনভার্ট করা
        const countBangla = toBengaliNumberLocal(users.length);
        headerTitle.innerHTML = `<i class="fas fa-users"></i> ব্যবহারকারীর তালিকা <span style="font-size:0.9em; color:#666; font-weight:normal;">(${countBangla} জন)</span>`;
    }

    const tbody = document.getElementById('adminUserTableBody');
    tbody.innerHTML = '';

    if (users.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">পাওয়া যায়নি।</td></tr>';
        return;
    }
    
    // Sort: Last Login অনুযায়ী সাজানো (সবচেয়ে সাম্প্রতিক আগে)
    users.sort((a, b) => new Date(b.lastLogin || 0) - new Date(a.lastLogin || 0));

    users.forEach(userData => {
        const isDisabled = userData.disabled === true;
        
        // ২. তারিখ ফরম্যাটিং
        // অ্যাকাউন্ট তৈরির তারিখ
        let createdStr = 'তথ্য নেই';
        if (userData.createdAt) {
            const cDate = new Date(userData.createdAt);
            createdStr = cDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'short', year: 'numeric' });
        } else if (userData.metadata?.creationTime) {
             // ফায়ারবেস মেটাডেটা থেকে যদি আসে
             const cDate = new Date(userData.metadata.creationTime);
             createdStr = cDate.toLocaleDateString('bn-BD', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // লাস্ট সিন / ভিজিট (Time Ago ফরম্যাটে)
        const lastSeenStr = userData.lastLogin ? timeAgoAdmin(userData.lastLogin) : 'কখনো না';

        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div style="font-weight:600; color:#333; font-size: 1em;">
                    ${userData.name || 'নাম নেই'}
                </div>
                <!-- নামের নিচে তারিখ এবং লাস্ট সিন -->
                <div style="font-size: 0.75em; color: #777; margin-top: 4px; line-height: 1.4;">
                    <i class="far fa-calendar-alt"></i> জয়েন: ${createdStr}<br>
                    <i class="far fa-clock"></i> ভিজিট: ${lastSeenStr}
                </div>
            </td>
            <td style="font-size:0.9em; color:#555; vertical-align: middle;">${userData.email || '-'}</td>
            <td style="text-align:center; vertical-align: middle;">
                <div class="user-actions">
                    <button class="manage-btn btn-user-edit" data-uid="${userData.uid}" title="এডিট"><i class="fas fa-cog"></i></button>
                    ${isDisabled 
                        ? `<button class="manage-btn btn-user-enable" data-uid="${userData.uid}" data-action="enable" title="আনব্লক করুন"><i class="fas fa-check"></i></button>` 
                        : `<button class="manage-btn btn-user-disable" data-uid="${userData.uid}" data-action="disable" title="ব্লক করুন"><i class="fas fa-ban"></i></button>`
                    }
                    <button class="manage-btn btn-user-delete" data-uid="${userData.uid}" data-action="delete" title="মুছে ফেলুন"><i class="fas fa-trash"></i></button>
                </div>
            </td>`;
        tbody.appendChild(tr);
    });
}

// Handle User Actions (Block/Delete)
async function handleUserAction(uid, action) {
    if(action === 'disable') {
        if(await adminShowConfirm("সতর্কতা", "ব্যবহারকারীকে ব্লক করবেন?")) {
            await setDoc(doc(db, "all_users_list", uid), { disabled: true }, { merge: true });
            // Also update main user doc if exists
            try { await updateDoc(doc(db, "userData", uid), { accountDisabled: true }); } catch(e){}
            showToast("ব্যবহারকারী ব্লক করা হয়েছে।");
            loadAllUsersForAdmin();
        }
    } 
    else if(action === 'enable') {
        if(await adminShowConfirm("নিশ্চিতকরণ", "ব্যবহারকারীকে আনব্লক করবেন?")) {
            await setDoc(doc(db, "all_users_list", uid), { disabled: false }, { merge: true });
            try { await updateDoc(doc(db, "userData", uid), { accountDisabled: false }); } catch(e){}
            showToast("ব্যবহারকারী আনব্লক করা হয়েছে।");
            loadAllUsersForAdmin();
        }
    } 
    else if(action === 'delete') {
        if(await adminShowConfirm("বিপদজনক!", "ব্যবহারকারী এবং তার সকল ডেটা (লিস্ট/খাতা) স্থায়ীভাবে ডিলিট করবেন?")) {
            try {
                // 1. Delete Sub-collections first (Manual loop required for Firestore)
                const listsRef = collection(db, "userData", uid, "my_shopping_lists");
                const ledgersRef = collection(db, "userData", uid, "my_ledgers");
                
                const [listsSnap, ledgersSnap] = await Promise.all([getDocs(listsRef), getDocs(ledgersRef)]);
                
                const deletePromises = [];
                listsSnap.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                ledgersSnap.forEach(doc => deletePromises.push(deleteDoc(doc.ref)));
                
                await Promise.all(deletePromises);

                // 2. Delete Parent Documents
                await deleteDoc(doc(db, "userData", uid));
                await deleteDoc(doc(db, "all_users_list", uid));

                showToast("ব্যবহারকারী সফলভাবে ডিলিট করা হয়েছে।");
                loadAllUsersForAdmin();
                document.getElementById('adminUserDataEditor').style.display = 'none';
            } catch (error) {
                console.error(error);
                alert("ডিলিট করতে সমস্যা হয়েছে: " + error.message);
            }
        }
    }
}

// --- Updated: Load Specific User Data (Real-time) ---
function loadTargetUserData(targetUid) {
    document.getElementById('adminUserDataEditor').style.display = 'block';
    
    // Header Setup (Same as before)
    const editorHeader = document.querySelector('.editor-header');
    editorHeader.innerHTML = `
        <div class="editor-header-content">
            <div class="editor-title-row"><h3><i class="fas fa-user-edit"></i> ডেটা এডিট মোড</h3></div>
            <div class="uid-display-container">
                <div class="uid-text-row">
                    <span id="displayUidText">UID: ${targetUid}</span>
                    <button class="uid-copy-btn-inline" onclick="adminCopyUid('${targetUid}')" title="UID কপি করুন"><i class="far fa-copy"></i></button>
                </div>
                <div class="uid-action-buttons-row">
                    <button class="uid-action-btn-block btn-reset-data" onclick="adminResetUserData('${targetUid}')"><i class="fas fa-sync-alt"></i> রিসেট ডেটা</button>
                    <button class="uid-action-btn-block btn-delete-acc" onclick="handleUserAction('${targetUid}', 'delete')"><i class="fas fa-trash-alt"></i> ডিলিট একাউন্ট</button>
                </div>
                <!-- Row 3: Manual UID Load Box (Updated) -->
                <div style="margin-top: 10px;">
                    <!-- এরর মেসেজ দেখানোর জন্য নতুন div -->
                    <div id="uidInlineError" class="uid-inline-error"></div>
                    
                    <div class="manual-uid-box" style="margin-top: 0;">
                        <input type="text" id="manualUidInput" class="manual-uid-input" placeholder="অন্য UID পেস্ট করুন...">
                        <button class="manual-uid-submit" onclick="adminLoadManualUid()">লোড</button>
                    </div>
                </div>
            </div>
<div id="adminTargetUid" style="display:none;"><div class="uid-display-box"><span>UID: ${targetUid}</span></div></div>
        </div>`;

    const container = document.getElementById('adminVisualContainer');
    container.innerHTML = '<p style="text-align:center; padding:20px;">ডেটা কানেক্ট করা হচ্ছে...</p>';

    setupAdminEditorStructure();

    // আগের টার্গেট লিসেনার থাকলে বন্ধ করুন
    if (unsubscribeAdminTargetLists) unsubscribeAdminTargetLists();
    if (unsubscribeAdminTargetLedgers) unsubscribeAdminTargetLedgers();

    adminCurrentFullData = { shoppingLists: {}, ledgers: {} };

    // ১. শপিং লিস্ট রিয়েল-টাইম লিসেনার
    unsubscribeAdminTargetLists = onSnapshot(collection(db, 'userData', targetUid, 'my_shopping_lists'), (snapshot) => {
        adminCurrentFullData.shoppingLists = {}; // রিসেট
        snapshot.forEach(doc => {
            adminCurrentFullData.shoppingLists[doc.id] = doc.data();
        });
        
        // যদি লিস্ট ভিউ খোলা থাকে, রি-রেন্ডার করুন
        if (adminCurrentViewContext === 'lists') {
            renderAdminShoppingListUI(); 
        }
    });

    // ২. লেজার রিয়েল-টাইম লিসেনার
    unsubscribeAdminTargetLedgers = onSnapshot(collection(db, 'userData', targetUid, 'my_ledgers'), (snapshot) => {
        adminCurrentFullData.ledgers = {}; // রিসেট
        snapshot.forEach(doc => {
            adminCurrentFullData.ledgers[doc.id] = doc.data();
        });

        // যদি লেজার ভিউ খোলা থাকে, রি-রেন্ডার করুন
        if (adminCurrentViewContext === 'ledgers') {
            renderAdminLedgerUI();
        }
    });
}

// --- Admin: Reset User Data (Complete Wipe) ---
window.adminResetUserData = async (targetUid) => {
    // ১. কনফার্মেশন চাওয়া
    const isConfirmed = await adminShowConfirm(
        "সতর্কতা!", 
        "এই ব্যবহারকারীর সকল শপিং লিস্ট, হিসাব খাতা এবং লেনদেনের তথ্য স্থায়ীভাবে ডিলিট হয়ে যাবে। আপনি কি নিশ্চিত?"
    );

    if (isConfirmed) {
        try {
            showToast("ডেটা মোছা হচ্ছে, অনুগ্রহ করে অপেক্ষা করুন...", { duration: 3000 });

            // ২. শপিং লিস্ট সাব-কালেকশন ডিলিট (Loop through documents)
            const listsRef = collection(db, "userData", targetUid, "my_shopping_lists");
            const listsSnap = await getDocs(listsRef);
            
            // Promise.all ব্যবহার করে দ্রুত সব ডিলিট করা
            const deleteListPromises = listsSnap.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deleteListPromises);

            // ৩. লেজার বা খাতা সাব-কালেকশন ডিলিট
            const ledgersRef = collection(db, "userData", targetUid, "my_ledgers");
            const ledgersSnap = await getDocs(ledgersRef);
            
            const deleteLedgerPromises = ledgersSnap.docs.map(doc => deleteDoc(doc.ref));
            await Promise.all(deleteLedgerPromises);

            // ৪. মেইন ইউজার ডকুমেন্টের সেটিংস রিসেট করা (ডিফল্ট অবস্থায় আনা)
            const userDocRef = doc(db, "userData", targetUid);
            await setDoc(userDocRef, {
                currentListId: 'default-list',
                currentLedgerId: 'default-ledger',
                itemDatabase: [], // অটোসাজেশন ক্লিয়ার
                darkMode: false,  // ডিফল্ট থিম
                fontSize: 16      // ডিফল্ট ফন্ট
                // লক্ষ্য করুন: accountDisabled বা অন্য অ্যাডমিন ফ্ল্যাগ এখানে হাত দেওয়া হচ্ছে না (merge: true)
            }, { merge: true });

            // ৫. সফলতার মেসেজ এবং UI আপডেট
            showToast("ব্যবহারকারীর সকল ডেটা সফলভাবে রিসেট করা হয়েছে।");
            
            // যেহেতু রিয়েল-টাইম লিসেনার চালু আছে, তাই UI অটোমেটিক আপডেট হবে।
            // তবুও অ্যাডমিন প্যানেলের ভিউ পরিষ্কার করার জন্য:
            adminCurrentFullData = { shoppingLists: {}, ledgers: {} };
            
            // যদি শপিং লিস্ট ভিউ খোলা থাকে
            if (adminCurrentViewContext === 'lists') {
                renderAdminShoppingListUI();
            } else {
                renderAdminLedgerUI();
            }

        } catch (error) {
            console.error("Reset Data Error:", error);
            alert("ডেটা রিসেট করতে সমস্যা হয়েছে: " + error.message);
        }
    }
};

// --- Admin: Manual UID Load with Inline Validation ---
window.adminLoadManualUid = async () => {
    const input = document.getElementById('manualUidInput');
    const errorDiv = document.getElementById('uidInlineError'); // এরর মেসেজের div
    const uid = input.value.trim();

    // আগের এরর স্টাইল রিসেট করা
    input.classList.remove('input-error');
    errorDiv.style.display = 'none';
    errorDiv.innerText = '';

    // ১. বক্স ফাঁকা থাকলে (Validation)
    if (!uid) {
        // লাল বর্ডার দেওয়া
        input.classList.add('input-error');
        
        // উপরে মেসেজ দেখানো
        errorDiv.innerText = "⚠️ বক্সে UID লিখুন";
        errorDiv.style.display = 'block';
        
        // ফোকাস করা (মেসেজটি বক্সের সাথে থাকায় কিবোর্ড উঠলেও সমস্যা হবে না)
        input.focus();
        return;
    }

    // ২. চেক করা হচ্ছে... (বাটনে লোডিং দেখানো)
    const btn = document.querySelector('.manual-uid-submit');
    const originalBtnText = btn.innerText;
    btn.innerText = 'চেক হচ্ছে...';
    btn.disabled = true; // ডাবল ক্লিক রোধ করতে

    try {
        const userRef = doc(db, "all_users_list", uid);
        const docSnap = await getDoc(userRef);

        if (docSnap.exists()) {
            // ৩. সঠিক হলে
            showToast("সঠিক UID! ডেটা লোড করা হচ্ছে...");
            input.value = ''; // ইনপুট ক্লিয়ার
            loadTargetUserData(uid); // ডেটা লোড
        } else {
            // ৪. ভুল বা ফায়ারবেসে না থাকলে (লাল বর্ডার ও মেসেজ)
            input.classList.add('input-error');
            errorDiv.innerHTML = "❌ এই UID টি ডেটাবেসে নেই";
            errorDiv.style.display = 'block';
        }

    } catch (error) {
        console.error("UID Check Error:", error);
        showToast("সার্ভার এরর! দয়া করে আবার চেষ্টা করুন।");
    } finally {
        // বাটন রিসেট
        btn.innerText = originalBtnText;
        btn.disabled = false;
    }
};

// --- HELPER: Save SPECIFIC Sub-document ---
// এই ফাংশনটি পুরো ডেটাবেস ওভাররাইট না করে নির্দিষ্ট ডক আপডেট করবে
async function adminSaveSpecificSubDoc(type, id) {
    const uidSpan = document.getElementById('adminTargetUid');
    let targetUid = '';
    if(uidSpan) {
         const box = uidSpan.querySelector('.uid-display-box span');
         if(box) targetUid = box.textContent.replace('UID:', '').trim();
    }
    if(!targetUid) return;

    try {
        if(type === 'list') {
            const data = adminCurrentFullData.shoppingLists[id];
            if(data) await setDoc(doc(db, 'userData', targetUid, 'my_shopping_lists', id), data);
        } else if (type === 'ledger') {
            const data = adminCurrentFullData.ledgers[id];
            if(data) await setDoc(doc(db, 'userData', targetUid, 'my_ledgers', id), data);
        }
    } catch(e) {
        console.error("Admin Save Error:", e);
        alert("সেভ করতে সমস্যা হয়েছে: " + e.message);
    }
}

// --- HELPER: Delete SPECIFIC Sub-document ---
async function adminDeleteSpecificSubDoc(type, id) {
    const uidSpan = document.getElementById('adminTargetUid');
    let targetUid = '';
    if(uidSpan) {
         const box = uidSpan.querySelector('.uid-display-box span');
         if(box) targetUid = box.textContent.replace('UID:', '').trim();
    }
    if(!targetUid) return;

    try {
        if(type === 'list') {
            await deleteDoc(doc(db, 'userData', targetUid, 'my_shopping_lists', id));
        } else if (type === 'ledger') {
            await deleteDoc(doc(db, 'userData', targetUid, 'my_ledgers', id));
        }
    } catch(e) { console.error(e); }
}

// এই ফাংশনটি আপডেট করুন (সঠিক ভার্সন)
function setupAdminEditorStructure() {
    const container = document.getElementById('adminVisualContainer');
    
    container.innerHTML = `
        <!-- স্টিকি হেডার -->
        <div id="adminStickyHeader" class="admin-sticky-top"></div>
        
        <!-- স্ক্রলেবল লিস্ট এরিয়া -->
        <div id="adminScrollableContent" class="admin-scrollable-list"></div>
        
        <!-- ✅ আইটেমের মোট মূল্য দেখানোর ফুটার (এটি ফিরিয়ে আনা হয়েছে) -->
        <div id="adminTotalFooter" class="admin-total-section" style="display:none;"></div>
    `;
    
    // লক্ষ্য করুন: এখানে editor-footer বা সেভ/ডিলিট বাটনগুলো ইচ্ছাকৃতভাবে বাদ দেওয়া হয়েছে।
}

// Tab Switching
document.getElementById('adminViewListsBtn').addEventListener('click', () => { renderAdminShoppingListUI(true); });
document.getElementById('adminViewLedgersBtn').addEventListener('click', () => { renderAdminLedgerUI(true); });

// --- SHOPPING LIST LOGIC ---

function renderAdminShoppingListUI(resetSearch = false) {
    adminCurrentViewContext = 'lists';
    document.getElementById('adminViewListsBtn').classList.add('active-tab');
    document.getElementById('adminViewLedgersBtn').classList.remove('active-tab');
    
    const listIds = Object.keys(adminCurrentFullData.shoppingLists || {});
    if (!adminSelectedListId || !adminCurrentFullData.shoppingLists[adminSelectedListId]) {
        adminSelectedListId = listIds.length > 0 ? listIds[0] : null;
    }

    const stickyHeader = document.getElementById('adminStickyHeader');
    let headerHtml = `
        <div class="admin-toolbar-group" style="margin-bottom:10px; border:none; padding:0;">
            <div class="admin-dropdown-row">
                <select class="admin-list-select" onchange="adminChangeList(this.value)">`;
    
    if (listIds.length === 0) headerHtml += `<option>কোনো তালিকা নেই</option>`;
    else {
        listIds.forEach(id => {
            const list = adminCurrentFullData.shoppingLists[id];
            headerHtml += `<option value="${id}" ${id === adminSelectedListId ? 'selected' : ''}>${list.name}</option>`;
        });
    }
    headerHtml += `</select></div>
        <div class="admin-btn-group">
            <button class="btn-tool btn-new" onclick="adminCreateList()"><i class="fas fa-plus"></i> নতুন</button>
            <button class="btn-tool btn-rename" onclick="adminRenameList()" ${!adminSelectedListId ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
            <button class="btn-tool btn-remove" onclick="adminDeleteList()" ${!adminSelectedListId ? 'disabled' : ''}><i class="fas fa-trash"></i></button>
        </div></div>`;

    if (adminSelectedListId) {
        headerHtml += `
        <div class="admin-btn-group btn-center" style="margin-bottom: 8px;">
             <button class="btn-tool btn-new" onclick="adminAddNewItem()" style="width:100%; justify-content:center;">+ পণ্য যোগ করুন</button>
        </div>
        <div class="search-row" style="margin-bottom: 5px;">
            <input type="text" id="adminShoppingSearch" class="admin-search-input" placeholder="পণ্য খুঁজুন...">
            <i class="fas fa-search"></i>
        </div>`;
    }
    
    stickyHeader.innerHTML = headerHtml;

    if(adminSelectedListId) {
        document.getElementById('adminShoppingSearch').addEventListener('input', (e) => { renderShoppingItems(e.target.value.toLowerCase()); });
        renderShoppingItems('');
    } else {
        document.getElementById('adminScrollableContent').innerHTML = '';
        document.getElementById('adminTotalFooter').style.display = 'none';
    }
}

function renderShoppingItems(searchTerm) {
    const listArea = document.getElementById('adminScrollableContent');
    const totalFooter = document.getElementById('adminTotalFooter');
    const currentList = adminCurrentFullData.shoppingLists[adminSelectedListId];
    if (!currentList) return;
    
    let items = currentList.items || [];
    let displayedItems = items.map((item, index) => ({...item, originalIndex: index}));
    
    if(searchTerm) {
        displayedItems = displayedItems.filter(item => item.name.toLowerCase().includes(searchTerm));
    }
    
    let grandTotal = 0;
    items.forEach(item => { if (!item.bought) grandTotal += (item.price || 0); });
    
    if (totalFooter) {
        totalFooter.innerHTML = `মোট: <span style="color:var(--primary-color);">${toBengaliNumberLocal(grandTotal)}</span>`;
        totalFooter.style.display = 'block';
    }

    let html = `<div class="admin-items-wrapper">`;
    if (displayedItems.length === 0) html += '<p style="text-align:center; color:#999; padding-top:20px;">পাওয়া যায়নি।</p>';
    else {
        displayedItems.forEach((item) => {
            const index = item.originalIndex;
            const isExpanded = adminExpandedItemIndex === index;
            const priorityClass = `priority-${item.priority || 'low'}`;
            const boughtClass = item.bought ? 'bought' : '';
            const expandedClass = isExpanded ? 'expanded' : '';
            const statusIcon = item.bought ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>';
            const itemTotal = item.price || 0;
            
            // Time logic
            const date = item.addedDate ? new Date(item.addedDate) : new Date();
            const dateStr = date.toLocaleDateString('bn-BD');

            html += `
            <div class="admin-item-card ${priorityClass} ${boughtClass} ${expandedClass}" onclick="adminToggleItemDetails(event, this, ${index})">
                <div class="admin-item-compact-row">
                    <button class="admin-toggle-bought-btn" onclick="event.stopPropagation(); adminToggleBought(${index})">${statusIcon}</button>
                    <span class="admin-item-name-compact">${item.name}</span>
                    <span class="admin-item-total-price-compact">${toBengaliNumberLocal(itemTotal)}</span>
                </div>
                <div class="admin-item-expanded-details">
                    <div class="admin-item-time-date"><i class="fas fa-clock"></i> ${dateStr}</div>
                    <div class="admin-item-actions-expanded">
                        <button class="btn-tool admin-action-sm btn-edit" onclick="event.stopPropagation(); openAdminItemEditModal(${index})"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn-tool admin-action-sm btn-delete" onclick="event.stopPropagation(); adminDeleteItem(${index})"><i class="fas fa-trash-alt"></i> Delete</button>
                    </div>
                </div>
            </div>`;
        });
    }
    html += `</div>`;
    listArea.innerHTML = html;
}

// Shopping List Actions
window.adminChangeList = (id) => { adminSelectedListId = id; renderAdminShoppingListUI(true); };

window.adminCreateList = async () => {
    const name = await adminShowPrompt("নতুন তালিকা", "নাম:");
    if(name) {
        const id = 'list-' + Date.now();
        const newList = { name: name, items: [] };
        adminCurrentFullData.shoppingLists[id] = newList;
        
        // Save only this list to sub-collection
        await adminSaveSpecificSubDoc('list', id);
        
        adminSelectedListId = id;
        renderAdminShoppingListUI(true);
        showToast("তালিকা তৈরি হয়েছে।");
    }
};

window.adminRenameList = async () => {
    const l = adminCurrentFullData.shoppingLists[adminSelectedListId];
    const name = await adminShowPrompt("নাম পরিবর্তন", "নতুন নাম:", l.name);
    if(name) { 
        l.name = name; 
        await adminSaveSpecificSubDoc('list', adminSelectedListId);
        renderAdminShoppingListUI(true); 
    }
};

window.adminDeleteList = async () => {
    if(await adminShowConfirm("নিশ্চিতকরণ", "পুরো তালিকা ডিলিট করবেন?")) {
        await adminDeleteSpecificSubDoc('list', adminSelectedListId);
        delete adminCurrentFullData.shoppingLists[adminSelectedListId];
        adminSelectedListId = null;
        renderAdminShoppingListUI(true);
        showToast("তালিকা ডিলিট হয়েছে।");
    }
};

window.adminToggleBought = async (index) => {
    const item = adminCurrentFullData.shoppingLists[adminSelectedListId].items[index];
    item.bought = !item.bought;
    await adminSaveSpecificSubDoc('list', adminSelectedListId);
    renderShoppingItems(document.getElementById('adminShoppingSearch').value.toLowerCase());
};

window.adminDeleteItem = async (index) => {
    if(await adminShowConfirm("নিশ্চিতকরণ", "পণ্যটি ডিলিট করবেন?")) {
        adminCurrentFullData.shoppingLists[adminSelectedListId].items.splice(index, 1);
        adminExpandedItemIndex = -1;
        await adminSaveSpecificSubDoc('list', adminSelectedListId);
        renderShoppingItems(document.getElementById('adminShoppingSearch').value.toLowerCase());
    }
};

window.adminAddNewItem = () => openAdminItemEditModal(-1);

window.openAdminItemEditModal = (index) => {
    const isNew = index === -1;
    const item = isNew ? {name:'', price:0, priority:'low', bought:false} : adminCurrentFullData.shoppingLists[adminSelectedListId].items[index]; 
    
    document.getElementById('adminItemName').value = item.name;
    document.getElementById('adminItemPrice').value = item.price || 0; 
    document.getElementById('adminItemPriority').value = item.priority || 'low';
    document.getElementById('adminItemBought').value = item.bought ? 'true' : 'false';
    
    const modal = document.getElementById('adminItemEditModal');
    
    // Save Handler
    document.getElementById('adminItemSaveBtn').onclick = async () => {
        const newItem = { 
            name: document.getElementById('adminItemName').value, 
            price: parseFloat(document.getElementById('adminItemPrice').value)||0, 
            priority: document.getElementById('adminItemPriority').value, 
            bought: document.getElementById('adminItemBought').value === 'true', 
            addedDate: item.addedDate || new Date().toISOString() 
        };

        if(isNew) { 
            if(!adminCurrentFullData.shoppingLists[adminSelectedListId].items) adminCurrentFullData.shoppingLists[adminSelectedListId].items=[]; 
            adminCurrentFullData.shoppingLists[adminSelectedListId].items.push(newItem); 
        } else {
            adminCurrentFullData.shoppingLists[adminSelectedListId].items[index] = {...item, ...newItem};
        }
        
        await adminSaveSpecificSubDoc('list', adminSelectedListId);
        
        modal.classList.remove('active');
        adminExpandedItemIndex = -1; 
        renderShoppingItems(document.getElementById('adminShoppingSearch').value.toLowerCase());
    };

    modal.classList.add('active');
};

// --- LEDGER LOGIC ---

function renderAdminLedgerUI(resetSearch = false) {
    adminCurrentViewContext = 'ledgers';
    document.getElementById('adminViewListsBtn').classList.remove('active-tab');
    document.getElementById('adminViewLedgersBtn').classList.add('active-tab');
    
    const totalFooter = document.getElementById('adminTotalFooter');
    if(totalFooter) totalFooter.style.display = 'none';

    const ledgerIds = Object.keys(adminCurrentFullData.ledgers || {});
    if (!adminSelectedLedgerId) adminSelectedLedgerId = 'all';
    if (adminSelectedLedgerId !== 'all' && !ledgerIds.includes(adminSelectedLedgerId)) adminSelectedLedgerId = 'all';

    const stickyHeader = document.getElementById('adminStickyHeader');
    let headerHtml = `
    <div class="admin-toolbar-group" style="margin-bottom:10px; border:none; padding:0;">
        <div class="admin-dropdown-row">
            <select class="admin-list-select" onchange="adminChangeLedger(this.value)">
                <option value="all" ${adminSelectedLedgerId === 'all' ? 'selected' : ''}>📑 সকল খাতা</option>`;
    
    ledgerIds.forEach(id => {
        const ledger = adminCurrentFullData.ledgers[id];
        headerHtml += `<option value="${id}" ${id === adminSelectedLedgerId ? 'selected' : ''}>${ledger.name}</option>`;
    });
    
    headerHtml += `</select></div>
        <div class="admin-btn-group">
            <button class="btn-tool btn-new" onclick="adminCreateLedger()"><i class="fas fa-plus"></i> নতুন</button>
            <button class="btn-tool btn-rename" onclick="adminRenameLedger()" ${adminSelectedLedgerId === 'all' ? 'disabled' : ''}><i class="fas fa-edit"></i></button>
            <button class="btn-tool btn-remove" onclick="adminDeleteLedger()" ${adminSelectedLedgerId === 'all' ? 'disabled' : ''}><i class="fas fa-trash"></i></button>
        </div>
    </div>`;

    // Summary calculation
    let totalPabo = 0, totalDebo = 0;
    const tempLedgerIds = adminSelectedLedgerId === 'all' ? ledgerIds : [adminSelectedLedgerId];
    tempLedgerIds.forEach(lid => {
        const l = adminCurrentFullData.ledgers[lid];
        if(l && l.customers) {
            l.customers.forEach(c => {
                const b = parseFloat(c.currentBalance) || 0;
                if(b > 0) totalPabo += b; else totalDebo += Math.abs(b);
            });
        }
    });

    headerHtml += `
    <div class="admin-ledger-summary" style="margin-bottom:10px;">
        <div class="summary-item"><strong class="text-red">${toBengaliNumberLocal(totalPabo)}</strong><span>মোট পাবো</span></div>
        <div class="summary-item" style="border-left:1px solid #eee;"><strong class="text-green">${toBengaliNumberLocal(totalDebo)}</strong><span>মোট দেবো</span></div>
    </div>`;

    if(adminSelectedLedgerId !== 'all') {
        headerHtml += `
        <div class="admin-btn-group btn-center" style="margin-bottom: 8px;">
             <button class="btn-tool btn-new" onclick="adminAddNewCustomer()" style="width:100%; justify-content:center;">+ গ্রাহক যোগ করুন</button>
        </div>`;
    } else {
        headerHtml += `<div class="ledger-notice-box">গ্রাহক যোগ করতে নির্দিষ্ট খাতা সিলেক্ট করুন।</div>`;
    }
    
    headerHtml += `
    <div class="search-row" style="margin-bottom: 5px;">
        <input type="text" id="adminLedgerSearch" class="admin-search-input" placeholder="গ্রাহক খুঁজুন...">
        <i class="fas fa-search"></i>
    </div>`;
    
    stickyHeader.innerHTML = headerHtml;
    
    document.getElementById('adminLedgerSearch').addEventListener('input', (e) => {
        renderLedgerCustomers(e.target.value.toLowerCase());
    });
    renderLedgerCustomers('');
}

function renderLedgerCustomers(searchTerm) {
    const listArea = document.getElementById('adminScrollableContent');
    if (!listArea) return;

    let allCustomers = [];
    const ledgerIds = Object.keys(adminCurrentFullData.ledgers || {});
    
    if (adminSelectedLedgerId === 'all') {
        ledgerIds.forEach(lid => {
            const ledger = adminCurrentFullData.ledgers[lid];
            if (ledger.customers) {
                ledger.customers.forEach((c, idx) => {
                    allCustomers.push({ ...c, _ledgerId: lid, _idx: idx, _ledgerName: ledger.name });
                });
            }
        });
    } else {
        const ledger = adminCurrentFullData.ledgers[adminSelectedLedgerId];
        if (ledger && ledger.customers) {
            ledger.customers.forEach((c, idx) => {
                allCustomers.push({ ...c, _ledgerId: adminSelectedLedgerId, _idx: idx });
            });
        }
    }
    
    // Sort and Filter
    allCustomers.sort((a, b) => new Date(b.lastUpdated || 0) - new Date(a.lastUpdated || 0));
    if (searchTerm) allCustomers = allCustomers.filter(c => c.name.toLowerCase().includes(searchTerm));

    // HTML Gen
    let html = '';
    if (allCustomers.length === 0) {
        html = '<p style="text-align:center; color:#999; padding-top:20px;">কোনো গ্রাহক নেই।</p>';
    } else {
        const colors = ['#e57373', '#81c784', '#64b5f6', '#ffb74d', '#9575cd', '#4db6ac'];
        allCustomers.forEach((cust) => {
            const rawBalance = parseFloat(cust.currentBalance) || 0;
            const balance = parseFloat(rawBalance.toFixed(2));
            let balanceHtml = balance > 0 ? `<span class="cust-balance-right balance-red">${toBengaliNumberLocal(balance)}</span>` : 
                             (balance < 0 ? `<span class="cust-balance-right balance-green">${toBengaliNumberLocal(Math.abs(balance))}</span>` : `<span class="cust-balance-right balance-neutral">০</span>`);

            const initial = cust.name.charAt(0).toUpperCase();
            const color = colors[Math.abs(cust.name.length) % colors.length];
            const ledgerTag = cust._ledgerName ? `<div class="ledger-tag">📁 ${cust._ledgerName}</div>` : '';
            
            // Transactions Table
            const transactions = cust.transactions || [];
            let txTableRows = '';
            if (transactions.length === 0) txTableRows = `<tr><td colspan="4" style="text-align:center; color:#999;">লেনদেন নেই</td></tr>`;
            else {
                const sortedTx = transactions.map((t, i) => ({...t, orgIdx: i})).sort((a, b) => new Date(b.date) - new Date(a.date));
                sortedTx.forEach((tx) => {
                    const d = new Date(tx.date);
                    const dateStr = `${toBengaliNumberLocal(d.getDate())}/${toBengaliNumberLocal(d.getMonth()+1)}/${toBengaliNumberLocal(d.getFullYear().toString().substr(-2))}`;
                    const colorTx = tx.type === 'gave' ? 'red' : 'green'; 
                    const typeText = tx.type === 'gave' ? 'দিলাম' : 'পেলাম';
                    txTableRows += `
                    <tr class="tx-row-admin" onclick="event.stopPropagation(); openAdminTxEditModal('${cust._ledgerId}', ${cust._idx}, '${tx.id}')">
                        <td>${dateStr}</td>
                        <td style="text-align:left;">${typeText} <br><small>${tx.description || ''}</small></td>
                        <td style="color:${colorTx}; font-weight:bold;">${toBengaliNumberLocal(tx.amount)}</td>
                        <td onclick="event.stopPropagation()">
                            <button class="action-icon-btn icon-del" onclick="adminDeleteTx('${cust._ledgerId}', ${cust._idx}, ${tx.orgIdx})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`;
                });
            }

            html += `
            <div class="admin-replica-customer">
                <div class="customer-top-section" onclick="toggleAdminCustomerTx('${cust._ledgerId}', ${cust._idx})">
                    <div class="cust-info-wrapper">
                        <div class="cust-avatar" style="background-color: ${color};">${initial}</div>
                        <div class="cust-name-block">
                            <span class="cust-name">${cust.name}</span>
                            ${ledgerTag}
                            <span style="font-size:0.75em; color:#999;">${timeAgoAdmin(cust.lastUpdated)}</span>
                        </div>
                    </div>
                    ${balanceHtml}
                </div>
                <div class="customer-bottom-section">
                    <div class="cust-phone">${cust.phone ? toBengaliNumberLocal(cust.phone) : 'ফোন নেই'}</div>
                    <div class="cust-action-buttons">
                        <button class="action-icon-btn icon-edit" onclick="event.stopPropagation(); adminEditCustomer('${cust._ledgerId}', ${cust._idx})"><i class="fas fa-pen"></i></button>
                        <button class="action-icon-btn icon-del" onclick="event.stopPropagation(); adminDeleteCustomer('${cust._ledgerId}', ${cust._idx})"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="admin-cust-tx-${cust._ledgerId}-${cust._idx}" class="admin-tx-container">
                    <div style="text-align:center; margin-bottom:8px;">
                        <button class="btn-tool btn-new" onclick="openAdminTxEditModal('${cust._ledgerId}', ${cust._idx}, -1)" style="width:100%; font-size:0.85em;">+ নতুন লেনদেন</button>
                    </div>
                    <table class="tx-table-admin">
                        <thead><tr><th>তারিখ</th><th style="text-align:left;">বিবরণ</th><th>টাকা</th><th>Action</th></tr></thead>
                        <tbody>${txTableRows}</tbody>
                    </table>
                </div>
            </div>`;
        });
    }
    listArea.innerHTML = html;
}

// Ledger Actions
window.adminChangeLedger = (id) => { adminSelectedLedgerId = id; renderAdminLedgerUI(true); };
window.toggleAdminCustomerTx = (lid, idx) => {
    const el = document.getElementById(`admin-cust-tx-${lid}-${idx}`);
    if(el) el.style.display = el.style.display === 'block' ? 'none' : 'block';
};

window.adminCreateLedger = async () => {
    const name = await adminShowPrompt("নতুন খাতা", "নাম:");
    if(name) {
        const id = 'ledger-'+Date.now();
        adminCurrentFullData.ledgers[id] = {name:name, customers:[]};
        await adminSaveSpecificSubDoc('ledger', id);
        adminSelectedLedgerId = id;
        renderAdminLedgerUI(true);
    }
};

window.adminRenameLedger = async () => {
    const l = adminCurrentFullData.ledgers[adminSelectedLedgerId];
    const name = await adminShowPrompt("নাম পরিবর্তন", "নতুন নাম:", l.name);
    if(name) { 
        l.name = name; 
        await adminSaveSpecificSubDoc('ledger', adminSelectedLedgerId);
        renderAdminLedgerUI(true); 
    }
};

window.adminDeleteLedger = async () => {
    if(await adminShowConfirm("নিশ্চিতকরণ", "পুরো খাতা ডিলিট করবেন?")) {
        await adminDeleteSpecificSubDoc('ledger', adminSelectedLedgerId);
        delete adminCurrentFullData.ledgers[adminSelectedLedgerId];
        adminSelectedLedgerId = 'all';
        renderAdminLedgerUI(true);
        showToast("খাতা ডিলিট হয়েছে।");
    }
};

// Customer CRUD
window.adminAddNewCustomer = async () => {
    const name = await adminShowPrompt("নতুন গ্রাহক", "নাম:");
    if(name) {
        const phone = await adminShowPrompt("ফোন নম্বর", "ফোন (অপশনাল):");
        const nc = { 
            id: 'cust-'+Date.now(), 
            name:name, 
            phone:phone||'', 
            currentBalance:0, 
            lastUpdated:new Date().toISOString(),
            transactions:[] 
        };
        if(!adminCurrentFullData.ledgers[adminSelectedLedgerId].customers) adminCurrentFullData.ledgers[adminSelectedLedgerId].customers = [];
        adminCurrentFullData.ledgers[adminSelectedLedgerId].customers.push(nc);
        
        await adminSaveSpecificSubDoc('ledger', adminSelectedLedgerId);
        renderAdminLedgerUI(true);
    }
};

window.adminEditCustomer = async (lid, idx) => {
    const c = adminCurrentFullData.ledgers[lid].customers[idx];
    const name = await adminShowPrompt("গ্রাহক এডিট", "নাম:", c.name);
    if(name) { 
        const phone = await adminShowPrompt("গ্রাহক এডিট", "ফোন:", c.phone);
        c.name = name; c.phone = phone || ''; 
        await adminSaveSpecificSubDoc('ledger', lid);
        renderLedgerCustomers(document.getElementById('adminLedgerSearch').value.toLowerCase()); 
    }
};

window.adminDeleteCustomer = async (lid, idx) => {
    if(await adminShowConfirm("সতর্কতা", "গ্রাহক এবং সব লেনদেন ডিলিট হবে!")) {
        adminCurrentFullData.ledgers[lid].customers.splice(idx, 1);
        await adminSaveSpecificSubDoc('ledger', lid);
        renderAdminLedgerUI();
    }
};

// Transaction Logic
window.openAdminTxEditModal = (lid, cidx, txId) => {
    const cust = adminCurrentFullData.ledgers[lid].customers[cidx];
    const isNew = txId === -1;
    let tx = isNew ? {amount:0, type:'gave', description:'', date:new Date().toISOString()} : cust.transactions.find(t => t.id === txId);
    
    document.getElementById('adminTxDate').value = tx.date.split('T')[0];
    document.getElementById('adminTxAmount').value = tx.amount;
    document.getElementById('adminTxType').value = tx.type;
    document.getElementById('adminTxDesc').value = tx.description || '';

    const modal = document.getElementById('adminTxEditModal');
    
    document.getElementById('adminTxSaveBtn').onclick = async () => {
        const amount = parseFloat(document.getElementById('adminTxAmount').value) || 0;
        const newTx = { 
            id: isNew ? 'tx-'+Date.now() : txId,
            date: new Date(document.getElementById('adminTxDate').value).toISOString(), 
            amount: parseFloat(amount.toFixed(2)),
            type: document.getElementById('adminTxType').value, 
            description: document.getElementById('adminTxDesc').value 
        };
        
        if(isNew) cust.transactions.push(newTx);
        else Object.assign(tx, newTx);
        
        recalculateCustomerState(cust); // Recalculate Balance
        await adminSaveSpecificSubDoc('ledger', lid);
        
        modal.classList.remove('active');
        renderAdminLedgerUI();
    };
    modal.classList.add('active');
};

window.adminDeleteTx = async (lid, cidx, tidx) => {
    if(await adminShowConfirm("নিশ্চিতকরণ", "লেনদেনটি ডিলিট করবেন?")) {
        const c = adminCurrentFullData.ledgers[lid].customers[cidx];
        c.transactions.splice(tidx, 1);
        recalculateCustomerState(c);
        await adminSaveSpecificSubDoc('ledger', lid);
        renderAdminLedgerUI();
    }
};

// Utils
function recalculateCustomerState(customer) {
    let balance = 0;
    let latestDate = customer.createdAt ? new Date(customer.createdAt) : new Date(0);
    if (customer.transactions) {
        customer.transactions.forEach(tx => {
            const amount = parseFloat(tx.amount) || 0;
            if (tx.type === 'gave') balance += amount; else balance -= amount;
            const txDate = new Date(tx.date);
            if (txDate > latestDate) latestDate = txDate;
        });
    }
    customer.currentBalance = parseFloat(balance.toFixed(2));
    customer.lastUpdated = latestDate.toISOString();
}

// User Data Reset
window.adminCopyUid = (uid) => {
    navigator.clipboard.writeText(uid).then(() => showToast("UID কপি হয়েছে।"));
};

window.adminToggleItemDetails = function(e, element, index) {
    if (e.target.closest('button') || e.target.closest('.admin-toggle-bought-btn')) return;
    
    if (element.classList.contains('expanded')) {
        element.classList.remove('expanded');
        adminExpandedItemIndex = -1;
    } else {
        const currentlyExpanded = document.getElementById('adminScrollableContent').querySelector('.admin-item-card.expanded');
        if (currentlyExpanded) currentlyExpanded.classList.remove('expanded');
        element.classList.add('expanded');
        adminExpandedItemIndex = index;
    }
}

async function adminShowPrompt(title, label, value = '') {
    return new Promise((resolve) => {
        const modal = document.getElementById('promptModal');
        
        // ফিক্স: বডিতে নিয়ে আসা এবং হাই Z-Index
        document.body.appendChild(modal);
        modal.style.zIndex = '50000'; 
        
        document.getElementById('promptTitle').textContent = title;
        document.getElementById('promptLabel').textContent = label;
        const input = document.getElementById('promptInput');
        input.value = value;
        
        const newSubmit = document.getElementById('promptSubmitButton').cloneNode(true);
        const newCancel = document.getElementById('promptCancelButton').cloneNode(true);
        document.getElementById('promptSubmitButton').replaceWith(newSubmit);
        document.getElementById('promptCancelButton').replaceWith(newCancel);

        newSubmit.onclick = () => { 
            modal.classList.remove('active'); 
            modal.style.zIndex = ''; 
            resolve(input.value); 
        };
        newCancel.onclick = () => { 
            modal.classList.remove('active'); 
            modal.style.zIndex = '';
            resolve(null); 
        };
        
        modal.classList.add('active'); 
        input.focus();
    });
}

async function adminShowConfirm(title, message) {
    return new Promise((resolve) => {
        const modal = document.getElementById('confirmationModal');
        
        // ফিক্স ১: মডালটি সবার উপরে আনতে বডিতে অ্যাপেন্ড করা (যদি কোনো কারণে অ্যাপ ভিউয়ের ভেতরে থেকে থাকে)
        document.body.appendChild(modal);

        // ফিক্স ২: Z-Index বাড়িয়ে ৫০,০০০ করা হলো (অ্যাডমিন প্যানেল ২০,০০০ এর উপরে থাকার জন্য)
        modal.style.zIndex = '50000'; 
        
        modal.querySelector('h3').textContent = title;
        document.getElementById('confirmationMessage').textContent = message;
        
        const confirmBtn = document.getElementById('confirmButton');
        const cancelBtn = document.getElementById('cancelButton');
        
        const newConfirm = confirmBtn.cloneNode(true);
        const newCancel = cancelBtn.cloneNode(true);
        
        confirmBtn.replaceWith(newConfirm);
        cancelBtn.replaceWith(newCancel);
        
        newConfirm.onclick = () => { 
            modal.classList.remove('active'); 
            modal.style.zIndex = ''; // রিসেট
            resolve(true); 
        };
        newCancel.onclick = () => { 
            modal.classList.remove('active'); 
            modal.style.zIndex = ''; // রিসেট
            resolve(false); 
        };
        
        modal.classList.add('active');
    });
}

window.closeAdminModal = (id) => document.getElementById(id).classList.remove('active');

function updateAdminLedgerHeaderStats() {
    let totalPabo = 0;
    let totalDebo = 0;
    
    const ledgerIds = Object.keys(adminCurrentFullData.ledgers || {});
    const tempLedgerIds = adminSelectedLedgerId === 'all' ? ledgerIds : [adminSelectedLedgerId];

    tempLedgerIds.forEach(lid => {
        const l = adminCurrentFullData.ledgers[lid];
        if(l && l.customers) {
            l.customers.forEach(c => {
                const b = parseFloat((parseFloat(c.currentBalance) || 0).toFixed(2));
                
                if(b > 0) totalPabo += b; // শুধুমাত্র পাবো
                else if(b < 0) totalDebo += Math.abs(b); // শুধুমাত্র দেবো
            });
        }
    });

    const summaryContainer = document.querySelector('.admin-ledger-summary');
    if(summaryContainer) {
        const paboEl = summaryContainer.querySelector('.text-red');
        const deboEl = summaryContainer.querySelector('.text-green');
        
        if(paboEl) paboEl.textContent = toBengaliNumberLocal(parseFloat(totalPabo.toFixed(2)));
if(deboEl) deboEl.textContent = toBengaliNumberLocal(parseFloat(totalDebo.toFixed(2)));
    }
}

// --- Admin Button Auto-Hide Logic ---
// টাইপিং বা ইনপুটের সময় অ্যাডমিন বাটন লুকিয়ে ফেলা

const adminHideInputs = document.querySelectorAll('input, select, textarea');
const adminBtn = document.getElementById('openAdminBtn');

if (adminBtn) {
    // ১. ইনপুট ফিল্ডে ফোকাস করলে বাটন হাইড হবে
    adminHideInputs.forEach(input => {
        input.addEventListener('focus', () => {
            adminBtn.style.display = 'none';
        });
        input.addEventListener('blur', () => {
            // অ্যাডমিন হলে বাটন আবার দেখাবে
            if (auth.currentUser && auth.currentUser.uid === ADMIN_UID && adminPanelPage.style.display === 'none') {
                adminBtn.style.display = 'block';
            }
        });
    });

    // ২. ক্যালকুলেটর ওপেন হলে বাটন হাইড হবে (অবজারভার দিয়ে ডিটেক্ট করা)
    const calcObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
            if (mutation.target.classList.contains('show')) {
                adminBtn.style.display = 'none';
            } else {
                // ক্যালকুলেটর বন্ধ হলে এবং অ্যাডমিন প্যানেল বন্ধ থাকলে বাটন দেখাবে
                if (auth.currentUser && auth.currentUser.uid === ADMIN_UID && adminPanelPage.style.display === 'none') {
                    adminBtn.style.display = 'block';
                }
            }
        });
    });

    const calculatorEl = document.getElementById('customCalculator');
    if (calculatorEl) {
        calcObserver.observe(calculatorEl, { attributes: true, attributeFilter: ['class'] });
    }
}
        
        // Registering Service Worker
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('firebase-messaging-sw.js')
                .then(registration => {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(error => {
                    console.log('ServiceWorker registration failed: ', error);
                });
        });
    }

        // --- Global State Variables ---
        let loadingInterval = null;
const loadingMessages = [
    "সংযোগ স্থাপন করা হচ্ছে...",
    "আপনার ডেটা আনা হচ্ছে...",
    "হিসাব প্রস্তুত করা হচ্ছে...",
    "সবকিছু প্রায় প্রস্তুত!"
];

// --- Real-time Listeners Unsubscribe Functions ---
let unsubscribeUserDoc = null;
let unsubscribeShoppingLists = null;
let unsubscribeLedgers = null;

// Admin Panel Listeners
let unsubscribeAdminAllUsers = null;
let unsubscribeAdminTargetLists = null;
let unsubscribeAdminTargetLedgers = null;

        let currentUser = null; 
        let currentView = 'shoppingList';
        let currentLedgerTab = 'main'; // 'main', 'receivable', 'payable'
        
        let zIndexCounter = 999;
        
        let touchstartX = null;
let touchendX = 0;
let touchstartY = 0;
let touchendY = 0;
const swipeThreshold = 80; // সোয়াইপ হিসাবে গণ্য হওয়ার জন্য ন্যূনতম দূরত্ব (পিক্সেল)
// ** <-- এই পর্যন্ত --> **

let lastOfflineToastTime = 0; // অফলাইন টোস্ট কন্ট্রোল করার জন্য ভেরিয়েবল


        // Shopping List State
        let shoppingLists = {};
        let currentListId = 'default-list';
        let shoppingItems = []; // This is a reference to the items of the current list
        let itemDatabase = new Set();
        const MAX_DATABASE_SIZE = 100;
        let draggedItem = null;
        let lastDeletedItem = null;
        let undoTimeout;
        let expandedItemIndex = -1; // NEW: To track which item is expanded

        // Ledger State (NEW STRUCTURE)
        let ledgers = {};
        let currentLedgerId = 'default-ledger';
        let currentLedgerView = 'main';
        let currentCustomerId = null;
        const customerColors = ['#e57373', '#81c784', '#64b5f6', '#ffb74d', '#9575cd', '#4db6ac', '#f06292', '#7986cb'];

        // START: Back Button Logic Variables
        let backPressCount = 0;
        let backPressTimeout;
        // END: Back Button Logic Variables
        
        // PERFORMANCE UPDATE: Pagination and lazy loading state
        const PAGE_SIZE = 30;
        let shoppingListItemsToShow = PAGE_SIZE;
        let customerListItemsToShow = PAGE_SIZE;
        let shoppingListObserver, customerListObserver;
        let allCustomers = []; // A flattened, sorted list for rendering

        // Common DOM Elements
        const body = document.body;
        const mainContainer = document.getElementById('mainContainer');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const infoButton = document.getElementById('infoButton');
        const toastContainer = document.getElementById('toastContainer');
        const loader = document.getElementById('loader');
        
        // Auth View DOM Elements
        const loginView = document.getElementById('login-view');
        const appView = document.getElementById('app-view');
        const signInBtn = document.getElementById('signInBtn');
        const profileBtn = document.getElementById('profileBtn');
        const profileMenu = document.getElementById('profileMenu');
        const signOutBtn = document.getElementById('signOutBtn');
        
        const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const showRegisterFormLink = document.getElementById('showRegisterFormLink');
const showLoginFormLink = document.getElementById('showLoginFormLink');
const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        
        // View Switcher
        const showShoppingListBtn = document.getElementById('showShoppingListBtn');
        const showLedgerBtn = document.getElementById('showLedgerBtn');
        const shoppingListSection = document.getElementById('shoppingListSection');
        const ledgerSection = document.getElementById('ledgerSection');
        
        // Shopping List DOM Elements
        const itemNameInput = document.getElementById('itemName');
        // REMOVED: itemQuantityInput
        const itemPriceInput = document.getElementById('itemPrice');
        const itemPriorityInput = document.getElementById('itemPriority');
        const shoppingListDiv = document.getElementById('shoppingList');
        const totalAmountSpan = document.getElementById('totalAmount');
        const currentListSelector = document.getElementById('currentListSelector');
        const voiceInputButton = document.getElementById('voiceInputButton');
        const autocompleteSuggestions = document.getElementById('autocompleteSuggestions');
        const shoppingListSearchInput = document.getElementById('shoppingListSearchInput');
        
        // Ledger DOM Elements (NEW)
        const currentLedgerSelector = document.getElementById('currentLedgerSelector');
        const ledgerMainView = document.getElementById('ledgerMainView');
        const ledgerCustomerView = document.getElementById('ledgerCustomerView');
        const receivableListView = document.getElementById('receivableListView');
        const payableListView = document.getElementById('payableListView');
        const customerListDiv = document.getElementById('customerList');
        const fabAddCustomerBtn = document.getElementById('fabAddCustomerBtn');
        const addCustomerModal = document.getElementById('addCustomerModal');
        const editCustomerModal = document.getElementById('editCustomerModal');
        const backToLedgerMainBtn = document.getElementById('backToLedgerMainBtn');
        const customerViewName = document.getElementById('customerViewName');
        const customerViewPhone = document.getElementById('customerViewPhone');
        const customerViewBalance = document.getElementById('customerViewBalance');
        const customerOptionsBtn = document.getElementById('customerOptionsBtn');
        const customerOptionsMenu = document.getElementById('customerOptionsMenu');

        const gaveAmountInput = document.getElementById('gaveAmountInput');
        const receivedAmountInput = document.getElementById('receivedAmountInput');
        const transactionDescriptionInput = document.getElementById('transactionDescriptionInput');
        const transactionDateInput = document.getElementById('transactionDateInput');
        const transactionDateLabel = document.getElementById('transactionDateLabel');
        const confirmTransactionBtn = document.getElementById('confirmTransactionBtn');
        const customerSearchInput = document.getElementById('customerSearchInput');
        const txConfirmModal = document.getElementById('txConfirmModal');
        
        const transactionDetailModal = document.getElementById('transactionDetailModal');
        const editTransactionModal = document.getElementById('editTransactionModal');
        let activeEditingTx = { customerId: null, txId: null, originalTx: null };
        let activeEditingCustomer = null;
        
        // NEW Bottom Navigation Menus
        const shoppingListBottomMenu = document.getElementById('shoppingListBottomMenu');
        const ledgerBottomMenu = document.getElementById('ledgerBottomMenu');


        // PDF rendering elements
        const pdfItemsContainer = document.getElementById('pdfItemsContainer');
        const pdfLedgerContent = document.getElementById('pdfLedgerContent');
        
        // New Page Auth Elements
        const registerConfirmPasswordInput = document.getElementById('registerConfirmPassword');
        // Removed: changePasswordModal
        const currentPasswordInput = document.getElementById('currentPasswordInput');
        const newPasswordInput = document.getElementById('newPasswordInput');
        const confirmNewPasswordInput = document.getElementById('confirmNewPasswordInput');
        const saveNewPasswordBtn = document.getElementById('saveNewPasswordBtn');

        // New Page Auth Elements (NEW)
        const changePasswordPage = document.getElementById('changePasswordPage');
        const backFromChangePasswordPage = document.getElementById('backFromChangePasswordPage');
        const cancelChangePasswordBtn = document.getElementById('cancelChangePasswordBtn');

        const resetPasswordPage = document.getElementById('resetPasswordPage');
        const resetPasswordEmailInput = document.getElementById('resetPasswordEmailInput');
        const resetPasswordSubmitBtn = document.getElementById('resetPasswordSubmitBtn');
        const cancelResetPasswordBtn = document.getElementById('cancelResetPasswordBtn');
        
        // START: New Change Name Page Elements
        const changeNamePage = document.getElementById('changeNamePage');
        const changeNameFirstNameInputPage = document.getElementById('changeNameFirstNameInputPage');
        const changeNameLastNameInputPage = document.getElementById('changeNameLastNameInputPage');
        const saveChangedNamePageBtn = document.getElementById('saveChangedNamePageBtn');
        // END: New Change Name Page Elements


        // Custom Modals DOM elements
        const alertModal = document.getElementById('alertModal');
        const alertMessage = document.getElementById('alertMessage');
        const confirmationModal = document.getElementById('confirmationModal');
        const confirmationMessage = document.getElementById('confirmationMessage');

        let confirmPromiseResolve;
        const promptModal = document.getElementById('promptModal');
        const promptTitle = document.getElementById('promptTitle');
        const promptLabel = document.getElementById('promptLabel');
        const promptInput = document.getElementById('promptInput');
        const promptSubmitButton = document.getElementById('promptSubmitButton');
        const promptCancelButton = document.getElementById('promptCancelButton');
        let promptPromiseResolve;
        const editItemModal = document.getElementById('editItemModal');
        const editItemNameInput = document.getElementById('editItemName');
        // REMOVED: editItemQuantityInput
        const editItemPriceInputModal = document.getElementById('editItemPrice');
        const editItemPriorityInput = document.getElementById('editItemPriority');
        const editItemSaveButton = document.getElementById('editItemSaveButton');
        const editItemCancelButton = document.getElementById('editItemCancelButton');
        
        const monthlySpendingModal = document.getElementById('monthlySpendingModal');
        const LAST_MONTHLY_REPORT_KEY = 'lastMonthlyReportShown';

        // Share Modal elements
        const shareModalOverlay = document.getElementById('shareModalOverlay');
        const shareableTextPre = document.getElementById('shareableText');
        const shareModalTitle = document.getElementById('shareModalTitle');
        
        // ... (আপনার অন্যান্য const ভেরিয়েবলগুলো) ...
// const changeEmailModal = document.getElementById('changeEmailModal'); // এই লাইনটি মুছুন বা কমেন্ট করুন

// START: NEW Change Email Page Elements
const changeEmailPage = document.getElementById('changeEmailPage'); // <-- নতুন লাইন
const changeEmailCurrentPasswordInput = document.getElementById('changeEmailCurrentPasswordInput'); // <-- নতুন লাইন
const changeEmailNewEmailInput = document.getElementById('changeEmailNewEmailInput'); // <-- নতুন লাইন
const backFromChangeEmailPage = document.getElementById('backFromChangeEmailPage'); // <-- নতুন লাইন
const cancelChangeEmailPageBtn = document.getElementById('cancelChangeEmailPageBtn'); // <-- নতুন লাইন
const saveNewEmailBtn = document.getElementById('saveNewEmailBtn'); // <-- নতুন লাইন
// END: NEW Change Email Page Elements
// ...

        // Report Page Elements
        const reportPage = document.getElementById('reportPage');
        const backFromReportBtn = document.getElementById('backFromReportBtn');
        const reportListFilter = document.getElementById('reportListFilter');
        const reportStartDateInput = document.getElementById('reportStartDate');
        const reportEndDateInput = document.getElementById('reportEndDate');
        const applyDateFilterButton = document.getElementById('applyDateFilter');
        const reportSummaryTotalLists = document.getElementById('reportSummaryTotalLists');
        const reportSummaryTotalItems = document.getElementById('reportSummaryTotalItems');
        const reportSummaryOverallTotal = document.getElementById('reportSummaryOverallTotal');
        const reportSummaryBoughtItemsCount = document.getElementById('reportSummaryBoughtItemsCount');
        const reportSummaryBoughtItemsTotal = document.getElementById('reportSummaryBoughtItemsTotal');
        const reportSummaryUnboughtItemsCount = document.getElementById('reportSummaryUnboughtItemsCount');
        const reportSummaryUnboughtItemsTotal = document.getElementById('reportSummaryUnboughtItemsTotal');
        const reportMonthlySpendingDiv = document.getElementById('reportMonthlySpending');
        const reportAnnualSpendingDiv = document.getElementById('reportAnnualSpending');
        const noMonthlyData = document.getElementById('noMonthlyData');
        const noAnnualData = document.getElementById('noAnnualData');
        const reportPriorityFilter = document.getElementById('reportPriorityFilter');
        const reportPriorityItemsDiv = document.getElementById('reportPriorityItems');
        const noPriorityData = document.getElementById('noPriorityData');
        // const reportPriorityTotal = document.getElementById('reportPriorityTotal'); // HTML-এ নেই
        // const reportPriorityTotalAmount = document.getElementById('reportPriorityTotalAmount'); // HTML-এ নেই
        const reportTopSpendingItemsDiv = document.getElementById('reportTopSpendingItems');
        const noTopSpendingData = document.getElementById('noTopSpendingData');
        const reportAllBoughtItemsDiv = document.getElementById('reportAllBoughtItems');
        const noBoughtItemsData = document.getElementById('noBoughtItemsData');
        // const reportBoughtTotal = document.getElementById('reportBoughtTotal'); // HTML-এ নেই
        // const reportBoughtTotalAmount = document.getElementById('reportBoughtTotalAmount'); // HTML-এ নেই
        const reportAllUnboughtItemsDiv = document.getElementById('reportAllUnboughtItems');
        const noUnboughtItemsData = document.getElementById('noUnboughtItemsData');
        // const reportUnboughtTotal = document.getElementById('reportUnboughtTotal'); // HTML-এ নেই
        // const reportUnboughtTotalAmount = document.getElementById('reportUnboughtTotalAmount'); // HTML-এ নেই
        
        // NEW: Customer Report Page Elements
        const customerReportPage = document.getElementById('customerReportPage');
        const backFromCustomerReportBtn = document.getElementById('backFromCustomerReportBtn');
        const customerReportPageName = document.getElementById('customerReportPageName');
        const customerReportPageContent = document.getElementById('customerReportPageContent');
        const customerReportPageFooterContainer = document.getElementById('customerReportPageFooterContainer');
        const customerReportPdfBtn = document.getElementById('customerReportPdfBtn');
        const customerReportShareBtn = document.getElementById('customerReportShareBtn');
        const customerReportCopyBtn = document.getElementById('customerReportCopyBtn');
        
        // Date Filter Results Elements (HTML-এ বিদ্যমান)
        const dateFilterResults = document.getElementById('dateFilterResults');
        const dateFilterTotalAmount = document.getElementById('dateFilterTotalAmount');
        const dateFilterBoughtTotal = document.getElementById('dateFilterBoughtTotal');
        const dateFilterUnboughtTotal = document.getElementById('dateFilterUnboughtTotal');
        const displayDateRange = document.getElementById('displayDateRange');
        const dateFilterItemsList = document.getElementById('dateFilterItemsList');
        const noDateFilterItemsData = document.getElementById('noDateFilterItemsData');


        // Font Size Controls
        const decreaseFontButton = document.getElementById('decreaseFont');
        const resetFontButton = document.getElementById('resetFont');
        const increaseFontButton = document.getElementById('increaseFont');
        const defaultFontSize = parseFloat(getComputedStyle(document.documentElement).getPropertyValue('--default-font-size'));
        let currentFontSize = defaultFontSize;

        let recognition; // For Web Speech API
        
        // --- Auth Listener (Optimized for Speed) ---
onAuthStateChanged(auth, async (user) => {
    // অ্যাডমিন বাটনের রেফারেন্স
    const adminBtn = document.getElementById('openAdminBtn');
    
    // আগের কোনো ব্লক পপআপ থাকলে ক্লিয়ার করা
    const oldOverlay = document.getElementById('blocked-user-popup');
    if(oldOverlay) oldOverlay.remove();

    if (user) {
        // ১. ইউজার ব্লকড কিনা চেক (ফাস্ট চেকিং)
        // এখানে getDoc এর বদলে onSnapshot ব্যবহার করা ভালো, যাতে ব্লক করলে সাথে সাথে অ্যাপ বন্ধ হয়
        const userStatusRef = doc(db, "all_users_list", user.uid);
        
        // ব্লক চেকিং লজিক (Lite Version)
        getDoc(userStatusRef).then(docSnap => {
            if (docSnap.exists() && docSnap.data().disabled === true) {
                signOut(auth);
                window.location.reload(); // পেজ রিলোড দিয়ে ব্লক স্ক্রিন আনা হবে
            }
        });

        currentUser = user;

        // অ্যাডমিন বাটন হ্যান্ডলিং
        if (user.uid === "66XoRf3tu4Z8QVXW7iQv09hJJr32") { // আপনার অ্যাডমিন UID
            if(adminBtn) adminBtn.style.display = 'block';
        } else {
            if(adminBtn) adminBtn.remove();
        }

        const changeEmailBtn = document.getElementById('changeEmailBtn');
        const isEmailPasswordUser = user.providerData.some(p => p.providerId === 'password');
        if (changeEmailBtn) changeEmailBtn.style.display = isEmailPasswordUser ? 'block' : 'none';

        // ২. UI ট্রানজিশন (লগইন স্ক্রিন থেকে অ্যাপ ভিউ)
        loginView.style.display = 'none';
        appView.style.display = 'flex';

        // ৩. লোডার চালু করা (সুন্দর স্পিনার)
        // এটি ডেটা লোড না হওয়া পর্যন্ত ঘুরবে
        manageLoader(true, "আপনার ডেটা সাজানো হচ্ছে...");

        // নাম ও ইমেইল সেট করা
        const profileUserNameDiv = document.getElementById('profileUserName');
        const profileUserEmailDiv = document.getElementById('profileUserEmail');
        if (profileUserNameDiv) profileUserNameDiv.textContent = user.displayName || 'ব্যবহারকারী';
        if (profileUserEmailDiv && user.email) {
            profileUserEmailDiv.textContent = user.email;
            profileUserEmailDiv.style.display = 'block';
        } else if (profileUserEmailDiv) {
            profileUserEmailDiv.style.display = 'none';
        }

        // ৪. ডেটা লোড শুরু করা (এটি ব্যাকগ্রাউন্ডে চলবে)
        loadDataFromFirestore();

        // ৫. ইউজারের তথ্য আপডেট (অ্যাসিঙ্ক্রোনাস - লোডিং আটকাবে না)
        try {
            const userListRef = doc(db, 'all_users_list', user.uid);
            // await ছাড়াই কল করা হয়েছে যাতে অ্যাপ ফাস্ট ওপেন হয়
            setDoc(userListRef, {
                uid: user.uid,
                name: user.displayName || 'No Name',
                email: user.email,
                lastLogin: new Date().toISOString(),
                createdAt: user.metadata.creationTime
            }, { merge: true });
        } catch (e) { console.log("User update error", e); }

    } else {
        // লগ আউট অবস্থায়
        currentUser = null;
        if(adminBtn) adminBtn.remove();
        loginView.style.display = 'flex';
        appView.style.display = 'none';
        document.body.classList.remove('auth-loading');
        manageLoader(false); // লোডার বন্ধ
    }
});

        function signInWithGoogle() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider)
                .then(result => {
                    const user = result.user;
                    if (user) {
                        sessionStorage.setItem('justLoggedIn', 'true');
                    }
                })
                .catch(error => {
                    console.error("Sign-in error:", error);
                    customAlert("সাইন ইন করা যায়নি। আপনার ব্রাউজারে পপ-আপ ব্লক করা থাকলে তা বন্ধ করে আবার চেষ্টা করুন।");
                });
        }

        async function signOutWithConfirmation() {
    const confirmed = await customConfirm("আপনি কি নিশ্চিতভাবে লগ আউট করতে চান?");
    if (confirmed) {
        // ১. সব রিয়েল-টাইম লিসেনার বন্ধ করা (মেমোরি লিক রোধ ও সিকিউরিটি)
        if (unsubscribeUserDoc) unsubscribeUserDoc();
        if (unsubscribeShoppingLists) unsubscribeShoppingLists();
        if (unsubscribeLedgers) unsubscribeLedgers();
        
        if (typeof undoTimeout !== 'undefined') clearTimeout(undoTimeout);
        if (typeof loadingInterval !== 'undefined') clearInterval(loadingInterval);
        
        // ২. সাইন আউট
        signOut(auth).catch(error => {
            console.error("Sign-out error:", error);
        });
    }
}
        
        // --- START: New Change Name Page Logic ---
        
        function showChangeNamePage() {
            if (!currentUser) return;
            
            profileMenu.style.display = 'none'; 
            mainContainer.style.display = 'none';
            changePasswordPage.style.display = 'none'; 
            resetPasswordPage.style.display = 'none'; 
            changeEmailPage.style.display = 'none'; // ADDED for safety
            changeNamePage.style.display = 'flex'; 
            document.body.style.overflow = 'hidden';
            history.pushState({ view: 'change-name' }, '', location.href);
            
            // Populate current values
            const currentName = currentUser.displayName || '';
            const names = currentName.split(' ');
            const firstName = names[0] || '';
            const lastName = names.slice(1).join(' ') || '';

            changeNameFirstNameInputPage.value = firstName;
            changeNameLastNameInputPage.value = lastName;

            // Clear previous errors
            clearFormError(changeNameFirstNameInputPage);
            clearFormError(changeNameLastNameInputPage);
            
            changeNameFirstNameInputPage.focus();
        }

        function hideChangeNamePage() {
             changeNamePage.style.display = 'none';
             mainContainer.style.display = 'flex';
             document.body.style.overflow = '';
             // START: Fix for back button exit prompt (Goal 2)
             if (backPressCount > 0) {
                 clearTimeout(backPressTimeout);
                 backPressCount = 0;
                 // Ensures the last history state is clean 'home' not 'home-exit-prompt'
                 history.replaceState({ view: 'home' }, '', location.href); 
             }
             // END: Fix for back button exit prompt
        }

        async function handleSaveChangedNamePage() {
            if (!currentUser) return;

            const firstName = changeNameFirstNameInputPage.value.trim();
            const lastName = changeNameLastNameInputPage.value.trim();
            
            clearFormError(changeNameFirstNameInputPage);
            clearFormError(changeNameLastNameInputPage);

            if (firstName === '') {
                showFormError(changeNameFirstNameInputPage, 'প্রথম নাম অবশ্যই দিতে হবে।');
                return;
            }
            
            const newName = [firstName, lastName].filter(n => n !== '').join(' ');

            if (newName.length === 0) {
                 showFormError(changeNameFirstNameInputPage, 'নাম খালি হতে পারে না।');
                 return;
            }

            try {
                await updateProfile(currentUser, { displayName: newName });
                const profileUserNameDiv = document.getElementById('profileUserName');
                if (profileUserNameDiv) {
                    profileUserNameDiv.textContent = newName;
                }
                showToast("আপনার নাম সফলভাবে পরিবর্তন করা হয়েছে।");
                history.back(); // Use history.back() for correct flow
                // Pop the 'change-name' state
            } catch (error) {
                console.error("Error updating profile:", error);
                customAlert("নাম পরিবর্তন করা যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।");
            }
        }
        // --- END: New Change Name Page Logic ---
        
        async function handleChangePassword() {
            if (!currentUser) return;
            
            // প্রোফাইল মেনু বন্ধ করার ফিক্স
            const profileMenu = document.getElementById('profileMenu');
            if (profileMenu) {
                profileMenu.style.display = 'none';
            }

            // ব্যবহারকারী গুগল দিয়ে সাইন ইন করেছেন কিনা তা চেক করা হচ্ছে
            const isEmailLogin = currentUser.providerData.some(p => p.providerId === 'password');
            const isGoogleLogin = currentUser.providerData.some(p => p.providerId === 'google.com'); // গুগল লগইন চেক
            
            if (isEmailLogin) { 
                // যদি ইমেইল পাসওয়ার্ড দিয়ে লগইন করা থাকে, তবে পাসওয়ার্ড পরিবর্তনের সাধারণ পেজ দেখাও
                showChangePasswordPage(false); 
            } else if (isGoogleLogin && !isEmailLogin) {
                // যদি শুধুমাত্র গুগল দিয়ে লগইন করা থাকে (অর্থাৎ পাসওয়ার্ড সেট করা নেই)
                
                // এখানে আমরা পাসওয়ার্ড পরিবর্তনের পেজটিকে 'পাসওয়ার্ড সেট' করার মোডে দেখাবো
                showChangePasswordPage(true); 
                
            } else {
                // অন্য কোনো বিরল প্রোভাইডার থাকলে
                customAlert('আপনার বর্তমান সাইন ইন পদ্ধতিটি পাসওয়ার্ড পরিবর্তন সমর্থন করে না।', 'সতর্কতা');
            }
        }
// ...

// --- START: New Change Password Page Logic (MODIFIED) ---

function showChangePasswordPage(isGoogleUser = false) { // নতুন প্যারামিটার যোগ করা হলো
    mainContainer.style.display = 'none';
    changeNamePage.style.display = 'none';
    resetPasswordPage.style.display = 'none';
    changeEmailPage.style.display = 'none'; // ADDED for safety
    customerReportPage.style.display = 'none'; // ADDED for safety
    reportPage.style.display = 'none'; // ADDED for safety
    changePasswordPage.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    history.pushState({ view: 'change-password' }, '', location.href);

    // ইনপুট রিসেট
    currentPasswordInput.value = '';
    newPasswordInput.value = '';
    confirmNewPasswordInput.value = '';
    
    // নতুন DOM এলিমেন্টগুলো
    const currentPasswordGroup = document.getElementById('currentPasswordGroup');
    const saveNewPasswordBtn = document.getElementById('saveNewPasswordBtn');
    const passwordChangeMessage = document.getElementById('passwordChangeMessage');
    
    // START: গুগল ইউজারদের জন্য UI পরিবর্তন
    if (isGoogleUser) {
        currentPasswordGroup.style.display = 'none';
        passwordChangeMessage.textContent = 'আপনার গুগল অ্যাকাউন্টের সাথে ইমেইল ও পাসওয়ার্ড যুক্ত করতে নতুন পাসওয়ার্ড সেট করুন।';
        saveNewPasswordBtn.textContent = 'পাসওয়ার্ড সেট করুন';
        saveNewPasswordBtn.dataset.isGoogleUser = 'true'; // লজিকের জন্য ট্যাগ
    } else {
        currentPasswordGroup.style.display = 'block'; // ডিফল্টভাবে block
        passwordChangeMessage.textContent = 'আপনার বর্তমান পাসওয়ার্ড যাচাই করে নতুন পাসওয়ার্ড সেট করুন।';
        saveNewPasswordBtn.textContent = 'সংরক্ষণ করুন';
        saveNewPasswordBtn.dataset.isGoogleUser = 'false';
    }
    // END: গুগল ইউজারদের জন্য UI পরিবর্তন

    // পাসওয়ার্ড টগল সেটআপ
    setupPasswordToggle(changePasswordPage);

    // আগের error ক্লাসগুলো মুছে ফেলা
    [currentPasswordInput, newPasswordInput, confirmNewPasswordInput].forEach(clearFormError);
    
    newPasswordInput.focus(); // এখন আর পুরাতন পাসওয়ার্ডে ফোকাস হবে না
}

function hideChangePasswordPage() {
    changePasswordPage.style.display = 'none';
    mainContainer.style.display = 'flex';
    document.body.style.overflow = '';
     // START: Fix for back button exit prompt (Goal 2)
    if (backPressCount > 0) {
        clearTimeout(backPressTimeout);
        backPressCount = 0;
        history.replaceState({ view: 'home' }, '', location.href); 
    }
    // END: Fix for back button exit prompt
}
// ...


async function saveNewPassword() {
    // 1. ভ্যালিডেশন
    const saveNewPasswordBtn = document.getElementById('saveNewPasswordBtn');
    const isGoogleUser = saveNewPasswordBtn.dataset.isGoogleUser === 'true'; // গুগল ইউজার কিনা চেক করা হচ্ছে
    
    const currentPass = currentPasswordInput.value;
    const newPass = newPasswordInput.value;
    const confirmNewPass = confirmNewPasswordInput.value;
    
    // সকল error মুছে ফেলা হচ্ছে
    [currentPasswordInput, newPasswordInput, confirmNewPasswordInput].forEach(clearFormError); 

    let isValid = true;

    // গুগল ইউজার না হলে পুরাতন পাসওয়ার্ড ভ্যালিডেশন দরকার
    if (!isGoogleUser && currentPass.length < 6) {
        showFormError(currentPasswordInput, 'বর্তমান পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে।'); 
        isValid = false;
    }
    if (newPass.length < 6) {
        showFormError(newPasswordInput, 'নতুন পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে।'); 
        isValid = false;
    }
    if (newPass !== confirmNewPass) {
        showFormError(confirmNewPasswordInput, 'পাসওয়ার্ড দুটি মিলছে না।'); 
        isValid = false;
    }
    
    if (!isValid) return;

    try {
        if (isGoogleUser) {
            // 2. শুধুমাত্র গুগল ইউজারের জন্য: নতুন পাসওয়ার্ড লিঙ্ক করা
            const credential = EmailAuthProvider.credential(currentUser.email, newPass);
            await linkWithCredential(currentUser, credential);

            showToast('ইমেইল ও পাসওয়ার্ড সফলভাবে যুক্ত করা হয়েছে।');

        } else {
            // 2. সাধারণ ইউজারের জন্য: Re-authentication (বর্তমান পাসওয়ার্ড যাচাই)
            const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
            await reauthenticateWithCredential(currentUser, credential);

            // 3. পাসওয়ার্ড আপডেট
            await updatePassword(currentUser, newPass);
            
            showToast('আপনার পাসওয়ার্ড সফলভাবে পরিবর্তন করা হয়েছে।');
        }
        
        history.back(); // Use history.back() for correct flow
        
    } catch (error) {
        console.error("Password Change Error:", error.code, error.message);
        if (error.code === 'auth/invalid-credential' || error.code === 'auth/wrong-password' || error.code === 'auth/user-mismatch') {
            showFormError(currentPasswordInput, 'বর্তমান পাসওয়ার্ডটি ভুল।');
            showToast('বর্তমান পাসওয়ার্ড ভুল দেওয়া হয়েছে।', { type: 'error' });
        } else if (error.code === 'auth/requires-recent-login') {
             customAlert('নিরাপত্তার জন্য, আপনাকে আবার লগইন করে পাসওয়ার্ড পরিবর্তন/যুক্ত করতে হবে।', 'সতর্কতা');
             history.back();
        } else if (error.code === 'auth/weak-password') {
             showFormError(newPasswordInput, 'পাসওয়ার্ডটি খুব দুর্বল। আরও শক্তিশালী পাসওয়ার্ড দিন।');
             showToast('পাসওয়ার্ডটি খুব দুর্বল।', { type: 'error' });
        } else if (error.code === 'auth/credential-already-in-use') {
             customAlert('এই ইমেইলটি ইতিমধ্যেই অন্য একটি অ্যাকাউন্টের সাথে যুক্ত আছে।', 'ত্রুটি');
        } else {
            customAlert('পাসওয়ার্ড পরিবর্তন/যুক্ত ব্যর্থ: ' + error.message, 'ত্রুটি');
        }
    }
}

// --- END: New Change Password Page Logic ---

function showChangeEmailPage() { // ফাংশনের নাম পরিবর্তন
    if (!currentUser || !currentUser.email) {
        customAlert("আপনার অ্যাকাউন্টে কোনো ইমেইল ঠিকানা নেই। গুগল দিয়ে সাইন ইন করা ব্যবহারকারীদের জন্য পাসওয়ার্ড সেট করার প্রয়োজন হতে পারে।", "ত্রুটি");
        profileMenu.style.display = 'none';
        return;
    }
    
    // UI রিসেট
    const currentPassGroup = document.getElementById('changeEmailCurrentPasswordGroup');
    const isEmailLogin = currentUser.providerData.some(p => p.providerId === 'password');
    
    // গুগল ইউজারের জন্য পাসওয়ার্ড চেকিং লুকানো
    if (!isEmailLogin) {
        currentPassGroup.style.display = 'none';
        document.getElementById('changeEmailMessage').textContent = 'আপনার গুগল অ্যাকাউন্টের সাথে যুক্ত ইমেইলটি পরিবর্তন করুন।';
    } else {
        currentPassGroup.style.display = 'block';
        document.getElementById('changeEmailMessage').textContent = 'নিরাপত্তার জন্য, অনুগ্রহ করে আপনার বর্তমান পাসওয়ার্ড দিয়ে নিজেকে যাচাই করুন:';
    }

    // ইনপুট রিসেট এবং এরর ক্লিয়ার
    changeEmailCurrentPasswordInput.value = '';
    changeEmailNewEmailInput.value = '';
    
    [changeEmailCurrentPasswordInput, changeEmailNewEmailInput].forEach(clearFormError); // সাধারণ clearFormError ব্যবহার করা হলো
    
    // পেইজ প্রদর্শন
    profileMenu.style.display = 'none';
    mainContainer.style.display = 'none';
    changePasswordPage.style.display = 'none'; 
    resetPasswordPage.style.display = 'none';
    changeNamePage.style.display = 'none';
    customerReportPage.style.display = 'none'; // ADDED for safety
    reportPage.style.display = 'none'; // ADDED for safety
    changeEmailPage.style.display = 'flex'; // Modal এর বদলে Page দেখাচ্ছে
    
    document.body.style.overflow = 'hidden';
    history.pushState({ view: 'change-email' }, '', location.href); // নতুন হিস্টোরি স্টেট
    
    setupPasswordToggle(changeEmailPage); // পাসওয়ার্ড টগল সেটআপ
    
    changeEmailNewEmailInput.focus();
}

function hideChangeEmailPage() { // ফাংশনের নাম পরিবর্তন
    changeEmailPage.style.display = 'none';
    mainContainer.style.display = 'flex';
    document.body.style.overflow = '';
    // START: Fix for back button exit prompt (Goal 2)
    if (backPressCount > 0) {
        clearTimeout(backPressTimeout);
        backPressCount = 0;
        history.replaceState({ view: 'home' }, '', location.href); 
    }
    // END: Fix for back button exit prompt
}

async function saveNewEmail() {

    const currentPass = changeEmailCurrentPasswordInput.value; // নিশ্চিত করুন যে এই ভেরিয়েবলটি ব্যবহার করছেন
    const isEmailLogin = currentUser.providerData.some(p => p.providerId === 'password');
    
    // সকল এরর বার্তা মুছুন
    [changeEmailCurrentPasswordInput, changeEmailNewEmailInput].forEach(clearFormError); 

    // ইনপুট ভ্যালিডেশন
    let isValid = true;
    if (changeEmailNewEmailInput.value === currentUser.email) {
        showFormError(changeEmailNewEmailInput, 'নতুন ইমেইলটি বর্তমান ইমেইলের মতোই।');
        isValid = false;
    }
    if (!isValidEmail(changeEmailNewEmailInput.value)) {
        showFormError(changeEmailNewEmailInput, 'অনুগ্রহ করে একটি সঠিক ইমেইল ঠিকানা দিন।');
        isValid = false;
    }
    // শুধুমাত্র ইমেইল/পাসওয়ার্ড ইউজারদের জন্য বর্তমান পাসওয়ার্ড চেক
    if (isEmailLogin && currentPass.length < 6) {
        showFormError(changeEmailCurrentPasswordInput, 'অনুগ্রহ করে সঠিক পাসওয়ার্ড দিন।');
        isValid = false;
    }
    
    if (!isValid) return; // কোনো লোকাল ভ্যালিডেশন ফেইল করলে এখানেই শেষ হবে
    
    try {
        // ধাপ ১: Re-authenticate (শুধুমাত্র ইমেইল/পাসওয়ার্ড ইউজারদের জন্য)
        if (isEmailLogin) {
             const credential = EmailAuthProvider.credential(currentUser.email, currentPass);
             // এই await স্টেটমেন্টটি যদি ভুল পাসওয়ার্ডের কারণে ব্যর্থ হয়, তবে সরাসরি catch ব্লকে চলে যাবে।
             await reauthenticateWithCredential(currentUser, credential);
        }

        // ধাপ ২: ইমেইল পরিবর্তনের জন্য ভেরিফিকেশন লিঙ্ক পাঠানো হচ্ছে
        await verifyBeforeUpdateEmail(currentUser, changeEmailNewEmailInput.value);

        // ধাপ ৩: UI আপডেট এবং বার্তা (সফল হলে এইগুলো চলবে)
        showToast(`ইমেইল পরিবর্তনের জন্য একটি ভেরিফিকেশন লিঙ্ক ${changeEmailNewEmailInput.value} ঠিকানায় পাঠানো হয়েছে। অনুগ্রহ করে আপনার ইনবক্স চেক করুন।`, { duration: 6000 });
        history.back(); // Use history.back() for correct flow

    } catch (error) {
        console.error("Email Change Error:", error.code, error.message);
        
        // Firebase এরর কোড ধরে লাল এরর মেসেজ দেখানো
        if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
             showFormError(changeEmailCurrentPasswordInput, 'পাসওয়ার্ড ভুল দেওয়া হয়েছে।'); // <--- লাল এরর দেখানোর লজিক
        } else if (error.code === 'auth/requires-recent-login') {
             customAlert('নিরাপত্তার জন্য, আপনাকে আবার সাইন ইন করে ইমেইল পরিবর্তন করতে হবে।', 'সতর্কতা');
             history.back();
        } else if (error.code === 'auth/email-already-in-use') {
             showFormError(changeEmailNewEmailInput, 'এই ইমেইল ঠিকানাটি ইতিমধ্যেই ব্যবহার করা হয়েছে।'); 
        } else {
             customAlert('ইমেইল পরিবর্তন ব্যর্থ: ' + error.message, 'ত্রুটি');
        }
        
        return; // <--- **গুরুত্বপূর্ণ:** কোনো ত্রুটি হলে ফাংশন এখানেই শেষ হবে
    }
}

/**
 * একটি বাটনকে লোডিং অবস্থায় সেট করে, ক্লিক ব্লক করে এবং স্পিনার দেখায়।
 * @param {HTMLElement} button - যে বাটনটিকে লোডিং অবস্থায় সেট করতে হবে।
 * @param {string} originalText - লোডিং শেষ হলে বাটনে দেখানোর জন্য আসল লেখা।
 * @returns {string} - আসল লেখাটি (Original Text) ফেরত দেয়।
 */
function setButtonLoading(button, originalText) {
    if (button.disabled) return originalText; // Already loading
    
    // আইকন ও লোডিং টেক্সট যোগ করা
    button.dataset.originalText = originalText;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> অপেক্ষা করুন...';
    button.disabled = true;
    button.classList.add('loading');
    return originalText;
}

/**
 * একটি বাটনকে স্বাভাবিক অবস্থায় ফিরিয়ে আনে।
 * @param {HTMLElement} button - যে বাটনটিকে স্বাভাবিক অবস্থায় ফেরাতে হবে।
 */
function resetButtonState(button) {
    // যদি বাটনটি লোডিং মোডে না থাকে, তবে কিছু করার দরকার নেই (নিরাপত্তা)
    if (!button.classList.contains('loading') && !button.disabled) return; 

    button.innerHTML = button.dataset.originalText || 'সাবমিট';
    button.disabled = false;
    button.classList.remove('loading');
    delete button.dataset.originalText;
}

        // --- Helper Functions ---
        
        // --- মাস্টার হেল্পার ফাংশন: গ্রাহকের ব্যালেন্স এবং তারিখ আপডেট করার জন্য ---
// এটি দশমিক সমস্যা এবং সর্টিং লজিক (Time Travel) হ্যান্ডেল করবে
function recalculateCustomerState(customer) {
    let balance = 0;
    // ডিফল্ট হিসেবে তৈরির তারিখ ধরবে
    let latestDate = customer.createdAt ? new Date(customer.createdAt) : new Date(0);

    if (customer.transactions && customer.transactions.length > 0) {
        customer.transactions.forEach(tx => {
            // ১. দশমিক ফিক্স: লেনদেনের অ্যামাউন্ট ২ ঘরে ফিক্স করা
            const amount = parseFloat(parseFloat(tx.amount).toFixed(2));
            
            // ২. ব্যালেন্স যোগ-বিয়োগ
            if (tx.type === 'gave') {
                balance += amount;
            } else if (tx.type === 'received') {
                balance -= amount;
            }

            // ৩. তারিখ লজিক: সব লেনদেনের মধ্যে সবচেয়ে নতুন তারিখটি খুঁজে বের করা
            const txDate = new Date(tx.date);
            if (txDate > latestDate) {
                latestDate = txDate;
            }
        });
    }

    // ৪. ফাইনাল ব্যালেন্স ২ ঘরে ফিক্স করা
    customer.currentBalance = parseFloat(balance.toFixed(2));
    
    // ৫. গ্রাহকের lastUpdated আপডেট করা (এটাই সর্টিং এ ব্যবহার হবে)
    customer.lastUpdated = latestDate.toISOString();
}
        
        const bengaliNumerals = ['০', '১', '২', '৩', '৪', '৫', '৬', '৭', '৮', '৯'];
        const bengaliMonthNames = ["জানুয়ারি", "ফেব্রুয়ারি", "মার্চ", "এপ্রিল", "মে", "জুন", "জুলাই", "আগস্ট", "সেপ্টেম্বর", "অক্টোবর", "নভেম্বর", "ডিসেম্বর"];
        const priorityDisplayNames = { "low": "কম জরুরি", "medium": "জরুরি", "high": "অতি জরুরি" };
        const englishNumerals = { '০': 0, '১': 1, '২': 2, '৩': 3, '৪': 4, '৫': 5, '৬': 6, '৭': 7, '৮': 8, '৯': 9 };
        
        // **সংশোধিত**
        function fromBengaliNumber(numberStr) {
             if (typeof numberStr !== 'string') numberStr = String(numberStr);
             return numberStr.split('').map(digit => {
                 if (englishNumerals.hasOwnProperty(digit)) {
                     return englishNumerals[digit];
                 }
                 return digit;
             }).join('');
        }
        
        // **নতুন ফাংশন:** মাসিক ডেটা সাজানোর জন্য
        function sortMonthlyKeys(a, b) {
            const getMonthIndex = (key) => bengaliMonthNames.findIndex(month => key.startsWith(month));
            const yearA = parseInt(fromBengaliNumber(a.split(',')[1].trim().split(' ')[0]), 10);
            const yearB = parseInt(fromBengaliNumber(b.split(',')[1].trim().split(' ')[0]), 10);
            const monthA = getMonthIndex(a);
            const monthB = getMonthIndex(b);

            if (yearA !== yearB) return yearB - yearA; // বছর অনুযায়ী সাজানো (সাম্প্রতিক থেকে পুরনো)
            return monthB - monthA; // মাস অনুযায়ী সাজানো (সাম্প্রতিক থেকে পুরনো)
        }

// --- START: Email/Password Auth Functions (MODIFIED) ---

function toggleForms(formToShow) {
    const authDivider = document.querySelector('.auth-divider');
    const signInBtn = document.getElementById('signInBtn');
    const forgotPasswordLinkP = signInBtn.nextElementSibling; // signInBtn এর পরের <p> ট্যাগ
    
    // START: গুরুত্বপূর্ণ পরিবর্তন
    if (formToShow === 'register') {
        loginForm.style.display = 'none';
        registerForm.style.display = 'block';
        
        // রেজিস্ট্রেশন ফর্ম দেখালে, অতিরিক্ত অপশনগুলো লুকিয়ে দাও
        if (authDivider) authDivider.style.display = 'none';
        if (signInBtn) signInBtn.style.display = 'none';
        // পাসওয়ার্ড ভুলে গেছেন? লিঙ্কটি লুকিয়ে দাও
        if (forgotPasswordLinkP && forgotPasswordLinkP.tagName === 'P') {
            forgotPasswordLinkP.style.display = 'none';
        }
        
    } else {
        registerForm.style.display = 'none';
        loginForm.style.display = 'block';
        
        // লগইন ফর্ম দেখালে, অতিরিক্ত অপশনগুলো আবার দেখাও
        if (authDivider) authDivider.style.display = 'flex'; // 'flex' ব্যবহার করা হয়েছে, কারণ CSS এ এটি flex
        if (signInBtn) signInBtn.style.display = 'flex';   // 'flex' ব্যবহার করা হয়েছে, কারণ এটি একটি flex বাটন
        // পাসওয়ার্ড ভুলে গেছেন? লিঙ্কটি দেখাও
        if (forgotPasswordLinkP && forgotPasswordLinkP.tagName === 'P') {
            forgotPasswordLinkP.style.display = 'block';
        }
    }
    // END: গুরুত্বপূর্ণ পরিবর্তন
}

// --- START: ইউনিফায়েড এরর হ্যান্ডলিং ফাংশন (ডুপ্লিকেশন দূর করা হয়েছে) ---

/**
 * ইনপুট ফিল্ডে ভ্যালিডেশন এরর প্রদর্শন করে।
 * এটি .auth-input-group, .custom-modal-input-group, এবং .phone-input-wrapper-কে সাপোর্ট করে।
 * @param {HTMLElement} inputElement - এরর মেসেজ প্রদর্শনের জন্য ইনপুট ফিল্ড।
 * @param {string} message - এরর মেসেজ।
 */
function showFormError(inputElement, message) {
    const parentGroup = inputElement.closest('.auth-input-group, .custom-modal-input-group, .phone-input-wrapper');
    if (parentGroup) {
        parentGroup.classList.add('error');
        const errorSpan = parentGroup.querySelector('.error-message');
        // .custom-modal-input-group-এর জন্য ভিন্ন এরর মেসেজ ক্লাস ব্যবহার করা হয়েছে
        if (!errorSpan) {
             const customErrorSpan = parentGroup.querySelector('.custom-modal-error-message');
             if (customErrorSpan) {
                customErrorSpan.textContent = message;
                return;
             }
        }
        if (errorSpan) errorSpan.textContent = message;
    }
}

/**
 * ইনপুট ফিল্ড থেকে ভ্যালিডেশন এরর ক্লাস এবং মেসেজ মুছে ফেলে।
 * @param {HTMLElement} inputElement - ইনপুট ফিল্ড যা থেকে এরর সরাতে হবে।
 */
function clearFormError(inputElement) {
    const parentGroup = inputElement.closest('.auth-input-group, .custom-modal-input-group, .phone-input-wrapper');
    if (parentGroup) {
        parentGroup.classList.remove('error');
        const errorSpan = parentGroup.querySelector('.error-message, .custom-modal-error-message');
        if (errorSpan) errorSpan.textContent = '';
    }
}

// ইমেইল ফরম্যাট চেক করার জন্য Helper ফাংশন
function isValidEmail(email) {
    const re = /^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;
    return re.test(String(email).toLowerCase());
}

// Auth ফর্মগুলোর জন্য পাসওয়ার্ড অটোফিল বন্ধ করতে এই ফাংশনটি ব্যবহার করা হয়েছে
function disableAuthAutocomplete() {
    document.getElementById('loginPassword')?.setAttribute('autocomplete', 'current-password');
    document.getElementById('registerPassword')?.setAttribute('autocomplete', 'new-password');
    document.getElementById('registerConfirmPassword')?.setAttribute('autocomplete', 'new-password');
}

// START: Password Toggle Setup (নতুন ফাংশন)
function setupPasswordToggle(container) {
    container.querySelectorAll('.password-input-wrapper').forEach(wrapper => {
        const input = wrapper.querySelector('input[type="password"], input[type="text"]');
        const button = wrapper.querySelector('.password-toggle-btn');
        if (input && button) {
            // Ensure initial state is correct for non-password types
            if (input.type === 'text') {
                button.querySelector('i').className = 'fas fa-eye';
            }
            
            button.onclick = () => {
                const isPassword = input.type === 'password';
                input.type = isPassword ? 'text' : 'password';
                button.querySelector('i').className = isPassword ? 'fas fa-eye' : 'fas fa-eye-slash';
                // Focus the input again after type change
                input.focus();
            };
        }
    });
}
// END: Password Toggle Setup


async function handleRegistration(e) {
    e.preventDefault();
    
    const nameInput = document.getElementById('registerName');
    const emailInput = document.getElementById('registerEmail');
    const passwordInput = document.getElementById('registerPassword');
    const confirmPasswordInput = document.getElementById('registerConfirmPassword'); // নতুন

    // সকল ফিল্ড থেকে আগের ভুল মুছে ফেলা হচ্ছে
    [nameInput, emailInput, passwordInput, confirmPasswordInput].forEach(clearFormError);

    let isValid = true;

    if (nameInput.value.trim() === '') {
        showFormError(nameInput, 'অনুগ্রহ করে আপনার নাম লিখুন।');
        isValid = false;
    }
    if (!isValidEmail(emailInput.value.trim())) {
        showFormError(emailInput, 'অনুগ্রহ করে একটি সঠিক ইমেইল দিন।');
        isValid = false;
    }
    if (passwordInput.value.length < 6) {
        showFormError(passwordInput, 'পাসওয়ার্ড কমপক্ষে ৬ অক্ষরের হতে হবে।');
        isValid = false;
    } else if (passwordInput.value !== confirmPasswordInput.value) { // পাসওয়ার্ড নিশ্চিতকরণ চেক
        showFormError(confirmPasswordInput, 'পাসওয়ার্ড দুটি মিলছে না।');
        isValid = false;
    }

    if (!isValid) return; // যদি কোনো ভুল থাকে, তাহলে আর এগোনো হবে না

    try {
        const userCredential = await createUserWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        await updateProfile(userCredential.user, { displayName: nameInput.value.trim() });
        showToast(`স্বাগতম, ${nameInput.value.trim()}! আপনার অ্যাকাউন্ট তৈরি হয়েছে।`);
    } catch (error) {
        if (error.code === 'auth/email-already-in-use') {
            showFormError(emailInput, 'এই ইমেইল দিয়ে অ্যাকাউন্ট খোলা আছে।');
        } else {
            customAlert('রেজিস্ট্রেশন ব্যর্থ হয়েছে: ' + error.message);
        }
    }
}

async function handleLogin(e) {
    e.preventDefault();
    
    const emailInput = document.getElementById('loginEmail');
    const passwordInput = document.getElementById('loginPassword');
    
    [emailInput, passwordInput].forEach(clearFormError);

    let isValid = true;
    if (!isValidEmail(emailInput.value.trim())) {
        showFormError(emailInput, 'অনুগ্রহ করে একটি সঠিক ইমেইল দিন।');
        isValid = false;
    }
    if (passwordInput.value === '') {
        showFormError(passwordInput, 'অনুগ্রহ করে পাসওয়ার্ড দিন।');
        isValid = false;
    }
    if (!isValid) return;

    try {
        await signInWithEmailAndPassword(auth, emailInput.value, passwordInput.value);
        sessionStorage.setItem('justLoggedIn', 'true');
    } catch (error) {
        if (error.code === 'auth/invalid-credential') {
            showFormError(emailInput, 'ইমেইল অথবা পাসওয়ার্ড সঠিক নয়।');
            showFormError(passwordInput, ' '); // পাসওয়ার্ড ফিল্ডেও ভুল চিহ্ন দেখানোর জন্য
        } else {
            customAlert('লগইন ব্যর্থ হয়েছে: ' + error.message);
        }
    }
}

// --- END: উন্নত ফাংশন ---

async function handlePasswordReset(e) {
    e.preventDefault();
    // এই ফাংশনটি এখন সরাসরি resetPasswordPage দেখাবে
    showResetPasswordPage(); 
}

async function handleResetPasswordSubmit() {
    const email = resetPasswordEmailInput.value.trim();
    clearFormError(resetPasswordEmailInput);
    
    if (email && isValidEmail(email)) {
        try {
            await sendPasswordResetEmail(auth, email);
            
            // **পরিবর্তন:** customAlert এর পরিবর্তে showToast ব্যবহার করা হলো
            showToast(`পাসওয়ার্ড রিসেট করার জন্য একটি ইমেইল ${email} ঠিকানায় পাঠানো হয়েছে। অনুগ্রহ করে আপনার ইনবক্স চেক করুন।`, { duration: 6000 });
            
            history.back(); // Use history.back() for correct flow
            loginView.style.display = 'flex'; 
        } catch (error) {
            console.error("Password Reset Error:", error);
            if(error.code === 'auth/user-not-found'){
                 showFormError(resetPasswordEmailInput, "এই ইমেইল দিয়ে কোনো অ্যাকাউন্ট খুঁজে পাওয়া যায়নি।");
                 // **পরিবর্তন:** অতিরিক্ত টোস্ট বার্তা যোগ করা হলো
                 showToast("এই ইমেইল দিয়ে কোনো অ্যাকাউন্ট খুঁজে পাওয়া যায়নি।", { type: 'error' });
            } else {
                 // **পরিবর্তন:** customAlert এর পরিবর্তে showToast ব্যবহার করা হলো
                 showToast("পাসওয়ার্ড রিসেট ইমেইল পাঠানো যায়নি। অনুগ্রহ করে আবার চেষ্টা করুন।", { type: 'error' });
            }
        }
    } else {
        showFormError(resetPasswordEmailInput, "অনুগ্রহ করে একটি সঠিক ইমেইল ঠিকানা দিন।");
    }
}

function showResetPasswordPage() {
    loginView.style.display = 'none';
    
    // ১. প্রথমে ডিসপ্লে ফ্লেক্স করা
    resetPasswordPage.style.display = 'flex';
    
    // ২. এরপর Z-Index বাড়িয়ে সবার উপরে আনা (যাতে ফ্ল্যাশ না করে)
    resetPasswordPage.style.zIndex = '10001'; 
    
    document.body.style.overflow = 'hidden';
    history.pushState({ view: 'reset-password' }, '', location.href);
    
    // ইনপুট রিসেট ও ফোকাস
    resetPasswordEmailInput.value = '';
    clearFormError(resetPasswordEmailInput);
    resetPasswordEmailInput.focus();
}

function hideResetPasswordPage() {
    // ১. প্রথমে ডিসপ্লে নান করা
    resetPasswordPage.style.display = 'none';
    
    // ২. সাথে সাথে Z-Index কমিয়ে নিচে পাঠিয়ে দেওয়া (যাতে ব্যাকগ্রাউন্ডে লুকিয়ে থাকে)
    resetPasswordPage.style.zIndex = '-1'; 
    
    // আমরা যদি অন্য কোনো পেজে না থাকি, তবে আবার লগইন ভিউ দেখাচ্ছি
    if(mainContainer.style.display !== 'flex' && changePasswordPage.style.display !== 'flex' && changeNamePage.style.display !== 'flex' && changeEmailPage.style.display !== 'flex') { 
        loginView.style.display = 'flex';
    }
    document.body.style.overflow = '';
    
    // ব্যাক বাটন ফিক্স
    if (backPressCount > 0) {
        clearTimeout(backPressTimeout);
        backPressCount = 0;
        history.replaceState({ view: 'home' }, '', location.href); 
    }
}

// --- END: Email/Password Auth Functions (MODIFIED) ---

        function toBengaliNumber(numberStr) {
            if (typeof numberStr !== 'string') numberStr = String(numberStr);
            return numberStr.split('').map(digit => {
                if (digit === '.' || digit === '-') return digit;
                const num = parseInt(digit, 10);
                return isNaN(num) ? digit : bengaliNumerals[num];
            }).join('');
        }

        function formatCurrency(amount, withSymbol = false) {
            if (typeof amount !== 'number') amount = 0;
            const fixedAmountStr = amount.toFixed(2);
            const formatted = toBengaliNumber(fixedAmountStr);
            return withSymbol ? `৳${formatted}` : formatted;
        }

        function getBengaliMonthName(monthIndex) { return bengaliMonthNames[monthIndex]; }
        
        function formatShortDateForDisplay(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
             return `${toBengaliNumber(String(date.getDate()))} ${getBengaliMonthName(date.getMonth())}`;
        }
        
        function formatLongDateForDisplay(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = String(date.getFullYear());
            return `${toBengaliNumber(day)}/${toBengaliNumber(month)}/${toBengaliNumber(year)}`;
        }
        
        function formatTimeForDisplay(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const hours = date.getHours();
            const minutes = date.getMinutes();
            const ampm = hours >= 12 ? 'PM' : 'AM';
            const formattedHours = hours % 12 || 12; // 12-hour format
            const formattedMinutes = String(minutes).padStart(2, '0');

            // Use bn-BD locale for Bengali AM/PM/Time formatting
            return date.toLocaleTimeString('bn-BD', { hour: 'numeric', minute: '2-digit', hour12: true });
        }


        function formatTransactionDateForDisplay(dateString) {
            if (!dateString) return { datePart: '', yearPart: '', timePart: '' };
            const date = new Date(dateString);
            if (isNaN(date)) return { datePart: '', yearPart: '', timePart: '' };

            const datePart = `${toBengaliNumber(String(date.getDate()).padStart(2, '0'))} ${getBengaliMonthName(date.getMonth())}`; 
            const yearPart = toBengaliNumber(String(date.getFullYear()));
            const timePart = formatTimeForDisplay(date); // Use new formatTimeForDisplay
            
            return { datePart, yearPart, timePart };
        }

        function formatDateForInput(date) {
            if (!(date instanceof Date) || isNaN(date)) return '';
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        function getPriorityDisplayName(priority) { return priorityDisplayNames[priority] || priority; }
        
        function timeAgo(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            if (isNaN(date)) return 'তারিখ নেই';
            
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `${toBengaliNumber(String(Math.floor(interval)))} বছর আগে`;
            interval = seconds / 2592000;
            if (interval > 1) return `${toBengaliNumber(String(Math.floor(interval)))} মাস আগে`;
            interval = seconds / 86400;
            if (interval > 1) return `${toBengaliNumber(String(Math.floor(interval)))} দিন আগে`;
            interval = seconds / 3600;
            if (interval > 1) return `${toBengaliNumber(String(Math.floor(interval)))} ঘন্টা আগে`;
            interval = seconds / 60;
            if (interval > 1) return `${toBengaliNumber(String(Math.floor(interval)))} মিনিট আগে`;
            return 'এইমাত্র';
        }
        
function manageLoader(show, message = '', progress = null, total = 100) { // <-- নতুন প্যারামিটার যোগ করা হয়েছে
    const loader = document.getElementById('loader');
    const loadingMessage = document.getElementById('loadingMessage');
    const progressBar = document.getElementById('progressBar');
    const progressLabel = document.getElementById('progressLabel');
    
    if (show) {
        loadingMessage.textContent = message;
        loader.style.display = 'flex';
        
        // প্রোগ্রেস বার আপডেট
        if (progress !== null && progressBar) {
            const percentage = Math.floor((progress / total) * 100);
            progressBar.value = percentage;
            progressBar.max = 100;
            progressLabel.textContent = `অগ্রগতি: ${toBengaliNumber(String(percentage))}%`;
            
            // কাজের শিরোনাম, যেমন, "PDF তৈরি হচ্ছে..."
            if (!message.includes('লোড হচ্ছে...')) {
                loadingMessage.textContent = message;
            } else {
                 loadingMessage.textContent = "অপেক্ষা করুন...";
            }
            
        } else if (progressBar) {
            progressBar.value = 0;
            progressLabel.textContent = '';
            loadingMessage.textContent = message;
        }

    } else {
        loader.style.display = 'none';
        if (progressBar) progressBar.value = 0;
    }
}

        function calculateGrandTotals() {
    let grandTotalReceivable = 0;
    let grandTotalPayable = 0;

    for (const ledgerId in ledgers) {
        const ledger = ledgers[ledgerId];
        if (ledger && ledger.customers) {
            ledger.customers.forEach(customer => {
                // দশমিক ফিক্স
                const balance = parseFloat((parseFloat(customer.currentBalance) || 0).toFixed(2));
                
                if (balance > 0) {
                    grandTotalReceivable += balance; // শুধুমাত্র পাবো
                } else if (balance < 0) {
                    grandTotalPayable += Math.abs(balance); // শুধুমাত্র দেবো
                }
            });
        }
    }

    return {
        receivable: parseFloat(grandTotalReceivable.toFixed(2)),
        payable: parseFloat(grandTotalPayable.toFixed(2))
    };
}
        
function calculateSingleLedgerTotals(ledgerId) {
    let totalReceivable = 0;
    let totalPayable = 0;
    const ledger = ledgers[ledgerId];

    if (ledger && ledger.customers) {
        ledger.customers.forEach(customer => {
            const balance = customer.currentBalance || 0;
            if (balance > 0) {
                totalReceivable += balance;
            } else if (balance < 0) {
                totalPayable += Math.abs(balance);
            }
        });
    }
    return { receivable: totalReceivable, payable: totalPayable };
}

        // --- Toast Notification Function ---
        function showToast(message, options = {}) {
            const { duration = 4000, type = 'info', undoCallback = null } = options;
            const toast = document.createElement('div');
            toast.className = 'toast';
            const messageSpan = document.createElement('span');
            messageSpan.textContent = message;
            toast.appendChild(messageSpan);
            let toastTimeout;
            if (undoCallback && typeof undoCallback === 'function') {
                const undoButton = document.createElement('button');
                undoButton.className = 'toast-undo-button';
                undoButton.textContent = 'Undo';
                undoButton.onclick = () => {
                    clearTimeout(toastTimeout);
                    undoCallback();
                    toast.classList.remove('show');
                    toast.addEventListener('transitionend', () => toast.remove());
                };
                toast.appendChild(undoButton);
            }
            toastContainer.appendChild(toast);
            setTimeout(() => toast.classList.add('show'), 10);
            const hideDuration = undoCallback ? 4000 : duration;
            toastTimeout = setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, hideDuration);
        }

        async function updateFirestore(updateData) {
    if (!currentUser) return;

    // ১. ইন্টারনেট কানেকশন চেক (ডুপ্লিকেট ফিক্স সহ)
    if (!navigator.onLine) {
        const now = Date.now();
        // লজিক: যদি গত ৫ সেকেন্ডের (5000 ms) মধ্যে এই মেসেজটি দেখানো হয়ে থাকে, তবে আর দেখাবে না।
        if (now - lastOfflineToastTime > 5000) {
            showToast("⚠️ ইন্টারনেট সংযোগ নেই! ডেটা অফলাইনে সেভ হয়েছে, সংযোগ ফিরলে সার্ভারে আপলোড হবে。", { duration: 4000 });
            lastOfflineToastTime = now; // শেষ দেখানোর সময় আপডেট করা হলো
        }
        // আমরা কোড থামাবো না, কারণ ফায়ারস্টোর অফলাইনেও কাজ করে।
    }

    try {
        const userDocRef = doc(db, 'userData', currentUser.uid);

        // ২. শপিং লিস্ট আপডেট লজিক
        if (updateData.shoppingLists) {
            const listRef = doc(db, 'userData', currentUser.uid, 'my_shopping_lists', currentListId);
            const currentListData = shoppingLists[currentListId];
            if (currentListData) {
                await setDoc(listRef, currentListData);
            }
        }

        // ৩. লেজার আপডেট লজিক
        if (updateData.ledgers) {
            if (currentLedgerId !== 'all' && ledgers[currentLedgerId]) {
                const ledgerRef = doc(db, 'userData', currentUser.uid, 'my_ledgers', currentLedgerId);
                await setDoc(ledgerRef, ledgers[currentLedgerId]);
            } else {
                for (const [lid, ledgerData] of Object.entries(ledgers)) {
                    await setDoc(doc(db, 'userData', currentUser.uid, 'my_ledgers', lid), ledgerData);
                }
            }
        }

        // ৪. অন্যান্য সেটিংস আপডেট লজিক
        const { shoppingLists: sl, ledgers: lg, ...settingsData } = updateData;
        if (Object.keys(settingsData).length > 0) {
            await setDoc(userDocRef, settingsData, { merge: true });
        }

    } catch (error) {
        console.error("Firestore update failed:", error);

        // ৫. স্মার্ট এরর হ্যান্ডলিং (ইন্টারনেট না থাকলে এই এরর দেখানোর দরকার নেই, কারণ আমরা আগেই হ্যান্ডেল করেছি)
        if (navigator.onLine) {
            let errorMessage = "দুঃখিত, পরিবর্তনগুলো সেভ করা যায়নি।";

            if (error.code === 'resource-exhausted') {
                errorMessage = "🚫 আপনার আজকের ব্যবহারের লিমিট (Quota) শেষ হয়ে গেছে। আগামীকাল আবার চেষ্টা করুন।";
            } else if (error.code === 'unavailable') {
                errorMessage = "📡 সার্ভারের সাথে সংযোগ স্থাপন করা যাচ্ছে না।";
            } else if (error.code === 'permission-denied') {
                errorMessage = "🔒 আপনার এই ডেটা পরিবর্তন করার অনুমতি নেই।";
            }
            showToast(errorMessage);
        }
        
        throw error;
    }
}
        
        function handleSwipeGesture() {
    const diffX = touchendX - touchstartX;
    const diffY = touchendY - touchstartY;

    // ১. সোয়াইপ থ্রেশহোল্ড অতিক্রম করেছে এবং অনুভূমিকভাবে বেশি হওয়া নিশ্চিত করা
    if (Math.abs(diffX) < swipeThreshold || Math.abs(diffX) < Math.abs(diffY)) {
        return; 
    }
    
    // ২. শুধুমাত্র Ledger-এর মূল ভিউ থেকে সোয়াইপ করার অনুমতি দেওয়া হয়েছে
    const isAtTopLevel = currentLedgerView === 'main' && currentLedgerTab === 'main';

    if (diffX < 0) {
        // বাম দিকে সোয়াইপ (Shopping List -> Ledger)
        if (currentView === 'shoppingList') {
            switchView('ledger');
        }
    } else {
        // ডান দিকে সোয়াইপ (Ledger -> Shopping List)
        if (currentView === 'ledger' && isAtTopLevel) { 
            switchView('shoppingList');
        }
    }
}

        // PERFORMANCE UPDATE: Denormalization logic
        function calculateCustomerBalance(customer) {
            return (customer.transactions || []).reduce((acc, tx) => {
                if (tx.type === 'gave') return acc + tx.amount;
                if (tx.type === 'received') return acc - tx.amount;
                return acc;
            }, 0);
        }

        async function migrateAndDenormalizeData() {
            let dataWasMigrated = false;
            for (const ledgerId in ledgers) {
                const ledger = ledgers[ledgerId];
                if (ledger && ledger.customers && Array.isArray(ledger.customers)) {
                    for (const customer of ledger.customers) {
                        if (typeof customer.currentBalance === 'undefined') {
                            dataWasMigrated = true;
                            console.log(`Denormalizing balance for customer: ${customer.name}`);
                            customer.currentBalance = calculateCustomerBalance(customer);
                            
                            const sortedTransactions = [...(customer.transactions || [])].sort((a, b) => new Date(b.date) - new Date(a.date));
                            customer.lastUpdated = sortedTransactions.length > 0 ? sortedTransactions[0].date : customer.createdAt;
                        }
                    }
                }
            }
            if (dataWasMigrated) {
                console.log("Data migration complete. Saving to Firestore.");
                await updateFirestore({ ledgers });
                showToast("হিসাব খাতা অপ্টিমাইজ করা হয়েছে।");
            }
        }
        
        // --- Real-time Data Loading (Fast & Non-blocking) ---
function loadDataFromFirestore() {
    if (!currentUser) return;

    // লোডার বন্ধ করার জন্য ফ্ল্যাগ
    let isSettingsLoaded = false;

    // ১. ইউজার সেটিংস (Theme/Font)
    const userDocRef = doc(db, 'userData', currentUser.uid);
    if (unsubscribeUserDoc) unsubscribeUserDoc();

    unsubscribeUserDoc = onSnapshot(userDocRef, (docSnap) => {
        if (docSnap.exists()) {
            const data = docSnap.data();

            if (data.accountDisabled === true) {
                window.location.reload(); 
                return;
            }

            currentListId = data.currentListId || 'default-list';
            currentLedgerId = data.currentLedgerId || 'default-ledger';
            itemDatabase = new Set(data.itemDatabase || []);

            if (data.darkMode) body.classList.add('dark-mode'); 
            else body.classList.remove('dark-mode');
            updateDarkModeToggleIcon(body.classList.contains('dark-mode'));

            currentFontSize = data.fontSize || defaultFontSize;
            
            // ✅ ফিক্স: এখানে 'false' পাঠানো হচ্ছে যাতে লুপ না হয়
            applyFontSize(currentFontSize, false); 
        } else {
            // নতুন ইউজার হলে ডিফল্ট সেট করা
            setDoc(userDocRef, {
                currentListId: 'default-list',
                currentLedgerId: 'default-ledger',
                itemDatabase: [],
                darkMode: false,
                fontSize: defaultFontSize
            }, { merge: true });
        }

        // --- ফাস্ট লোডিং ফিক্স ---
        // সেটিংস লোড হয়ে গেলেই আমরা স্পিনার সরিয়ে দেব।
        // লিস্টগুলো চোখের সামনে রেন্ডার হবে (এতে অ্যাপ সুপার ফাস্ট মনে হবে)
        if (!isSettingsLoaded) {
            isSettingsLoaded = true;
            document.body.classList.remove('auth-loading');
            manageLoader(false); // স্পিনার বন্ধ
        }

    }, (error) => console.error("User Doc Error:", error));

    // ২. শপিং লিস্ট (ব্যাকগ্রাউন্ডে লোড হবে)
    if (unsubscribeShoppingLists) unsubscribeShoppingLists();
    
    const listsQuery = collection(db, 'userData', currentUser.uid, 'my_shopping_lists');
    unsubscribeShoppingLists = onSnapshot(listsQuery, (snapshot) => {
        shoppingLists = {};
        if (snapshot.empty) {
            shoppingLists['default-list'] = { name: 'আমার তালিকা', items: [] };
        } else {
            snapshot.forEach(doc => {
                shoppingLists[doc.id] = doc.data();
            });
        }
        
        if (!shoppingLists[currentListId]) currentListId = Object.keys(shoppingLists)[0] || 'default-list';
        shoppingItems = shoppingLists[currentListId]?.items || [];

        // UI আপডেট (লাইভ)
        populateListSelector();
        populateReportListFilter();
        renderList();
        
    }, (error) => console.error("Shopping List Error:", error));

    // ৩. হিসাব খাতা (ব্যাকগ্রাউন্ডে লোড হবে)
    if (unsubscribeLedgers) unsubscribeLedgers();

    const ledgersQuery = collection(db, 'userData', currentUser.uid, 'my_ledgers');
    unsubscribeLedgers = onSnapshot(ledgersQuery, (snapshot) => {
        ledgers = {};
        if (snapshot.empty) {
            ledgers['default-ledger'] = { name: 'আমার খাতা', customers: [] };
        } else {
            snapshot.forEach(doc => {
                ledgers[doc.id] = doc.data();
            });
        }

        if (!ledgers[currentLedgerId] && currentLedgerId !== 'all') currentLedgerId = Object.keys(ledgers)[0] || 'default-ledger';

        // UI আপডেট (লাইভ)
        populateLedgerSelector();
        prepareAndRenderLedger();
        
        if (currentLedgerView === 'customer' && currentCustomerId) {
            renderLedgerCustomerView(); 
        }

    }, (error) => console.error("Ledger Error:", error));
}

// --- Push Notification Setup ---
const messaging = getMessaging(app);

async function requestNotificationPermission() {
    try {
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
            console.log('Notification permission granted.');
            
            // টোকেন জেনারেট করা (Vapid Key টি ১ নম্বর ধাপ থেকে পাবেন)
            const token = await getToken(messaging, { 
                vapidKey: 'YOUR_GENERATED_VAPID_KEY_FROM_FIREBASE_CONSOLE' 
            });

            if (token) {
                console.log('FCM Token:', token);
                // এই টোকেনটি ইউজারের ডাটাবেসে সেভ করতে হবে, যাতে পরে তাকে নোটিফিকেশন পাঠানো যায়
                if (currentUser) {
                    await setDoc(doc(db, 'userData', currentUser.uid), { fcmToken: token }, { merge: true });
                }
            }
        } else {
            console.log('Unable to get permission to notify.');
        }
    } catch (err) {
        console.log('An error occurred while retrieving token. ', err);
    }
}

// অ্যাপ খোলা অবস্থায় নোটিফিকেশন আসলে কি হবে
onMessage(messaging, (payload) => {
    console.log('Message received. ', payload);
    // টোস্ট নোটিফিকেশন দেখান
    showToast(`${payload.notification.title}: ${payload.notification.body}`, { duration: 5000 });
});

// ইউজার লগইন করার পর পারমিশন চাওয়া হবে
// onAuthStateChanged এর ভেতরে যেখানে loadDataFromFirestore() কল করেছেন, তার নিচে এটি দিন:
// requestNotificationPermission();

function checkAndSendLocalReminder() {
    // উদাহরণ: যদি শপিং লিস্টে আইটেম থাকে কিন্তু কেনা না হয়
    if (shoppingItems.length > 0 && shoppingItems.some(i => !i.bought)) {
        // ব্রাউজার এপিআই ব্যবহার করে নোটিফিকেশন পাঠানো
        if (Notification.permission === "granted") {
            new Notification("বাজার বাকি আছে!", {
                body: `আপনার তালিকায় ${shoppingItems.filter(i => !i.bought).length}টি পণ্য কেনা বাকি।`,
                icon: "/icons/icon-192x192.png"
            });
        }
    }
}
                
        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentYear();
            initializeVoiceInput();
            setupAutocomplete();
            setupEventListeners();
            setupPaginationObservers();
            switchView('shoppingList');
            history.replaceState({ view: 'home' }, '', location.href); 
            history.pushState({ view: 'home' }, '', location.href);
            disableAuthAutocomplete();
        });
        
        function updateCurrentYear() {
            document.getElementById('currentYear').textContent = toBengaliNumber(String(new Date().getFullYear()));
        }

        // --- View Management ---
        function switchView(view) {
            currentView = view;
            mainContainer.style.display = 'block';
            reportPage.style.display = 'none';
            customerReportPage.style.display = 'none';
            changePasswordPage.style.display = 'none'; 
            resetPasswordPage.style.display = 'none'; 
            changeNamePage.style.display = 'none'; // ADDED
            changeEmailPage.style.display = 'none'; // ADDED
            document.body.style.overflow = '';

            shoppingListSection.style.display = 'none';
            ledgerSection.style.display = 'none';
            if(fabAddCustomerBtn) fabAddCustomerBtn.style.display = 'none';
            
            shoppingListBottomMenu.style.display = 'none';
            ledgerBottomMenu.style.display = 'none';

            showShoppingListBtn.classList.remove('active');
            showLedgerBtn.classList.remove('active');
            
            // Reset expanded item index on view switch
            expandedItemIndex = -1;

            if (view === 'shoppingList') {
                shoppingListSection.style.display = 'flex';
                shoppingListBottomMenu.style.display = 'flex';
                showShoppingListBtn.classList.add('active');
                renderList();
                const navItems = shoppingListBottomMenu.querySelectorAll('.nav-item');
                navItems.forEach(item => item.classList.remove('active'));
                document.getElementById('navHomeBtn').classList.add('active');
            } else if (view === 'ledger') {
                ledgerSection.style.display = 'flex';
                ledgerBottomMenu.style.display = 'flex';
                if(fabAddCustomerBtn) fabAddCustomerBtn.style.display = 'flex';
                showLedgerBtn.classList.add('active');
                currentLedgerTab = 'main';
                renderLedgerTabView();
            }
        }

        // --- Multiple Lists Management (Shopping List) ---
        function populateListSelector() {
            currentListSelector.innerHTML = '';
            for (const id in shoppingLists) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = shoppingLists[id].name;
                currentListSelector.appendChild(option);
            }
            currentListSelector.value = currentListId;
        }
        
        function switchList(newId) {
            if (newId === currentListId || !shoppingLists[newId]) return;
            currentListId = newId;
            shoppingItems = shoppingLists[currentListId].items;
            expandedItemIndex = -1; // Reset expanded item
            renderList(); // This will reset pagination
            currentListSelector.value = currentListId;
            updateFirestore({ currentListId: newId });
        }

        async function addNewList() {
            const listName = await customPrompt("নতুন তালিকা", "নতুন তালিকার নাম দিন:");
            if (listName && listName.trim() !== '') {
                const trimmedName = listName.trim();
                const newListId = 'list-' + Date.now();
                shoppingLists[newListId] = { name: trimmedName, items: [] };
                populateListSelector();
                populateReportListFilter();
                switchList(newListId);
                await updateFirestore({ shoppingLists });
                showToast(`"${trimmedName}" তালিকা তৈরি হয়েছে!`, { duration: 2000 });
            } else if (listName !== null) {
                customAlert("তালিকার নাম খালি হতে পারে না।", "ত্রুটি");
            }
        }
        
        async function renameList() {
            const currentList = shoppingLists[currentListId];
            if (!currentList) return;
            const newName = await customPrompt(`তালিকার নাম পরিবর্তন করুন`, `"${currentList.name}" তালিকার নতুন নাম দিন:`, currentList.name);
            if (newName && newName.trim() !== '') {
                const trimmedName = newName.trim();
                shoppingLists[currentListId].name = trimmedName;
                populateListSelector();
                populateReportListFilter();
                await updateFirestore({ shoppingLists });
                showToast('তালিকার নাম পরিবর্তন করা হয়েছে।', { duration: 2000 });
            } else if (newName !== null) {
                customAlert("তালিকার নাম খালি হতে পারে না।", "ত্রুটি");
            }
        }

        // এই ফাংশনটি শুধুমাত্র তালিকা ডিলিট করার জন্য ব্যবহৃত হবে
        async function deleteCurrentList() {
            // যদি মাত্র একটি তালিকা থাকে, তবে ডিলিট করতে দেওয়া হবে না
            if (Object.keys(shoppingLists).length <= 1) {
                customAlert("কমপক্ষে একটি তালিকা থাকতে হবে। আপনি এই তালিকাটি মুছে ফেলতে পারবেন না।", "অপারেশন ব্যর্থ");
                return;
            }
            // ব্যবহারকারীর কাছে নিশ্চিতকরণ চাওয়া হচ্ছে
            const confirmDelete = await customConfirm(`আপনি কি নিশ্চিত যে আপনি "${shoppingLists[currentListId].name}" তালিকাটি মুছে ফেলতে চান?`);
            if (confirmDelete) {
                const listIdToDelete = currentListId;
                const deletedListName = shoppingLists[listIdToDelete].name;

                // প্রথমে ব্রাউজারের মেমোরি থেকে তালিকাটি ডিলিট করা হচ্ছে
                delete shoppingLists[listIdToDelete];
                
                // নতুন একটি তালিকাকে বর্তমান তালিকা হিসেবে সেট করা হচ্ছে
                const newCurrentListId = Object.keys(shoppingLists)[0];
                
                // UI আপডেট করা হচ্ছে
                populateListSelector();
                populateReportListFilter();
                
                // Firestore-কে ডিলিট করার জন্য সঠিক payload তৈরি করা হচ্ছে
                const firestoreUpdatePayload = {
                    [`shoppingLists.${listIdToDelete}`]: deleteField(), // ডট নোটেশন দিয়ে নির্দিষ্ট তালিকাটি ডিলিট করার কমান্ড
                    currentListId: newCurrentListId                  // বর্তমান তালিকা আইডি আপডেট করার কমান্ড
                };

                // এখানে updateDoc ব্যবহার করা হচ্ছে, যা ফিল্ড ডিলিট করার জন্য সঠিক ফাংশন
                try {
                    const userDocRef = doc(db, 'userData', currentUser.uid);
                    await updateDoc(userDocRef, firestoreUpdatePayload);
                } catch (error) {
                     console.error("Firestore field deletion failed:", error);
                     showToast("তালিকাটি সার্ভার থেকে ডিলিট করা যায়নি।");
                     // যদি কোনো কারণে ডিলিট ব্যর্থ হয়, তবে পুরনো ডেটা আবার লোড করে নেওয়া হবে
                     loadDataFromFirestore(); 
                     return;
                }
                
                // সফলভাবে ডিলিট হওয়ার পর নতুন তালিকাতে সুইচ করা হচ্ছে
                switchList(newCurrentListId);

                showToast(`"${deletedListName}" তালিকা স্থায়ীভাবে মুছে ফেলা হয়েছে!`, { type: 'info', duration: 2500 });
            }
        }
        
        // --- Multiple Ledgers Management (Hisaab Khata) ---
        function populateLedgerSelector() {
    currentLedgerSelector.innerHTML = '';
    
    // START: নতুন "সকল খাতা" অপশন যোগ করা হলো
    const allOption = document.createElement('option');
    allOption.value = 'all';
    allOption.textContent = '📑 সকল খাতা';
    currentLedgerSelector.appendChild(allOption);
    // END: পরিবর্তন শেষ

    for (const id in ledgers) {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = ledgers[id].name;
        currentLedgerSelector.appendChild(option);
    }
    currentLedgerSelector.value = currentLedgerId;
}

        // এই নতুন ফাংশনটি দিয়ে পুরোনোটিকে প্রতিস্থাপন করুন
function switchLedger(newId) {
    if (newId === currentLedgerId || !ledgers[newId] && newId !== 'all') return;

    // --- START: স্থায়ী সমাধানের জন্য নতুন লাইন ---
    // যখনই খাতা পরিবর্তন হবে, ভিউ-কে forcibly মূল তালিকায় ফিরিয়ে আনা হচ্ছে
    currentLedgerView = 'main';
    // --- END: সমাধান শেষ ---

    currentLedgerId = newId;
    prepareAndRenderLedger(); // এখন এটি সবসময় সঠিক ভিউ রেন্ডার করবে
    currentLedgerSelector.value = newId;

    if (newId !== 'all') {
        updateFirestore({ currentLedgerId: newId });
    }
}

        async function addNewLedger() {
            const ledgerName = await customPrompt("নতুন খাতা", "নতুন খাতার নাম দিন:");
            if (ledgerName && ledgerName.trim() !== '') {
                const trimmedName = ledgerName.trim();
                const newLedgerId = 'ledger-' + Date.now();
                ledgers[newLedgerId] = { name: trimmedName, customers: [] };
                populateLedgerSelector();
                switchLedger(newLedgerId);
                await updateFirestore({ ledgers });
                showToast(`"${trimmedName}" খাতা তৈরি হয়েছে!`, { duration: 2000 });
            } else if (ledgerName !== null) {
                customAlert("খাতার নাম খালি হতে পারে না।", "ত্রুটি");
            }
        }

        async function renameLedger() {
            const currentLedger = ledgers[currentLedgerId];
            if (!currentLedger) return;
            const newName = await customPrompt(`খাতার নাম পরিবর্তন করুন`, `"${currentLedger.name}" খাতার নতুন নাম দিন:`, currentLedger.name);
            if (newName && newName.trim() !== '') {
                const trimmedName = newName.trim();
                ledgers[currentLedgerId].name = trimmedName;
                populateLedgerSelector();
                await updateFirestore({ ledgers });
                showToast('খাতার নাম পরিবর্তন করা হয়েছে।', { duration: 2000 });
            } else if (newName !== null) {
                customAlert("খাতার নাম খালি হতে পারে না।", "ত্রুটি");
            }
        }

        async function deleteCurrentLedger() {
            // যদি মাত্র একটি খাতা থাকে, তবে ডিলিট করতে দেওয়া হবে না
            if (Object.keys(ledgers).length <= 1) {
                customAlert("কমপক্ষে একটি খাতা থাকতে হবে। আপনি এই খাতাটি মুছে ফেলতে পারবেন না।", "অপারেশন ব্যর্থ");
                return;
            }
            // ব্যবহারকারীর কাছে নিশ্চিতকরণ চাওয়া হচ্ছে
            const confirmDelete = await customConfirm(`আপনি কি নিশ্চিত যে আপনি "${ledgers[currentLedgerId].name}" খাতাটি মুছে ফেলতে চান?`);
            if (confirmDelete) {
                const ledgerIdToDelete = currentLedgerId;
                const deletedLedgerName = ledgers[ledgerIdToDelete].name;

                // প্রথমে ব্রাউজারের মেমোরি থেকে খাতাটি ডিলিট করা হচ্ছে
                delete ledgers[ledgerIdToDelete];
                
                // নতুন একটি খাতাকে বর্তমান খাতা হিসেবে সেট করা হচ্ছে
                const newCurrentLedgerId = Object.keys(ledgers)[0];
                
                // UI আপডেট করা হচ্ছে
                populateLedgerSelector();
                
                // Firestore-কে ডিলিট করার জন্য সঠিক payload তৈরি করা হচ্ছে
                const firestoreUpdatePayload = {
                    [`ledgers.${ledgerIdToDelete}`]: deleteField(), // ডট নোটেশন দিয়ে নির্দিষ্ট খাতাটি ডিলিট করার কমান্ড
                    currentLedgerId: newCurrentLedgerId              // বর্তমান খাতা আইডি আপডেট করার কমান্ড
                };

                // এখানে updateDoc সরাসরি ব্যবহার করা হচ্ছে, যা ফিল্ড ডিলিট করার জন্য সঠিক
                try {
                    const userDocRef = doc(db, 'userData', currentUser.uid);
                    await updateDoc(userDocRef, firestoreUpdatePayload);
                } catch (error) {
                     console.error("Firestore field deletion failed:", error);
                     showToast("খাতাটি সার্ভার থেকে ডিলিট করা যায়নি।");
                     // যদি কোনো কারণে ডিলিট ব্যর্থ হয়, তবে পুরনো ডেটা আবার লোড করে নেওয়া হবে
                     loadDataFromFirestore(); 
                     return;
                }
                
                // সফলভাবে ডিলিট হওয়ার পর নতুন খাতাতে সুইচ করা হচ্ছে
                switchLedger(newCurrentLedgerId);

                showToast(`"${deletedLedgerName}" খাতা স্থায়ীভাবে মুছে ফেলা হয়েছে!`, { type: 'info', duration: 2500 });
            }
        }

        // --- Custom Modals (Z-Index fix included) ---
        // পরিবর্তন করা হলো: zIndexCounter++ এর পরিবর্তে একটি উচ্চ মান নিশ্চিত করা হলো।
function customAlert(message, title = 'সতর্কতা') {
    history.pushState({ view: 'modal' }, '', location.href);
    alertModal.querySelector('h3').textContent = title;
    alertMessage.innerHTML = message;
    
    // START: ফিক্স
    zIndexCounter = Math.max(zIndexCounter + 1, 10000); // নিশ্চিত করা হলো যে এটি সব কিছুর উপরে থাকবে
    // END: ফিক্স
    
    alertModal.style.zIndex = zIndexCounter;
    alertModal.classList.add('active');
    document.body.style.overflow = 'hidden';
    alertModal.querySelector('.confirm-btn').focus();
}
        function closeAlertModal() {
            alertModal.classList.remove('active');
            document.body.style.overflow = '';
        }
        // আপডেট করা customPrompt ফাংশন
function customPrompt(title, message, defaultValue = '', inputType = 'text') {
    // আগের কোনো প্রম্পট খোলা থাকলে তা বাতিল করে দেওয়া হচ্ছে
    if (promptPromiseResolve) {
        promptPromiseResolve(null);
        promptModal.classList.remove('active');
    }

    history.pushState({ view: 'modal' }, '', location.href);
    return new Promise((resolve) => {
        promptTitle.textContent = title;
        promptLabel.textContent = message;
        promptInput.value = defaultValue;
        promptInput.type = inputType;
        
        // Z-Index ফিক্স
        zIndexCounter = Math.max(zIndexCounter + 1, 10000); 
        promptModal.style.zIndex = zIndexCounter;
        
        promptModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        setTimeout(() => promptInput.focus(), 50);
        
        promptPromiseResolve = resolve;

        const handleSubmit = () => {
            cleanup();
            resolve(promptInput.value);
        };
        const handleCancel = () => {
            cleanup();
            resolve(null);
        };
        const handleKey = (e) => {
            if (e.key === 'Enter') handleSubmit();
            if (e.key === 'Escape') handleCancel();
        };

        // ইভেন্ট লিসেনার ক্লিনআপ ফাংশন (মেমোরি লিক ফিক্স)
        const cleanup = () => {
            promptModal.classList.remove('active');
            document.body.style.overflow = '';
            promptSubmitButton.removeEventListener('click', handleSubmit);
            promptCancelButton.removeEventListener('click', handleCancel);
            promptInput.removeEventListener('keydown', handleKey);
            promptPromiseResolve = null;
        };

        promptSubmitButton.addEventListener('click', handleSubmit);
        promptCancelButton.addEventListener('click', handleCancel);
        promptInput.addEventListener('keydown', handleKey);
    });
}
        function cancelCustomPrompt() {
            promptModal.classList.remove('active');
            document.body.style.overflow = '';
            if (promptPromiseResolve) {
                promptPromiseResolve(null);
                promptPromiseResolve = null;
            }
        }
// আপডেট করা customConfirm ফাংশন
function customConfirm(message) {
    // আগের কোনো কনফার্মেশন খোলা থাকলে বাতিল করা
    if (confirmPromiseResolve) {
        confirmPromiseResolve(false);
        confirmationModal.classList.remove('active');
    }

    history.pushState({ view: 'modal' }, '', location.href);
    return new Promise((resolve) => {
        confirmationMessage.textContent = message;
        
        zIndexCounter = Math.max(zIndexCounter + 1, 10000);
        confirmationModal.style.zIndex = zIndexCounter;
        
        confirmationModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        confirmPromiseResolve = resolve;
        confirmButton.focus();
    });
}
        function handleConfirm(isConfirmed) {
            // এখন মডাল বন্ধ করার কাজটি popstate handler করবে, তাই এখান থেকে UI পরিবর্তনের কোড সরানো হলো।
            if (confirmPromiseResolve) {
                confirmPromiseResolve(isConfirmed);
                confirmPromiseResolve = null; // রিসলভ করার পর এটিকে রিসেট করা ভালো অভ্যাস
            }
            // ব্রাউজারের হিস্টোরি থেকে মডালের ধাপটি সরিয়ে দেওয়া হচ্ছে
            // এটি popstate ইভেন্টকে ট্রিগার করবে, যা মডালটিকে স্ক্রিন থেকে সরাবে
            if (history.state && history.state.view === 'modal') {
                history.back();
            } else {
                // যদি কোনো কারণে হিস্টোরি স্টেটে মডাল না থাকে, তবুও UI ঠিক করা হচ্ছে
                confirmationModal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // --- Autocomplete & Voice Input (UNTOUCHED) ---
        function addToItemDatabase(itemName) {
            itemDatabase.add(itemName);
            if (itemDatabase.size > MAX_DATABASE_SIZE) {
                itemDatabase.delete(itemDatabase.values().next().value);
            }
            updateFirestore({ itemDatabase: Array.from(itemDatabase) });
        }
        function setupAutocomplete() {
            let selectedSuggestionIndex = -1;
            itemNameInput.addEventListener('input', () => {
                const query = itemNameInput.value.trim().toLowerCase();
                autocompleteSuggestions.innerHTML = '';
                selectedSuggestionIndex = -1;
                if (query.length < 1) { autocompleteSuggestions.style.display = 'none'; return; }
                const suggestions = Array.from(itemDatabase).filter(item => item.toLowerCase().includes(query)).slice(0, 5);
                if (suggestions.length > 0) {
                    suggestions.forEach((suggestion) => {
                        const div = document.createElement('div');
                        div.textContent = suggestion;
                        div.addEventListener('click', () => {
                            itemNameInput.value = suggestion;
                            autocompleteSuggestions.style.display = 'none';
                            itemPriceInput.focus(); // UPDATED: Focus next logical field
                        });
                        autocompleteSuggestions.appendChild(div);
                    });
                    autocompleteSuggestions.style.display = 'block';
                } else { autocompleteSuggestions.style.display = 'none'; }
            });
            itemNameInput.addEventListener('keydown', (e) => {
                const suggestions = autocompleteSuggestions.querySelectorAll('div');
                if (suggestions.length === 0 || autocompleteSuggestions.style.display === 'none') return;
                
                if (e.key === 'ArrowDown') { e.preventDefault(); selectedSuggestionIndex = (selectedSuggestionIndex + 1) % suggestions.length; updateSelectedSuggestion(); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); selectedSuggestionIndex = (selectedSuggestionIndex - 1 + suggestions.length) % suggestions.length; updateSelectedSuggestion(); }
                else if (e.key === 'Enter' && selectedSuggestionIndex > -1) { e.preventDefault(); suggestions[selectedSuggestionIndex].click(); }
                else if (e.key === 'Escape') { autocompleteSuggestions.style.display = 'none'; }
            });
            function updateSelectedSuggestion() {
                const suggestions = autocompleteSuggestions.querySelectorAll('div');
                suggestions.forEach((s, i) => {
                    s.classList.toggle('selected', i === selectedSuggestionIndex);
                    if (i === selectedSuggestionIndex) s.scrollIntoView({ block: 'nearest' });
                });
            }
            document.addEventListener('click', (e) => {
                if (!itemNameInput.contains(e.target) && !autocompleteSuggestions.contains(e.target)) {
                    autocompleteSuggestions.style.display = 'none';
                }
            });
        }
        function initializeVoiceInput() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = false; recognition.lang = 'bn-BD';
                recognition.onresult = (event) => { itemNameInput.value = event.results[0][0].transcript; };
                recognition.onerror = (event) => { customAlert(`ভয়েস ইনপুট এ সমস্যা: ${event.error}`, "ভয়েস ইনপুট ত্রুটি"); };
                recognition.onend = () => { voiceInputButton.classList.remove('listening'); voiceInputButton.innerHTML = '<i class="fas fa-microphone"></i>'; };
                voiceInputButton.addEventListener('click', () => {
                    if (voiceInputButton.classList.contains('listening')) { recognition.stop(); } 
                    else {
                        try {
                            recognition.start();
                            voiceInputButton.classList.add('listening');
                            voiceInputButton.innerHTML = '<i class="fas fa-stop-circle"></i>';
                        } catch (e) {
                            customAlert('মাইক্রোফোন শুরু করা যায়নি। অনুমতি দেওয়া আছে কিনা দেখুন।', 'ত্রুটি');
                        }
                    }
                });
            } else { voiceInputButton.style.display = 'none'; }
        }
        
        // --- Core Shopping List Functions (REFACTORED - UPDATED) ---
        // PERFORMANCE UPDATE: renderList now supports pagination and efficient updates.
        function renderList() {
            shoppingListDiv.innerHTML = ''; // Clear everything for a fresh render (e.g., after search)
            
            const searchTerm = shoppingListSearchInput.value.trim().toLowerCase();
            const filteredItems = searchTerm
                ? shoppingItems.filter(item => item.name.toLowerCase().includes(searchTerm))
                : [...shoppingItems];

            if (filteredItems.length === 0) {
                const message = searchTerm ? `"${shoppingListSearchInput.value}" নামে কোনো পণ্য পাওয়া যায়নি।` : "তালিকা এখনো খালি। কিছু পণ্য যোগ করুন!";
                shoppingListDiv.innerHTML = `<p style="text-align:center; padding: 20px;">${message}</p>`;
            } else {
                const itemsToDisplay = filteredItems.slice(0, shoppingListItemsToShow);
                itemsToDisplay.forEach((item, index) => {
                    const listItemDiv = createShoppingListItemElement(item, index);
                    shoppingListDiv.appendChild(listItemDiv);
                });

                // Add pagination sentinel if more items exist
                if (filteredItems.length > shoppingListItemsToShow) {
                    const sentinel = document.createElement('div');
                    sentinel.id = 'shoppingListSentinel';
                    sentinel.className = 'pagination-loader';
                    sentinel.textContent = 'লোড হচ্ছে...';
                    shoppingListDiv.appendChild(sentinel);
                    shoppingListObserver.observe(sentinel);
                }
            }
            updateTotalAmount();
        }
        
        // PERFORMANCE UPDATE: Appends the next page of items instead of re-rendering.
        function renderNextShoppingListPage() {
            const sentinel = document.getElementById('shoppingListSentinel');
            if (sentinel) {
                sentinel.remove();
                shoppingListObserver.disconnect();
            }

            const searchTerm = shoppingListSearchInput.value.trim().toLowerCase();
            const filteredItems = searchTerm
                ? shoppingItems.filter(item => item.name.toLowerCase().includes(searchTerm))
                : [...shoppingItems];

            const itemsToAppend = filteredItems.slice(shoppingListItemsToShow, shoppingListItemsToShow + PAGE_SIZE);
            itemsToAppend.forEach((item, index) => {
                const originalIndex = shoppingListItemsToShow + index;
                const listItemDiv = createShoppingListItemElement(item, originalIndex);
                shoppingListDiv.appendChild(listItemDiv);
            });

            shoppingListItemsToShow += PAGE_SIZE;

            if (filteredItems.length > shoppingListItemsToShow) {
                const newSentinel = document.createElement('div');
                newSentinel.id = 'shoppingListSentinel';
                newSentinel.className = 'pagination-loader';
                newSentinel.textContent = 'লোড হচ্ছে...';
                shoppingListDiv.appendChild(newSentinel);
                shoppingListObserver.observe(newSentinel);
            }
        }

        // PERFORMANCE UPDATE: Efficiently updates total without full re-render.
        function updateTotalAmount() {
            let total = 0;
            shoppingItems.forEach(item => {
                if (!item.bought) {
                    total += (item.price || 0); // UPDATED: Use item.price directly
                }
            });
            totalAmountSpan.textContent = formatCurrency(total);
        }

        // UPDATED: New Item Element (Compact/Expandable) - Event Listeners Removed for Performance
function createShoppingListItemElement(item, index) {
    const listItemDiv = document.createElement('div');
    // Check if the current item should be expanded
    const isExpanded = expandedItemIndex === index; 
    
    listItemDiv.className = `list-item ${item.bought ? 'bought' : ''} ${isExpanded ? 'expanded' : ''}`;
    listItemDiv.dataset.id = index;
    listItemDiv.setAttribute('draggable', 'true');
    
    // ড্র্যাগ ইভেন্টগুলো রাখা হয়েছে (এগুলো ডেলিগেট করা জটিল)
    listItemDiv.addEventListener('dragstart', dragStart);
    listItemDiv.addEventListener('dragover', dragOver);
    listItemDiv.addEventListener('drop', dropItem);
    listItemDiv.addEventListener('dragend', dragEnd);
    
    const priorityIndicator = document.createElement('div');
    priorityIndicator.className = `item-priority-indicator priority-${item.priority || 'low'}`;
    
    const itemTotal = item.price || 0; 

    // Time/Date formatting
    const date = item.addedDate ? new Date(item.addedDate) : new Date();
    const { datePart, timePart } = formatTransactionDateForDisplay(date.toISOString());
    const displayTimeDate = `${timePart} · ${datePart}`;

    // --- Inner HTML Structure ---
    listItemDiv.innerHTML = `
        <!-- 1. Compact Row (Always Visible) -->
        <div class="item-compact-row">
            <button class="toggle-bought-btn" 
                    title="${item.bought ? 'কেনা হয়নি হিসাবে চিহ্নিত করুন' : 'কেনা হয়েছে হিসাবে চিহ্নিত করুন'}">
                ${item.bought ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>'}
            </button>
            <span class="item-name-compact">${item.name}</span>
            <span class="item-total-price-compact">${formatCurrency(itemTotal)}</span>
        </div>
        
        <!-- 2. Expanded Details Row (Hidden by default, shown on click/expand) -->
        <div class="item-expanded-details">
            <div class="item-time-date">
                <i class="fas fa-clock"></i>
                ${displayTimeDate}
            </div>
            <div class="item-actions-expanded">
                <button class="edit-btn-expanded" title="পণ্যের বিস্তারিত সম্পাদনা করুন">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="delete-btn-expanded" title="পণ্যটি মুছুন">
                    <i class="fas fa-trash-alt"></i> Delete
                </button>
            </div>
        </div>`;
    
    listItemDiv.prepend(priorityIndicator);
    
    // লক্ষ্য করুন: এখানে কোনো click event listener নেই। 
    
    return listItemDiv;
}

        function dragStart(e) {
            draggedItem = this; 
            setTimeout(() => this.classList.add('dragging'), 0);
        }

        function dragOver(e) { e.preventDefault(); }

        async function dropItem(e) {
            e.preventDefault();
            if (draggedItem !== this) {
                 const draggedIndex = parseInt(draggedItem.dataset.id);
                 const targetIndex = parseInt(this.dataset.id);
                 const [removed] = shoppingItems.splice(draggedIndex, 1);
                 shoppingItems.splice(targetIndex, 0, removed);
                 
                 await updateFirestore({ shoppingLists });
                 renderList();
            }
        }
        function dragEnd() { 
            this.classList.remove('dragging'); 
            draggedItem = null;
        }

        // PERFORMANCE UPDATE: Uses efficient DOM manipulation instead of full re-render.
        function addItem() {
            const itemName = itemNameInput.value.trim();
            if (itemName === '') {
                customAlert('অনুগ্রহ করে পণ্যের নাম লিখুন।', "ইনপুট ত্রুটি");
                itemNameInput.focus(); return;
            }
            
            // UPDATED: Quantity removed.
            const newItem = {
                name: itemName,
                price: parseFloat(itemPriceInput.value) || 0, // Use price as is
                priority: itemPriorityInput.value,
                bought: false,
                addedDate: new Date().toISOString(),
                listId: currentListId
            };
            
            shoppingItems.push(newItem);
            const newIndex = shoppingItems.length - 1;

            // Only add to DOM if it's visible on the current page
            if (newIndex < shoppingListItemsToShow) {
                const listItemDiv = createShoppingListItemElement(newItem, newIndex);
                shoppingListDiv.appendChild(listItemDiv);
            }
            
            updateTotalAmount();
            addToItemDatabase(itemName);
            
            itemNameInput.value = ''; itemPriceInput.value = ''; itemPriorityInput.value = 'low'; itemNameInput.focus(); // UPDATED: Quantity removed
            
            updateFirestore({ shoppingLists });
            showToast('পণ্য যোগ করা হয়েছে।', { duration: 1500 });
        }
        
        async function commitLastDeletion() {
            if (lastDeletedItem) {
                await updateFirestore({ shoppingLists });
                lastDeletedItem = null;
            }
        }

        function undoLastDeletion() {
            if (lastDeletedItem) {
                clearTimeout(undoTimeout);
                shoppingItems.splice(lastDeletedItem.index, 0, lastDeletedItem.item);
                expandedItemIndex = -1; // Reset expanded item
                renderList(); // A full re-render is acceptable for an undo action.
                updateFirestore({ shoppingLists });
                showToast('পণ্যটি পুনরুদ্ধার করা হয়েছে।', { duration: 3000 });
                lastDeletedItem = null;
            }
        }
        
        function deleteItem(index) {
    // আগের কোনো ডিলিট যদি Undo না করা হয়, তবে তাকে কমিট করা হচ্ছে
    commitLastDeletion();
    clearTimeout(undoTimeout);

    const itemToDelete = shoppingItems[index];
    lastDeletedItem = { item: itemToDelete, index: index };
    
    // অ্যারে থেকে আইটেম সরানো হলো (এটি Index Mismatch-এর মূল কারণ)
    shoppingItems.splice(index, 1); 
    
    if (expandedItemIndex === index) expandedItemIndex = -1; // Reset expanded item if deleted
    else if (expandedItemIndex > index) expandedItemIndex--; // Adjust expanded item index if deleted item was before it

    // *** FIX: ম্যানুয়াল DOM ম্যানিপুলেশনের কোড বাদ দেওয়া হয়েছে।
    // পরিবর্তিত renderList() কল করা হলো, যা বর্তমানে লোড হওয়া পেজ ধরে রাখবে
    // এবং ডিলিট হওয়ার পর সঠিক ইনডেক্স সহ পুরো তালিকা রেন্ডার করবে।
    renderList(); 
    
    // updateTotalAmount() কে আর আলাদাভাবে কল করতে হবে না, কারণ renderList() ফাংশনটি এখন করে
    
    showToast(`"${itemToDelete.name}" মোছা হয়েছে।`, { undoCallback: undoLastDeletion });

    undoTimeout = setTimeout(commitLastDeletion, 4000);
}

        let editingItemIndex = -1;
        function openEditItemModal(index) {
            history.pushState({ view: 'modal' }, '', location.href);
            editingItemIndex = index;
            const currentItem = shoppingItems[index];
            editItemNameInput.value = currentItem.name;
            // REMOVED: editItemQuantityInput.value = currentItem.quantity || 1;
            editItemPriceInputModal.value = currentItem.price || 0;
            editItemPriorityInput.value = currentItem.priority || 'low';
            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            editItemModal.style.zIndex = zIndexCounter;
            editItemModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }
        function closeEditItemModal() {
            editItemModal.classList.remove('active');
            document.body.style.overflow = '';
            editingItemIndex = -1;
        }

        async function saveEditedItem() {
            const newName = editItemNameInput.value.trim();
            if (newName === '') {
                customAlert('অনুগ্রহ করে পণ্যের নাম লিখুন।', "ইনপুট ত্রুটি");
                return;
            }
            const item = shoppingItems[editingItemIndex];
            item.name = newName;
            item.price = parseFloat(editItemPriceInputModal.value) || 0; // UPDATED: Price only
            item.priority = editItemPriorityInput.value;
            
            // PERFORMANCE UPDATE: Update only the specific item in the DOM
            // NOTE: A full re-render is safer after edit to update all display properties/sorting.
            // However, sticking to the existing update logic for now.
            const elementToUpdate = shoppingListDiv.querySelector(`[data-id='${editingItemIndex}']`);
            if (elementToUpdate) {
                const newItemElement = createShoppingListItemElement(item, editingItemIndex);
                elementToUpdate.replaceWith(newItemElement);
            }
            
            // Re-expand the item if it was expanded
            if (expandedItemIndex === editingItemIndex) {
                 shoppingListDiv.querySelector(`[data-id='${editingItemIndex}']`)?.classList.add('expanded');
            }
            
            updateTotalAmount();
            await updateFirestore({ shoppingLists });
            closeEditItemModal();
            showToast('পণ্যটি সফলভাবে সম্পাদন করা হয়েছে।', { duration: 2000 });
        }

        async function toggleBought(index) {
            const item = shoppingItems[index];
            item.bought = !item.bought;
            
            // PERFORMANCE UPDATE: Efficiently update the specific item in the DOM
            const elementToUpdate = shoppingListDiv.querySelector(`[data-id='${index}']`);
            if (elementToUpdate) {
                elementToUpdate.classList.toggle('bought');
                const toggleButton = elementToUpdate.querySelector('.toggle-bought-btn');
                toggleButton.innerHTML = item.bought ? '<i class="fas fa-check-circle"></i>' : '<i class="far fa-circle"></i>';
                toggleButton.title = item.bought ? 'কেনা হয়নি হিসাবে চিহ্নিত করুন' : 'কেনা হয়েছে হিসাবে চিহ্নিত করুন';
                
                // If item is expanded, keep it expanded
                if(elementToUpdate.classList.contains('expanded')) {
                    // Update icon color in compact row if needed, already handled by CSS
                }
            }
            
            updateTotalAmount();
            await updateFirestore({ shoppingLists });
        }

        // --- Core Ledger Functions (REBUILT & REFACTORED - UNTOUCHED) ---
        // নতুন হেল্পার ফাংশন: সকল খাতা থেকে সকল গ্রাহকের তালিকা তৈরি করে
        function getAllCustomersFromAllLedgers() {
            const allCustomersList = [];
            for (const ledgerId in ledgers) {
                if (ledgers[ledgerId].customers) {
                    ledgers[ledgerId].customers.forEach(customer => {
                        // প্রতিটি গ্রাহকের সাথে তার খাতার আইডি যোগ করা হচ্ছে
                        allCustomersList.push({ ...customer, ledgerId: ledgerId });
                    });
                }
            }
            return allCustomersList;
        }

        // PERFORMANCE UPDATE: This function now sorts the full customer list once.
        // এই সম্পূর্ণ ফাংশনটি প্রতিস্থাপন করুন
function prepareAndRenderLedger() {
    // যদি "সকল খাতা" সিলেক্ট করা থাকে
    if (currentLedgerId === 'all') {
        allCustomers = getAllCustomersFromAllLedgers().sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
    } 
    // যদি নির্দিষ্ট খাতা সিলেক্ট করা থাকে
    else {
        const currentLedger = ledgers[currentLedgerId];
        if (!currentLedger || !currentLedger.customers) {
            allCustomers = [];
        } else {
            allCustomers = [...currentLedger.customers].sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
        }
    }
    renderLedger();
}

        // এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরোনোটিকে প্রতিস্থাপন করুন
function renderLedger() {
    if (currentView !== 'ledger') return;

    // --- START: নতুন এবং নির্ভরযোগ্য সমাধান ---
    // ধাপ ১: প্রথমে হিসাব খাতা সেকশনের সকল প্রধান অংশ লুকিয়ে ফেলা হচ্ছে
    ledgerMainView.style.display = 'none';
    ledgerCustomerView.style.display = 'none';
    receivableListView.style.display = 'none';
    payableListView.style.display = 'none';

    // ধাপ ২: এবার শর্ত অনুযায়ী শুধুমাত্র প্রয়োজনীয় অংশটি দেখানো হবে
    if (currentLedgerView === 'main') {
        // যদি মূল তালিকা দেখানোর কথা থাকে
        renderLedgerTabView(); // এটি নিজেই ledgerMainView, receivableListView, বা payableListView-কে দেখাবে
    } else if (currentLedgerView === 'customer') {
        // যদি কোনো নির্দিষ্ট গ্রাহকের পাতা দেখানোর কথা থাকে
        renderLedgerCustomerView();
        ledgerCustomerView.style.display = 'flex'; // শুধুমাত্র গ্রাহকের ভিউ দেখানো হচ্ছে
    }
    // --- END: সমাধান শেষ ---
}
        
        // এই সম্পূর্ণ ফাংশনটি দিয়ে আপনার পুরোনোটিকে প্রতিস্থাপন করুন
function renderLedgerTabView() {
    // প্রথমে সকল ভিউ লুকিয়ে ফেলা হচ্ছে
    ledgerMainView.style.display = 'none';
    receivableListView.style.display = 'none';
    payableListView.style.display = 'none';
    ledgerCustomerView.style.display = 'none';

    // নেভিগেশন মেনুর একটিভ স্টেট রিসেট করা হচ্ছে
    const navItems = ledgerBottomMenu.querySelectorAll('.nav-item');
    navItems.forEach(item => item.classList.remove('active'));

    // --- START: প্লাস (+) বাটনের জন্য কেন্দ্রীয় নিয়ন্ত্রণ ---
    // বাটনটি শুধুমাত্র তখনই দেখা যাবে যখন দুটি শর্ত পূরণ হবে:
    // ১. ব্যবহারকারী মূল 'খাতা' ট্যাবে থাকবেন (currentLedgerTab === 'main')।
    // ২. একটি নির্দিষ্ট খাতা সিলেক্ট করা থাকবে (currentLedgerId !== 'all')।
    
    const isMainTabActive = currentLedgerTab === 'main';
    const isSpecificLedgerSelected = currentLedgerId !== 'all';

    if (fabAddCustomerBtn) {
        if (isMainTabActive && isSpecificLedgerSelected) {
            fabAddCustomerBtn.style.display = 'flex'; // শর্ত পূরণ হলে বাটন দেখাও
        } else {
            fabAddCustomerBtn.style.display = 'none'; // অন্যথায় বাটন লুকাও
        }
    }
    // --- END: কেন্দ্রীয় নিয়ন্ত্রণ শেষ ---

    // এবার সঠিক ট্যাব অনুযায়ী ভিউ দেখানো হচ্ছে
    if (isMainTabActive) {
        ledgerMainView.style.display = 'block';
        document.getElementById('navLedgerHomeBtn').classList.add('active');
        renderLedgerMainView();
    } else if (currentLedgerTab === 'receivable') {
        receivableListView.style.display = 'block';
        document.getElementById('navLedgerReceivableBtn').classList.add('active');
        renderReceivableList();
    } else if (currentLedgerTab === 'payable') {
        payableListView.style.display = 'block';
        document.getElementById('navLedgerPayableBtn').classList.add('active');
        renderPayableList();
    }
}

function renderLedgerMainView() {
    customerListItemsToShow = PAGE_SIZE;
    customerListDiv.innerHTML = '';

    // এলিমেন্টগুলো ধরা
    const recEl = document.getElementById('ledger-total-receivable');
    const payEl = document.getElementById('ledger-total-payable');
    const statusMsg = document.getElementById('ledgerStatusMsg'); // নতুন টাইটেল বার

    if (currentLedgerId === 'all') {
        // --- সকল খাতা মোড ---
        const grandTotals = calculateGrandTotals();
        
        if(recEl) recEl.textContent = formatCurrency(grandTotals.receivable, false);
        if(payEl) payEl.textContent = formatCurrency(grandTotals.payable, false);

        // ✅ টাইটেল বার দেখানো হচ্ছে
if(statusMsg) {
    statusMsg.style.display = 'flex'; // <--- পরিবর্তন: 'block' এর বদলে 'flex' দিন
    statusMsg.innerHTML = '<i class="fas fa-calculator"></i> সকল খাতার মোট হিসাব';
}

        // '+' বাটন লুকানো
        if(fabAddCustomerBtn) fabAddCustomerBtn.style.display = 'none';

    } else {
        // --- নির্দিষ্ট খাতা মোড ---
        const singleLedgerTotals = calculateSingleLedgerTotals(currentLedgerId);
        
        if(recEl) recEl.textContent = formatCurrency(singleLedgerTotals.receivable, false);
        if(payEl) payEl.textContent = formatCurrency(singleLedgerTotals.payable, false);

        // ✅ নির্দিষ্ট খাতায় টাইটেল বার লুকানো হচ্ছে (কারণ ড্রপডাউনেই নাম আছে)
        if(statusMsg) statusMsg.style.display = 'none';

        // '+' বাটন দেখানো
        if(fabAddCustomerBtn) fabAddCustomerBtn.style.display = 'flex';
    }

    // --- লিস্ট রেন্ডারিং (আগের মতোই) ---
    const searchTerm = customerSearchInput.value.trim().toLowerCase();
    const filteredCustomers = searchTerm
        ? allCustomers.filter(c => c.name.toLowerCase().includes(searchTerm))
        : allCustomers;
    
    if (filteredCustomers.length === 0) {
         const message = searchTerm ? `"${searchTerm}" নামে কোনো গ্রাহক পাওয়া যায়নি।` : `কোনো গ্রাহক নেই। নতুন গ্রাহক যোগ করতে ডানদিকের '+' বাটনে ক্লিক করুন।`;
         customerListDiv.innerHTML = `<p style="text-align:center; padding: 20px; color: #777;">${message}</p>`;
         return;
    }
    
    const customersToDisplay = filteredCustomers.slice(0, customerListItemsToShow);
    customersToDisplay.forEach((customer) => {
        const ledgerIdForCustomer = customer.ledgerId || currentLedgerId;
        const itemDiv = createCustomerListItemElement(customer, ledgerIdForCustomer);
        customerListDiv.appendChild(itemDiv);
    });
    
    if (filteredCustomers.length > customerListItemsToShow) {
        const sentinel = document.createElement('div');
        sentinel.id = 'customerListSentinel';
        sentinel.className = 'pagination-loader';
        sentinel.textContent = 'লোড হচ্ছে...';
        customerListDiv.appendChild(sentinel);
        customerListObserver.observe(sentinel);
    }
}
        
        // PERFORMANCE UPDATE: Appends next page of customers
        function renderNextCustomerListPage() {
            const sentinel = document.getElementById('customerListSentinel');
            if (sentinel) {
                sentinel.remove();
                customerListObserver.disconnect();
            }

            const searchTerm = customerSearchInput.value.trim().toLowerCase();
            const filteredCustomers = searchTerm
                ? allCustomers.filter(c => c.name.toLowerCase().includes(searchTerm))
                : allCustomers;
            
            const customersToAppend = filteredCustomers.slice(customerListItemsToShow, customerListItemsToShow + PAGE_SIZE);
            customersToAppend.forEach(customer => {
                const itemDiv = createCustomerListItemElement(customer, currentLedgerId);
                customerListDiv.appendChild(itemDiv);
            });

            customerListItemsToShow += PAGE_SIZE;

            if (filteredCustomers.length > customerListItemsToShow) {
                const newSentinel = document.createElement('div');
                newSentinel.id = 'customerListSentinel';
                newSentinel.className = 'pagination-loader';
                newSentinel.textContent = 'লোড হচ্ছে...';
                customerListDiv.appendChild(newSentinel);
                customerListObserver.observe(newSentinel);
            }
        }

        // PERFORMANCE UPDATE: Reads balance and lastUpdated directly from the customer object.
        function createCustomerListItemElement(customer, ledgerId) {
            const balance = customer.currentBalance || 0;
            const lastUpdateTime = timeAgo(customer.lastUpdated);
            const initial = customer.name.trim().charAt(0).toUpperCase() || '?';
            const color = customerColors[Math.abs(customer.name.split("").reduce((a, b) => { a = ((a << 5) - a) + b.charCodeAt(0); return a & a }, 0)) % customerColors.length];

            const itemDiv = document.createElement('div');
            itemDiv.className = 'customer-list-item';
            itemDiv.dataset.customerId = customer.id;
            itemDiv.dataset.ledgerId = ledgerId; // খাতার আইডি যোগ করা হলো

            itemDiv.onclick = () => {
                const targetLedgerId = itemDiv.dataset.ledgerId;
                const targetCustomerId = itemDiv.dataset.customerId;
                // যদি গ্রাহক অন্য খাতার হয়, তবে আগে সেই খাতায় সুইচ করা হবে
                if (currentLedgerId !== targetLedgerId) {
                    switchLedger(targetLedgerId);
                }
                showCustomerView(targetCustomerId);
            };

            let balanceClass = '';
            let balanceContent = '';
            if (balance > 0) {
                balanceClass = 'positive';
                balanceContent = `<span class="balance-amount">${formatCurrency(Math.abs(balance), false)}</span>`;
            } else if (balance < 0) {
                balanceClass = 'negative';
                balanceContent = `<span class="balance-amount">${formatCurrency(Math.abs(balance), false)}</span>`;
            } else {
                 balanceContent = formatCurrency(0, false);
            }

            itemDiv.innerHTML = `
                <div class="customer-initial-circle" style="background-color: ${color};">${initial}</div>
                <div class="customer-info">
                    <div class="name">${customer.name}</div>
                    <div class="last-updated">${lastUpdateTime}</div>
                </div>
                <div class="customer-balance ${balanceClass}">
                    ${balanceContent}
                    <i class="fas fa-chevron-right"></i>
                </div>
            `;
            return itemDiv;
        }

        // PERFORMANCE UPDATE: Reads from denormalized fields
        function renderLedgerCustomerView() {
            const customer = findCustomerById(currentCustomerId);
            if (!customer) return;

            const initialHeaderDiv = document.getElementById('customerViewInitialHeader');
            const lastUpdatedDiv = document.getElementById('customerViewLastUpdated');

            const totalBalance = customer.currentBalance || 0;
            customerViewName.textContent = customer.name;
            
            if (customer.phone) {
                const formattedPhone = customer.phone.startsWith('0') ? `+88${customer.phone}` : `+88${customer.phone}`;
                customerViewPhone.innerHTML = `<a href="tel:${formattedPhone}"><i class="fas fa-phone-alt"></i> ${toBengaliNumber(formattedPhone)}</a>`;
            } else {
                customerViewPhone.innerHTML = '';
            }
            
            const initial = customer.name.trim().charAt(0).toUpperCase() || '?';
            const color = customerColors[Math.abs(customer.name.split("").reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)) % customerColors.length];
            initialHeaderDiv.textContent = initial;
            initialHeaderDiv.style.backgroundColor = color;
            
            const lastUpdateTime = timeAgo(customer.lastUpdated);
            lastUpdatedDiv.textContent = `(${lastUpdateTime})`;
            
            let balanceHTML = '';
            let balanceClass = 'balance';
            if (totalBalance > 0) {
                balanceHTML = `<span class="balance-label">পাবো</span> <span class="balance-amount">${formatCurrency(totalBalance)}</span>`;
                balanceClass += ' positive';
            } else if (totalBalance < 0) {
                balanceHTML = `<span class="balance-label">দেবো</span> <span class="balance-amount">${formatCurrency(Math.abs(totalBalance))}</span>`;
                balanceClass += ' negative';
            } else {
                balanceHTML = 'কোনো দেনা-পাওনা নেই';
            }
            customerViewBalance.innerHTML = balanceHTML;
            customerViewBalance.className = balanceClass;

            gaveAmountInput.value = '';
            receivedAmountInput.value = '';
            transactionDescriptionInput.value = '';
            transactionDateInput.value = formatDateForInput(new Date());
            transactionDateLabel.textContent = formatShortDateForDisplay(new Date());
            updateConfirmButtonState();
        }
        
        function updateConfirmButtonState() {
             // UPDATED: Use evaluateMathString for robust checking
             const evaluateMathString = (str) => {
                 try {
                     if (!str) return 0;
                     if (!isNaN(str)) return parseFloat(str);
                     if (/[^0-9.\+\-\*\/]/.test(str)) return parseFloat(str) || 0;
                     const result = new Function('return ' + str)();
                     return parseFloat(result.toPrecision(12));
                 } catch (e) {
                     return parseFloat(str) || 0;
                 }
             };

             const gaveAmount = evaluateMathString(gaveAmountInput.value) || 0;
             const receivedAmount = evaluateMathString(receivedAmountInput.value) || 0;
             
             if(gaveAmount > 0 || receivedAmount > 0) {
                 confirmTransactionBtn.classList.remove('disabled');
             } else {
                 confirmTransactionBtn.classList.add('disabled');
             }
        }
        
        function findCustomerById(id) {
            return ledgers[currentLedgerId]?.customers?.find(c => c.id === id);
        }

        function findTransactionById(customerId, txId) {
            const customer = findCustomerById(customerId);
            if (!customer || !customer.transactions) return null;
            return customer.transactions.find(tx => tx.id === txId);
        }

        function showCustomerView(customerId) {
    currentCustomerId = customerId;
    currentLedgerView = 'customer';
    renderLedger();
    // ✅ এখানে অতিরিক্ত একটি history state যুক্ত করা হলো, যাতে ব্যাক বাটন ঠিক থাকে
    if (currentLedgerTab === 'receivable') {
         history.pushState({ view: 'receivable' }, '', location.href);
    } else if (currentLedgerTab === 'payable') {
         history.pushState({ view: 'payable' }, '', location.href);
    }
    history.pushState({ view: 'customer' }, '', location.href);
}

        function showMainLedgerView() {
            currentCustomerId = null;
            currentLedgerView = 'main';
            currentLedgerTab = 'main';
            renderLedgerTabView();
        }
        
        function openAddCustomerModal() {
            history.pushState({ view: 'modal' }, '', location.href);
            const customerNameInput = document.getElementById('customerNameInput');
            const customerPhoneInput = document.getElementById('customerPhoneInput');
            customerNameInput.value = customerSearchInput.value;
            customerPhoneInput.value = '';

            const phoneWrapper = customerPhoneInput.closest('.phone-input-wrapper');
            phoneWrapper.classList.remove('input-invalid');
            document.getElementById('addCustomerConfirmBtn').disabled = false;
            
            // এরর ক্লিয়ার করা হয়েছে
            [customerNameInput, customerPhoneInput].forEach(clearFormError);

            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            addCustomerModal.style.zIndex = zIndexCounter;
            addCustomerModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            customerNameInput.focus();
        }

        function closeAddCustomerModal() {
            addCustomerModal.classList.remove('active');
            document.body.style.overflow = '';
        }

        async function addCustomer() {
    const addCustomerConfirmBtn = document.getElementById('addCustomerConfirmBtn');
    const originalText = setButtonLoading(addCustomerConfirmBtn, addCustomerConfirmBtn.textContent);

    try {
        const name = document.getElementById('customerNameInput').value.trim();
        const phone = document.getElementById('customerPhoneInput').value.trim();

        if (!name) { customAlert('অনুগ্রহ করে গ্রাহকের নাম লিখুন।'); return; }

        // বর্তমান সময়
        const now = new Date().toISOString();

        const newCustomer = {
            id: 'customer-' + Date.now(),
            name: name, 
            phone: phone, 
            transactions: [],
            createdAt: now,        // তৈরির সময়
            currentBalance: 0,
            lastUpdated: now       // আপডেটেড সময় (সবার উপরে রাখার জন্য)
        };

        if (!ledgers[currentLedgerId].customers) ledgers[currentLedgerId].customers = [];
        
        // অ্যারের শুরুতে যোগ করা (Unshift) যাতে রিলোড ছাড়াও সাথে সাথে উপরে দেখায়
        ledgers[currentLedgerId].customers.unshift(newCustomer);
        
        await updateFirestore({ ledgers });
        
        showToast(`"${name}"-কে যোগ করা হয়েছে।`, { duration: 2000 });
        customerSearchInput.value = '';
        prepareAndRenderLedger(); // এটি এখন সঠিক সর্টিং করবে
    } catch (error) {
        console.error("Add Customer Error:", error);
        customAlert("গ্রাহক যোগ করা যায়নি। আবার চেষ্টা করুন।");
    } finally {
        resetButtonState(addCustomerConfirmBtn);
    }
}

        async function addTransactionToCustomer() {
    if (confirmTransactionBtn.classList.contains('disabled')) return;

    const originalText = setButtonLoading(confirmTransactionBtn, confirmTransactionBtn.textContent);

    try {
        const customer = findCustomerById(currentCustomerId);
        if (!customer) throw new Error("Customer not found");

        // --- গাণিতিক সমাধানকারী ফাংশন ---
        // এটি "5.5+5.5" টেক্সটকে 11 তে রূপান্তর করবে
        const evaluateMathString = (str) => {
            try {
                if (!str) return 0;
                // ১. যদি স্ট্রিংয়ে শুধু সংখ্যা থাকে, সরাসরি ফেরত দাও
                if (!isNaN(str)) return parseFloat(str);
                
                // ২. নিরাপত্তা চেক: সংখ্যা এবং +, -, *, / ছাড়া অন্য কিছু আছে কিনা
                if (/[^0-9.\+\-\*\/]/.test(str)) return parseFloat(str) || 0;
                
                // ৩. সমাধান করা (যেমন: 5.5+5.5 = 11)
                const result = new Function('return ' + str)();
                return parseFloat(result.toPrecision(12)); // দশমিক ফিক্স
            } catch (e) {
                return parseFloat(str) || 0;
            }
        };

        // ইনপুট ফিল্ডের ভ্যালুগুলোকে প্রসেস করা হচ্ছে
        const gaveAmount = evaluateMathString(gaveAmountInput.value);
        const receivedAmount = evaluateMathString(receivedAmountInput.value);
        
        if (gaveAmount > 0 && receivedAmount > 0) { 
            customAlert('একই সাথে "টাকা দিলাম" এবং "টাকা পেলাম" যোগ করা যাবে না।'); 
            return; 
        }
        if (gaveAmount === 0 && receivedAmount === 0) { 
            customAlert('অনুগ্রহ করে টাকার পরিমাণ লিখুন।'); 
            return; 
        }
        
        // লেনদেনের আগের ব্যালেন্স (দশমিক ফিক্স সহ)
        const prevBalance = parseFloat((parseFloat(customer.currentBalance) || 0).toFixed(2));
        
        const dateVal = transactionDateInput.value;
        // তারিখ ইনপুট থেকে নেওয়া
        const txDateObj = new Date(dateVal);
        // সময় ঠিক রাখা (বর্তমান সময় দিয়ে, যাতে সর্টিং ঠিক থাকে - ১ সেকেন্ডের পার্থক্যও ধরা পরবে)
        const now = new Date();
        txDateObj.setHours(now.getHours(), now.getMinutes(), now.getSeconds());

        const transaction = {
            id: 'tx-' + Date.now(),
            type: gaveAmount > 0 ? 'gave' : 'received',
            // লেনদেনের টাকার পরিমাণ ২ ঘর ফিক্স করা
            amount: parseFloat((gaveAmount > 0 ? gaveAmount : receivedAmount).toFixed(2)), 
            description: transactionDescriptionInput.value.trim(),
            date: txDateObj.toISOString()
        };
        
        if (!customer.transactions) customer.transactions = [];
        customer.transactions.push(transaction);

        // --- মাস্টার ফাংশন কল (ব্যালেন্স ও সর্টিং ঠিক করার জন্য) ---
        // এটি ব্যালেন্স পুনরায় হিসাব করবে এবং lastUpdated তারিখ ঠিক করবে
        recalculateCustomerState(customer);
        // -------------------------------------------------------
        
        await updateFirestore({ ledgers });
        
        // UI আপডেট
        renderLedgerCustomerView();
        
        // কনফার্মেশন মডালে আপডেট হওয়া ব্যালেন্স পাঠানো
        showTransactionConfirmation(customer, transaction, prevBalance, customer.currentBalance);

    } catch (error) {
        console.error("Add Transaction Error:", error);
        customAlert("লেনদেন রেকর্ড করা যায়নি। আবার চেষ্টা করুন।");
    } finally {
        resetButtonState(confirmTransactionBtn);
    }
}

        function showTransactionConfirmation(customer, tx, prevBalance, newBalance) {
            history.pushState({ view: 'modal' }, '', location.href);
            const customerInfoDiv = document.getElementById('txConfirmCustomerInfo');
            const detailsDiv = document.getElementById('txConfirmDetails');
            
            const initial = customer.name.trim().charAt(0).toUpperCase() || '?';
            const color = customerColors[Math.abs(customer.name.split("").reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)) % customerColors.length];
            
            customerInfoDiv.innerHTML = `
                <div class="initial-circle" style="background-color: ${color};">${initial}</div>
                <div class="name">${customer.name}</div>
            `;
            
            const gaveText = formatCurrency(tx.type === 'gave' ? tx.amount : 0);
            const receivedText = formatCurrency(tx.type === 'received' ? tx.amount : 0);

            let descriptionHTML = '';
            if (tx.description) {
                descriptionHTML = `
                    <div class="tx-detail-item description">
                        <span style="text-align: left; white-space: pre-wrap; width: 100%;">${tx.description}</span>
                    </div>
                `;
            }

            let prevBalanceType = 'ব্যালেন্স';
            let prevBalanceClass = ''; // নতুন ভেরিয়েবল যোগ করা হয়েছে
            if (prevBalance > 0) { // পাবো (Receivable) -> লাল
                prevBalanceType = 'পূর্বের পাবো';
                prevBalanceClass = 'gave';
            } else if (prevBalance < 0) { // দেবো (Payable) -> সবুজ
                prevBalanceType = 'পূর্বের দেবো';
                prevBalanceClass = 'received';
            }

            let newBalanceType = 'বর্তমান ব্যালেন্স';
            let newBalanceClass = '';
            if (newBalance > 0) { // পাবো (Receivable) -> লাল রঙ হবে
                 newBalanceType = 'বর্তমান পাবো';
                 newBalanceClass = 'gave'; // 'positive' এর পরিবর্তে 'gave' ক্লাস ব্যবহার করা হয়েছে
            } else if (newBalance < 0) { // দেবো (Payable) -> সবুজ রঙ হবে
                 newBalanceType = 'বর্তমান দেবো';
                 newBalanceClass = 'received'; // 'negative' এর পরিবর্তে 'received' ক্লাস ব্যবহার করা হয়েছে
            }


            detailsDiv.innerHTML = `
                <div class="tx-detail-item">
                    <span>${prevBalanceType}</span>
                    <span class="${prevBalanceClass}">${formatCurrency(Math.abs(prevBalance))}</span>
                </div>
                <div class="tx-detail-item">
                    <span>দিলাম</span>
                    <span class="gave">${gaveText}</span>
                </div>
                <div class="tx-detail-item">
                    <span>পেলাম</span>
                    <span class="received">${receivedText}</span>
                </div>
                <div class="tx-detail-item final-balance">
                    <span class="balance-label">${newBalanceType.split(' ')[1]}</span>
                    <span class="balance-amount ${newBalanceClass}">${formatCurrency(Math.abs(newBalance))}</span>
                </div>
                ${descriptionHTML}
            `;
            
            const shareText = `**লেনদেন রেকর্ড**\nগ্রাহক: ${customer.name}\n\n${prevBalanceType}: ${formatCurrency(Math.abs(prevBalance))}\nদিলাম: ${gaveText}\nপেলাম: ${receivedText}\n------------------\n${newBalanceType}: ${formatCurrency(Math.abs(newBalance))}\n${tx.description ? 'বিবরণ: ' + tx.description + '\n' : ''}\n\nTalika.xyz থেকে পাঠানো হয়েছে`;

            document.getElementById('txConfirmCopyBtn').onclick = () => {
                 copyTextToClipboard(shareText.replace(/\*\*/g, ''));
                 showToast('তথ্য কপি করা হয়েছে!');
                 closeTxConfirmModal();
            };
            document.getElementById('txConfirmShareBtn').onclick = () => {
                const textToShare = shareText.replace(/\*\*/g, '');
                if (navigator.share) {
                    navigator.share({ title: `লেনদেন রেকর্ড - ${customer.name}`, text: textToShare, url: window.location.href });
                } else {
                    copyTextToClipboard(textToShare);
                    showToast('শেয়ার অপশন নেই, তথ্য কপি করা হয়েছে।');
                }
                 closeTxConfirmModal();
            };

            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            txConfirmModal.style.zIndex = zIndexCounter;
            txConfirmModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeTxConfirmModal() {
            txConfirmModal.classList.remove('active');
            document.body.style.overflow = '';
            showMainLedgerView();
            prepareAndRenderLedger();
        }

        // --- Common Functions for Both Views (MODIFIED) ---
        // সংশোধিত কোড (ত্রুটির উৎস বের করার জন্য):
        async function downloadPdf() {
            const pdfBtn = document.getElementById('navPdfBtn');
            try {
                if (currentView === 'shoppingList') {
                    pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // স্পিনার চালু
                    await downloadShoppingListPdf();
                } 
            } catch (error) {
                // *** নতুন লাইন: ত্রুটির উৎস ও মেসেজ কনসোলে দেখাবে ***
                console.error("PDF generation failed:", error.message, error); 
                customAlert(`PDF তৈরি করতে একটি সমস্যা হয়েছে। বিস্তারিত ত্রুটি: ${error.message || 'অজানা ত্রুটি'}`, "ব্যর্থ");
            } finally {
                if (currentView === 'shoppingList') {
                    pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>'; // স্পিনার বন্ধ
                }
            }
        }
        
        async function downloadShoppingListPdf() {
    const pdfBtn = document.getElementById('navPdfBtn');

    // বাটন ডিজেবল ও স্পিনার চালু
    pdfBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    pdfBtn.disabled = true;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('p', 'mm', 'a4');
    const PAGE_WIDTH = doc.internal.pageSize.getWidth();
    const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
    const MARGIN = 10;
    const CONTENT_WIDTH = PAGE_WIDTH - (MARGIN * 2);
    let y = MARGIN;
    
    // প্রোগ্রেস বারের জন্য গণনা
    const totalItemsCount = shoppingItems.length;
    let processedItems = 0;

    // লোডার চালু
    manageLoader(true, "PDF তৈরি হচ্ছে: কাঠামো প্রস্তুত করা হচ্ছে...");

    const checkAndAddPage = async (requiredHeight) => {
        if (y + requiredHeight > PAGE_HEIGHT - MARGIN) {
            doc.addPage();
            y = MARGIN;
        }
    };
    
    try { 
        // ১. হেডার (Header) রেন্ডারিং
        const pdfHeader = document.getElementById('pdfHeader');
        pdfHeader.textContent = `কেনাকাটার তালিকা - ${shoppingLists[currentListId].name}`;
        const headerCanvas = await html2canvas(pdfHeader, { scale: 2, backgroundColor: null, useCORS: true });
        const headerImgData = headerCanvas.toDataURL('image/png');
        const headerImgHeight = (headerCanvas.height * CONTENT_WIDTH) / headerCanvas.width;
        await checkAndAddPage(headerImgHeight);
        doc.addImage(headerImgData, 'PNG', MARGIN, y, CONTENT_WIDTH, headerImgHeight);
        y += headerImgHeight + 5;

        manageLoader(true, "PDF তৈরি হচ্ছে: শিরোনাম যুক্ত করা হচ্ছে...", 5);

        // ২. কলাম হেডার (Column Header) রেন্ডারিং
        const pdfHeaderCols = document.getElementById('pdfHeaderCols');
        const headerColsCanvas = await html2canvas(pdfHeaderCols, { scale: 2, backgroundColor: null, useCORS: true });
        const headerColsImgData = headerColsCanvas.toDataURL('image/png');
        const headerColsImgHeight = (headerColsCanvas.height * CONTENT_WIDTH) / headerColsCanvas.width;
        await checkAndAddPage(headerColsImgHeight);
        doc.addImage(headerColsImgData, 'PNG', MARGIN, y, CONTENT_WIDTH, headerColsImgHeight);
        y += headerColsImgHeight + 5;

        // ৩. আইটেম রেন্ডারিং (Items Loop)
        pdfItemsContainer.innerHTML = '';
        
        if (shoppingItems.length > 0) {
            for (let i = 0; i < shoppingItems.length; i++) {
                const item = shoppingItems[i];
                processedItems++;

                // প্রোগ্রেস বার আপডেট (স্মুথ)
                const currentProgress = 5 + Math.floor((processedItems / totalItemsCount) * 90);
                manageLoader(true, `PDF তৈরি হচ্ছে: ${toBengaliNumber(String(processedItems))}টি পণ্য রেন্ডার করা হয়েছে...`, currentProgress);
                
                // --- Item HTML তৈরি (প্রথম কোডের মতো ক্লীন পদ্ধতিতে) ---
                const itemDiv = document.createElement('div');
                itemDiv.className = `pdf-item ${item.bought ? 'bought-pdf' : ''}`;
                itemDiv.style.width = '700px'; 
                
                const pdfPriorityIndicator = document.createElement('div');
                pdfPriorityIndicator.className = `pdf-priority-indicator priority-${item.priority || 'low'}`;
                itemDiv.appendChild(pdfPriorityIndicator);
                
                const nameSpan = document.createElement('span');
                nameSpan.className = 'pdf-name';
                nameSpan.style.flexBasis = '50%';
                nameSpan.textContent = `${item.bought ? "[কেনা হয়েছে] " : ""}${toBengaliNumber(String(i + 1))}. ${item.name}`;
                
                const totalItemPriceSpan = document.createElement('span');
                totalItemPriceSpan.className = 'pdf-total';
                totalItemPriceSpan.style.flexBasis = '50%';
                const calculatedItemTotal = item.price || 0;
                totalItemPriceSpan.textContent = formatCurrency(calculatedItemTotal);
                
                itemDiv.appendChild(nameSpan);
                itemDiv.appendChild(totalItemPriceSpan);
                
                pdfItemsContainer.appendChild(itemDiv);

                // ক্যানভাসে রূপান্তর
                const itemCanvas = await html2canvas(itemDiv, { scale: 2, backgroundColor: null, useCORS: true });
                const itemImgData = itemCanvas.toDataURL('image/png');
                const itemImgHeight = (itemCanvas.height * CONTENT_WIDTH) / itemCanvas.width;

                await checkAndAddPage(itemImgHeight);
                doc.addImage(itemImgData, 'PNG', MARGIN, y, CONTENT_WIDTH, itemImgHeight);
                y += itemImgHeight;

                pdfItemsContainer.removeChild(itemDiv); // মেমোরি ক্লিয়ার
            }
        } else {
            // খালি তালিকার জন্য মেসেজ
            const noItemsDiv = document.createElement('div');
            noItemsDiv.style.textAlign = 'center';
            noItemsDiv.style.padding = '20px 0';
            noItemsDiv.style.fontSize = '22px';
            noItemsDiv.style.width = '700px';
            noItemsDiv.textContent = "তালিকায় কোনো পণ্য নেই।";
            pdfItemsContainer.appendChild(noItemsDiv);

            const canvas = await html2canvas(noItemsDiv, { scale: 2, backgroundColor: null, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const imgHeight = (canvas.height * CONTENT_WIDTH) / canvas.width;
            
            await checkAndAddPage(imgHeight);
            doc.addImage(imgData, 'PNG', MARGIN, y, CONTENT_WIDTH, imgHeight);
            y += imgHeight;
            pdfItemsContainer.innerHTML = '';
        }

        // ৪. সারাংশ (Summary) রেন্ডারিং
        let totalBought = 0, totalUnbought = 0, overallTotal = 0;
        shoppingItems.forEach(item => {
            const itemTotal = item.price || 0;
            overallTotal += itemTotal;
            if(item.bought) totalBought += itemTotal;
            else totalUnbought += itemTotal;
        });

        document.getElementById('pdfBoughtTotal').textContent = formatCurrency(totalBought);
        document.getElementById('pdfUnboughtTotal').textContent = formatCurrency(totalUnbought);
        document.getElementById('pdfOverallTotal').textContent = formatCurrency(overallTotal);

        const summaryEl = document.getElementById('pdfTotalAmount');
        const summaryCanvas = await html2canvas(summaryEl, { scale: 2, backgroundColor: null, useCORS: true });
        const summaryImgData = summaryCanvas.toDataURL('image/png');
        const summaryImgHeight = (summaryCanvas.height * CONTENT_WIDTH) / summaryCanvas.width;
        
        await checkAndAddPage(summaryImgHeight + 5);
        y += 5;
        doc.addImage(summaryImgData, 'PNG', MARGIN, y, CONTENT_WIDTH, summaryImgHeight);

        // ৫. পেজ নম্বর যোগ করা (Footer)
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(12);
            doc.setTextColor(0);
            const pageText = `${i}/${totalPages}`;
            doc.text(pageText, PAGE_WIDTH - 5, PAGE_HEIGHT - 5, { align: 'right' });
        }

        manageLoader(true, "PDF তৈরি হচ্ছে: চূড়ান্ত ফাইল সেভ করা হচ্ছে...", 98);
        
        // --- ৬. চূড়ান্ত সেভিং লজিক (Hybrid Support) ---
        // এই অংশটিই আপনার অ্যাপের জন্য সবচেয়ে গুরুত্বপূর্ণ
        const fileName = `কেনাকাটার-তালিকা-${shoppingLists[currentListId].name}.pdf`;
        
        if (typeof Android !== 'undefined' && Android.saveBase64Pdf) {
            // যদি অ্যাপটি অ্যান্ড্রয়েড WebView এর ভেতরে চলে
            const pdfDataUri = doc.output('datauristring');
            Android.saveBase64Pdf(pdfDataUri, fileName); 
        } else {
             // যদি সাধারণ ব্রাউজারে চলে (PC বা Mobile Browser)
             doc.save(fileName);
        }
    
    } catch (error) { 
        console.error("PDF generation failed:", error.message, error); 
        customAlert(`PDF তৈরি করতে একটি সমস্যা হয়েছে।`, "ব্যর্থ");
    } finally { 
        // লোডার বন্ধ (Android App এ এটিই লোডিং স্ক্রিন সরাবে)
        manageLoader(false); 
        pdfBtn.innerHTML = '<i class="fas fa-file-pdf"></i>'; 
        pdfBtn.disabled = false;
        pdfItemsContainer.innerHTML = ''; // ক্লিনআপ
    }
}

        async function downloadCustomerReportPdf(customerId) {
    const button = document.getElementById('customerReportPdfBtn');
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;

    try {
        const customer = findCustomerById(customerId);
        if (!customer) throw new Error("Customer not found");

        manageLoader(true, "PDF রিপোর্ট প্রস্তুত হচ্ছে: ডেটা আনা হচ্ছে...");

        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'mm', 'a4');
        const PAGE_WIDTH = doc.internal.pageSize.getWidth();
        const PAGE_HEIGHT = doc.internal.pageSize.getHeight();
        const MARGIN = 10;
        const CONTENT_WIDTH = PAGE_WIDTH - (MARGIN * 2);
        let y = MARGIN;
        const transactions = [...(customer.transactions || [])].sort((a, b) => new Date(a.date) - new Date(b.date));
        const totalTransactionsCount = transactions.length;
        let processedTransactions = 0;
        
        const checkAndAddPage = (requiredHeight) => {
            if (y + requiredHeight > PAGE_HEIGHT - MARGIN - 10) { 
                doc.addPage();
                y = MARGIN;
                return true;
            }
            return false;
        };

        const renderElementToPdf = async (element) => {
            const canvas = await html2canvas(element, { scale: 2, backgroundColor: null, useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const imgHeight = (canvas.height * CONTENT_WIDTH) / canvas.width;
            return { imgData, imgHeight };
        };
        
        pdfLedgerContent.innerHTML = '';

        const reportDate = new Date();
        const reportGeneratedAt = reportDate.toLocaleTimeString('bn-BD', { hour: 'numeric', minute: '2-digit', hour12: true });

        const headerDiv = document.createElement('div');
        headerDiv.innerHTML = `
            <div class="pdf-report-header">
                <div class="pdf-report-header-left">
                    <p class="name">${customer.name}</p>
                    <p class="phone">${customer.phone ? 'মোবাইল: ' + toBengaliNumber(customer.phone) : ''}</p>
                </div>
                <div class="pdf-report-header-right"><p class="logo">📕 হিসাব খাতা</p></div>
            </div>`;
        pdfLedgerContent.appendChild(headerDiv);
        const { imgData: headerImg, imgHeight: headerHeight } = await renderElementToPdf(headerDiv);
        checkAndAddPage(headerHeight);
        doc.addImage(headerImg, 'PNG', MARGIN, y, CONTENT_WIDTH, headerHeight);
        y += headerHeight;
        pdfLedgerContent.innerHTML = '';

        const subheaderDiv = document.createElement('div');
        subheaderDiv.innerHTML = `
             <div class="pdf-report-subheader">
                <div class="pdf-report-subheader-left">
                    <p class="title">বাকি হিসাব রিপোর্ট</p>
                    <p class="date">${formatLongDateForDisplay(reportDate)}</p>
                </div>
                <div class="pdf-report-subheader-right">
                    <p>হিসাবের সংখ্যা: ${toBengaliNumber(String(transactions.length))}</p>
                    <p>রিপোর্ট তৈরি: ${reportGeneratedAt}</p>
                </div>
            </div>`;
        pdfLedgerContent.appendChild(subheaderDiv);
        const { imgData: subheaderImg, imgHeight: subheaderHeight } = await renderElementToPdf(subheaderDiv);
        checkAndAddPage(subheaderHeight);
        doc.addImage(subheaderImg, 'PNG', MARGIN, y, CONTENT_WIDTH, subheaderHeight);
        y += subheaderHeight + 2;
        pdfLedgerContent.innerHTML = '';

        const tableHeaderTable = document.createElement('table');
        tableHeaderTable.className = 'pdf-report-table';
        tableHeaderTable.innerHTML = `
            <thead>
                <tr>
                    <th class="col-details">বিবরণ</th>
                    <th class="col-gave">দিলাম</th>
                    <th class="col-received">পেলাম</th>
                </tr>
            </thead>`;
        pdfLedgerContent.appendChild(tableHeaderTable);
        const { imgData: tableHeaderImg, imgHeight: tableHeaderHeight } = await renderElementToPdf(tableHeaderTable.querySelector('thead'));
        pdfLedgerContent.innerHTML = '';
        
        const addTableHeader = () => {
            doc.addImage(tableHeaderImg, 'PNG', MARGIN, y, CONTENT_WIDTH, tableHeaderHeight);
            y += tableHeaderHeight;
        };
        
        addTableHeader();

        manageLoader(true, `PDF রিপোর্ট প্রস্তুত হচ্ছে: ${toBengaliNumber(String(totalTransactionsCount))}টি লেনদেন রেন্ডার করা হচ্ছে...`, 5);

        for (let i = 0; i < transactions.length; i++) {
            const tx = transactions[i];
            processedTransactions++;

            const currentProgress = 5 + Math.floor((processedTransactions / totalTransactionsCount) * 90);
            manageLoader(true, `PDF রিপোর্ট প্রস্তুত হচ্ছে: ${toBengaliNumber(String(processedTransactions))}টি লেনদেন সম্পন্ন...`, currentProgress);
            
            const rowTable = document.createElement('table');
            rowTable.className = 'pdf-report-table';
            const { datePart, yearPart, timePart } = formatTransactionDateForDisplay(tx.date);
            const description = tx.description ? `<span class="tx-description-pdf">${tx.description}</span>` : '';

            rowTable.innerHTML = `
                <tbody>
                    <tr>
                        <td class="col-details">${datePart} ${yearPart}<br><span class="tx-time-pdf">${timePart}</span>${description}</td>
                        <td class="col-gave gave-amount">${tx.type === 'gave' ? formatCurrency(tx.amount, false) : ''}</td>
                        <td class="col-received received-amount">${tx.type === 'received' ? formatCurrency(tx.amount, false) : ''}</td>
                    </tr>
                </tbody>`;
            pdfLedgerContent.appendChild(rowTable);
            const { imgData: rowImg, imgHeight: rowHeight } = await renderElementToPdf(rowTable.querySelector('tbody tr'));
             pdfLedgerContent.innerHTML = '';

            if (checkAndAddPage(rowHeight)) {
                addTableHeader();
            }
            doc.addImage(rowImg, 'PNG', MARGIN, y, CONTENT_WIDTH, rowHeight);
            y += rowHeight;
        }
        
        let totalGave = 0, totalReceived = 0;
        transactions.forEach(tx => {
            if (tx.type === 'gave') totalGave += tx.amount;
            if (tx.type === 'received') totalReceived += tx.amount;
        });
        const finalBalance = totalGave - totalReceived;

        const footerTable = document.createElement('table');
        footerTable.className = 'pdf-report-table';
        footerTable.innerHTML = `
             <tfoot>
                <tr class="total-row">
                    <td class="col-details">মোট</td>
                    <td class="col-gave gave-amount">${formatCurrency(totalGave, false)}</td>
                    <td class="col-received received-amount">${formatCurrency(totalReceived, false)}</td>
                </tr>
                <tr class="net-balance-row">
                    <td class="col-details">${finalBalance >= 0 ? 'পাবো' : 'দেবো'}</td>
                    ${finalBalance >= 0 
                        ? `<td class="col-gave gave-amount">${formatCurrency(finalBalance, false)}</td><td class="col-received"></td>` 
                        : `<td class="col-gave"></td><td class="col-received received-amount">${formatCurrency(Math.abs(finalBalance), false)}</td>`
                    }
                </tr>
            </tfoot>`;
        pdfLedgerContent.appendChild(footerTable);
        const { imgData: footerImg, imgHeight: footerHeight } = await renderElementToPdf(footerTable.querySelector('tfoot'));
        if(checkAndAddPage(footerHeight)) {}
        doc.addImage(footerImg, 'PNG', MARGIN, y, CONTENT_WIDTH, footerHeight);
        y += footerHeight;
        pdfLedgerContent.innerHTML = '';
        
        manageLoader(true, "PDF রিপোর্ট প্রস্তুত হচ্ছে: চূড়ান্ত ফাইল তৈরি হচ্ছে...", 98);
        
        // পেজ নম্বর যুক্ত করা
        const totalPages = doc.internal.getNumberOfPages();
        for (let i = 1; i <= totalPages; i++) {
            doc.setPage(i);
            doc.setFontSize(12);
            doc.setTextColor(0);
            const pageText = `${i}/${totalPages}`;
            doc.text(pageText, PAGE_WIDTH - 5, PAGE_HEIGHT - 5, { align: 'right' });
        }

        manageLoader(false); // লোডার বন্ধ

        // --- WebView এর জন্য ডাউনলোড লজিক ---
        const fileName = `${customer.name}-রিপোর্ট.pdf`;

        // চেক করা হচ্ছে অ্যাপটি অ্যান্ড্রয়েড WebView এর ভেতরে চলছে কিনা
        if (typeof Android !== 'undefined' && Android.saveBase64Pdf) {
            // PDF ডেটাকে Base64 স্ট্রিং এ কনভার্ট করা
            const pdfDataUri = doc.output('datauristring');
            
            // অ্যান্ড্রয়েড ইন্টারফেসের মাধ্যমে ডেটা পাঠানো
            // Android.saveBase64Pdf(base64Data, fileName)
            Android.saveBase64Pdf(pdfDataUri, fileName);
            
            showToast("PDF ডাউনলোড শুরু হয়েছে...");
        } else {
            // সাধারণ ব্রাউজার হলে ডিফল্ট ডাউনলোড
            doc.save(fileName);
        }
        // ------------------------------------

    } catch (error) {
        console.error("PDF generation failed:", error.message, error); 
        customAlert(`PDF তৈরি করতে একটি সমস্যা হয়েছে। বিস্তারিত ত্রুটি: ${error.message || 'অজানা ত্রুটি'}`, "ব্যর্থ");
    } finally {
        button.innerHTML = '<i class="fas fa-file-pdf"></i>'; // স্পিনার বন্ধ করা
        button.disabled = false;
        pdfLedgerContent.innerHTML = '';
        manageLoader(false); // নিশ্চিত করা লোডার বন্ধ হয়েছে
    }
}


        // --- Dark Mode & Font Size (UNTOUCHED) ---
        function toggleDarkMode() {
            body.classList.toggle('dark-mode');
            const isDarkMode = body.classList.contains('dark-mode');
            updateDarkModeToggleIcon(isDarkMode);
            updateFirestore({ darkMode: isDarkMode });
        }
        function updateDarkModeToggleIcon(isDarkMode) {
            darkModeToggle.innerHTML = isDarkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
            darkModeToggle.title = isDarkMode ? 'লাইট মোড' : 'ডার্ক মোড';
        }
        // --- ফন্ট সাইজ ফাংশন (লুপ ফিক্স করা হয়েছে) ---
function applyFontSize(size, saveToDb = true) {
    // সাইজ লিমিট চেক
    if (size < 13) size = 13;
    if (size > 25) size = 25;

    document.body.style.fontSize = `${size}px`;
    currentFontSize = size;

    // যদি saveToDb সত্য হয়, তবেই ফায়ারবেসে আপডেট যাবে
    if (saveToDb) {
        updateFirestore({ fontSize: size });
    }
}
        
        // --- Modal Controls & Share Functionality (UNTOUCHED) ---
        function openInfoModal() { 
            history.pushState({ view: 'modal' }, '', location.href);
            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            document.getElementById('infoModalOverlay').style.zIndex = zIndexCounter;
            document.getElementById('infoModalOverlay').classList.add('active'); 
            document.body.style.overflow = 'hidden'; 
        }
        function closeInfoModal() { document.getElementById('infoModalOverlay').classList.remove('active'); document.body.style.overflow = ''; }
        
        function handleNavClick(menuElement, clickedButton) {
            const navItems = menuElement.querySelectorAll('.nav-item');
            navItems.forEach(item => item.classList.remove('active'));
            clickedButton.classList.add('active');
        }

        function openShareModal() {
            if (currentView === 'shoppingList') {
                handleNavClick(shoppingListBottomMenu, document.getElementById('navShareBtn'));
                openShoppingListShareModal();
            } else {
                handleNavClick(ledgerBottomMenu, document.getElementById('navLedgerShareBtn'));
                openLedgerShareModal();
            }
        }

        function openShoppingListShareModal() {
            history.pushState({ view: 'modal' }, '', location.href);
            shareModalTitle.textContent = 'তালিকা শেয়ার করুন';
            let shareText = `কেনাকাটার তালিকা: ${shoppingLists[currentListId].name}\n\n`;
            shareText += `পণ্যের তালিকা:\n`;
            let totalBought = 0, totalUnbought = 0, overallTotal = 0;
            if (shoppingItems.length === 0) { shareText += "তালিকায় কোনো পণ্য নেই।"; } 
            else {
                shoppingItems.forEach((item, index) => {
                    const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                    shareText += `${toBengaliNumber(String(index + 1))}. ${item.name} - ${formatCurrency(itemTotal)} (${getPriorityDisplayName(item.priority || 'low')})${item.bought ? ' [কেনা হয়েছে]' : ' [কেনা হয়নি]'}\n`; // UPDATED: Removed quantity/unit price
                    overallTotal += itemTotal;
                    if (item.bought) { totalBought += itemTotal; } else { totalUnbought += itemTotal; }
                });
                shareText += `\n--------------------------\n`;
                shareText += `কেনা পণ্যের মোট মূল্য: ${formatCurrency(totalBought)}\n`;
                shareText += `কেনা হয়নি পণ্যের মোট মূল্য: ${formatCurrency(totalUnbought)}\n`;
                shareText += `সামগ্রিক মোট মূল্য: ${formatCurrency(overallTotal)}\n`;
            }
            shareText += `\nTalika.xyz থেকে পাঠানো হয়েছে`;
            shareableTextPre.textContent = shareText;
            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            shareModalOverlay.style.zIndex = zIndexCounter;
            shareModalOverlay.classList.add('active'); 
            document.body.style.overflow = 'hidden';
        }

        function openLedgerShareModal() {
    history.pushState({ view: 'modal' }, '', location.href);
    shareModalTitle.textContent = 'হিসাব খাতা শেয়ার করুন';
    let shareText = '';

    // যদি "সকল খাতা" সিলেক্ট করা থাকে
    if (currentLedgerId === 'all') {
        shareText = `**সকল খাতার সারাংশ**\n\n`;
        const allLedgerCustomers = getAllCustomersFromAllLedgers();
        const receivableCustomers = [];
        const payableCustomers = [];
        const { receivable: totalReceivable, payable: totalPayable } = calculateGrandTotals();

        allLedgerCustomers.forEach(customer => {
            const balance = customer.currentBalance || 0;
            if (balance > 0) {
                receivableCustomers.push({ name: customer.name, amount: balance });
            } else if (balance < 0) {
                payableCustomers.push({ name: customer.name, amount: Math.abs(balance) });
            }
        });

        shareText += `মোট পাবো: ${formatCurrency(totalReceivable)}\n`;
        shareText += `মোট দেবো: ${formatCurrency(totalPayable)}\n\n`;

        if (receivableCustomers.length > 0) {
            shareText += `-- যাদের থেকে পাবো --\n`;
            receivableCustomers.forEach(c => {
                shareText += `${c.name}: ${formatCurrency(c.amount)}\n`;
            });
            shareText += `\n`;
        }
        if (payableCustomers.length > 0) {
            shareText += `-- যাদেরকে দেবো --\n`;
            payableCustomers.forEach(c => {
                shareText += `${c.name}: ${formatCurrency(c.amount)}\n`;
            });
        }
    } 
    // যদি নির্দিষ্ট খাতা সিলেক্ট করা থাকে (এখানে নতুন কোড যোগ করা হয়েছে)
    else {
        const currentLedger = ledgers[currentLedgerId];
        shareText = `**হিসাব খাতা: ${currentLedger.name}**\n\n`;
        const { receivable: totalReceivable, payable: totalPayable } = calculateSingleLedgerTotals(currentLedgerId);
        
        const receivableCustomers = [];
        const payableCustomers = [];

        if (currentLedger && currentLedger.customers) {
            currentLedger.customers.forEach(customer => {
                const balance = customer.currentBalance || 0;
                if (balance > 0) {
                    receivableCustomers.push({ name: customer.name, amount: balance });
                } else if (balance < 0) {
                    payableCustomers.push({ name: customer.name, amount: Math.abs(balance) });
                }
            });
        }

        shareText += `মোট পাবো: ${formatCurrency(totalReceivable)}\n`;
        shareText += `মোট দেবো: ${formatCurrency(totalPayable)}\n\n`;

        if (receivableCustomers.length > 0) {
            shareText += `-- যাদের থেকে পাবো --\n`;
            receivableCustomers.forEach(c => {
                shareText += `${c.name}: ${formatCurrency(c.amount)}\n`;
            });
            shareText += `\n`;
        }
        if (payableCustomers.length > 0) {
            shareText += `-- যাদেরকে দেবো --\n`;
            payableCustomers.forEach(c => {
                shareText += `${c.name}: ${formatCurrency(c.amount)}\n`;
            });
        }
    }

    shareText += `\nTalika.xyz থেকে শেয়ার করা হয়েছে`;
    shareableTextPre.textContent = shareText.replace(/\*\*/g, '');
    zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
    shareModalOverlay.style.zIndex = zIndexCounter;
    shareModalOverlay.classList.add('active');
    document.body.style.overflow = 'hidden';
}

        function copyTextToClipboard(text) {
            if (navigator.clipboard && window.isSecureContext) {
                return navigator.clipboard.writeText(text);
            } else {
                const textArea = document.createElement('textarea');
                textArea.value = text;
                textArea.style.position = 'fixed';
                textArea.style.opacity = '0';
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                } catch (err) {
                    console.error('Fallback copy failed', err);
                }
                document.body.removeChild(textArea);
            }
        }

        function closeShareModal() { shareModalOverlay.classList.remove('active'); document.body.style.overflow = ''; }

        function copyShareableText() {
            copyTextToClipboard(shareableTextPre.textContent).then(() => {
                showToast('তথ্য কপি করা হয়েছে!');
            }).catch(err => customAlert('কপি করতে ব্যর্থ। অনুগ্রহ করে ম্যানুয়ালি কপি করুন।', "ব্যর্থ"));
        }

        function shareViaWebAPI() {
    const title = currentView === 'shoppingList' ? `কেনাকাটার তালিকা: ${shoppingLists[currentListId].name}` : `হিসাব খাতা: সকল খাতার সারাংশ`;
    const textToShare = shareableTextPre.textContent;
    const urlToShare = "https://www.talika.xyz/";

    // ১. Android App (WebView) অগ্রাধিকার:
    // যদি এটি অ্যাপের ভেতরে চলে, তবে ব্রাউজারের শেয়ার বাদ দিয়ে সরাসরি অ্যাপের শেয়ার সিস্টেম কল করবে।
    // এটি সবচেয়ে নির্ভরযোগ্য পদ্ধতি।
    if (typeof Android !== 'undefined' && Android.startNativeShare) {
        Android.startNativeShare(title, textToShare);
        closeShareModal(); // মডাল বন্ধ করে দেওয়া হবে
        return;
    }

    // ২. সাধারণ ব্রাউজার (Chrome, Safari, etc.):
    if (navigator.share) {
        navigator.share({ title: title, text: textToShare, url: urlToShare })
        .then(() => {
             // সফলভাবে শেয়ার হলে মডাল বন্ধ হবে
             closeShareModal(); 
        })
        .catch(err => {
             // ৩. ইউজার যদি শেয়ার উইন্ডো ওপেন করে কেটে দেয় (AbortError),
             // তাহলে কোনো এরর বা কপি করার দরকার নেই। এটিই ইউজার এক্সপেরিয়েন্স ফিক্স করবে।
             if (err.name === 'AbortError') {
                 console.log('Share cancelled by user');
                 return; 
             }
             
             // অন্য কোনো আসল সমস্যা হলে তখন কপি করবে
             console.error("Web Share Error:", err);
             fallbackToClipboard(textToShare);
        });
    } else {
        // ৪. ব্রাউজারে শেয়ার সাপোর্ট না করলে (যেমন: পুরনো ব্রাউজার বা পিসি)
        fallbackToClipboard(textToShare);
    }
}

// আলাদা হেল্পার ফাংশন (মেসেজটি একটু সুন্দর করা হয়েছে)
function fallbackToClipboard(text) {
    copyTextToClipboard(text);
    // টাইটেল 'শেয়ার ব্যর্থ' এর বদলে 'কপি করা হয়েছে' দিলে ইউজার পজিটিভ ফিল করবে
    customAlert('সরাসরি শেয়ার সম্ভব হয়নি। তবে তথ্যটি আপনার জন্য কপি করে দেওয়া হয়েছে, আপনি পেস্ট করে পাঠাতে পারবেন।', 'কপি করা হয়েছে');
}

        // --- Report Page Functions (সংশোধিত) ---
        function showReportPage() {
            mainContainer.style.display = 'none';
            customerReportPage.style.display = 'none';
            changeNamePage.style.display = 'none'; // ADDED
            changePasswordPage.style.display = 'none'; // ADDED
            changeEmailPage.style.display = 'none'; // ADDED
            reportPage.style.display = 'flex';
            handleNavClick(shoppingListBottomMenu, document.getElementById('navReportBtn'));
            history.pushState({ view: 'report' }, '', location.href);
            
            const today = new Date(), firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            reportStartDateInput.value = formatDateForInput(firstDayOfMonth);
            reportEndDateInput.value = formatDateForInput(today);
            document.getElementById('dateFilterResults').style.display = 'none';
            reportPriorityFilter.value = 'low'; reportListFilter.value = 'all';
            updateReportContent();
        }

        function hideReportPage() {
            reportPage.style.display = 'none';
            mainContainer.style.display = 'flex';
            handleNavClick(shoppingListBottomMenu, document.getElementById('navHomeBtn'));
        }

        function openReportModalFromMonthly() { closeMonthlySpendingModal(); showReportPage(); }
        
        function populateReportListFilter() {
            reportListFilter.innerHTML = '<option value="all">সমস্ত তালিকার মোট</option>';
            for (const id in shoppingLists) {
                const option = document.createElement('option');
                option.value = id;
                option.textContent = shoppingLists[id].name;
                reportListFilter.appendChild(option);
            }
            reportListFilter.value = 'all';
        }
        function calculateReportSummary(items) {
            let summary = { totalItems: 0, overallTotal: 0, boughtItemsCount: 0, boughtItemsTotal: 0, unboughtItemsCount: 0, unboughtItemsTotal: 0, listIds: new Set() };
            items.forEach(item => {
                summary.totalItems++; 
                const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                summary.overallTotal += itemTotal; 
                summary.listIds.add(item.listId);
                if (item.bought) { summary.boughtItemsCount++; summary.boughtItemsTotal += itemTotal; } else { summary.unboughtItemsCount++; summary.unboughtItemsTotal += itemTotal; }
            });
            return summary;
        }
        // **সংশোধিত**: HTML-এ বিদ্যমান ID গুলো ব্যবহার করা হচ্ছে
        function renderSummaryBlock(items) {
            const summary = calculateReportSummary(items);
            reportSummaryTotalLists.textContent = toBengaliNumber(String(summary.listIds.size));
            reportSummaryTotalItems.textContent = toBengaliNumber(String(summary.totalItems)); 
            reportSummaryOverallTotal.textContent = formatCurrency(summary.overallTotal);
            reportSummaryBoughtItemsCount.textContent = toBengaliNumber(String(summary.boughtItemsCount)); 
            reportSummaryBoughtItemsTotal.textContent = formatCurrency(summary.boughtItemsTotal);
            reportSummaryUnboughtItemsCount.textContent = toBengaliNumber(String(summary.unboughtItemsCount)); 
            reportSummaryUnboughtItemsTotal.textContent = formatCurrency(summary.unboughtItemsTotal);
        }
        function getFilteredItems() {
            const selectedListId = reportListFilter.value; 
            let allItems = [];
            
            // সকল তালিকা থেকে item.listId সহ ডেটা ফিল্টার করা
            for (const listId in shoppingLists) {
                const listName = shoppingLists[listId].name;
                if (selectedListId === 'all' || selectedListId === listId) {
                    allItems = allItems.concat(shoppingLists[listId].items.map(item => ({...item, listName: listName, listId: listId})));
                }
            }
            return allItems;
        }
        // **সংশোধিত**: অপ্রয়োজনীয় DOM ইন্টারেকশন মুছে ফেলা হয়েছে
        function updateReportContent() {
             const filteredItems = getFilteredItems(); 
             renderSummaryBlock(filteredItems);
             const hide = (el) => el.style.display = 'none'; const show = (el) => el.style.display = 'block';
             // HTML-এ বিদ্যমান নয় এমন DOM এলিমেন্টের স্টাইল আপডেট করার চেষ্টা মুছে ফেলা হয়েছে
             [noMonthlyData, noAnnualData, noTopSpendingData, noPriorityData, noBoughtItemsData, noUnboughtItemsData].forEach(hide);

             renderMonthlySpending(filteredItems); 
             renderAnnualSpending(filteredItems); 
             renderPriorityItemsReport(reportPriorityFilter.value, filteredItems); 
             renderTopSpendingItems(filteredItems); 
             renderAllBoughtItems(filteredItems); 
             renderAllUnboughtItems(filteredItems);
             
             if (filteredItems.length === 0) { 
                 [noMonthlyData, noAnnualData, noTopSpendingData, noPriorityData, noBoughtItemsData, noUnboughtItemsData].forEach(show); 
             }
             // তারিখ ফিল্টার রেজাল্ট লুকানো
             document.getElementById('dateFilterResults').style.display = 'none';
        }
        
        // **সংশোধিত**: মাসিক খরচ (Monthly Spending) - তারিখ অনুযায়ী সাজানো এবং Sticky Footer যুক্ত করা
        function renderMonthlySpending(items) {
            reportMonthlySpendingDiv.innerHTML = ''; 
            const monthlySpending = {};
            let overallTotal = 0; // সামগ্রিক মোট মূল্য

            items.filter(item => item.bought && item.addedDate).forEach(item => {
                const date = new Date(item.addedDate);
                const monthYearKey = `${getBengaliMonthName(date.getMonth())}, ${toBengaliNumber(String(date.getFullYear()))} ইং`;
                if (!monthlySpending[monthYearKey]) monthlySpending[monthYearKey] = { total: 0, items: [] };
                
                const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                monthlySpending[monthYearKey].total += itemTotal;
                monthlySpending[monthYearKey].items.push(item);
                overallTotal += itemTotal;
            });
            
            const sortedKeys = Object.keys(monthlySpending).sort(sortMonthlyKeys);

            if (sortedKeys.length > 0) { 
                const ul = document.createElement('ul');
                sortedKeys.forEach(monthYear => {
                    const monthData = monthlySpending[monthYear];
                    const li = document.createElement('li'); 
                    li.innerHTML = `<span>${monthYear} (মোট: ${toBengaliNumber(String(monthData.items.length))}টি):</span> <span class="report-amount">${formatCurrency(monthData.total)}</span>`; 
                    ul.appendChild(li);
                }); 
                reportMonthlySpendingDiv.appendChild(ul); 
                noMonthlyData.style.display = 'none';
                
                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট মাসিক খরচ:</span>
                    <span style="color: var(--income-color) !important;">${formatCurrency(overallTotal)}</span>
                `;
                reportMonthlySpendingDiv.appendChild(stickyFooter);
                
            } else { 
                noMonthlyData.style.display = 'block'; 
            }
        }
        
        // **সংশোধিত**: বাৎসরিক খরচ (Annual Spending) - তারিখ অনুযায়ী সাজানো এবং Sticky Footer যুক্ত করা
        function renderAnnualSpending(items) {
            reportAnnualSpendingDiv.innerHTML = ''; 
            const annualSpending = {};
            let overallTotal = 0;

            items.filter(item => item.bought && item.addedDate).forEach(item => {
                const date = new Date(item.addedDate); 
                const yearKey = `${toBengaliNumber(String(date.getFullYear()))} ইং`;
                if (!annualSpending[yearKey]) annualSpending[yearKey] = { total: 0, items: [] };
                
                const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                annualSpending[yearKey].total += itemTotal;
                annualSpending[yearKey].items.push(item);
                overallTotal += itemTotal;
            });
            
            // বছর অনুযায়ী সাজানো (সাম্প্রতিক থেকে পুরনো)
            const sortedYears = Object.keys(annualSpending).sort((a, b) => {
                 return parseInt(fromBengaliNumber(b.split(' ')[0])) - parseInt(fromBengaliNumber(a.split(' ')[0]));
            });

            if (sortedYears.length > 0) { 
                const ul = document.createElement('ul');
                sortedYears.forEach(year => {
                    const yearData = annualSpending[year];
                    const li = document.createElement('li'); 
                    li.innerHTML = `<span>${year} (মোট: ${toBengaliNumber(String(yearData.items.length))}টি):</span> <span class="report-amount">${formatCurrency(yearData.total)}</span>`; 
                    ul.appendChild(li);
                }); 
                reportAnnualSpendingDiv.appendChild(ul); 
                noAnnualData.style.display = 'none';
                
                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট বাৎসরিক খরচ:</span>
                    <span style="color: var(--income-color) !important;">${formatCurrency(overallTotal)}</span>
                `;
                reportAnnualSpendingDiv.appendChild(stickyFooter);

            } else { 
                noAnnualData.style.display = 'block'; 
            }
        }
        
        // **সংশোধিত**: গুরুত্ব অনুযায়ী পণ্যের তালিকা - মোট পরিমাণ দেখানো এবং Sticky Footer যুক্ত করা
        function renderPriorityItemsReport(selectedPriority, items) {
            reportPriorityItemsDiv.innerHTML = ''; 
            let total = 0;
            
            const priorityItems = items.filter(item => (item.priority || 'low') === selectedPriority);

            // গুরুত্ব অনুযায়ী সাজানো
            priorityItems.sort((a, b) => {
                 const dateA = new Date(a.addedDate);
                 const dateB = new Date(b.addedDate);
                 return dateB - dateA; // সাম্প্রতিক থেকে পুরনো
            });


            if (priorityItems.length > 0) { 
                const ul = document.createElement('ul');
                priorityItems.forEach(item => {
                    const li = document.createElement('li'); 
                    const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                    const status = item.bought ? ' (কেনা হয়েছে)' : ' (কেনা হয়নি)';
                    
                    li.innerHTML = `<span>${item.name} (${formatCurrency(item.price || 0)}/ইউনিট${status}) - ${item.listName}:</span> <span class="report-amount">${formatCurrency(itemTotal)}</span>`; // UPDATED: Removed quantity
                    ul.appendChild(li); 
                    total += itemTotal;
                });
                
                reportPriorityItemsDiv.appendChild(ul); 
                noPriorityData.style.display = 'none';
                
                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট পণ্যের মূল্য:</span>
                    <span style="color: var(--primary-color) !important;">${formatCurrency(total)}</span>
                `;
                reportPriorityItemsDiv.appendChild(stickyFooter);

            } else { 
                noPriorityData.style.display = 'block'; 
            }
        }
        
        // **সংশোধিত**: সর্বোচ্চ খরচের পণ্য - মোট পরিমাণ অনুযায়ী সাজানো এবং Sticky Footer যুক্ত করা
        function renderTopSpendingItems(items) {
            reportTopSpendingItemsDiv.innerHTML = '';

            // প্রতিটি আইটেমের জন্য মোট মূল্য গণনা করে সে অনুযায়ী সাজানো হচ্ছে
            const sortedIndividualItems = items
                .map(item => ({
                    ...item,
                    totalPrice: item.price || 0 // UPDATED: Use item.price directly
                }))
                .sort((a, b) => b.totalPrice - a.totalPrice) // সর্বোচ্চ খরচ অনুযায়ী সাজানো
                .slice(0, 10); // সেরা ১০টি আইটেম নেওয়া

            if (sortedIndividualItems.length > 0) {
                const ul = document.createElement('ul');
                let overallTotal = 0;

                sortedIndividualItems.forEach(item => {
                    const li = document.createElement('li');
                    const itemTotal = item.totalPrice;
                    const status = item.bought ? ' (কেনা হয়েছে)' : ' (কেনা হয়নি)';
                    
                    li.innerHTML = `<span>${item.name} (${formatCurrency(item.price || 0)}/ইউনিট${status}) - ${item.listName}:</span> <span class="report-amount">${formatCurrency(itemTotal)}</span>`; // UPDATED: Removed quantity
                    ul.appendChild(li);
                    overallTotal += itemTotal;
                });
                
                reportTopSpendingItemsDiv.appendChild(ul);
                noTopSpendingData.style.display = 'none';
                
                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট পণ্যের মূল্য:</span>
                    <span style="color: var(--primary-color) !important;">${formatCurrency(overallTotal)}</span>
                `;
                reportTopSpendingItemsDiv.appendChild(stickyFooter);


            } else {
                noTopSpendingData.style.display = 'block';
            }
        }
        
        // **সংশোধিত**: সকল কেনা পণ্যের তালিকা - মোট মূল্য দেখানো এবং Sticky Footer যুক্ত করা
        function renderAllBoughtItems(items) {
            reportAllBoughtItemsDiv.innerHTML = ''; 
            let total = 0; 
            const boughtItems = items.filter(item => item.bought);

            boughtItems.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate)); // সাম্প্রতিক থেকে পুরনো


            if (boughtItems.length > 0) { 
                const ul = document.createElement('ul');
                boughtItems.forEach(item => {
                    const li = document.createElement('li'); 
                    const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                    li.innerHTML = `<span>${item.name} (${formatCurrency(item.price || 0)}/ইউনিট) - ${item.listName}:</span> <span class="report-amount">${formatCurrency(itemTotal)}</span>`; // UPDATED: Removed quantity
                    ul.appendChild(li); 
                    total += itemTotal;
                });
                
                reportAllBoughtItemsDiv.appendChild(ul); 
                noBoughtItemsData.style.display = 'none';
                
                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট পণ্যের মূল্য:</span>
                    <span style="color: var(--income-color) !important;">${formatCurrency(total)}</span>
                `;
                reportAllBoughtItemsDiv.appendChild(stickyFooter);


            } else { 
                noBoughtItemsData.style.display = 'block'; 
            }
        }
        
        // **সংশোধিত**: সকল কেনা হয়নি পণ্যের তালিকা - মোট মূল্য দেখানো এবং Sticky Footer যুক্ত করা
        function renderAllUnboughtItems(items) {
            reportAllUnboughtItemsDiv.innerHTML = ''; 
            let total = 0; 
            const unboughtItems = items.filter(item => !item.bought);
            
            unboughtItems.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate)); // সাম্প্রতিক থেকে পুরনো

            if (unboughtItems.length > 0) { 
                const ul = document.createElement('ul');
                unboughtItems.forEach(item => {
                    const li = document.createElement('li'); 
                    const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                    li.innerHTML = `<span>${item.name} (${formatCurrency(item.price || 0)}/ইউনিট) - ${item.listName}:</span> <span class="report-amount">${formatCurrency(itemTotal)}</span>`; // UPDATED: Removed quantity
                    ul.appendChild(li); 
                    total += itemTotal;
                });
                
                reportAllUnboughtItemsDiv.appendChild(ul); 
                noUnboughtItemsData.style.display = 'none';

                // Sticky Footer যোগ করা
                const stickyFooter = document.createElement('div');
                stickyFooter.className = 'sticky-total-wrapper';
                stickyFooter.innerHTML = `
                    <span>মোট পণ্যের মূল্য:</span>
                    <span style="color: var(--expense-color) !important;">${formatCurrency(total)}</span>
                `;
                reportAllUnboughtItemsDiv.appendChild(stickyFooter);

            } else { 
                noUnboughtItemsData.style.display = 'block'; 
            }
        }
        
        // **সংশোধিত**: তারিখ পরিসীমা অনুযায়ী রিপোর্ট - ভ্যালিডেশন এবং সাজানো
        function applyDateFilter() {
             const startDateStr = reportStartDateInput.value, endDateStr = reportEndDateInput.value;
             // এরর ক্লিয়ার করা
             [reportStartDateInput, reportEndDateInput].forEach(clearFormError);

             if (!startDateStr || !endDateStr) { customAlert("অনুগ্রহ করে শুরুর এবং শেষের উভয় তারিখ নির্বাচন করুন।"); return; }
             
             const start = new Date(startDateStr); start.setHours(0, 0, 0, 0); 
             const end = new Date(endDateStr); end.setHours(23, 59, 59, 999);
             
             if (start > end) {
                  showFormError(reportStartDateInput, "তারিখ সঠিক নয়");
                  showFormError(reportEndDateInput, "শুরুর তারিখ শেষের পরে");
                  customAlert("শুরুর তারিখ শেষের তারিখের পরে হতে পারে না।", "তারিখ ত্রুটি");
                  return;
             }
             
             const filteredByList = getFilteredItems();
             const dateFilteredItems = filteredByList.filter(item => { 
                 const itemDate = item.addedDate ? new Date(item.addedDate) : null; 
                 return itemDate && itemDate >= start && itemDate <= end; 
             });
             
             let total = 0, boughtTotal = 0, unboughtTotal = 0;
             dateFilteredItems.forEach(item => { 
                 const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                 total += itemTotal; 
                 if (item.bought) boughtTotal += itemTotal; else unboughtTotal += itemTotal; 
             });
             
             dateFilterTotalAmount.textContent = formatCurrency(total);
             dateFilterBoughtTotal.textContent = formatCurrency(boughtTotal);
             dateFilterUnboughtTotal.textContent = formatCurrency(unboughtTotal);
             displayDateRange.innerHTML = `তারিখ: <br>${formatLongDateForDisplay(start)} থেকে ${formatLongDateForDisplay(end)} পর্যন্ত`;
             
             renderDateFilterItems(dateFilteredItems); 
             dateFilterResults.style.display = 'block';
        }
        
        // **সংশোধিত**: তারিখ পরিসীমা আইটেম রেন্ডার
        function renderDateFilterItems(items) {
             const container = document.getElementById('dateFilterItemsList'); 
             const noDataMsg = document.getElementById('noDateFilterItemsData'); 
             container.innerHTML = '';
             
             items.sort((a, b) => new Date(b.addedDate) - new Date(a.addedDate)); // সাম্প্রতিক থেকে পুরনো
             
             if (items.length > 0) { 
                const ul = document.createElement('ul');
                items.forEach(item => {
                    const li = document.createElement('li'); 
                    const itemTotal = item.price || 0; // UPDATED: Use item.price directly
                    const status = item.bought ? '(কেনা হয়েছে)' : '(কেনা হয়নি)'; 
                    const itemDate = new Date(item.addedDate);
                    const formattedDate = `${toBengaliNumber(String(itemDate.getDate()))}/${toBengaliNumber(String(itemDate.getMonth() + 1))}/${toBengaliNumber(String(itemDate.getFullYear()))}`;
                    li.innerHTML = `<span>${item.name} (${formattedDate}) ${status} - ${item.listName}</span> <span class="report-amount">${formatCurrency(itemTotal)}</span>`; // UPDATED: Removed quantity
                    ul.appendChild(li);
                }); 
                container.appendChild(ul); 
                noDataMsg.style.display = 'none';
             } else { 
                 noDataMsg.style.display = 'block'; 
             }
        }

        // --- Welcome & Monthly Modals (UNTOUCHED) ---
        function closeMonthlySpendingModal() { 
            monthlySpendingModal.classList.remove('active'); 
            document.body.style.overflow = ''; 
        }
        
        // --- Pagination / Lazy Loading (UNTOUCHED) ---
        function setupPaginationObservers() {
            const options = { root: null, rootMargin: '0px', threshold: 0.1 };

            shoppingListObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    renderNextShoppingListPage();
                }
            }, options);

            customerListObserver = new IntersectionObserver((entries) => {
                if (entries[0].isIntersecting) {
                    renderNextCustomerListPage();
                }
            }, options);
        }
        
        // --- Event Listener Setup (MODIFIED with Event Delegation) ---
function setupEventListeners() {

    // Auth Buttons
    signInBtn.addEventListener('click', signInWithGoogle);
    signOutBtn.addEventListener('click', signOutWithConfirmation);
    document.getElementById('changeNameBtn').addEventListener('click', showChangeNamePage);
    
    // New Change Name Page Listeners
    document.getElementById('backFromChangeNamePage').addEventListener('click', () => history.back());
    document.getElementById('cancelChangeNamePageBtn').addEventListener('click', () => history.back());
    saveChangedNamePageBtn.addEventListener('click', handleSaveChangedNamePage);
    
    document.getElementById('changePasswordBtn').addEventListener('click', handleChangePassword);
    
    loginForm.addEventListener('submit', handleLogin);
    registerForm.addEventListener('submit', handleRegistration);
    showRegisterFormLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleForms('register');
    });
    showLoginFormLink.addEventListener('click', (e) => {
        e.preventDefault();
        toggleForms('login');
    });
    forgotPasswordLink.addEventListener('click', handlePasswordReset);

    // View Switcher
    showShoppingListBtn.addEventListener('click', () => switchView('shoppingList'));
    showLedgerBtn.addEventListener('click', () => switchView('ledger'));

    // Header controls
    infoButton.addEventListener('click', openInfoModal);
    darkModeToggle.addEventListener('click', toggleDarkMode);
    decreaseFontButton.addEventListener('click', () => applyFontSize(Math.max(13, currentFontSize - 1)));
    resetFontButton.addEventListener('click', () => applyFontSize(defaultFontSize));
    increaseFontButton.addEventListener('click', () => applyFontSize(Math.min(25, currentFontSize + 1)));
    
    profileBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        profileMenu.style.display = profileMenu.style.display === 'block' ? 'none' : 'block';
    });

    // List management controls
    document.getElementById('addNewListBtn').addEventListener('click', addNewList);
    document.getElementById('renameListBtn').addEventListener('click', renameList);
    document.getElementById('deleteCurrentListBtn').addEventListener('click', deleteCurrentList);
    currentListSelector.addEventListener('change', (e) => switchList(e.target.value));

    // Item input controls
    document.getElementById('addItemBtn').addEventListener('click', addItem);
    itemNameInput.addEventListener('keydown', (e) => { 
        if (e.key === 'Enter' && autocompleteSuggestions.style.display === 'none') {
            e.preventDefault();
            addItem(); 
        }
    });
    shoppingListSearchInput.addEventListener('input', renderList);

    // --- START: Shopping List Event Delegation (PERFORMANCE FIX) ---
    // একটি মাত্র লিসেনার পুরো তালিকার সব ক্লিক হ্যান্ডেল করবে
    const shoppingListContainer = document.getElementById('shoppingList');
    
    shoppingListContainer.addEventListener('click', (e) => {
        const itemElement = e.target.closest('.list-item');
        if (!itemElement) return;

        const index = parseInt(itemElement.dataset.id);

        // ১. টগল কেনা/কেনা হয়নি
        if (e.target.closest('.toggle-bought-btn')) {
            e.stopPropagation();
            toggleBought(index);
            return;
        }

        // ২. এডিট বাটন
        if (e.target.closest('.edit-btn-expanded')) {
            e.stopPropagation();
            itemElement.classList.remove('expanded');
            expandedItemIndex = -1;
            openEditItemModal(index);
            return;
        }

        // ৩. ডিলিট বাটন
        if (e.target.closest('.delete-btn-expanded')) {
            e.stopPropagation();
            deleteItem(index);
            return;
        }
        
        // ৪. এক্সপান্ড/কলাপস (যদি অন্য কোনো বাটনে ক্লিক না হয়ে থাকে)
        if (!e.target.closest('button') && !e.target.closest('.item-actions-expanded') && !e.target.closest('.item-time-date')) {
            if (itemElement.classList.contains('expanded')) {
                itemElement.classList.remove('expanded');
                expandedItemIndex = -1;
            } else {
                const currentlyExpanded = shoppingListContainer.querySelector('.list-item.expanded');
                if (currentlyExpanded) {
                    currentlyExpanded.classList.remove('expanded');
                }
                itemElement.classList.add('expanded');
                expandedItemIndex = index;
            }
        }
    });
    // --- END: Event Delegation ---

    // Ledger management controls
    document.getElementById('addNewLedgerBtn').addEventListener('click', addNewLedger);
    document.getElementById('renameLedgerBtn').addEventListener('click', renameLedger);
    document.getElementById('deleteCurrentLedgerBtn').addEventListener('click', deleteCurrentLedger);
    currentLedgerSelector.addEventListener('change', (e) => switchLedger(e.target.value));
    
    // NEW Ledger Event Listeners
    fabAddCustomerBtn.addEventListener('click', openAddCustomerModal);
    backToLedgerMainBtn.addEventListener('click', () => history.back());
    confirmTransactionBtn.addEventListener('click', addTransactionToCustomer);
    customerSearchInput.addEventListener('input', renderLedgerMainView);
    
    gaveAmountInput.addEventListener('input', () => { 
        if(gaveAmountInput.value) receivedAmountInput.value = '';
        updateConfirmButtonState();
    });
    receivedAmountInput.addEventListener('input', () => { 
        if(receivedAmountInput.value) gaveAmountInput.value = '';
        updateConfirmButtonState();
    });
    
    transactionDateInput.addEventListener('change', () => {
        const date = transactionDateInput.valueAsDate || new Date();
        transactionDateLabel.textContent = formatShortDateForDisplay(date);
    });
    
    const transactionDateLabelBtn = document.getElementById('transactionDateLabelBtn');
    transactionDateLabelBtn.addEventListener('click', (e) => {
        e.preventDefault(); 
        try {
            transactionDateInput.showPicker();
        } catch (error) {
            console.error("showPicker error:", error);
            transactionDateInput.click();
        }
    });

    // Bottom Nav Listeners for Shopping List
    document.getElementById('navHomeBtn').addEventListener('click', (e) => {
        handleNavClick(shoppingListBottomMenu, e.currentTarget);
        hideReportPage();
        renderList();
    });
    document.getElementById('navShareBtn').addEventListener('click', (e) => {
        openShareModal();
    });
    document.getElementById('navReportBtn').addEventListener('click', (e) => {
        handleNavClick(shoppingListBottomMenu, e.currentTarget);
        showReportPage();
    });
    document.getElementById('navPdfBtn').addEventListener('click', (e) => {
        handleNavClick(shoppingListBottomMenu, e.currentTarget);
        downloadPdf();
    });
    
    // Bottom Nav Listeners for Ledger
    document.getElementById('navLedgerHomeBtn').addEventListener('click', () => {
        currentLedgerTab = 'main';
        renderLedgerTabView();
    });
    document.getElementById('navLedgerShareBtn').addEventListener('click', () => {
        openShareModal();
    });
    document.getElementById('navLedgerReceivableBtn').addEventListener('click', () => {
        currentLedgerTab = 'receivable';
        history.pushState({ view: 'receivable' }, '', location.href);
        renderLedgerTabView();
    });
    document.getElementById('navLedgerPayableBtn').addEventListener('click', () => {
        currentLedgerTab = 'payable';
        history.pushState({ view: 'payable' }, '', location.href);
        renderLedgerTabView();
    });
    
    // New Page Listeners
    document.getElementById('backFromChangePasswordPage').addEventListener('click', () => history.back());
    document.getElementById('cancelChangePasswordBtn').addEventListener('click', () => history.back());
    saveNewPasswordBtn.addEventListener('click', saveNewPassword);
    
    document.getElementById('cancelResetPasswordBtn').addEventListener('click', () => history.back());
    resetPasswordSubmitBtn.addEventListener('click', handleResetPasswordSubmit);

    // Modal & Page close buttons
    document.getElementById('closeInfoModalBtn').addEventListener('click', () => history.back());
    document.getElementById('closeShareModalBtn').addEventListener('click', () => history.back());
    backFromReportBtn.addEventListener('click', () => history.back());
    backFromCustomerReportBtn.addEventListener('click', () => history.back());
    document.getElementById('closeAlertModalBtn').addEventListener('click', () => history.back());
    document.getElementById('alertOkBtn').addEventListener('click', () => history.back());
    document.getElementById('closeConfirmationModalBtn').addEventListener('click', () => { handleConfirm(false); });
    document.getElementById('closePromptModalBtn').addEventListener('click', () => history.back());
    document.getElementById('closeEditModalBtn').addEventListener('click', () => history.back());
    document.getElementById('closeMonthlyModalBtn').addEventListener('click', closeMonthlySpendingModal);
    document.getElementById('closeMonthlyModalBtn2').addEventListener('click', closeMonthlySpendingModal);
    document.getElementById('closeAddCustomerModalBtn').addEventListener('click', () => history.back());
    document.getElementById('closeTxConfirmModalBtn').addEventListener('click', () => { closeTxConfirmModal(); history.pushState({ view: 'home' }, '', location.href); });
    
    transactionDetailModal.querySelector('.custom-modal-close').addEventListener('click', () => history.back());
    editTransactionModal.querySelector('.custom-modal-close').addEventListener('click', () => history.back());
    editTransactionModal.querySelector('.cancel-btn').addEventListener('click', () => history.back());
    document.getElementById('saveEditedTransactionBtn').addEventListener('click', saveEditedTransaction);
    
    editCustomerModal.querySelector('.custom-modal-close').addEventListener('click', () => history.back());
    editCustomerModal.querySelector('.cancel-btn').addEventListener('click', () => history.back());
    document.getElementById('saveEditedCustomerBtn').addEventListener('click', saveEditedCustomer);


    // Modal action buttons
    document.getElementById('copyShareTextBtn').addEventListener('click', copyShareableText);
    document.getElementById('shareViaApiBtn').addEventListener('click', shareViaWebAPI);
    confirmButton.addEventListener('click', () => { handleConfirm(true); });
    cancelButton.addEventListener('click', () => { handleConfirm(false); });
    
    editItemSaveButton.addEventListener('click', () => { saveEditedItem(); history.back(); });
    editItemCancelButton.addEventListener('click', () => history.back());
    
    document.getElementById('addCustomerConfirmBtn').addEventListener('click', () => { addCustomer(); history.back(); });
    document.getElementById('addCustomerCancelBtn').addEventListener('click', () => history.back());
    document.getElementById('monthlyToFullReportBtn').addEventListener('click', openReportModalFromMonthly);
    
    // Phone validation listeners
    setupPhoneValidation(document.getElementById('customerPhoneInput'), document.getElementById('addCustomerConfirmBtn'));
    setupPhoneValidation(document.getElementById('editCustomerPhoneInput'), document.getElementById('saveEditedCustomerBtn'));
    
    // Report filters
    reportListFilter.addEventListener('change', updateReportContent);
    reportPriorityFilter.addEventListener('change', () => renderPriorityItemsReport(reportPriorityFilter.value, getFilteredItems()));
    applyDateFilterButton.addEventListener('click', applyDateFilter);
    
    document.addEventListener('click', (e) => {
        const activeModal = document.querySelector('.custom-modal.active, .modal-overlay.active');
        if (activeModal && (e.target.classList.contains('modal-overlay') || e.target.classList.contains('custom-modal'))) {
            history.back();
        }
        if (profileMenu && !profileBtn.contains(e.target) && !profileMenu.contains(e.target)) {
            profileMenu.style.display = 'none';
        }
        if (customerOptionsBtn && customerOptionsMenu && !customerOptionsBtn.contains(e.target) && !customerOptionsMenu.contains(e.target)) {
            customerOptionsMenu.style.display = 'none';
        }
    });
    document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
            const activeModal = document.querySelector('.modal-overlay.active, .custom-modal.active');
            if (activeModal) {
                    history.back();
            }
            if(profileMenu && profileMenu.style.display === 'block') {
                profileMenu.style.display = 'none';
            }
            if(customerOptionsMenu && customerOptionsMenu.style.display === 'block') {
                customerOptionsMenu.style.display = 'none';
            }
            }
    });

    // Customer Options Menu Logic
    customerOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        customerOptionsMenu.style.display = customerOptionsMenu.style.display === 'block' ? 'none' : 'block';
    });
    document.getElementById('customerReportBtn').addEventListener('click', () => {
        showCustomerReportPage(currentCustomerId);
        customerOptionsMenu.style.display = 'none';
    });
        document.getElementById('customerEditBtn').addEventListener('click', () => {
        editCustomer(currentCustomerId);
        customerOptionsMenu.style.display = 'none';
    });
        document.getElementById('customerDeleteBtn').addEventListener('click', () => {
        deleteCustomer(currentCustomerId);
        customerOptionsMenu.style.display = 'none';
    });
    
    document.getElementById('changeEmailBtn').addEventListener('click', showChangeEmailPage);

    backFromChangeEmailPage.addEventListener('click', () => history.back()); 
    cancelChangeEmailPageBtn.addEventListener('click', () => history.back()); 
    saveNewEmailBtn.addEventListener('click', saveNewEmail); 
    
    // --- START: Swipe Gesture Listeners (Fixed for Edge Cases) ---
    mainContainer.addEventListener('touchstart', (e) => {
        // ইনপুট ফিল্ডে টাচ করলে সোয়াইপ হবে না
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
            touchstartX = null;
            return;
        }
        
        const touchX = e.changedTouches[0].screenX;
        
        // Edge Detection (কিনারা সনাক্তকরণ):
        // যদি বাম পাশ থেকে ২০ পিক্সেল বা ডান পাশ থেকে ২০ পিক্সেলের মধ্যে সোয়াইপ শুরু হয়,
        // তবে আমাদের কোড কাজ করবে না। এটি আইফোনের 'Back' জেশ্চারকে সম্মান জানাবে।
        if (touchX < 20 || touchX > window.innerWidth - 20) {
            touchstartX = null;
            return;
        }

        touchstartX = touchX;
        touchstartY = e.changedTouches[0].screenY;
    }, { passive: true }); // 'passive: true' পারফরম্যান্স বাড়ায়

    mainContainer.addEventListener('touchend', (e) => {
        if (touchstartX === null) return;
        if (draggedItem) return; 
        if (customCalculator.classList.contains('show')) return;
        
        touchendX = e.changedTouches[0].screenX;
        touchendY = e.changedTouches[0].screenY;
        handleSwipeGesture();
        touchstartX = null; 
    }, { passive: true });
    // --- END: Swipe Gesture Listeners ---
    
    window.handleUserAction = handleUserAction;
    
    window.addEventListener('popstate', handleBackButton);

    setupPasswordToggle(loginView);
    setupPasswordToggle(changePasswordPage);
    setupPasswordToggle(changeEmailPage);
    
    // Menu Toggle Logic
    const shoppingListMenuBtn = document.getElementById('shoppingListMenuBtn');
    if (shoppingListMenuBtn) {
        shoppingListMenuBtn.onclick = (e) => {
            e.stopPropagation();
            const menu = document.getElementById('shoppingListMenu');
            document.getElementById('ledgerMenu')?.classList.remove('show');
            menu.classList.toggle('show');
        };
    }

    const ledgerMenuBtn = document.getElementById('ledgerMenuBtn');
    if (ledgerMenuBtn) {
        ledgerMenuBtn.onclick = (e) => {
            e.stopPropagation();
            const menu = document.getElementById('ledgerMenu');
            document.getElementById('shoppingListMenu')?.classList.remove('show');
            menu.classList.toggle('show');
        };
    }

    document.onclick = (e) => {
        const sMenu = document.getElementById('shoppingListMenu');
        const lMenu = document.getElementById('ledgerMenu');
        
        if (sMenu && sMenu.classList.contains('show') && !sMenu.contains(e.target) && e.target.id !== 'shoppingListMenuBtn') {
            sMenu.classList.remove('show');
        }
        if (lMenu && lMenu.classList.contains('show') && !lMenu.contains(e.target) && e.target.id !== 'ledgerMenuBtn') {
            lMenu.classList.remove('show');
        }
    };
}

        function setupPhoneValidation(phoneInput, submitButton) {
            const phoneWrapper = phoneInput.closest('.phone-input-wrapper');
            phoneInput.addEventListener('input', () => {
                const phone = phoneInput.value.trim();
                // এরর ক্লিয়ার
                clearFormError(phoneInput);
                
                if (phone.length > 0 && (phone.length !== 11 || !/^\d{11}$/.test(phone))) {
                    phoneWrapper.classList.add('input-invalid');
                    submitButton.disabled = true;
                    showFormError(phoneInput, 'নম্বরটি সঠিক নয়'); // এরর মেসেজ দেখানো
                } else {
                    phoneWrapper.classList.remove('input-invalid');
                    submitButton.disabled = false;
                }
            });
        }
        
        async function handleBackButton(event) {
    
    // --- START: ক্যালকুলেটরের জন্য ---
    if (customCalculator.classList.contains('show')) {
        hideCalculator();
        return; 
    }
    // --- END: ক্যালকুলেটরের জন্য ---
    
    // START: মডাল ও পেজ চেক
    const activeModal = document.querySelector('.custom-modal.active, .modal-overlay.active');
    
    if (activeModal) {
        // মডাল হলে, তাকে বন্ধ করে দাও।
        activeModal.classList.remove('active');
        document.body.style.overflow = '';
        return;
    }
    
    if (changeNamePage.style.display === 'flex') {
        hideChangeNamePage();
        return;
    }
    if (changePasswordPage.style.display === 'flex') {
        hideChangePasswordPage();
        return;
    }
    if (changeEmailPage.style.display === 'flex') { 
        hideChangeEmailPage();
        return; 
    }
    if (resetPasswordPage.style.display === 'flex') {
        hideResetPasswordPage();
        return;
    }
    if (reportPage.style.display === 'flex') {
        hideReportPage();
        return;
    }
    if (customerReportPage.style.display === 'flex') {
        hideCustomerReportPage();
        return;
    }
    // END: মডাল ও পেজ চেক
            
    // ✅ ফিক্স ২: Ledger Tab Flow (নেভিগেশন ফিক্স)
    if (currentView === 'ledger') {
        if (currentLedgerView === 'customer') {
            
            // কোথায় ফিরতে হবে তা history.state থেকে চেক করা
            const previousState = history.state;
            if (previousState && (previousState.view === 'receivable' || previousState.view === 'payable')) {
                currentLedgerTab = previousState.view;
                renderLedgerTabView();
            } else {
                showMainLedgerView(); // মূল তালিকায় ফিরবে
            }
            return;
        }
        if (currentLedgerTab === 'receivable' || currentLedgerTab === 'payable') {
            currentLedgerTab = 'main';
            renderLedgerTabView();
            return;
        }
    }
    
    // Exit Prompt Logic (Only for 'home' view)
    backPressCount++;
    if (backPressCount === 1) {
        showToast('বের হতে আবার ব্যাক বাটন চাপুন।', { duration: 2000 });
        backPressTimeout = setTimeout(() => {
            backPressCount = 0;
        }, 2000);
        history.pushState({ view: 'home-exit-prompt' }, '', location.href);
        return;
    } else if (backPressCount >= 2) {
         clearTimeout(backPressTimeout);
         const wantsToExit = await customConfirm("আপনি কি অ্যাপ থেকে বের হতে চাচ্ছেন?");
         if (wantsToExit) {
             window.close();
         } else {
             backPressCount = 0;
             history.replaceState({ view: 'home' }, '', location.href); 
         }
         return;
    }
}


        // NEW: Customer options functions (UNTOUCHED)
function showCustomerReportPage(customerId) {
    const customer = findCustomerById(customerId);
    if (!customer) return;

    // UI সেটআপ
    mainContainer.style.display = 'none';
    reportPage.style.display = 'none';
    changeNamePage.style.display = 'none';
    changePasswordPage.style.display = 'none';
    changeEmailPage.style.display = 'none';
    customerReportPage.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    history.pushState({ view: 'customer-report' }, '', location.href);

    customerReportPageName.textContent = `${customer.name}-এর রিপোর্ট`;

    // টেবিল তৈরি
    const { tableElement, totalGave, totalReceived, allTransactions } = generateCustomerTransactionTable(customer, true);

    customerReportPageContent.innerHTML = '';
    customerReportPageContent.appendChild(tableElement);

    // ফুটার (মোট হিসাব)
    customerReportPageFooterContainer.innerHTML = '';
    if (allTransactions.length > 0) {
        const footer = document.createElement('div');
        footer.className = 'tx-table-footer';
        footer.style.fontWeight = 'bold';

        footer.innerHTML = `
            <div class="tx-col tx-col-details">মোট</div>
            <div class="tx-col tx-col-gave">${formatCurrency(totalGave, false)}</div>
            <div class="tx-col tx-col-received">${formatCurrency(totalReceived, false)}</div>
        `;
        customerReportPageFooterContainer.appendChild(footer);
    }

    // লেনদেনের ডিটেইলস দেখার জন্য ক্লিক লিসেনার
    customerReportPageContent.onclick = function(e) {
        const row = e.target.closest('.tx-table-row');
        if (row && row.dataset.txId) {
            showTransactionDetailModal(customerId, row.dataset.txId);
        }
    };

    // পিডিএফ বাটন
    customerReportPdfBtn.onclick = () => downloadCustomerReportPdf(customerId);

    // শেয়ার টেক্সট তৈরি
    const shareText = generateCustomerReportShareText(customer);

    // --- শেয়ার বাটন লজিক (সংশোধিত: ব্যাক বাটন ফিক্স সহ) ---
    customerReportShareBtn.onclick = () => {
        const subject = `রিপোর্ট - ${customer.name}`;

        // ১. ওয়েব শেয়ার API চেষ্টা করা
        if (navigator.share) {
            navigator.share({ title: subject, text: shareText, url: 'https://www.talika.xyz/' })
                .catch(err => {
                    // *** ফিক্স: ইউজার ক্যান্সেল করলে বা ব্যাক করলে চুপচাপ রিটার্ন করবে ***
                    if (err.name === 'AbortError') {
                        return; 
                    }

                    // অন্য কোনো সমস্যা হলে Android Native Share চেষ্টা করা
                    if (typeof Android !== 'undefined' && Android.startNativeShare) {
                        Android.startNativeShare(subject, shareText);
                    } else {
                        // সব ব্যর্থ হলে কপি করা
                        copyTextToClipboard(shareText);
                        customAlert('শেয়ার ব্যর্থ। তথ্যটি আপনার জন্য কপি করা হয়েছে।', 'শেয়ার করুন');
                    }
                });
        }
        // ২. যদি ব্রাউজার শেয়ার না থাকে কিন্তু অ্যাপের শেয়ার থাকে (WebView)
        else if (typeof Android !== 'undefined' && Android.startNativeShare) {
            Android.startNativeShare(subject, shareText);
        }
        // ৩. কোনোটিই না থাকলে কপি করা
        else {
            copyTextToClipboard(shareText);
            customAlert('শেয়ার ব্যর্থ। তথ্যটি আপনার জন্য কপি করা হয়েছে।', 'শেয়ার করুন');
        }
    };
    // --- শেয়ার লজিক শেষ ---

    // কপি বাটন
    customerReportCopyBtn.onclick = () => {
        copyTextToClipboard(shareText);
        showToast('রিপোর্টের তথ্য কপি করা হয়েছে!');
    };
}


        function hideCustomerReportPage() {
            mainContainer.style.display = 'block';
            customerReportPage.style.display = 'none';
            document.body.style.overflow = ''; 
        }

        function editCustomer(customerId) {
            history.pushState({ view: 'modal' }, '', location.href);
            const customer = findCustomerById(customerId);
            if (!customer) return;
            
            activeEditingCustomer = customer;
            
            const nameInput = document.getElementById('editCustomerNameInput');
            const phoneInput = document.getElementById('editCustomerPhoneInput');
            const saveButton = document.getElementById('saveEditedCustomerBtn');
            
            nameInput.value = customer.name;
            phoneInput.value = customer.phone || '';
            
            // এরর ক্লিয়ার করা হয়েছে
            [nameInput, phoneInput].forEach(clearFormError);

            phoneInput.closest('.phone-input-wrapper').classList.remove('input-invalid');
            saveButton.disabled = false;

            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            editCustomerModal.style.zIndex = zIndexCounter;
            editCustomerModal.classList.add('active');
            document.body.style.overflow = 'hidden';
            nameInput.focus();
        }

        async function saveEditedCustomer() {
    if (!activeEditingCustomer) return;
    
    const saveButton = document.getElementById('saveEditedCustomerBtn');
    // ১. লোডিং স্টেট সেট করা
    const originalText = setButtonLoading(saveButton, saveButton.textContent);

    try {
        const newName = document.getElementById('editCustomerNameInput').value.trim();
        const newPhone = document.getElementById('editCustomerPhoneInput').value.trim();

        if (!newName) { customAlert('গ্রাহকের নাম খালি রাখা যাবে না।'); return; }

        activeEditingCustomer.name = newName;
        activeEditingCustomer.phone = newPhone;
        
        // ২. ডেটাবেসে সেভ করা
        await updateFirestore({ ledgers });
        
        // ৩. সফলতার পর UI আপডেট করা
        history.back(); // Use history.back() for correct flow
        showToast('গ্রাহকের তথ্য আপডেট করা হয়েছে।', { duration: 2000 });
        
        if (currentLedgerView === 'customer' && currentCustomerId === activeEditingCustomer.id) {
            renderLedgerCustomerView();
        }
        prepareAndRenderLedger();
        activeEditingCustomer = null;
    } catch (error) {
        console.error("Edit Customer Error:", error);
        customAlert("গ্রাহকের তথ্য আপডেট করা যায়নি। আবার চেষ্টা করুন।");
    } finally {
        // ৪. বাটনকে স্বাভাবিক অবস্থায় ফিরিয়ে আনা
        resetButtonState(saveButton);
    }
}


        async function deleteCustomer(customerId) {
    const customer = findCustomerById(customerId);
    if (!customer) return;

    const confirmed = await customConfirm(`আপনি কি নিশ্চিত যে "${customer.name}"-কে এবং তার সমস্ত লেনদেন মুছে ফেলতে চান? মুছে ফেলার পর আর ফিরিয়ে আনা যাবে না।`);
    
    if (confirmed) {
        const customerIndex = ledgers[currentLedgerId].customers.findIndex(c => c.id === customerId);
        if (customerIndex > -1) {
            const deletedCustomerName = customer.name;
            ledgers[currentLedgerId].customers.splice(customerIndex, 1);
            
            // ✅ ফিক্স: updateFirestore ব্যবহার করা হচ্ছে, যা নির্ভরযোগ্য
            await updateFirestore({ ledgers });
            
            showToast(`"${deletedCustomerName}"-কে মুছে ফেলা হয়েছে।`, { duration: 2000 });
            
            // ✅ ফিক্স: মেইন ভিউতে ফিরে যাওয়া এবং রি-রেন্ডার
            showMainLedgerView();
            prepareAndRenderLedger();
        }
    }
}
        
        // FIXED: Receivable List View
function renderReceivableList() {
    let receivableCustomers = [];
    let totalReceivableAmount = 0;
    let title = '';

    if (currentLedgerId === 'all') {
        const allLedgerCustomers = getAllCustomersFromAllLedgers();
        receivableCustomers = allLedgerCustomers.filter(c => (c.currentBalance || 0) > 0);
        totalReceivableAmount = calculateGrandTotals().receivable;
        title = 'সকল খাতার যাদের থেকে পাবো';
    } else {
        const ledgerCustomers = ledgers[currentLedgerId]?.customers || [];
        receivableCustomers = ledgerCustomers.filter(c => (c.currentBalance || 0) > 0);
        totalReceivableAmount = calculateSingleLedgerTotals(currentLedgerId).receivable;
        title = `${ledgers[currentLedgerId].name}-যাদের থেকে পাবো`;
    }
    
    // ✅ ফিক্স ১: সর্টিং লজিক পরিবর্তন (সর্বশেষ আপডেট অনুযায়ী)
    receivableCustomers.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated)); 
    
    receivableListView.innerHTML = ''; 

    // --- মডার্ন হেডার তৈরি ---
    const headerDiv = document.createElement('div');
    headerDiv.className = 'filtered-ledger-header';
    headerDiv.innerHTML = `
        <h2>${title}</h2>
        <div class="filtered-ledger-summary">
            মোট গ্রাহক: <strong>${toBengaliNumber(String(receivableCustomers.length))}</strong> জন | <span>মোট পাবো: <strong class="total-receivable">${formatCurrency(totalReceivableAmount)}</strong></span>
        </div>
    `;
    receivableListView.appendChild(headerDiv);

    const scrollContainer = document.createElement('div');
    scrollContainer.className = 'customer-list-scroll-container';

    if (receivableCustomers.length > 0) {
        receivableCustomers.forEach(customer => {
            const ledgerIdForCustomer = customer.ledgerId || currentLedgerId;
            const itemDiv = createCustomerListItemElement(customer, ledgerIdForCustomer);
            scrollContainer.appendChild(itemDiv); 
        });
    } else {
        scrollContainer.innerHTML = `<p style="text-align:center; padding: 20px; color: #777;">এই মুহূর্তে কোনো টাকা প্রাপ্য নেই।</p>`;
    }
    
    receivableListView.appendChild(scrollContainer);
}

// ২. `renderPayableList` ফাংশনটি প্রতিস্থাপন করুন:
function renderPayableList() {
    let payableCustomers = [];
    let totalPayableAmount = 0;
    let title = '';

    if (currentLedgerId === 'all') {
        const allLedgerCustomers = getAllCustomersFromAllLedgers();
        payableCustomers = allLedgerCustomers.filter(c => (c.currentBalance || 0) < 0);
        totalPayableAmount = calculateGrandTotals().payable;
        title = 'সকল খাতার যাদেরকে দেবো';
    } else {
        const ledgerCustomers = ledgers[currentLedgerId]?.customers || [];
        payableCustomers = ledgerCustomers.filter(c => (c.currentBalance || 0) < 0);
        totalPayableAmount = calculateSingleLedgerTotals(currentLedgerId).payable;
        title = `${ledgers[currentLedgerId].name}-যাদেরকে দেবো`;
    }

    // ✅ ফিক্স ১: সর্টিং লজিক পরিবর্তন (সর্বশেষ আপডেট অনুযায়ী)
    payableCustomers.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));
    
    payableListView.innerHTML = ''; 

    // --- মডার্ন হেডার তৈরি ---
    const headerDiv = document.createElement('div');
    headerDiv.className = 'filtered-ledger-header';
    headerDiv.innerHTML = `
        <h2>${title}</h2>
        <div class="filtered-ledger-summary">
            মোট গ্রাহক: <strong>${toBengaliNumber(String(payableCustomers.length))}</strong> জন | <span>মোট দেবো: <strong class="total-payable">${formatCurrency(totalPayableAmount)}</strong></span>
        </div>
    `;
    payableListView.appendChild(headerDiv);

    const scrollContainer = document.createElement('div');
    scrollContainer.className = 'customer-list-scroll-container';

    if (payableCustomers.length > 0) {
        payableCustomers.forEach(customer => {
            const ledgerIdForCustomer = customer.ledgerId || currentLedgerId;
            const itemDiv = createCustomerListItemElement(customer, ledgerIdForCustomer);
            scrollContainer.appendChild(itemDiv); 
        });
    } else {
        scrollContainer.innerHTML = `<p style="text-align:center; padding: 20px; color: #777;">এই মুহূর্তে কোনো টাকা পরিশোধের বাকি নেই।</p>`;
    }
    
    payableListView.appendChild(scrollContainer);
}

        function generateCustomerTransactionTable(customer, clickable = false) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'customer-transaction-table';
            
            const allTransactions = [...(customer.transactions || [])];

            let totalGave = 0;
            let totalReceived = 0;

            if (allTransactions.length === 0) {
                tableContainer.innerHTML = `<p style="text-align:center; padding: 20px;">কোনো লেনদেন নেই।</p>`;
                return { tableElement: tableContainer, totalGave, totalReceived, allTransactions };
            }

            tableContainer.innerHTML = `
                <div class="tx-table-header">
                    <div class="tx-col tx-col-details">লেনদেনের বিবরণ</div>
                    <div class="tx-col tx-col-gave">দিলাম</div>
                    <div class="tx-col tx-col-received">পেলাম</div>
                </div>
            `;

            const transactionsWithRunningBalance = [];
            let runningBalance = 0;
            allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date)); 
            allTransactions.forEach(tx => {
                if (tx.type === 'gave') runningBalance += tx.amount;
                if (tx.type === 'received') runningBalance -= tx.amount;
                transactionsWithRunningBalance.push({ ...tx, runningBalance });
            });
            transactionsWithRunningBalance.reverse();

            
            transactionsWithRunningBalance.forEach(tx => {
                if (tx.type === 'gave') totalGave += tx.amount;
                if (tx.type === 'received') totalReceived += tx.amount;
                
                const row = document.createElement('div');
                row.className = 'tx-table-row';
                if (clickable) {
                    row.dataset.txId = tx.id;
                }
                const { datePart, yearPart, timePart } = formatTransactionDateForDisplay(tx.date);
                const descriptionHTML = tx.description ? `
                    <span class="tx-description-text">${tx.description}</span>` : '';

                let balanceDisplay = 'হিসাব ০.০০';
                if (tx.runningBalance > 0) {
                    balanceDisplay = `<span class="balance-label">পাবো</span> <span style="color: var(--expense-color);">${formatCurrency(tx.runningBalance, false)}</span>`;
                } else if (tx.runningBalance < 0) {
                    balanceDisplay = `<span class="balance-label">দেবো</span> <span style="color: var(--income-color);">${formatCurrency(Math.abs(tx.runningBalance), false)}</span>`;
                }

                row.innerHTML = `
                    <div class="tx-col tx-col-details">
                        <div class="tx-date">${datePart}</div>
                        <div class="tx-date-year">${yearPart}</div>
                        <div class="tx-time">${timePart}</div>
                        ${descriptionHTML}
                        <div class="running-balance-chip">${balanceDisplay}</div>
                    </div>
                    <div class="tx-col tx-col-gave">
                        ${tx.type === 'gave' ? formatCurrency(tx.amount, false) : ''}
                    </div>
                    <div class="tx-col tx-col-received">
                        ${tx.type === 'received' ? formatCurrency(tx.amount, false) : ''}
                    </div>
                `;
                tableContainer.appendChild(row);
            });
            
            return { tableElement: tableContainer, totalGave, totalReceived, allTransactions };
        }

        function generateCustomerReportShareText(customer) {
            const ledgerName = ledgers[currentLedgerId]?.name || "আমার খাতা";
            const transactions = [...(customer.transactions || [])].sort((a, b) => new Date(a.date) - new Date(b.date));
            let totalGave = 0;
            let totalReceived = 0;

            let text = `**${customer.name} - বাকি হিসাব রিপোর্ট**\n`;
            text += `খাতা: ${ledgerName}\n\n`;

            transactions.forEach(tx => {
                const { datePart, yearPart } = formatTransactionDateForDisplay(tx.date);
                text += `🗓️ ${datePart} ${yearPart}\n`;
                if (tx.type === 'gave') {
                    text += `🔴 দিলাম: ${formatCurrency(tx.amount)}\n`;
                    totalGave += tx.amount;
                }
                if (tx.type === 'received') {
                    text += `🟢 পেলাম: ${formatCurrency(tx.amount)}\n`;
                    totalReceived += tx.amount;
                }
                if (tx.description) {
                    text += `📝 ${tx.description}\n`;
                }
                text += `--------------------\n`;
            });
            
            const finalBalance = totalGave - totalReceived;
            
            text += `\n**সর্বমোট:**\n`;
            text += `মোট দিলাম: ${formatCurrency(totalGave)}\n`;
            text += `মোট পেলাম: ${formatCurrency(totalReceived)}\n`;
            text += `**${finalBalance >= 0 ? 'পাবো' : 'দেবো'}: ${formatCurrency(Math.abs(finalBalance))}**\n\n`;
            text += `Talika.xyz থেকে পাঠানো হয়েছে`;
            
            return text.replace(/\*\*/g, '');
        }

        function showTransactionDetailModal(customerId, txId) {
            history.pushState({ view: 'modal' }, '', location.href);
            const tx = findTransactionById(customerId, txId);
            if (!tx) return;

            activeEditingTx = { customerId, txId, originalTx: { ...tx } };
            const container = document.getElementById('transactionDetailContent');
            const { datePart, yearPart, timePart } = formatTransactionDateForDisplay(tx.date);
            const descriptionHTML = tx.description ? `<span class="tx-description-text" style="margin-top: 5px; display: block;">${tx.description}</span>` : '<i>কোনো বিবরণ নেই</i>';

            container.innerHTML = `
                 <div class="tx-table-header">
                    <div class="tx-col tx-col-details">বিবরণ</div>
                    <div class="tx-col tx-col-gave">দিলাম</div>
                    <div class="tx-col tx-col-received">পেলাম</div>
                </div>
                <div class="tx-table-row">
                     <div class="tx-col tx-col-details">
                        <div class="tx-date">${datePart}</div>
                        <div class="tx-date-year">${yearPart}</div>
                        <div class="tx-time">${timePart}</div>
                        ${descriptionHTML}
                    </div>
                    <div class="tx-col tx-col-gave">
                        ${tx.type === 'gave' ? formatCurrency(tx.amount) : ''}
                    </div>
                    <div class="tx-col tx-col-received">
                        ${tx.type === 'received' ? formatCurrency(tx.amount) : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('transactionDetailDeleteBtn').onclick = () => deleteTransaction(customerId, txId);
            document.getElementById('transactionDetailEditBtn').onclick = () => showEditTransactionModal(customerId, txId);

            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            transactionDetailModal.style.zIndex = zIndexCounter;
            transactionDetailModal.classList.add('active');
        }
        
        function showEditTransactionModal(customerId, txId) {
            history.pushState({ view: 'modal' }, '', location.href);
            const customer = findCustomerById(customerId);
            const tx = findTransactionById(customerId, txId);
            if (!customer || !tx) return;

            const customerInfoDiv = document.getElementById('editTransactionCustomerInfo');
            const initial = customer.name.trim().charAt(0).toUpperCase() || '?';
            const color = customerColors[Math.abs(customer.name.split("").reduce((a,b)=>{a=((a<<5)-a)+b.charCodeAt(0);return a&a},0)) % customerColors.length];
            const balance = customer.currentBalance || 0;
            
            let balanceHTML = '';
            let balanceClass = '';
            if (balance > 0) {
                balanceHTML = `<span class="balance-label">পাবো</span> <span class="balance-amount">${formatCurrency(balance)}</span>`;
                balanceClass = 'positive';
            } else if (balance < 0) {
                balanceHTML = `<span class="balance-label">দেবো</span> <span class="balance-amount">${formatCurrency(Math.abs(balance))}</span>`;
                balanceClass = 'negative';
            } else {
                balanceHTML = 'হিসাব ০.০০';
            }
            
            customerInfoDiv.innerHTML = `
                 <div style="display: flex; align-items: center; gap: 10px;">
                    <div class="customer-initial-circle" style="background-color: ${color}; width: 35px; height: 35px; font-size: 1.1em;">${initial}</div>
                    <div>
                        <div style="font-weight: bold;">${customer.name}</div>
                        <div class="balance ${balanceClass}">${balanceHTML}</div>
                    </div>
                </div>
            `;
            
            document.getElementById('editGaveAmountInput').value = tx.type === 'gave' ? tx.amount : '';
            document.getElementById('editReceivedAmountInput').value = tx.type === 'received' ? tx.amount : '';
            document.getElementById('editDescriptionInput').value = tx.description;
            document.getElementById('editDateInput').value = formatDateForInput(new Date(tx.date));
            
            // এরর ক্লিয়ার করা হয়েছে
            [document.getElementById('editGaveAmountInput'), document.getElementById('editReceivedAmountInput')].forEach(clearFormError);


            transactionDetailModal.classList.remove('active');
            zIndexCounter = Math.max(zIndexCounter + 1, 10000); // ফিক্স
            editTransactionModal.style.zIndex = zIndexCounter;
            editTransactionModal.classList.add('active');
        }

        async function deleteTransaction(customerId, txId) {
     const confirmed = await customConfirm('আপনি কি এই লেনদেনটি মুছে ফেলতে নিশ্চিত?');
     
     if (confirmed) {
        const customer = findCustomerById(customerId);
        if (!customer) return;
        const txIndex = customer.transactions.findIndex(t => t.id === txId);
        
        if (txIndex > -1) {
            customer.transactions.splice(txIndex, 1);
            
            // ✅ ফিক্স: ব্যালেন্স ও তারিখ আপডেট
            recalculateCustomerState(customer);

            // ✅ ফিক্স: সার্ভারে আপডেট
            await updateFirestore({ ledgers });
            
            showToast('লেনদেন মুছে ফেলা হয়েছে।', { duration: 2000 });
            
            // ✅ ফিক্স: history.back() ব্যবহার করে মডাল বন্ধ করা
            history.back(); 
            
            // স্ক্রিন রিফ্রেশ না করে ডেটা আপডেট করা
            showCustomerReportPage(customerId);
            renderLedgerCustomerView();
            prepareAndRenderLedger();
        }
     }
}
        
        async function saveEditedTransaction() {
    const saveButton = document.getElementById('saveEditedTransactionBtn');
    // ১. লোডিং স্টেট সেট করা
    const originalText = setButtonLoading(saveButton, saveButton.textContent);
    
    try {
        const { customerId, txId, originalTx } = activeEditingTx;
        const customer = findCustomerById(customerId);
        const tx = findTransactionById(customerId, txId);
        if (!customer || !tx) throw new Error("Customer or Transaction not found");
        
        const gaveInput = document.getElementById('editGaveAmountInput');
        const receivedInput = document.getElementById('editReceivedAmountInput');
        const gaveAmount = parseFloat(gaveInput.value) || 0;
        const receivedAmount = parseFloat(receivedInput.value) || 0;

        // ভ্যালিডেশন
        [gaveInput, receivedInput].forEach(clearFormError);
        if (gaveAmount > 0 && receivedAmount > 0) { 
            showFormError(gaveInput, 'একসাথে দুটি এন্ট্রি দেওয়া যাবে না।');
            showFormError(receivedInput, 'একসাথে দুটি এন্ট্রি দেওয়া যাবে না।');
            return; 
        }
        if (gaveAmount === 0 && receivedAmount === 0) { 
            showFormError(gaveInput, 'টাকার পরিমাণ আবশ্যক।');
            showFormError(receivedInput, 'টাকার পরিমাণ আবশ্যক।');
            return; 
        }
        
        // ব্যালেন্স অ্যাডজাস্টমেন্ট ক্যালকুলেশন
        let balanceAdjustment = 0;
        if (originalTx.type === 'gave') balanceAdjustment -= originalTx.amount;
        else balanceAdjustment += originalTx.amount;
        
        tx.type = gaveAmount > 0 ? 'gave' : 'received';
        tx.amount = parseFloat((gaveAmount > 0 ? gaveAmount : receivedAmount).toFixed(2));
        tx.description = document.getElementById('editDescriptionInput').value.trim();
        
        if (tx.type === 'gave') balanceAdjustment += tx.amount;
        else balanceAdjustment -= tx.amount;

        // NOTE: Instead of manually manipulating customer.currentBalance,
        // we call the master function to recalculate the state based on the new transactions.
        // customer.currentBalance += balanceAdjustment; // REMOVED manual manipulation

        // তারিখ আপডেট করা
        const newDate = document.getElementById('editDateInput').value;
        const oldDate = new Date(tx.date);
        const finalDate = new Date(newDate + 'T00:00:00');
        finalDate.setHours(oldDate.getHours(), oldDate.getMinutes(), oldDate.getSeconds());
        tx.date = finalDate.toISOString();
        // customer.lastUpdated = new Date().toISOString(); // REMOVED manual manipulation
        
        // মাস্টার ফাংশন কল (ব্যালেন্স ও সর্টিং ঠিক করার জন্য)
        recalculateCustomerState(customer);

        // ২. ডেটাবেসে সেভ করা
        await updateFirestore({ ledgers });
        
        // ৩. সফলতার পর UI আপডেট করা
        showToast('লেনদেন আপডেট করা হয়েছে।', { duration: 2000 });
        history.back(); 
        showCustomerReportPage(customerId);
        renderLedgerCustomerView();
        prepareAndRenderLedger();
    } catch (error) {
         console.error("Edit Transaction Error:", error);
         customAlert("লেনদেন আপডেট করা যায়নি। আবার চেষ্টা করুন।");
    } finally {
        // ৪. বাটনকে স্বাভাবিক অবস্থায় ফিরিয়ে আনা
        resetButtonState(saveButton);
    }
}
        
        // --- START: চূড়ান্ত কাস্টম ক্যালকুলেটর লজিক (পার্সেন্টেজ ও চেইনিং ফিক্সড) ---

const customCalculator = document.getElementById('customCalculator');
const calculatorGrid = customCalculator.querySelector('.calculator-grid');

const calculatorTargetInputs = [
    document.getElementById('itemPrice'),
    document.getElementById('gaveAmountInput'),
    document.getElementById('receivedAmountInput'),
    // document.getElementById('itemQuantity'), // REMOVED
    document.getElementById('editItemPrice'),
    // document.getElementById('editItemQuantity'), // REMOVED
    document.getElementById('editGaveAmountInput'),
    document.getElementById('editReceivedAmountInput')
];

let calculatorTargetInput = null;
let firstOperand = null;
let operator = null;
let waitingForSecondOperand = false;
let hasCalculated = false;
let displayExpression = '';

// ফাংশন: ক্যালকুলেটর দেখানো
function showCalculator(inputElement) {
    if (calculatorTargetInput === inputElement && customCalculator.classList.contains('show')) return;

    if (inputElement) {
        inputElement.type = 'text';
        inputElement.inputMode = 'decimal';
        inputElement.setAttribute('pattern', '[0-9]*');

        let cleanValue = inputElement.value.trim();
        if (cleanValue === '' || isNaN(parseFloat(cleanValue))) {
            cleanValue = '0';
        } else {
            cleanValue = String(parseFloat(cleanValue));
        }
        inputElement.value = cleanValue;
    }

    calculatorTargetInput = inputElement;
    resetCalculatorState();

    const activeModals = document.querySelectorAll('.custom-modal.active, .modal-overlay.active');
    let maxZIndex = 1000;
    activeModals.forEach(modal => {
        const zIndex = parseInt(window.getComputedStyle(modal).zIndex, 10);
        if (!isNaN(zIndex) && zIndex > maxZIndex) {
            maxZIndex = zIndex;
        }
    });

    customCalculator.style.zIndex = maxZIndex + 1;

    if (!customCalculator.classList.contains('show')) {
        history.pushState({
            view: 'modal',
            calculatorOpen: true
        }, '', location.href);
        customCalculator.classList.add('show');
    }
}

// ফাংশন: ক্যালকুলেটর লুকানো
function hideCalculator() {
    if (!customCalculator.classList.contains('show')) return;

    if (calculatorTargetInput) {
        let finalValue = calculatorTargetInput.value;
        
        // যদি অপারেটর ঝুলে থাকে (যেমন 20+), সেটা ক্লিন করে রেজাল্ট রাখা
        if (operator && waitingForSecondOperand) {
             finalValue = String(firstOperand);
        } 
        // যদি এক্সপ্রেশন থাকে (যেমন 10+5), ক্যালকুলেট করা
        else if (operator && firstOperand !== null) {
             const parts = finalValue.split(operator);
             const lastPart = parts[parts.length - 1];
             if(lastPart) {
                 finalValue = String(calculate(firstOperand, operator, parseFloat(lastPart)));
             }
        }
        
        finalValue = String(parseFloat(finalValue) || '');
        if (finalValue === '0') finalValue = '';

        calculatorTargetInput.value = finalValue;

        const inputEvent = new Event('input', {
            bubbles: true,
            cancelable: true
        });
        calculatorTargetInput.dispatchEvent(inputEvent);
    }

    customCalculator.classList.remove('show');
    calculatorTargetInput = null;
    resetCalculatorState();
}

function resetCalculatorState() {
    firstOperand = null;
    operator = null;
    waitingForSecondOperand = false;
    hasCalculated = false;
    displayExpression = '';
}

calculatorTargetInputs.forEach(input => {
    if (input) {
        input.readOnly = true;
        input.addEventListener('click', (e) => {
            showCalculator(e.target);
        });
    }
});

document.addEventListener('click', (e) => {
    if (calculatorTargetInput && !calculatorTargetInput.contains(e.target) && !customCalculator.contains(e.target)) {
        if (history.state && history.state.calculatorOpen) {
            history.back();
        } else {
            hideCalculator();
        }
    }
});

// --- ক্যালকুলেটর বাটন লজিক (চেইনিং ফিক্সড: 5.5+5.5+ চাপলে 11+ হবে) ---
calculatorGrid.addEventListener('click', (e) => {
    const key = e.target.closest('.calc-btn')?.dataset.key;
    if (!key || !calculatorTargetInput) return;

    const display = calculatorTargetInput;
    let currentValue = display.value;

    // ইনপুট খালি থাকলে 0 ধরবে
    if (currentValue.trim() === '') currentValue = '0';
    currentValue = String(currentValue);

    // --- হেল্পার ফাংশন: স্ট্রিং ক্যালকুলেশন (নিরাপদ) ---
    const safeCalculate = (str) => {
        try {
            // 12 ডিজিট প্রিসিশন ফিক্স (যেমন: 0.1+0.2 = 0.3)
            const result = new Function('return ' + str)();
            return String(parseFloat(result.toPrecision(12)));
        } catch (e) {
            return str;
        }
    };

    if (/\d/.test(key)) { // সংখ্যা (0-9)
        if (waitingForSecondOperand || hasCalculated) {
            // "=" চাপার পর বা রেজাল্ট আসার পর নতুন সংখ্যা চাপলে আগের সব মুছে নতুন শুরু হবে
            currentValue = key;
            waitingForSecondOperand = false;
            hasCalculated = false;
        } else {
            if (currentValue === '0' && !currentValue.includes('.')) {
                currentValue = key;
            } else {
                currentValue += key;
            }
        }
    } 
    else if (key === '.') { // দশমিক (.)
        if (waitingForSecondOperand || hasCalculated) {
            currentValue = '0.';
            waitingForSecondOperand = false;
            hasCalculated = false;
        } else {
            // শেষ সংখ্যাটিতে ডট আছে কিনা চেক করা (যাতে 5.5.5 না হয়)
            const parts = currentValue.split(/[\+\-\*\/]/);
            const currentNumberSegment = parts[parts.length - 1];
            if (!currentNumberSegment.includes('.')) {
                currentValue += '.';
            }
        }
    } 
    else if (['+', '-', '*', '/'].includes(key)) { // অপারেটর (+, -, *, /)
        const lastChar = currentValue.slice(-1);
        
        // ১. যদি শেষে অলরেডি অন্য অপারেটর থাকে, সেটা রিপ্লেস করো (যেমন: 5+ এর পর - দিলে 5- হবে)
        if (['+', '-', '*', '/'].includes(lastChar)) {
            currentValue = currentValue.slice(0, -1) + key;
        } 
        else {
            // ২. চেইনিং লজিক: যদি আগে থেকেই কোনো হিসাব থাকে (যেমন 5.5+5.5),
            // তবে নতুন অপারেটর চাপলে আগেরটার রেজাল্ট বের করে তারপর অপারেটর বসাবে (11+)
            
            // প্রথম ক্যারেক্টার বাদ দিয়ে চেক করা (নেগেটিভ নম্বরের জন্য)
            const checkString = currentValue.substring(1); 
            const hasOperator = /[\+\-\*\/]/.test(checkString);

            if (hasOperator && !hasCalculated) {
                // আগের হিসাব শেষ করো
                const result = safeCalculate(currentValue);
                currentValue = result + key; // রেজাল্ট (11) + নতুন অপারেটর (+)
            } else {
                // সাধারণ অবস্থা: শুধু অপারেটর যোগ করো
                currentValue += key;
            }
        }
        
        waitingForSecondOperand = false; 
        hasCalculated = false; 
        operator = key; // স্টেট আপডেট
    } 
    else if (key === '%') {
        // পার্সেন্টেজ লজিক (সিম্পল)
        const parts = currentValue.split(/[\+\-\*\/]/);
        const lastNum = parts[parts.length - 1];
        if (lastNum) {
            const val = parseFloat(lastNum);
            const percentVal = val / 100;
            currentValue = currentValue.substring(0, currentValue.lastIndexOf(lastNum)) + percentVal;
        }
    }
    else if (key === '=') { // সমান চিহ্ন
        // "=" চাপলে ফাইনাল রেজাল্ট দেখাবে (শুধু 11)
        if(!hasCalculated) {
            currentValue = safeCalculate(currentValue);
            hasCalculated = true;
            operator = null; 
            waitingForSecondOperand = true; // এরপর সংখ্যা চাপলে নতুন করে শুরু হবে
        }
    } 
    else if (key === 'AC') {
        currentValue = '0';
        resetCalculatorState();
    } 
    else if (key === 'backspace') {
        if (currentValue === '0' || hasCalculated) {
            currentValue = '0';
            hasCalculated = false; // ব্যাকস্পেস দিলে ক্যালকুলেটেড ফ্ল্যাগ রিসেট
        } else {
            currentValue = currentValue.slice(0, -1);
            if (currentValue === '') currentValue = '0';
        }
    }

    // ডিসপ্লে আপডেট
    display.value = currentValue;
    const inputEvent = new Event('input', { bubbles: true, cancelable: true });
    display.dispatchEvent(inputEvent);
});

function calculate(first, op, second) {
    const a = parseFloat(first);
    const b = parseFloat(second);
    let result = 0;

    switch (op) {
        case '+': result = a + b; break;
        case '-': result = a - b; break;
        case '*': result = a * b; break;
        case '/':
            if (b === 0) {
                if (typeof showToast === 'function') showToast('শূন্য দিয়ে ভাগ করা যায় না।');
                return 0;
            }
            result = a / b;
            break;
        default: return second;
    }
    return parseFloat(result.toPrecision(12));
}

// --- END: চূড়ান্ত কাস্টম ক্যালকুলেটর লজিক ---
    })(); // End of IIFE

    </script>
</body>
</html>